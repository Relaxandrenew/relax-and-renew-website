<!-- Portal Version: v1.7 | Profile edits now submit as change requests (no automatic syncing messaging) -->
<!DOCTYPE html>
<html lang="en" class="scroll-smooth" data-build="2026-01-12-v4">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Client Portal | Relax & Renew RMT</title>
  <script>
    // Force HTTPS for PWA install eligibility
    (function rnr_force_https(){
      try {
        if (location && location.protocol === "http:" && /relaxandrenew\.ca$/i.test(location.hostname)) {
          location.replace("https://" + location.host + location.pathname + location.search + location.hash);
        }
      } catch(e) {}
    })();
  </script>

  <meta name="description" content="Relax & Renew Client Portal — rebook appointments, view your details, and manage your membership." />

  <!-- Meta Pixel -->
  <script>
  !function(f,b,e,v,n,t,s)
  {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
  n.callMethod.apply(n,arguments):n.queue.push(arguments)};
  if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
  n.queue=[];t=b.createElement(e);t.async=!0;
  t.src=v;s=b.getElementsByTagName(e)[0];
  s.parentNode.insertBefore(t,s)}(window, document,'script',
  'https://connect.facebook.net/en_US/fbevents.js');
  fbq('init', '701194265870298');
  fbq('track', 'PageView');
  </script>
  <noscript><img height="1" width="1" style="display:none"
  src="https://www.facebook.com/tr?id=701194265870298&ev=PageView&noscript=1"
  /></noscript>

  <!-- Google Analytics / Ads -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=AW-17575022013"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-J4NC9FL44H');
    gtag('config', 'AW-17575022013');
  </script>

  <!-- Suppress noisy third-party errors -->
  <script>
    window.onerror = function(msg, url, line, col, error) {
      if (!url || (msg && String(msg).toLowerCase().indexOf("script error") > -1)) return true;
      return false;
    };
    window.addEventListener('unhandledrejection', function(event) { event.preventDefault(); });
  </script>

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;0,700;1,400&display=swap" rel="stylesheet">

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            gold: '#E0C584',
                            goldHover: '#F0D594',
                            light: '#F0E2C0', 
                            dim: 'rgba(240, 226, 192, 0.6)',
                            black: '#050505',
                            dark: '#0a0a0a',
                            panel: 'rgba(20, 20, 20, 0.7)',
                        }
                    },
                    fontFamily: {
                        serif: ['"Cormorant Garamond"', 'serif'],
                    },
                    backgroundImage: {
                        'hero-pattern': "linear-gradient(to bottom, rgba(0,0,0,0.3), rgba(0,0,0,0.9)), url('https://static.wixstatic.com/media/bf8fef_94f8be278f0f4b8abaee73b95d03b5e2~mv2.png')",
                        'alternate-pattern': "linear-gradient(to bottom, rgba(0,0,0,0.8), rgba(0,0,0,0.95)), url('https://static.wixstatic.com/media/bf8fef_7776f5b067be4025a75ed7e149bb1d7e~mv2.jpg')",
                        'gift-card-bg': "url('https://static.wixstatic.com/media/bf8fef_9da7c8e6be37443d89cac9f6884ec878~mv2.jpg')"
                    },
                    animation: {
                        'fade-in-up': 'fadeInUp 1s ease-out forwards',
                        'subtle-bounce': 'subtleBounce 3s ease-in-out infinite',
                        'loading-bar': 'loadingBar 1.5s ease-in-out infinite',
                    },
                    keyframes: {
                        fadeInUp: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' }
                        },
                        subtleBounce: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-3px)' }
                        },
                        loadingBar: {
                            '0%': { transform: 'translateX(-100%)' },
                            '100%': { transform: 'translateX(300%)' }
                        }
                    }
                }
            }
        };
  </script>

  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <!-- Auth0 Lock (Embedded Email + Password Window) -->
  <script src="https://cdn.auth0.com/js/lock/14.2.0/lock.min.js"></script>

  <style>
    :root {
      --brand-black: #050505;
      --brand-gold: #E0C584;
      --brand-gold-hover: #F0D594;
      --brand-light: #F0E2C0;
      --brand-dim: rgba(240, 226, 192, 0.6);
      --radius: 0.25rem;
      --shadow: 0 10px 30px rgba(0,0,0,0.55);
    }

    html, body { min-height: 100vh; height: auto; }
    html { background-color: #050505; }
    html, body { min-height: 100%; height: auto; }
    body { min-height: 100vh; }

    
    body {
      font-family: 'Cormorant Garamond', serif;
      background-color: #050505; 
      color: var(--brand-light);
      overflow-x: hidden;
    }

    /* =========================================
       FIXED: Header Navigation (From Index.html)
       ========================================= */
    .fixed-nav { 
        position: fixed; top: 0; left: 0; width: 100%; height: 80px; 
        z-index: 50; 
        transition: all 0.4s ease; 
        background: rgba(5, 5, 5, 0.95); 
        backdrop-filter: blur(15px); 
        border-bottom: 1px solid rgba(224, 197, 132, 0.2); 
        display: flex; align-items: center; 
    }
    
    .nav-link { 
        color: #F0E2C0; 
        text-transform: uppercase; 
        font-size: 0.8rem; 
        font-weight: 600; 
        letter-spacing: 0.15em; 
        text-decoration: none; 
        position: relative; 
        padding-bottom: 5px; 
    }
    .nav-link::after { 
        content: ''; position: absolute; bottom: 0; left: 0; width: 0; height: 1px; 
        background: #E0C584; transition: width 0.3s ease; 
    }
    .nav-link:hover::after { width: 100%; }

    /* Mobile Menu (Portal) */
    .mobile-menu {
      background: #050505;
      transform: translateX(100%);
      transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
      overscroll-behavior: contain;
      -webkit-overflow-scrolling: touch;
      will-change: transform;
    }
    .mobile-menu.open { transform: translateX(0); }

    .mobile-menu-backdrop.open {
      opacity: 1;
      pointer-events: auto;
    }

    html.menu-open,
    body.menu-open {
      overflow: hidden !important;
      height: 100%;
    }

    .header-hero { background: linear-gradient(145deg, rgba(8,8,8,0.95), rgba(5,5,5,0.98)); }

    /* Cards */
    .card-fancy, .glass-panel {
      background: linear-gradient(145deg, rgba(20,20,20,0.8), rgba(10,10,10,0.9));
      border: 1px solid rgba(224, 197, 132, 0.1);
      backdrop-filter: blur(10px);
      transition: all 0.4s ease;
      position: relative;
      overflow: hidden;
      border-radius: var(--radius);
    }
    .card-fancy::before, .glass-panel::before {
      content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 2px;
      background: linear-gradient(90deg, transparent, #E0C584, transparent);
      transform: scaleX(0); transition: transform 0.5s ease;
    }
    .card-fancy:hover, .glass-panel:hover { border-color: rgba(224, 197, 132, 0.3); }
    .card-fancy:hover::before, .glass-panel:hover::before { transform: scaleX(1); }

    /* Buttons */
    .btn-outline {
      border: 1px solid #E0C584; color: #E0C584; background: transparent;
      padding: 0.6rem 1.5rem; text-transform: uppercase; font-weight: 700; letter-spacing: 0.1em;
      transition: 0.3s; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; cursor: pointer;
    }
    .btn-outline:hover {
      background: rgba(224, 197, 132, 0.1); color: #F0E2C0; border-color: #F0D594;
      box-shadow: 0 0 15px rgba(224, 197, 132, 0.2);
    }
    .btn-filled {
      background: #E0C584; color: #000; border: 1px solid #E0C584;
      padding: 0.6rem 1.5rem; text-transform: uppercase; font-weight: 700; letter-spacing: 0.1em;
      transition: 0.3s; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; cursor: pointer;
    }
    .btn-filled:hover {
      background: #F0D594; border-color: #F0D594; transform: translateY(-1px);
      box-shadow: 0 5px 15px rgba(224, 197, 132, 0.3);
    }
    .btn-disabled {
      opacity: 0.5; cursor: not-allowed; background: #333 !important; border-color: #444 !important; color: #777 !important;
      box-shadow: none !important; transform: none !important;
    }

    /* Inputs */
    .input {
      width: 100%; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(224, 197, 132, 0.3);
      color: var(--brand-light); padding: 0.6rem 1rem; border-radius: 0.25rem; outline: none; font-size: 1rem;
      min-height: 48px;
      max-width: 100%; /* Prevent overflow */
    }
    /* Profile Inputs (dark) */
    .input-dark {
      width: 100%;
      background: rgba(0, 0, 0, 0.35);
      border: 1px solid rgba(224, 197, 132, 0.3);
      color: var(--brand-light);
      padding: 0.6rem 1rem;
      border-radius: 0.25rem;
      outline: none;
      font-size: 1rem;
      min-height: 48px;
      max-width: 100%;
      transition: border-color .15s ease, box-shadow .15s ease;
    }
    .input-dark::placeholder { color: rgba(224, 197, 132, 0.55); }
    .input-dark:focus {
      border-color: rgba(240, 213, 148, 0.8);
      box-shadow: 0 0 0 3px rgba(224, 197, 132, 0.18);
    }
    textarea.input-dark { min-height: 110px; resize: vertical; }

    /* Fixed Dropdowns: Custom arrow, dark background for options */
    select.input {
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      padding-right: 2.5rem;
      background-color: rgba(5,5,5,0.8);
      /* Custom Gold Chevron */
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23E0C584' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
      background-position: right 0.5rem center;
      background-repeat: no-repeat;
      background-size: 1.5em 1.5em;
    }
    .input:focus { border-color: #E0C584; background-color: rgba(255, 255, 255, 0.1); }
    
    /* Ensure Dropdown Options are Black */
    select.input option {
      background-color: #050505;
      color: #F0E2C0;
      padding: 10px;
    }

    /* Sidebar */
    .sidebar-btn {
      width: 100%; display: flex; gap: 0.7rem; align-items: center; padding: 0.75rem 1rem;
      border: 1px solid transparent; border-radius: var(--radius); color: rgba(240, 226, 192, 0.6);
      transition: all 0.3s ease; font-size: 1.05rem; background: transparent;
    }
    .sidebar-btn:hover { background: rgba(224, 197, 132, 0.05); color: #E0C584; }
    .sidebar-btn.active { background: rgba(224, 197, 132, 0.1); border: 1px solid rgba(224, 197, 132, 0.2); color: #E0C584; }

    /* Calendar */
    .calendar-day {
      width: 100%; aspect-ratio: 1/1; display: flex; align-items: center; justify-content: center;
      border: 1px solid rgba(224, 197, 132, 0.1); background: rgba(255,255,255,0.02);
      border-radius: var(--radius); font-weight: 600; transition: all 0.2s ease; user-select: none; color: var(--brand-light);
    }
    .calendar-day-available { cursor: pointer; }
    .calendar-day-available:hover { border-color: #E0C584; background: rgba(224, 197, 132, 0.1); transform: scale(1.05); }
    .calendar-day-disabled { background: rgba(0, 0, 0, 0.3); color: rgba(240, 226, 192, 0.2); cursor: not-allowed; border-color: transparent; }
    .calendar-day-selected { background: #E0C584 !important; color: #000 !important; border-color: #E0C584 !important; font-weight: bold; box-shadow: 0 0 10px rgba(224,197,132,0.3); }
    .calendar-day-today { border-color: #F0E2C0; }

    /* Slots */
    .time-slot-btn {
      width: 100%; display: flex; align-items: center; justify-content: center; gap: 0.5rem;
      padding: 0.6rem; border: 1px solid rgba(224, 197, 132, 0.2); background: rgba(255,255,255,0.03);
      border-radius: var(--radius); transition: all 0.2s ease; font-weight: 600; color: var(--brand-light);
    }
    .time-slot-btn:hover { border-color: #E0C584; background: rgba(224, 197, 132, 0.1); }
    .time-slot-selected { background: #E0C584 !important; color: #000 !important; border-color: #E0C584 !important; }
    .time-slot-unavailable { opacity: 0.4; cursor: not-allowed; border-color: transparent; }

    .pill {
      background: rgba(224, 197, 132, 0.08); border: 1px solid rgba(224, 197, 132, 0.2); color: #F0E2C0;
      display: inline-flex; align-items: center; gap: 0.4rem; padding: 0.3rem 0.8rem; border-radius: 4px;
      font-size: 0.9rem; letter-spacing: 0.05em;
    }
    .muted { color: var(--brand-dim); }
    .divider { border-color: rgba(224, 197, 132, 0.15); }
    
    .toast {
      background: rgba(20, 20, 20, 0.95); border: 1px solid #E0C584; color: #E0C584;
      box-shadow: 0 10px 30px rgba(0,0,0,0.8); backdrop-filter: blur(10px);
    }

    /* Simple indeterminate loading bar animation (used in auth-check overlay) */
    .animate-loading-bar {
      animation: rnrLoadingBar 1.1s infinite ease-in-out;
      will-change: transform;
    }
    @keyframes rnrLoadingBar {
      0% { transform: translateX(-120%); }
      50% { transform: translateX(220%); }
      100% { transform: translateX(220%); }
    }

    /* =========================================
       FIXED: Login Overlay CSS
       ========================================= */
    #login-overlay, #auth-check-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 200; /* Higher than nav */
      background: #000000;
            padding: 24px 12px;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
/* backdrop-filter removed for solid overlay */
      display: flex;
      align-items: center;
      justify-content: center;
      transition: opacity 0.4s ease, visibility 0.4s ease;
    
      height: 100dvh;
    
      overflow: auto;
    
      pointer-events: auto;
      touch-action: manipulation;
    }
    #login-overlay.hidden, #auth-check-overlay.hidden {
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
    }
    .login-card {
      background: #050505;
      border: 1px solid rgba(224, 197, 132, 0.25);
      backdrop-filter: blur(10px);
      padding: 2.5rem 2rem;
      max-width: 420px;
      width: 90%;
      position: relative;
    }
    .login-card::before {
      content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 2px;
      background: linear-gradient(90deg, transparent, #E0C584, transparent);
    }

    
    @media (max-width: 640px) {
      #login-overlay, #auth-check-overlay { align-items: flex-start; }
      .login-card {
        padding: 1.75rem 1.25rem;
        width: 94%;
        max-height: calc(100vh - 48px);
        overflow-y: auto;
      }
    }

/* =========================================
       FIXED: Auth0 Lock Styles (Robust Overrides)
       ========================================= */
    #auth0-lock-container { width: 100% !important; }
    #auth0-lock-container .auth0-lock,
    #auth0-lock-container .auth0-lock * {
      font-family: 'Cormorant Garamond', serif !important;
      border-radius: 0px !important;
      box-shadow: none !important;
    }
    #auth0-lock-container .auth0-lock .auth0-lock-widget {
      background: #050505 !important;
      border: 1px solid rgba(224,197,132,0.45) !important;
      overflow: hidden !important;
    }
    #auth0-lock-container .auth0-lock .auth0-lock-header,
    #auth0-lock-container .auth0-lock .auth0-lock-header-bg,
    #auth0-lock-container .auth0-lock .auth0-lock-footer,
    #auth0-lock-container .auth0-lock .auth0-lock-name,
    #auth0-lock-container .auth0-lock .auth0-lock-badge {
      display: none !important;
    }
    #auth0-lock-container .auth0-lock,
    #auth0-lock-container .auth0-lock .auth0-lock-content,
    #auth0-lock-container .auth0-lock .auth0-lock-pane,
    #auth0-lock-container .auth0-lock .auth0-lock-cred-pane,
    #auth0-lock-container .auth0-lock .auth0-lock-center,
    #auth0-lock-container .auth0-lock .auth0-lock-form,
    #auth0-lock-container .auth0-lock .auth0-lock-body-content,
    #auth0-lock-container .auth0-lock .auth0-lock-signup,
    #auth0-lock-container .auth0-lock .auth0-lock-terms,
    #auth0-lock-container .auth0-lock .auth0-lock-message,
    #auth0-lock-container .auth0-lock .auth0-lock-warning,
    #auth0-lock-container .auth0-lock .auth0-lock-error,
    #auth0-lock-container .auth0-lock .auth0-lock-error-msg {
      background: #050505 !important;
    }
    #auth0-lock-container .auth0-lock,
    #auth0-lock-container .auth0-lock label,
    #auth0-lock-container .auth0-lock p,
    #auth0-lock-container .auth0-lock .auth0-lock-alternative,
    #auth0-lock-container .auth0-lock .auth0-lock-terms {
      color: rgba(240,226,192,0.92) !important;
    }
    #auth0-lock-container .auth0-lock label {
      color: #E0C584 !important;
      font-weight: 700 !important;
      letter-spacing: 0.04em !important;
    }
    #auth0-lock-container .auth0-lock .auth0-lock-tabs,
    #auth0-lock-container .auth0-lock .auth0-lock-tabs-container {
      background: #050505 !important;
      border-bottom: 1px solid rgba(224,197,132,0.25) !important;
    }
    #auth0-lock-container .auth0-lock .auth0-lock-tabs li a,
    #auth0-lock-container .auth0-lock .auth0-lock-tabs li span {
      background: #050505 !important;
      color: rgba(240,226,192,0.70) !important;
      text-transform: uppercase !important;
      letter-spacing: 0.14em !important;
      font-weight: 700 !important;
      font-size: 0.72rem !important;
      padding: 18px 16px !important;
    }
    #auth0-lock-container .auth0-lock .auth0-lock-tabs li.auth0-lock-tabs-current a,
    #auth0-lock-container .auth0-lock .auth0-lock-tabs li.auth0-lock-tabs-current span {
      color: #E0C584 !important;
    }
    #auth0-lock-container .auth0-lock .auth0-lock-input-wrap {
      background: #050505 !important;
      border: 1px solid rgba(224,197,132,0.55) !important;
      padding: 0 !important;
    }
    #auth0-lock-container .auth0-lock .auth0-lock-input-wrap input,
    #auth0-lock-container .auth0-lock .auth0-lock-input-wrap textarea {
      background: #050505 !important;
      color: rgba(240,226,192,0.95) !important;
      font-size: 1.05rem !important;
    }
    #auth0-lock-container .auth0-lock .auth0-lock-input-wrap input::placeholder,
    #auth0-lock-container .auth0-lock .auth0-lock-input-wrap textarea::placeholder {
      color: rgba(240,226,192,0.45) !important;
    }
    #auth0-lock-container .auth0-lock .auth0-lock-input-wrap:focus-within {
      border-color: #F0D594 !important;
      box-shadow: 0 0 0 3px rgba(224,197,132,0.18) !important;
    }
    #auth0-lock-container .auth0-lock .auth0-lock-input-wrap .auth0-lock-input-icon {
      color: rgba(224,197,132,0.90) !important;
    }
    #auth0-lock-container .auth0-lock button.auth0-lock-submit,
    #auth0-lock-container .auth0-lock .auth0-lock-submit button {
      background: #E0C584 !important;
      border: 1px solid #E0C584 !important;
      color: #000000 !important;

      /* Keep the same thin button, but ensure perfect centering */
      height: 34px !important;
      min-height: 34px !important;
      padding: 0 14px !important;
      box-sizing: border-box !important;

      display: flex !important;
      align-items: center !important;
      justify-content: center !important;

      text-transform: uppercase !important;
      letter-spacing: 0.12em !important;
      font-weight: 800 !important;
      font-size: 0.95rem !important;
      line-height: 1 !important;

      border-radius: 0px !important;
      box-shadow: 0 0 0 rgba(224,197,132,0) !important;
      transition: transform 140ms ease, box-shadow 140ms ease, background-color 140ms ease, color 140ms ease, border-color 140ms ease !important;
    }
    #auth0-lock-container .auth0-lock button.auth0-lock-submit:hover,
    #auth0-lock-container .auth0-lock .auth0-lock-submit button:hover {
      background: #F0D594 !important;
      border-color: #F0D594 !important;
      color: #000000 !important;
      box-shadow: 0 0 0 3px rgba(224,197,132,0.18) !important;
      transform: translateY(-1px) !important;
    }
    #auth0-lock-container .auth0-lock .auth0-lock-separator span {
      background: #050505 !important;
      color: rgba(240,226,192,0.85) !important;
    }
    #auth0-lock-container .auth0-lock .auth0-lock-separator:before,
    #auth0-lock-container .auth0-lock .auth0-lock-separator:after {
      background: rgba(224,197,132,0.25) !important;
    }
    #auth0-lock-container .auth0-lock a {
      color: #E0C584 !important;
    }
    #auth0-lock-container .auth0-lock a:hover {
      color: #F0D594 !important;
    }

    /* CRITICAL FIX: Collapse Auth0 Lock's excessive internal height */
    #auth0-lock-container .auth0-lock .auth0-lock-cred-pane-internal-wrapper {
      min-height: auto !important;
      height: auto !important;
    }

    #auth0-lock-container .auth0-lock .auth0-lock-content-wrapper {
      min-height: auto !important;
      height: auto !important;
    }

    #auth0-lock-container .auth0-lock .auth0-lock-body-content {
      min-height: auto !important;
      height: auto !important;
    }

    #auth0-lock-container .auth0-lock .auth0-lock-submit {
      margin-top: 1rem !important; /* Reduce gap above button */
    }

    /* Remove any fixed heights Auth0 might be setting */
    #auth0-lock-container .auth0-lock-center {
      min-height: auto !important;
      height: auto !important;
      padding-bottom: 0 !important;
    }

/* =========================================
   BOOKING CONFIRMATION MODAL
   ========================================= */
#booking-modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: 300;
  background: rgba(0,0,0,0.9);
  backdrop-filter: blur(15px);
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.3s ease, visibility 0.3s ease;
}
#booking-modal-overlay.active {
  opacity: 1;
  visibility: visible;
}
.booking-modal-card {
  background: linear-gradient(145deg, rgba(20,20,20,0.98), rgba(10,10,10,0.99));
  border: 1px solid rgba(224, 197, 132, 0.3);
  padding: 3rem 2.5rem;
  max-width: 400px;
  width: 90%;
  text-align: center;
  position: relative;
}
.booking-modal-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 2px;
  background: linear-gradient(90deg, transparent, #E0C584, transparent);
}
.booking-spinner {
  width: 60px;
  height: 60px;
  border: 3px solid rgba(224, 197, 132, 0.2);
  border-top-color: #E0C584;
  border-radius: 50%;
  animation: booking-spin 1s linear infinite;
  margin: 0 auto 1.5rem;
}

/* Inline/row usage: remove the bottom margin so the spinner centers correctly */
#cancel-status-spinner.booking-spinner {
  margin: 0;
}

/* Small spinner for mobile weekly navigation (month re-fetch) */
.rnr-spinner-sm {
  width: 14px;
  height: 14px;
  border: 2px solid rgba(224, 197, 132, 0.25);
  border-top-color: #E0C584;
  border-radius: 50%;
  animation: booking-spin 0.9s linear infinite;
  display: inline-block;
}
@keyframes booking-spin {
  to { transform: rotate(360deg); }
}
.booking-status-text {
  color: #E0C584;
  font-size: 1.25rem;
  font-weight: 600;
  letter-spacing: 0.05em;
  min-height: 2rem;
  transition: opacity 0.2s ease;
}
.booking-substatus {
  color: rgba(240, 226, 192, 0.6);
  font-size: 0.85rem;
  margin-top: 0.5rem;
  letter-spacing: 0.1em;
  text-transform: uppercase;
}
.booking-success-icon {
  width: 70px;
  height: 70px;
  border: 3px solid #4ade80;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto 1.5rem;
  animation: booking-success-pop 0.4s ease;
}
@keyframes booking-success-pop {
  0% { transform: scale(0); opacity: 0; }
  50% { transform: scale(1.2); }
  100% { transform: scale(1); opacity: 1; }
}
.booking-error-icon {
  width: 70px;
  height: 70px;
  border: 3px solid #f87171;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto 1.5rem;
  animation: booking-success-pop 0.4s ease;
}


    /* =========================================
       MOBILE HARDENING: Auth0 overlay + keyboard
       - Prevent underlay scroll/bleed
       - Keep Lock visible above mobile keyboard
       ========================================= */
/* On short screens, start from top so Lock isn't trapped */
    
    /* =========================================================
       MOBILE OPTIMIZATION (visual + performance)
       - Reduce oversizing on small screens
       - Reduce heavy blur/background-fixed
       - Center Auth0 Lock cleanly
       - Make touch targets comfortable without being oversized
       ========================================================= */

    @media (max-width: 768px) {
      body { background-attachment: scroll !important; }
      .card-fancy, .glass-panel { backdrop-filter: none; }
    }

    @media (max-width: 640px) {
      /* Global sizing */
      html { font-size: 15px; }
      .header-hero { padding-top: 1.5rem !important; padding-bottom: 1.5rem !important; }
      .header-hero h1 { font-size: clamp(1.6rem, 6vw, 2.2rem) !important; line-height: 1.15 !important; }
      .header-hero p { font-size: 0.95rem !important; }

      /* Cards / panels */
      .card-fancy, .glass-panel { padding: 1rem !important; }
      .divider { margin: 0.75rem 0 !important; }

      /* Inputs / buttons */
      select, input {
        min-height: 44px !important;
        padding: 0.65rem 0.8rem !important;
        font-size: 0.95rem !important;
      }
      .btn-filled, .btn-outline {
        padding: 0.6rem 0.85rem !important;
        font-size: 0.95rem !important;
      }

      /* Time slot buttons */
      .slot-btn { padding: 0.55rem 0.6rem !important; font-size: 0.9rem !important; }

      /* Login overlay and Auth0 Lock */
      #login-overlay, #auth-check-overlay { padding: 16px !important; }
      .login-card {
        width: 100% !important;
        max-width: 420px !important;
        margin: 0 auto !important;
        padding: 0 !important;
        border: none !important;
        background: transparent !important;
        box-shadow: none !important;
      }
      .login-card::before { display: none !important; }
      #auth0-lock-container {
        width: 100% !important;
        display: flex !important;
        justify-content: center !important;
      }
      #auth0-lock-container .auth0-lock,
      #auth0-lock-container .auth0-lock-widget {
        width: 100% !important;
        max-width: 420px !important;
        margin: 0 auto !important;
      }
      /* Keep just one clean border on mobile (Auth0 widget only) */
      #auth0-lock-container .auth0-lock-widget {
        border: 1px solid rgba(224, 197, 132, 0.35) !important;
      }

      /* Mobile menu: keep content stable and prevent behind-scroll */
      #mobile-menu { padding-bottom: env(safe-area-inset-bottom); }
    }

    /* Desktop-only: remove website header on portal (keep banner/hero) */
    @media (min-width: 641px) {
      #navbar { display: none !important; }
      #navbar-spacer { display: none !important; height: 0 !important; }
    }

@media (max-height: 700px) {
      #login-overlay, #auth-check-overlay { align-items: flex-start; justify-content: flex-start; }
      .login-card { margin-top: 8px; }
    }

    /* Light mode: swap gold accents to black for legibility */
    html.light-mode {
      --brand-gold: #111111;
      --brand-gold-hover: #111111;
      --brand-light: #111111;
      --brand-dim: rgba(0,0,0,0.6);
      --brand-black: #ffffff;
    }
    html.light-mode .text-brand-gold,
    html.light-mode .pill.text-brand-gold { color: #111111 !important; }
	    /* In light mode, ensure primary typography is dark (Tailwind color utilities are static). */
	    html.light-mode .text-brand-light { color: #111827 !important; }
	    html.light-mode .text-brand-dim { color: rgba(17,24,39,0.65) !important; }
	    /* Catch opacity variants like text-brand-gold/60 generated by Tailwind CDN */
	    html.light-mode [class*="text-brand-gold/"] { color: rgba(17,17,17,0.85) !important; }
	    html.light-mode [class*="hover:text-brand-gold"] { color: #111111 !important; }
	    html.light-mode [class*="hover:text-brand-light"] { color: #111111 !important; }
    html.light-mode .border-brand-gold { border-color: rgba(0,0,0,0.35) !important; }
    html.light-mode .btn-outline { border-color: rgba(0,0,0,0.35) !important; color: #111111 !important; }
    html.light-mode .divider { border-color: rgba(0,0,0,0.20) !important; }


    /* Robust scroll lock (prevents background scroll behind overlays on mobile/desktop) */
    html.rnr-scroll-locked, body.rnr-scroll-locked {
      height: 100% !important;
      overflow: hidden !important;
      overscroll-behavior: none;
    }
    body.rnr-scroll-locked {
      touch-action: none;
    }


    /* Mobile time picker overlay tweaks */
    @media (max-width: 768px) {
      #mobile-times-overlay .modal-card {
        width: calc(100vw - 24px);
        max-width: 100vw !important;
        margin: 0 auto;
      }
      #mobile-times-overlay .modal-card #time-slots-grid {
        /* Mobile: 5 columns for 15-min blocks (10:00, 10:15, 10:30, 10:45, 11:00) */
        grid-template-columns: repeat(5, minmax(0, 1fr));
      }

      /* Mobile calendar compaction: reduce vertical space (desktop unaffected) */
      #calendar-days { gap: 0.35rem !important; }
      .calendar-day { font-size: 0.85rem !important; }
      #prev-month-btn, #next-month-btn { padding: 0.45rem 0.6rem !important; }
      #calendar-month-label { font-size: 1.05rem !important; }
      #tab-rebook h2 { font-size: 1.55rem !important; margin-bottom: 1rem !important; }
      /* Weekday row */
      #tab-rebook .grid.grid-cols-7.gap-2.text-center { margin-top: 0.75rem !important; gap: 0.35rem !important; font-size: 9px !important; }
      /* Stepper */
      #booking-stepper { padding: 0.9rem !important; margin-bottom: 1rem !important; }
      #booking-stepper .stepper-label { font-size: 0.75rem !important; }

      /* Make the mobile overlay card scrollable (content scrolls, footer stays visible) */
      #mobile-times-overlay .modal-card {
        max-height: calc(100dvh - 24px);
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      #mobile-times-overlay .rnr-modal-scroll {
        flex: 1;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        overscroll-behavior: contain;
        padding-right: 2px;
      }

      /* Shrink time slot buttons on mobile */
      #mobile-times-overlay .time-slot-btn {
        padding: 0.46rem !important;
        border-radius: var(--radius) !important;
        min-height: 2.25rem;
        display: flex !important;
        flex-direction: column !important;
        align-items: center !important;
        justify-content: center !important;
        gap: 0.04rem;
        line-height: 1.05 !important;
      }
      /* Mobile time label parts */
      #mobile-times-overlay .time-slot-btn .time-main {
        font-size: 0.95rem !important;
        font-weight: 700 !important;
      }
      #mobile-times-overlay .time-slot-btn .time-ampm {
        font-size: 0.72rem !important;
        font-weight: 700 !important;
        letter-spacing: 0.10em;
      }
      #mobile-times-overlay #time-slots-grid {
        gap: 0.35rem !important;
      }

      /* Hide Step 3 confirm panel under the calendar on mobile (it will be shown in its own confirm modal) */
      #summary-confirm-panel { display: none !important; }
      #mobile-times-overlay #summary-confirm-panel { display: none !important; }
      #mobile-confirm-overlay #summary-confirm-panel { display: block !important; }


    }


    /* RNR: smaller/thinner Auth0 buttons (requested) */
    #auth0-lock-container .auth0-lock button.auth0-lock-submit,
    #auth0-lock-container .auth0-lock .auth0-lock-submit button {
      padding: 0 14px !important;
      height: 34px !important;
      min-height: 34px !important;
      line-height: 1 !important;
      border-radius: 0px !important;
}


    /* Quick Rebook disabled state */
    .quickrebook-disabled,
    button.card-fancy[disabled] {
      opacity: 0.45 !important;
      cursor: not-allowed !important;
      transform: none !important;
    }
    button.card-fancy[disabled]:hover {
      border-color: rgba(224,197,132,0.20) !important;
      box-shadow: none !important;
      transform: none !important;
    }

/* Quick Rebook: disabled state + inline spinner */
.quickrebook-btn[disabled],
.quickrebook-btn.quickrebook-disabled {
  cursor: not-allowed !important;
  opacity: 0.55 !important;
  filter: grayscale(0.15);
}
.quickrebook-btn .qr-spinner {
  display: none;
  width: 14px;
  height: 14px;
  border: 2px solid rgba(224, 197, 132, 0.35);
  border-top-color: #E0C584;
  border-radius: 50%;
  animation: rnrSpin 0.8s linear infinite;
}
.quickrebook-btn[disabled] .qr-spinner,
.quickrebook-btn.quickrebook-disabled .qr-spinner {
  display: inline-block;
}
@keyframes rnrSpin { to { transform: rotate(360deg); } }

</style>

  <script>
    // =========================================================
    // CONFIG
    // =========================================================
    const N8N_WEBHOOK_BASE = "https://primary-production-efcf.up.railway.app/webhook";
    const REVIEW_FLAG_GET_WEBHOOK_URL = `${N8N_WEBHOOK_BASE}/review-flag-get`;
    const REVIEW_FLAG_SET_WEBHOOK_URL = `${N8N_WEBHOOK_BASE}/review-flag-set`;
    const AVAILABILITY_WEBHOOK_URL = `${N8N_WEBHOOK_BASE}/portal-availability-gate`;
    const BOOKING_WEBHOOK_URL      = `${N8N_WEBHOOK_BASE}/portal-booking-confirmed`;
    const APPOINTMENTS_WEBHOOK_URL = `${N8N_WEBHOOK_BASE}/portal-get-appointments`;
    const CANCEL_WEBHOOK_URL        = `${N8N_WEBHOOK_BASE}/portal-cancel-appointment`;
    const LAST_BOOKING_WEBHOOK_URL  = `${N8N_WEBHOOK_BASE}/portal-get-last-booking`;
    const WAITLIST_WEBHOOK_URL      = `${N8N_WEBHOOK_BASE}/portal-join-waitlist`;
    const INVOICE_WEBHOOK_URL       = `${N8N_WEBHOOK_BASE}/portal-get-invoice`;
    const REQUEST_CANCEL_WEBHOOK_URL= `${N8N_WEBHOOK_BASE}/portal-request-cancellation`;
    const PROFILE_UPDATE_WEBHOOK_URL = `${N8N_WEBHOOK_BASE}/profile-update`;

    // Scroll lock helpers (used by mobile overlays/modals)
    let __rnrScrollLockCount = 0;
    let __rnrScrollLockY = 0;

    function lockBodyScroll() {
      try {
        __rnrScrollLockCount += 1;
        if (__rnrScrollLockCount > 1) return;

        __rnrScrollLockY = window.scrollY || window.pageYOffset || 0;

        document.documentElement.classList.add('rnr-scroll-locked');
        document.body.classList.add('rnr-scroll-locked');

        // iOS-friendly lock: pin body
        document.body.style.position = 'fixed';
        document.body.style.top = `-${__rnrScrollLockY}px`;
        document.body.style.left = '0';
        document.body.style.right = '0';
        document.body.style.width = '100%';
      } catch (e) {}
    }

    function unlockBodyScroll() {
      try {
        if (!__rnrScrollLockCount) return;
        __rnrScrollLockCount -= 1;
        if (__rnrScrollLockCount > 0) return;

        document.documentElement.classList.remove('rnr-scroll-locked');
        document.body.classList.remove('rnr-scroll-locked');

        document.body.style.position = '';
        document.body.style.top = '';
        document.body.style.left = '';
        document.body.style.right = '';
        document.body.style.width = '';

        window.scrollTo(0, __rnrScrollLockY || 0);
      } catch (e) {}
    }

    function isMobileUI() {
      try {
        return window.matchMedia && window.matchMedia('(max-width: 768px)').matches;
      } catch (e) {
        return (window.innerWidth || 1024) <= 768;
      }
    

    }

    // =========================================================
    // Mobile Step 2 Date Strip (7-day window + prev/next 7 days)
    // - Uses month-wide availabilityByDate cache
    // - Unavailable/past days are disabled (unclickable)
    // =========================================================
    let __mobileStripStartDateStr = null; // YYYY-MM-DD start for the 7 tiles

    function _rnrDateFromStr(dateStr) {
      // dateStr is YYYY-MM-DD
      try { return new Date(dateStr + 'T00:00:00'); } catch (e) { return new Date(dateStr); }
    }

    function _rnrAddDays(dateObj, n) {
      const d = new Date(dateObj.getTime());
      d.setDate(d.getDate() + Number(n || 0));
      return d;
    }

    function getSlotsForDateKey(dateStr) {
      try {
        const key = (typeof normalizeDateKey === 'function' ? (normalizeDateKey(dateStr) || dateStr) : dateStr);
        let v = (availabilityByDate && (availabilityByDate[key] || availabilityByDate[dateStr])) || [];
        if (v && !Array.isArray(v)) {
          if (Array.isArray(v.slots)) v = v.slots;
          else if (Array.isArray(v.times)) v = v.times;
          else if (Array.isArray(v.timeSlots)) v = v.timeSlots;
          else v = [];
        }
        return Array.isArray(v) ? v : [];
      } catch (e) {
        return [];
      }
    }

function renderMobileDateStrip() {
      if (!isMobileUI()) return;
      const strip = document.getElementById('mobile-date-strip');
      const range = document.getElementById('mobile-strip-range');
      if (!strip || !range) return;

      if (!selectedDateStr) {
        strip.innerHTML = '';
        range.textContent = '—';
        return;
      }

      // Ensure start date is initialized and keeps selected date inside the visible window
      if (!__mobileStripStartDateStr) __mobileStripStartDateStr = selectedDateStr;

      // If the selected date is outside the current 7-day window, re-anchor the strip to the selected date
      const _tmpStart = _rnrDateFromStr(__mobileStripStartDateStr);
      const _tmpStartStr = toDateStr(_tmpStart);
      const _tmpEndStr = toDateStr(_rnrAddDays(_tmpStart, 6));
      if (selectedDateStr < _tmpStartStr || selectedDateStr > _tmpEndStr) {
        __mobileStripStartDateStr = selectedDateStr;
      }

      const start = _rnrDateFromStr(__mobileStripStartDateStr);
      const startStr = toDateStr(start);
      const endStr = toDateStr(_rnrAddDays(start, 6));
      range.textContent = `${formatDatePretty(startStr)} – ${formatDatePretty(endStr)}`;

      const todayStr = toDateStr(new Date());
      strip.innerHTML = '';

      for (let i = 0; i < 7; i++) {
        const d = _rnrAddDays(start, i);
        const ds = toDateStr(d);

        const slots = (availabilityByDate && availabilityByDate[ds]) ? availabilityByDate[ds] : getSlotsForDateKey(ds);
        const hasAnyAvailable = Array.isArray(slots) && slots.some(function(s) { return isSlotAvailable(s) && slotPassesUiWindow(dateStr, s); });
        const isPast = ds < todayStr;
        const selectable = (!isPast) && hasAnyAvailable && !!selectedServiceKey && !!selectedStandardDuration;
        const isSelected = selectedDateStr === ds;

        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'calendar-day px-0 py-2 text-xs rounded-lg border';

        // Compact label: day letter + number
        const weekday = d.toLocaleDateString('en-CA', { weekday: 'short' }).slice(0,1);
        const dayNum = d.getDate();
        btn.innerHTML = `
          <div class="flex flex-col items-center leading-none">
            <div class="text-[10px] uppercase tracking-[0.15em] text-brand-dim">${weekday}</div>
            <div class="font-bold text-sm text-brand-light">${dayNum}</div>
          </div>
        `;

        if (!selectable) {
          btn.disabled = true;
          btn.classList.add('border-white/5', 'bg-white/5', 'text-white/30', 'opacity-40', 'cursor-not-allowed');
        } else {
          btn.classList.add('border-brand-gold/30', 'bg-black/40', 'hover:bg-brand-gold/15', 'hover:border-brand-gold');
          btn.addEventListener('click', function() {
            // If the mobile overlay is already open, update state without re-opening/re-moving DOM.
            if (typeof isMobileTimesOverlayOpen === 'function' && isMobileTimesOverlayOpen()) {
              setSelectedDateInOverlay(ds);
            } else {
              selectDate(ds);
            }
            try { setMobileOverlayStep('step2'); } catch(e) {}
            try { renderMobileDateStrip(); } catch(e) {}
          });
        }

        if (isSelected) {
          btn.classList.add('calendar-day-selected');
        }

        strip.appendChild(btn);
      }

      try { if (typeof lucide !== 'undefined') lucide.createIcons(); } catch (e) {}
    }

    function isMobileTimesOverlayOpen() {
      const overlay = document.getElementById('mobile-times-overlay');
      return !!(overlay && !overlay.classList.contains('hidden'));
    }

    // Update selected date + time list while keeping the mobile overlay open.
    function setSelectedDateInOverlay(dateStr) {
      const norm = (typeof normalizeDateKey === 'function' ? (normalizeDateKey(dateStr) || dateStr) : dateStr);
      selectedDateStr = norm;
      selectedSlot = null;

      try { setConfirmEnabled(false); } catch (e) {}
      try { document.querySelectorAll('.time-slot-btn').forEach(b => b.classList.remove('time-slot-selected')); } catch(e) {}

      try {
        const info = document.getElementById('selected-date-info');
        if (info) info.classList.remove('hidden');
        const disp = document.getElementById('selected-date-display');
        if (disp) disp.textContent = formatDatePretty(norm);
      } catch (e) {}

      try { loadTimeSlots(norm); } catch (e) {}
      try { updateSummary(); } catch (e) {}
      try { updateBookingStepper(); } catch (e) {}
      try { savePortalState(); } catch (e) {}
      try { renderCalendar(); } catch (e) {}
      try { syncMobileConfirmButton(); } catch (e) {}
      try { setMobileOverlayStep('step2'); } catch (e) {}
    }

    // Shift the 7-day strip by a full week and automatically select the first available day
    // in the newly visible window (this prevents the UI from snapping back to the prior week).
    
    // Weekly navigation helper: show a small spinner + disable arrows while month availability is re-fetching.
    let __mobileWeekNavBusy = false;

    function setMobileWeekLoading(isLoading) {
      try {
        const sp = document.getElementById('mobile-week-loading');
        const prev = document.getElementById('mobile-week-prev');
        const next = document.getElementById('mobile-week-next');
        if (sp) sp.classList.toggle('hidden', !isLoading);
        [prev, next].forEach(function(b){
          if (!b) return;
          b.disabled = !!isLoading;
          b.classList.toggle('opacity-50', !!isLoading);
          b.classList.toggle('cursor-not-allowed', !!isLoading);
        });
      } catch (e) {}
    }

    // Shift the 7-day strip by +/- 7 days.
    // If the window crosses into a new month, pre-load that month ONCE (instead of re-loading per-day),
    // then auto-select the first available day in the new window.
    function shiftMobileDateStrip(deltaDays) {
      (async function() {
        if (!isMobileUI()) return;
        if (!selectedDateStr) return;
        if (!__mobileStripStartDateStr) __mobileStripStartDateStr = selectedDateStr;
        if (__mobileWeekNavBusy) return;

        __mobileWeekNavBusy = true;
        setMobileWeekLoading(true);

        const start = _rnrDateFromStr(__mobileStripStartDateStr);
        const newStart = _rnrAddDays(start, Number(deltaDays || 0));
        const newStartStr = toDateStr(newStart);

        // Preload any month(s) covered by this 7-day window (max 2 months)
        const monthSamples = {};
        for (let i = 0; i < 7; i++) {
          const ds = toDateStr(_rnrAddDays(newStart, i));
          const mk = String(ds).slice(0, 7); // YYYY-MM
          if (!monthSamples[mk]) monthSamples[mk] = ds;
        }
        const months = Object.keys(monthSamples);
        for (const mk of months) {
          await ensureAvailabilityMonthForDate(monthSamples[mk]);
        }

        __mobileStripStartDateStr = newStartStr;

        // Choose first selectable day in this 7-day window; if none, keep newStart
        const todayStr = toDateStr(new Date());
        let chosen = null;
        for (let i = 0; i < 7; i++) {
          const ds = toDateStr(_rnrAddDays(newStart, i));
          const slots = (availabilityByDate && availabilityByDate[ds]) ? availabilityByDate[ds] : getSlotsForDateKey(ds);
          const hasAnyAvailable = Array.isArray(slots) && slots.some(function(s) { return isSlotAvailable(s) && slotPassesUiWindow(ds, s); });
          const isPast = ds < todayStr;
          const selectable = (!isPast) && hasAnyAvailable && !!selectedServiceKey && !!selectedStandardDuration;
          if (selectable) { chosen = ds; break; }
        }
        if (!chosen) chosen = newStartStr;

        setSelectedDateInOverlay(chosen);
        renderMobileDateStrip();
      })().catch(function(e){
        console.warn('shiftMobileDateStrip error:', e);
      }).finally(function(){
        __mobileWeekNavBusy = false;
        setMobileWeekLoading(false);
      });
    }


    window.renderMobileDateStrip = renderMobileDateStrip;
    window.shiftMobileDateStrip = shiftMobileDateStrip;
    window.isMobileTimesOverlayOpen = isMobileTimesOverlayOpen;
    window.setSelectedDateInOverlay = setSelectedDateInOverlay;

    // If the user rotates or resizes to desktop, restore the time blocks back under the calendar.
    function restoreMobileTimeBlocksToPageForDesktop() {
      try {
        if (!__mobileTimesMoved) return;
        if (isMobileUI()) return;

        const content = document.getElementById('mobile-times-content');
        const anchor = document.getElementById('mobile-times-anchor');
        if (!content || !anchor) return;

        const ids = ['selected-date-info', 'time-slots-container', 'no-slots'];
        let ref = anchor;
        ids.forEach((id) => {
          const el = document.getElementById(id);
          if (el) {
            ref.insertAdjacentElement('afterend', el);
            ref = el;
          }
        });
        __mobileTimesMoved = false;
      } catch (e) {}
    }

    window.addEventListener('resize', function() {
      try { restoreMobileTimeBlocksToPageForDesktop(); } catch (e) {}
    }, { passive: true });



    // Ensure month-wide availability is loaded for the month containing dateStr.
    async function ensureAvailabilityMonthForDate(dateStr) {
      try {
        if (!dateStr || !selectedServiceKey || !selectedStandardDuration) return;
        const key = (typeof normalizeDateKey === 'function' ? (normalizeDateKey(dateStr) || dateStr) : dateStr);
        const y = Number(String(key).slice(0,4));
        const m = Number(String(key).slice(5,7));
        if (!y || !m) return;
        const desired = new Date(y, m - 1, 1);
        if (!calendarCurrent || calendarCurrent.getFullYear() !== desired.getFullYear() || calendarCurrent.getMonth() !== desired.getMonth()) {
          calendarCurrent = desired;
          // Update calendar header immediately while we fetch
          try { renderCalendar(); } catch(e) {}
          // Fetch month availability (your existing month-wide loader)
          if (typeof maybeLoadAvailabilityForCurrentMonth === 'function') {
            await maybeLoadAvailabilityForCurrentMonth();
          }
        }
      } catch (e) {
        console.warn('ensureAvailabilityMonthForDate error:', e);
      }
    }



    function openMobileTimesOverlay() {
      if (!isMobileUI()) return;
      const overlay = document.getElementById('mobile-times-overlay');
      const content = document.getElementById('mobile-times-content');
      const anchor = document.getElementById('mobile-times-anchor');
      if (!overlay || !content || !anchor) return;

      // Move Step 2 DOM blocks (preserves IDs and existing logic)
      restoreSummaryConfirmPanelToPage();
      const ids = ['selected-date-info', 'time-slots-container', 'no-slots'];
      if (!__mobileTimesMoved) {
        ids.forEach((id) => {
          const el = document.getElementById(id);
          if (el) content.appendChild(el);
        });
        __mobileTimesMoved = true;
      }

      overlay.classList.remove('hidden');
      setMobileOverlayStep('step2');
      lockBodyScroll();
      syncMobileConfirmButton();      try {
        // Ensure the correct month availability is loaded before rendering the strip (matches calendar behavior)
        (async function(){
          try { if (selectedDateStr) await ensureAvailabilityMonthForDate(selectedDateStr); } catch(e) {}
          try {
            if (selectedDateStr) {
              if (!__mobileStripStartDateStr) __mobileStripStartDateStr = selectedDateStr;
            }
            renderMobileDateStrip();
          } catch(e) {}
        })();
      } catch (e) {}try { if (typeof lucide !== 'undefined') lucide.createIcons(); } catch (e) {}
    }

    function closeMobileTimesOverlay() {
      const overlay = document.getElementById('mobile-times-overlay');
      if (!overlay) return;

      overlay.classList.add('hidden');
      __mobileOverlayStep = 'step2';
      unlockBodyScroll();
    }


    function syncMobileConfirmButton() {
      const mainBtn = document.getElementById('confirm-booking-btn');
      const mobileBtn = document.getElementById('mobile-confirm-btn');
      if (!mainBtn || !mobileBtn) return;
      const enabled = !mainBtn.disabled;
      mobileBtn.disabled = !enabled;
      mobileBtn.classList.toggle('btn-disabled', !enabled);
    }

    

    let __mobileOverlayStep = 'step2';

    function setMobileOverlayStep(step) {
      __mobileOverlayStep = step || 'step2';
      const stripNav = document.getElementById('mobile-strip-nav');
      const strip = document.getElementById('mobile-date-strip');
      const times = document.getElementById('time-slots-container');
      const noSlots = document.getElementById('no-slots');
      const panel = document.getElementById('summary-confirm-panel');
      const title = document.getElementById('mobile-times-title');
      const subtitle = document.getElementById('mobile-times-subtitle');
      const contBtn = document.getElementById('mobile-confirm-btn');
      const backBtn = document.getElementById('mobile-back-btn');

      if (__mobileOverlayStep === 'step3') {
        if (stripNav) stripNav.classList.add('hidden');
        if (strip) strip.classList.add('hidden');
        if (times) times.classList.add('hidden');
        if (noSlots) noSlots.classList.add('hidden');
        if (panel) panel.classList.remove('hidden');
        if (title) title.textContent = 'Confirm';
        if (subtitle) subtitle.textContent = 'Review your details, then confirm your booking.';
        if (contBtn) contBtn.classList.add('hidden');
        if (backBtn) backBtn.textContent = 'Back to Times';
      } else {
        // Step 2
        if (stripNav) stripNav.classList.remove('hidden');
        if (strip) strip.classList.remove('hidden');
        if (panel) panel.classList.add('hidden');
        if (title) title.textContent = 'Select a Time';
        if (subtitle) subtitle.textContent = 'Pick a day and time. Unavailable days are disabled.';
        if (contBtn) contBtn.classList.remove('hidden');
        if (backBtn) backBtn.textContent = 'Back';
        // Do not force-show times/no-slots here; existing logic controls visibility.
      }
    }

    function mobileBackInOverlay() {
      if (!isMobileUI()) { closeMobileTimesOverlay(); return; }
      if (__mobileOverlayStep === 'step3') {
        setMobileOverlayStep('step2');
        return;
      }
      closeMobileTimesOverlay();
    }

    window.mobileBackInOverlay = mobileBackInOverlay;

function restoreSummaryConfirmPanelToPage() {
      try {
        const panel = document.getElementById('summary-confirm-panel');
        const anchor = document.getElementById('summary-confirm-anchor');
        if (panel && anchor && !anchor.contains(panel)) {
          anchor.insertAdjacentElement('afterend', panel);
        }
      } catch (e) {}
    }

    function openMobileConfirmOverlay() {
      if (!isMobileUI()) return;
      const timesOverlay = document.getElementById('mobile-times-overlay');
      const confirmOverlay = document.getElementById('mobile-confirm-overlay');
      const content = document.getElementById('mobile-confirm-content');
      if (!confirmOverlay || !content) return;

      // Move the confirm panel into the confirm modal
      const panel = document.getElementById('summary-confirm-panel');
      if (panel) content.appendChild(panel);

      // Hide Step 2 overlay (keep scroll lock active)
      if (timesOverlay) timesOverlay.classList.add('hidden');

      confirmOverlay.classList.remove('hidden');
      lockBodyScroll(); // bump lock count so background stays locked while confirm is open
      try { if (typeof lucide !== 'undefined') lucide.createIcons(); } catch (e) {}
    }

    function closeMobileConfirmOverlay(backToTimes) {
      const confirmOverlay = document.getElementById('mobile-confirm-overlay');
      const timesOverlay = document.getElementById('mobile-times-overlay');
      if (!confirmOverlay) return;

      confirmOverlay.classList.add('hidden');
      unlockBodyScroll(); // release one layer of lock

      // Always restore the confirm panel to the page anchor (it stays hidden on mobile)
      restoreSummaryConfirmPanelToPage();

      if (backToTimes) {
        if (timesOverlay) timesOverlay.classList.remove('hidden');
        // Ensure Step 2 view is in a sane state
        try { setMobileOverlayStep('step2'); } catch(e) {}
        try { renderMobileDateStrip(); } catch(e) {}
        try { syncMobileConfirmButton(); } catch(e) {}
        try { if (typeof lucide !== 'undefined') lucide.createIcons(); } catch (e) {}
      } else {
        // Full close: also close the times overlay (which will unlock the remaining lock)
        try { closeMobileTimesOverlay(); } catch (e) {}
      }
    }

    function mobileFinalConfirm() {
      const btn = document.getElementById('confirm-booking-btn');
      if (btn && !btn.disabled) {
        btn.click();
      } else {
        showToast('Select a time', 'Please select a time first.', true, 4500);
      }
    }

function mobileConfirmBooking() {
      // Step 2 -> Confirm overlay
      const btn = document.getElementById('confirm-booking-btn');
      if (btn && !btn.disabled) {
        openMobileConfirmOverlay();
      } else {
        showToast('Select a time', 'Please select a time first.', true, 4500);
      }
    }

    // Expose for inline onclick handlers

    window.isMobileUI = isMobileUI;
    window.openMobileTimesOverlay = openMobileTimesOverlay;
    window.closeMobileTimesOverlay = closeMobileTimesOverlay;
    window.mobileConfirmBooking = mobileConfirmBooking;
    window.openMobileConfirmOverlay = openMobileConfirmOverlay;
    window.closeMobileConfirmOverlay = closeMobileConfirmOverlay;
    window.mobileFinalConfirm = mobileFinalConfirm;
    window.setMobileOverlayStep = setMobileOverlayStep;


    const DEFAULT_PRACTITIONER_ID  = "1834304626376050851";
    const STATIC_SETUP_MINUTES = 25;
    const TRAVEL_FEE_THRESHOLD_MINUTES = 36; // Fee applies when drive time meets or exceeds this
    
    // Travel fee tiers based on drive time
    const TRAVEL_FEE_TIERS = [
      { minMinutes: 120, fee: 200 },
      { minMinutes: 60, fee: 100 },
      { minMinutes: 45, fee: 40 },
      { minMinutes: 36, fee: 20 },
    ];

    // Auth0 Config
    const AUTH0_DOMAIN = "auth.relaxandrenew.ca";
    const AUTH0_CLIENT_ID = "T8FERqkpcryRN77voMnLeaXIkha1eqK1";
    const AUTH0_DB_CONNECTION = "Username-Password-Authentication";

    // Custom claim keys
    const CLAIM_PROFILE_OBJ  = "https://relaxandrenew.ca/profile";
    const CLAIM_ADDRESS      = "https://relaxandrenew.ca/address";
    const CLAIM_CITY         = "https://relaxandrenew.ca/city";
    const CLAIM_POSTAL       = "https://relaxandrenew.ca/postal_code";
    const CLAIM_PHONE        = "https://relaxandrenew.ca/phone";

        const CLAIM_CLINIKO_PATIENT_ID = "https://relaxandrenew.ca/cliniko_patient_id";
// Google Review Prompt
    const GOOGLE_REVIEW_URL = 'https://g.page/r/CVMjbVYTDMv3EAE/review';
    const LS_REVIEW_DISABLED = 'rnr_review_prompt_disabled';
    const LS_REVIEW_PROMPTED = 'rnr_review_prompted_keys';

  </script>
  <!-- PWA -->
  <link rel="manifest" href="/manifest.json" />
  <meta name="theme-color" content="#E0C584" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="apple-touch-icon" href="/icons/icon-192x192.png" />

  <style>
    /* Offline banner */
    .offline-banner {
      position: fixed;
      top: 12px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 9999;
      background: rgba(0,0,0,0.75);
      border: 1px solid rgba(224,197,132,0.25);
      color: #E0C584;
      padding: 10px 14px;
      border-radius: 999px;
      display: none;
      align-items: center;
      gap: 10px;
      backdrop-filter: blur(10px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
      font-size: 0.85rem;
    }
    .offline-banner.show { display: inline-flex; }

    /* Stepper */
    .stepper-item { display: flex; align-items: center; gap: 10px; opacity: 0.65; }
    .stepper-item.active { opacity: 1; }
    .stepper-circle {
      width: 30px; height: 30px;
      border-radius: 999px;
      border: 1px solid rgba(224,197,132,0.35);
      display: flex; align-items: center; justify-content: center;
      color: #E0C584;
      background: rgba(224,197,132,0.06);
      font-weight: 700;
    }
    .stepper-item.active .stepper-circle { background: rgba(224,197,132,0.12); }
    .stepper-label { font-size: 0.85rem; color: rgba(224,197,132,0.9); }
    .stepper-line { flex: 1; height: 1px; background: rgba(224,197,132,0.18); min-width: 24px; }

    /* Skeleton */
    .skeleton { position: relative; overflow: hidden; background: rgba(255,255,255,0.06); border-radius: 10px; }
    .skeleton::after {
      content: "";
      position: absolute; top: 0; left: -150px; height: 100%; width: 150px;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.10), transparent);
      animation: shimmer 1.2s infinite;
    }
    @keyframes shimmer { 0% { left: -150px; } 100% { left: 100%; } }
    .skeleton-avatar { width: 44px; height: 44px; border-radius: 999px; }
    .skeleton-text { height: 10px; border-radius: 999px; margin-top: 10px; }
    .skeleton-text-lg { height: 14px; border-radius: 999px; }

    /* Modals */
    .modal-overlay {
      position: fixed; inset: 0; z-index: 9998;
      background: rgba(0,0,0,0.75);
      display: flex; align-items: center; justify-content: center;
      padding: 18px;
      backdrop-filter: blur(12px);
    }
    .modal-overlay.hidden { display: none; }
    .modal-card {
      width: min(560px, 94vw);
      background: rgba(0,0,0,0.72);
      border: 1px solid rgba(224,197,132,0.22);
      border-radius: 18px;
      padding: 18px;
      box-shadow: 0 20px 50px rgba(0,0,0,0.5);
    }
    .btn-danger {
      background: rgba(248,113,113,0.15);
      border: 1px solid rgba(248,113,113,0.35);
      color: #fca5a5;
      padding: 10px 14px;
      border-radius: 12px;
      font-weight: 700;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: 0.2s;
    }
    .btn-danger:hover { background: rgba(248,113,113,0.22); transform: translateY(-1px); }

    /* Therapist card */
    .therapist-card {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      border-radius: 14px;
      border: 1px solid rgba(224,197,132,0.18);
      background: rgba(224,197,132,0.06);
    }
    .therapist-avatar {
      width: 44px; height: 44px;
      border-radius: 999px;
      object-fit: cover;
      border: 1px solid rgba(224,197,132,0.25);
    }
    .therapist-name { font-weight: 800; color: #E0C584; }
    .therapist-title { font-size: 0.85rem; color: rgba(224,197,132,0.75); }

    /* Light mode */
    html.light-mode body {
      background-color: #f3f4f6 !important; /* soft gray (not stark white) */
      color: #111827 !important;
    }

    /* Make panels/cards feel "light" without going pure white */
    html.light-mode .glass-panel,
    html.light-mode .card-fancy {
      background: rgba(229,231,235,0.92) !important; /* gray-200 */
      color: #111827 !important;
      border-color: rgba(17,24,39,0.12) !important;
    }

    /* Modal cards were too bright in light mode */
    html.light-mode .booking-modal-card,
    html.light-mode .modal-card {
      background: rgba(229,231,235,0.96) !important;
      color: #111827 !important;
      border-color: rgba(17,24,39,0.16) !important;
      box-shadow: 0 18px 50px rgba(0,0,0,0.20) !important;
    }

    /* Keep the overlay/backdrop tasteful (not harsh) */
    html.light-mode #booking-modal-overlay { background: rgba(0,0,0,0.55) !important; }
    html.light-mode .modal-overlay { background: rgba(0,0,0,0.45) !important; }
    html.light-mode .mobile-menu-backdrop { background: rgba(0,0,0,0.35) !important; }

    /* Navigation + mobile menu readability */
    html.light-mode .fixed-nav {
      background: rgba(243,244,246,0.92) !important;
      border-bottom-color: rgba(17,24,39,0.10) !important;
    }
    html.light-mode .nav-link { color: #111827 !important; }
    html.light-mode .nav-link::after { background: rgba(17,24,39,0.65) !important; }

    /* Light mode: sidebar/menu typography should be dark */
    html.light-mode .sidebar-btn { color: rgba(17,24,39,0.78) !important; }
    html.light-mode .sidebar-btn:hover { background: rgba(17,24,39,0.06) !important; color: #111827 !important; }
    html.light-mode .sidebar-btn.active { background: rgba(17,24,39,0.10) !important; border-color: rgba(17,24,39,0.28) !important; color: #111827 !important; }
    html.light-mode .sidebar-btn i,
    html.light-mode .sidebar-btn svg { color: #111827 !important; stroke: #111827 !important; }

    /* Light mode: reverse button styling (black fill + gold text) */
    html.light-mode .btn-filled { background: #111111 !important; border-color: #111111 !important; color: #E0C584 !important; }
    html.light-mode .btn-filled:hover { background: #000000 !important; border-color: #000000 !important; box-shadow: 0 6px 18px rgba(0,0,0,0.22) !important; }
    html.light-mode .btn-outline { border-color: rgba(0,0,0,0.55) !important; color: #111111 !important; }
    html.light-mode .btn-outline:hover { background: rgba(0,0,0,0.06) !important; color: #111111 !important; border-color: rgba(0,0,0,0.75) !important; box-shadow: none !important; }

    html.light-mode .mobile-menu {
      background: rgba(243,244,246,0.98) !important;
      border-left-color: rgba(17,24,39,0.14) !important;
    }

    /* In mobile menu, the "PORTAL" label and close/menu button text should not remain gold */
    html.light-mode #mobile-menu-btn,
    html.light-mode #mobile-menu-close,
    html.light-mode #mobile-menu .text-brand-gold {
      color: #111827 !important;
    }

    html.light-mode .divider { border-color: rgba(17,24,39,0.14) !important; }
    html.light-mode .muted { color: rgba(17,24,39,0.70) !important; }
    html.light-mode .pill { color: #111827 !important; border-color: rgba(17,24,39,0.18) !important; background: rgba(17,24,39,0.04) !important; }

    /* Keep subtle "top bar" highlight animation visible in light mode */
    html.light-mode .card-fancy::before,
    html.light-mode .glass-panel::before { background: linear-gradient(90deg, transparent, rgba(17,24,39,0.65), transparent) !important; }

    /* Skeleton shimmer needs contrast in light mode */
    html.light-mode .skeleton { background: rgba(17,24,39,0.08) !important; }
    html.light-mode .skeleton::after {
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.75), transparent) !important;
      opacity: 1 !important;
    }

    /* Therapist card colors in light mode */
    html.light-mode .therapist-card { background: rgba(17,24,39,0.04) !important; border-color: rgba(17,24,39,0.12) !important; }
    html.light-mode .therapist-name { color: #111827 !important; }
    html.light-mode .therapist-title { color: rgba(17,24,39,0.70) !important; }

    /* Buttons should feel animated/interactive in light mode too */
    html.light-mode .btn-outline {
      border-color: rgba(17,24,39,0.35) !important;
      color: #111827 !important;
    }
    html.light-mode .btn-outline:hover {
      background: rgba(17,24,39,0.06) !important;
      color: #111827 !important;
      border-color: rgba(17,24,39,0.45) !important;
      box-shadow: 0 10px 22px rgba(0,0,0,0.14) !important;
      transform: translateY(-1px);
    }

    /* Review prompt QR: prevent huge SVG from forcing modal size */
    #review-prompt-qr svg { width: 100% !important; height: auto !important; max-width: 240px; display: block; }

  </style>

</head>

<body class="bg-hero-pattern bg-cover bg-center bg-fixed bg-no-repeat bg-gray-900 text-brand-light">
  
  
  <div id="offline-banner" class="offline-banner">
    <i data-lucide="wifi-off" class="w-4 h-4"></i>
    You're offline — some features may be unavailable
  </div>
<!-- =========================================================
       LOGIN OVERLAY (shows on top of portal until authenticated)
       ========================================================= -->
<div id="auth-check-overlay">
    <div class="login-card">
      <div class="text-center">
        <div class="mx-auto flex items-center justify-center">
          <img src="https://static.wixstatic.com/media/bf8fef_511df25fad074d79a408119293545f75~mv2.png"
               alt="Relax & Renew"
               class="w-16 h-16 object-contain opacity-95" />
        </div>
        <h2 class="text-3xl text-brand-gold mt-5 font-bold">Checking Session…</h2>
        <p class="text-brand-dim text-sm mt-2">Please wait a moment.</p>
      </div>
      <div class="mt-6">
        <div class="w-full h-1 bg-white/10 overflow-hidden rounded">
          <div class="h-full w-1/3 bg-brand-gold animate-loading-bar rounded"></div>
        </div>
      </div>
    </div>
  </div>

  <div id="login-overlay" class="hidden">
    <div class="login-card">
      <div class="text-center">
        <div class="mx-auto flex items-center justify-center">
          <img src="https://static.wixstatic.com/media/bf8fef_511df25fad074d79a408119293545f75~mv2.png"
               alt="Relax & Renew"
               class="w-16 h-16 object-contain opacity-95" />
        </div>
        <h2 class="text-3xl text-brand-gold mt-5 font-bold">Welcome</h2>
        <p class="text-brand-dim text-sm mt-2">
          Sign in to your client portal to continue.
        </p>
      </div>

      <div class="mt-6">
        <div id="auth0-lock-container"></div>
            <label class="mt-4 flex items-center gap-3 text-sm select-none">
              <input id="remember-email" type="checkbox" class="h-4 w-4 accent-[rgba(224,197,132,0.9)]" checked />
              <span class="text-brand-dim">Remember my email on this device</span>
            </label>
      </div>

      <p class="text-[11px] text-brand-dim leading-snug mt-4 text-center opacity-80">
        By logging in, you agree to our
        <a href="/privacy-policy" class="underline text-brand-gold hover:text-brand-light">Privacy Policy</a>
        and
        <a href="/terms" class="underline text-brand-gold hover:text-brand-light">Terms</a>.
      </p>

      <div id="auth0-error" class="hidden mt-4 text-sm border border-red-500/30 bg-red-500/10 p-3 text-red-300"></div>

      <p class="text-xs text-brand-dim mt-6 text-center opacity-70">
        Note: This portal is for returning clients only. New to Relax &amp; Renew?
        <a href="/" class="text-brand-gold underline hover:text-brand-light">Book your first session here</a>.
      </p>
    </div>
  </div>

  <!-- NAV -->
  <nav id="navbar" class="fixed-nav h-20 flex items-center">
    <div class="container mx-auto px-6 flex justify-between items-center h-full">
      <a href="/" class="flex items-center gap-3 no-underline group">
        <img src="https://static.wixstatic.com/media/bf8fef_511df25fad074d79a408119293545f75~mv2.png" alt="Relax & Renew Logo" class="h-10 w-auto transition-transform group-hover:scale-105">
        <div class="hidden md:flex flex-col">
          <span class="text-brand-gold font-bold tracking-[0.2em] text-sm leading-none">RELAX & RENEW</span>
          <span class="text-brand-light text-[0.65rem] tracking-[0.4em] uppercase opacity-70 leading-tight mt-1">Mobile RMT</span>
        </div>
      </a>

      <!-- Desktop Menu -->
      <div class="hidden lg:flex items-center space-x-8 whitespace-nowrap">
        <a href="index.html#services" class="nav-link">Services</a>
        <a href="index.html#pricing" class="nav-link">Pricing</a>
        <a href="index.html#giftcards" class="nav-link">Gift Cards</a>
        <a href="index.html#area" class="nav-link">Service Area</a>
        <a href="index.html#faq" class="nav-link">FAQ</a>
        <a href="therapists.html" class="nav-link">Our Therapists</a>
        <a href="membership.html" class="nav-link">Membership</a>
        <span class="nav-link text-brand-gold font-bold border-b border-brand-gold">
          <i data-lucide="user-check" class="w-4 h-4 inline mr-1"></i>
          Client Portal
        </span>
      </div>

      <!-- Mobile Menu Button -->
      <button id="mobile-menu-btn" class="lg:hidden text-brand-gold p-2 hover:text-brand-light transition-colors">
        <i data-lucide="menu" class="w-8 h-8"></i>
      </button>
    </div>
  </nav>

  <!-- Mobile Menu Backdrop -->
  <div id="mobile-menu-backdrop" class="mobile-menu-backdrop fixed inset-0 bg-black/70 opacity-0 pointer-events-none transition-opacity z-40 lg:hidden"></div>

  <!-- Mobile Menu Overlay -->
  <div id="mobile-menu" class="mobile-menu fixed top-0 right-0 h-[100dvh] w-[88vw] max-w-[380px] bg-black border-l border-brand-gold/30 z-50 lg:hidden overflow-y-auto">
    <div class="p-6">
      <div class="flex justify-between items-center mb-8">
        <span class="text-brand-gold font-bold tracking-[0.2em] text-sm">PORTAL</span>
        <button id="mobile-menu-close" class="text-brand-gold p-2 hover:rotate-90 transition-transform" aria-label="Close menu">
          <i data-lucide="x" class="w-8 h-8"></i>
        </button>
      </div>

      <div class="flex flex-col space-y-4">
        <button class="mobile-portal-btn text-left nav-link text-lg flex items-center gap-3" data-tab="dashboard">
          <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
          Dashboard
        </button>

        <button class="mobile-portal-btn text-left nav-link text-lg flex items-center gap-3" data-tab="rebook">
          <i data-lucide="calendar-days" class="w-5 h-5"></i>
          Book / Rebook
        </button>

        <button class="mobile-portal-btn text-left nav-link text-lg flex items-center gap-3" data-tab="history">
          <i data-lucide="history" class="w-5 h-5"></i>
          Appointment History
        </button>

        <button class="mobile-portal-btn text-left nav-link text-lg flex items-center gap-3" data-tab="membership">
          <i data-lucide="badge-percent" class="w-5 h-5"></i>
          Membership
        </button>

        <button class="text-left nav-link text-lg flex items-center gap-3 opacity-60 cursor-not-allowed" disabled>
          <i data-lucide="user" class="w-5 h-5"></i>
          Profile (Coming Soon)
        </button>

        <hr class="divider mt-2">

        <button id="install-app-btn" class="text-left nav-link text-lg flex items-center gap-3">
          <i data-lucide="download" class="w-5 h-5"></i>
          Download App
        </button>

        <button id="install-app-ios-btn" class="hidden text-left nav-link text-lg flex items-center gap-3">
          <i data-lucide="square-plus" class="w-5 h-5"></i>
          Add to Home Screen
        </button>

        <a href="/" class="nav-link text-lg flex items-center gap-3">
          <i data-lucide="arrow-left" class="w-5 h-5"></i>
          Return to Website
        </a>

        <button id="logout-btn-mobile" class="text-left nav-link text-lg text-red-300 hover:text-red-200 flex items-center gap-3">
          <i data-lucide="log-out" class="w-5 h-5"></i>
          Sign Out
        </button>
        <div class="mt-3 text-xs opacity-60">Build: 2026-01-12-v4</div>
      </div>
    </div>
  </div>

  <!-- Spacer -->
  <div id="navbar-spacer" aria-hidden="true" class="h-20"></div>

  <!-- HEADER HERO -->
  <header class="header-hero pt-12 pb-10 border-b border-brand-gold/20">
    <div class="container mx-auto px-6 max-w-6xl">
      <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-6">
        <div class="animate-fade-in-up">
          <div class="text-[0.75rem] tracking-[0.45em] uppercase text-brand-dim">Relax & Renew RMT</div>
          <h1 class="text-4xl md:text-5xl font-serif text-brand-gold mt-2">Client Portal</h1>
          <p class="text-brand-dim mt-3 text-lg font-light">Rebook quickly using your saved profile.</p>
        </div>
        <div class="flex items-center gap-3 animate-fade-in-up" style="animation-delay:0.1s">
          <div class="pill">
            <i data-lucide="user" class="w-4 h-4 text-brand-gold"></i>
            <span id="welcome-pill">Loading profile…</span>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- MAIN -->
  <main class="min-h-screen">
    <div class="container mx-auto max-w-7xl px-4 md:px-6 py-14 mt-6">
      <div class="grid grid-cols-1 lg:grid-cols-[260px_1fr] gap-8">
        <!-- SIDEBAR -->
        <aside class="hidden lg:block">
          <div class="glass-panel p-5 sticky top-[110px]">
            <div class="flex items-center gap-3 mb-6 pb-6 border-b border-brand-gold/10">
              <div class="w-11 h-11 border border-brand-gold/20 bg-brand-gold/5 flex items-center justify-center text-brand-gold rounded">
                <i data-lucide="user" class="w-5 h-5"></i>
              </div>
              <div class="flex-1 min-w-0">
                <div class="text-[0.65rem] text-brand-dim uppercase tracking-widest">Welcome back</div>
                <div class="text-brand-light font-serif text-sm leading-tight truncate" id="nav-user-name">—</div>
                <button type="button" onclick="openProfileView()" class="mt-1 text-[0.7rem] text-brand-gold/80 hover:text-brand-gold underline underline-offset-4 decoration-brand-gold/30 hover:decoration-brand-gold/70 transition">View Profile</button>
              </div>
            </div>

            <div class="space-y-2">
              <button class="sidebar-btn active" data-tab="dashboard">
                <i data-lucide="layout-dashboard" class="w-5 h-5 text-brand-gold"></i>
                <span>Dashboard</span>
                <span id="appt-count-badge" class="ml-auto text-[10px] bg-brand-gold/20 text-brand-gold px-1.5 py-0.5 rounded hidden">0</span>
              </button>
              <button class="sidebar-btn" data-tab="rebook">
                <i data-lucide="calendar-plus" class="w-5 h-5 text-brand-gold"></i>
                <span>Rebook</span>
              </button>
              <button class="sidebar-btn" data-tab="history">
                <i data-lucide="history" class="w-5 h-5 text-brand-gold"></i>
                <span>History</span>
              </button>
              <button class="sidebar-btn" data-tab="membership" disabled>
                <i data-lucide="badge-percent" class="w-5 h-5 text-brand-dim"></i>
                <span>Membership</span>
                <span class="ml-auto pill text-[10px] px-1.5 py-0.5">Soon</span>
              </button>
              
              <button id="theme-toggle-btn" class="sidebar-btn text-left nav-link text-lg flex items-center gap-3" onclick="toggleTheme()">
                <i id="theme-icon" data-lucide="sun" class="w-5 h-5 text-brand-gold"></i>
                <span id="theme-label">Light Mode</span>
              </button>
<hr class="divider my-3">
              <button id="logout-btn" class="sidebar-btn text-red-400 hover:text-red-200 hover:bg-red-900/10 hover:border-red-900/30">
                <i data-lucide="log-out" class="w-5 h-5"></i>
                <span>Sign Out</span>
              </button>
            </div>
          </div>
        </aside>

        <!-- CONTENT -->
        <section>
          <!-- DASHBOARD TAB -->
          <div id="tab-dashboard" class="tab-content animate-fade-in-up">
            <!-- Welcome Header -->
            <div class="glass-panel p-6 mb-6">
              <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                <div>
                  <h2 class="text-3xl font-serif text-brand-light">Welcome Back</h2>
                  <p class="muted mt-2 font-light">Here's an overview of your account.</p>
                </div>
                <button onclick="switchTab('rebook')" class="btn-filled text-sm py-2 px-4">
                  <i data-lucide="calendar-plus" class="w-4 h-4"></i>
                  Book Appointment
                </button>
              </div>
            </div>

            <!-- Dashboard Stats Grid -->
            <!-- Mobile: 2x2 compact tiles; Desktop: 4 across -->
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 sm:gap-4 mb-8">
              <div class="card-fancy p-3 sm:p-5">
                <div class="flex items-center gap-2 sm:gap-3 mb-2 sm:mb-3">
                  <div class="w-9 h-9 sm:w-10 sm:h-10 border border-brand-gold/20 bg-brand-gold/5 flex items-center justify-center text-brand-gold rounded">
                    <i data-lucide="calendar-check" class="w-4 h-4 sm:w-5 sm:h-5"></i>
                  </div>
                  <div class="text-[0.6rem] sm:text-[0.65rem] tracking-[0.2em] uppercase text-brand-gold/60">Upcoming</div>
                </div>
                <div class="text-2xl sm:text-3xl font-serif text-brand-light" id="dash-upcoming-count">0</div>
                <div class="muted text-[0.7rem] sm:text-xs mt-1">Scheduled appointments</div>
              </div>
              <div class="card-fancy p-3 sm:p-5">
                <div class="flex items-center gap-2 sm:gap-3 mb-2 sm:mb-3">
                  <div class="w-9 h-9 sm:w-10 sm:h-10 border border-brand-gold/20 bg-brand-gold/5 flex items-center justify-center text-brand-gold rounded">
                    <i data-lucide="crown" class="w-4 h-4 sm:w-5 sm:h-5"></i>
                  </div>
                  <div class="text-[0.6rem] sm:text-[0.65rem] tracking-[0.2em] uppercase text-brand-gold/60">Membership</div>
                </div>
                <div class="text-base sm:text-lg font-serif text-brand-light" id="dash-membership-status">Standard</div>
                <div class="muted text-[0.7rem] sm:text-xs mt-1">Membership tier</div>
              </div>
              <div class="card-fancy p-3 sm:p-5">
                <div class="flex items-center gap-2 sm:gap-3 mb-2 sm:mb-3">
                  <div class="w-9 h-9 sm:w-10 sm:h-10 border border-brand-gold/20 bg-brand-gold/5 flex items-center justify-center text-brand-gold rounded">
                    <i data-lucide="map-pin" class="w-4 h-4 sm:w-5 sm:h-5"></i>
                  </div>
                  <div class="text-[0.6rem] sm:text-[0.65rem] tracking-[0.2em] uppercase text-brand-gold/60">Location</div>
                </div>
                <div class="text-base sm:text-lg font-serif text-brand-light break-words leading-snug" id="dash-location">—</div>
                <div class="muted text-[0.7rem] sm:text-xs mt-1">Service address</div>
              </div>
            
              <div class="card-fancy p-3 sm:p-5">
                <div class="flex items-center gap-2 sm:gap-3 mb-2 sm:mb-3">
                  <div class="w-9 h-9 sm:w-10 sm:h-10 border border-brand-gold/20 bg-brand-gold/5 flex items-center justify-center text-brand-gold rounded">
                    <i data-lucide="bar-chart-3" class="w-4 h-4 sm:w-5 sm:h-5"></i>
                  </div>
                  <div class="text-[0.6rem] sm:text-[0.65rem] tracking-[0.2em] uppercase text-brand-gold/60">Total Treatments</div>
                </div>
                <div class="text-2xl sm:text-3xl font-serif text-brand-light" id="dash-total-treatments">0</div>
                <div class="muted text-[0.7rem] sm:text-xs mt-1"><span id="dash-total-hours">0 hours</span> of therapy</div>
              </div>
</div>

            

            <!-- Post-session feedback prompt (Dashboard) -->
            

            <!-- Book Same as Last Time -->
            <div id="book-same-container" class="mb-6">
              <button type="button" onclick="bookSameAsLastTime(event)" class="card-fancy p-5 w-full text-left hover:border-brand-gold/40 transition quickrebook-btn pointer-events-none opacity-60">
                <div class="flex items-center gap-4">
                  <div class="w-12 h-12 border border-brand-gold/20 bg-brand-gold/5 flex items-center justify-center text-brand-gold rounded">
                    <i data-lucide="repeat" class="w-6 h-6"></i>
                  </div>
                  <div class="flex-1">
                    <div class="font-serif text-lg text-brand-light flex items-center gap-2">Book Same as Last Time<span class="qr-spinner" aria-hidden="true"></span></div>
                    <div class="muted text-sm" id="last-booking-summary"><span class="skeleton skeleton-text block w-56"></span></div>
                  </div>
                  <i data-lucide="chevron-right" class="w-5 h-5 text-brand-gold"></i>
                </div>
              </button>
            </div>

            <!-- New client helper (only shows when no previous completed appointment) -->
            <div id="book-first-helper" class="hidden mb-6">
              <button type="button" onclick="switchTab('rebook')" class="card-fancy p-5 w-full text-left hover:border-brand-gold/40 transition">
                <div class="flex items-center gap-4">
                  <div class="w-12 h-12 border border-brand-gold/20 bg-brand-gold/5 flex items-center justify-center text-brand-gold rounded">
                    <i data-lucide="sparkles" class="w-6 h-6"></i>
                  </div>
                  <div class="flex-1">
                    <div class="font-serif text-lg text-brand-light">New here?</div>
                    <div class="muted text-sm">Select a treatment and date to book your first appointment.</div>
                  </div>
                  <i data-lucide="chevron-right" class="w-5 h-5 text-brand-gold"></i>
                </div>
              </button>
            </div>

            <!-- Next Appointment Countdown -->
            <div id="next-appt-countdown-card" class="hidden glass-panel p-6 mb-6">
              <div class="flex items-center justify-between mb-2">
                <h3 class="text-xl font-serif text-brand-light flex items-center gap-2">
                  <i data-lucide="timer" class="w-5 h-5 text-brand-gold"></i>
                  Next Appointment
                </h3>
              </div>
              <div class="text-2xl font-serif text-brand-light" id="next-appt-countdown">—</div>
              <div class="muted text-xs mt-2">Countdown to your next session</div>
            </div>
<!-- Upcoming Appointments Section -->
            <div class="glass-panel p-6 mb-6">
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-serif text-brand-light flex items-center gap-2">
                  <i data-lucide="calendar-clock" class="w-5 h-5 text-brand-gold"></i>
                  Upcoming Appointments
                </h3>
                <button onclick="loadUpcomingAppointments()" class="btn-outline text-xs py-1.5 px-3">
                  <i data-lucide="refresh-cw" class="w-3 h-3"></i>
                  Refresh
                </button>
              </div>

              <!-- Appointments Loading State -->
              <div id="appointments-loading" class="py-8 text-center">
                <div id="appointments-skeleton" class="space-y-3">
                  <div class="card-fancy p-4">
                    <div class="flex items-center gap-4">
                      <div class="skeleton skeleton-avatar"></div>
                      <div class="flex-1">
                        <div class="skeleton skeleton-text-lg w-3/4"></div>
                        <div class="skeleton skeleton-text w-1/2"></div>
                      </div>
                    </div>
                  </div>
                  <div class="card-fancy p-4">
                    <div class="flex items-center gap-4">
                      <div class="skeleton skeleton-avatar"></div>
                      <div class="flex-1">
                        <div class="skeleton skeleton-text-lg w-2/3"></div>
                        <div class="skeleton skeleton-text w-1/3"></div>
                      </div>
                    </div>
                  </div>
                </div>
                <p class="text-brand-dim text-sm mt-4">Loading appointments...</p>
</div>

              <!-- Appointments List -->
              <div id="appointments-list" class="space-y-3 hidden"></div>

              <!-- No Appointments State -->
              <div id="appointments-empty" class="hidden py-8 text-center">
                <div class="w-12 h-12 mx-auto mb-4 border border-brand-gold/20 rounded-full flex items-center justify-center">
                  <i data-lucide="calendar-x" class="w-6 h-6 text-brand-gold/50"></i>
                </div>
                <h4 class="text-lg font-serif text-brand-light mb-2">No Upcoming Appointments</h4>
                <p class="muted text-sm mb-4">You don't have any scheduled sessions.</p>
                <button onclick="switchTab('rebook')" class="btn-outline text-sm py-2 px-4">
                  <i data-lucide="calendar-plus" class="w-4 h-4"></i>
                  Book Now
                </button>
              </div>

              <!-- Error State -->
              <div id="appointments-error" class="hidden py-6">
                <div class="card-fancy p-4 border-red-500/30">
                  <div class="flex items-start gap-3">
                    <i data-lucide="alert-circle" class="w-5 h-5 text-red-400 mt-0.5"></i>
                    <div>
                      <div class="font-bold text-brand-light">Unable to load appointments</div>
                      <div class="muted mt-1 text-sm" id="appointments-error-message">Please try again.</div>
                      <button onclick="loadUpcomingAppointments()" class="btn-outline text-xs py-1.5 mt-3">
                        <i data-lucide="refresh-cw" class="w-3 h-3"></i>
                        Try Again
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Quick Actions -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <button onclick="switchTab('rebook')" class="card-fancy p-5 text-left hover:border-brand-gold/40 transition-all group">
                <div class="flex items-center gap-4">
                  <div class="w-12 h-12 border border-brand-gold/20 bg-brand-gold/5 flex items-center justify-center text-brand-gold rounded group-hover:bg-brand-gold/10 transition-all">
                    <i data-lucide="calendar-plus" class="w-6 h-6"></i>
                  </div>
                  <div>
                    <div class="font-serif text-lg text-brand-light">Rebook</div>
                    <div class="muted text-sm">Schedule your next session</div>
                  </div>
                </div>
              </button>
              <button onclick="switchTab('history')" class="card-fancy p-5 text-left hover:border-brand-gold/40 transition-all group">
                <div class="flex items-center gap-4">
                  <div class="w-12 h-12 border border-brand-gold/20 bg-brand-gold/5 flex items-center justify-center text-brand-gold rounded group-hover:bg-brand-gold/10 transition-all">
                    <i data-lucide="history" class="w-6 h-6"></i>
                  </div>
                  <div>
                    <div class="font-serif text-lg text-brand-light">View History</div>
                    <div class="muted text-sm">See past appointments</div>
                  </div>
                </div>
              </button>
            </div>
          </div>

          <!-- REBOOK TAB -->
          <div id="tab-rebook" class="tab-content hidden animate-fade-in-up">
            <!-- Profile summary -->
            <div class="glass-panel p-6 mb-8">
              <div>
                <h2 class="text-3xl font-serif text-brand-light">Book Appointment</h2>
                <p class="muted mt-2 font-light">We use your saved client profile. No typing required.</p>
              </div>

              <div id="profile-missing" class="mt-6 card-fancy p-4 hidden border-red-500/30">
                <div class="flex items-start gap-3">
                  <i data-lucide="alert-triangle" class="w-5 h-5 text-red-400 mt-0.5"></i>
                  <div>
                    <div class="font-bold text-brand-light">Profile data is missing</div>
                    <div class="muted mt-1 text-sm">
                      We could not find a saved address (and/or city/postal code) for your portal account. Because this is a mobile service, we cannot load availability without it.
                      Please contact us to update your profile.
                    </div>
                    <div class="mt-3">
                      <a class="btn-outline text-xs py-2" href="/cdn-cgi/l/email-protection#264f4840496654434a475e4748425443484351084547">
                        <i data-lucide="mail" class="w-4 h-4"></i> Contact Support
                      </a>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <!-- Booking Progress Stepper -->
            <div id="booking-stepper" class="glass-panel p-6 mb-8">
              <div class="flex items-center justify-between gap-3 flex-wrap">
                <div class="stepper-item" id="step-1">
                  <div class="stepper-circle">1</div>
                  <div class="stepper-label">Select Treatment</div>
                </div>
                <div class="stepper-line"></div>
                <div class="stepper-item" id="step-2">
                  <div class="stepper-circle">2</div>
                  <div class="stepper-label">Choose Date</div>
                </div>
                <div class="stepper-line"></div>
                <div class="stepper-item" id="step-3">
                  <div class="stepper-circle">3</div>
                  <div class="stepper-label">Pick Time</div>
                </div>
              </div>
            </div>


            <!-- Booking UI -->
            <div class="grid grid-cols-1 lg:grid-cols-[1fr_360px] gap-8">
              <!-- Calendar + slots -->
              <div class="glass-panel p-6">
                <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-5">
                  <div>
                    <div class="text-[0.65rem] tracking-[0.35em] uppercase text-brand-gold font-bold mb-1">Step 1</div>
                    <h3 class="text-2xl font-serif mt-1">Select Treatment</h3>
                    <p class="muted mt-2 text-sm">Choose a treatment and duration to load availability.</p>
                  </div>
                  <div class="flex flex-col gap-3 w-full md:w-72">
                    <select id="treatment-select" class="input w-full">
                      <option value="">Select treatment…</option>
                      <option value="relaxation">Relaxation Massage</option>
                      <option value="deep-tissue">Deep Tissue Massage</option>
                      <option value="sports">Sports Massage</option>
                      <option value="senior">Senior Massage</option>
                      <option value="hot-stone">Hot Stone Massage</option>
                      <option value="cupping">Cupping Therapy</option>
                      <option value="prenatal">Prenatal Massage</option>
                      <option value="pediatric">Pediatric Massage</option>
                      <option value="infant">Infant Massage</option>
                    </select>

                    <select id="duration-select" class="input w-full" disabled>
                      <option value="">Select a treatment first…</option>
                    </select>
                  </div>
                </div>

                <hr class="divider my-6">

                <!-- Book Same as Last Time (inline) -->
                <div id="rebook-book-same-container" class="mb-6">
                  <button type="button" onclick="bookSameAsLastTime(event)" class="card-fancy p-4 w-full text-left hover:border-brand-gold/40 transition quickrebook-btn pointer-events-none opacity-60">
                    <div class="flex items-center gap-3">
                      <div class="w-10 h-10 border border-brand-gold/20 bg-black/40 rounded-lg flex items-center justify-center">
                        <i data-lucide="rotate-cw" class="w-5 h-5 text-brand-gold"></i>
                      </div>
                      <div class="flex-1">
                        <div class="text-brand-light font-semibold text-base flex items-center gap-2">Book Same as Last Time<span class="qr-spinner" aria-hidden="true"></span></div>
                        <div class="muted text-xs" id="rebook-last-booking-summary">Loading...</div>
                      </div>
                      <i data-lucide="chevron-right" class="w-4 h-4 text-brand-gold opacity-70"></i>
                    </div>
                  </button>
                </div>

                <!-- NEW PROGRESS BAR LOADER -->
                <div id="availability-loading" class="hidden mb-6">
                    <div class="flex justify-between text-xs uppercase tracking-wider text-brand-gold/80 mb-2 font-bold">
                        <span>Checking Availability...</span>
                        <span class="animate-pulse">Please Wait</span>
                    </div>
                    <div class="h-1.5 w-full bg-brand-gold/10 rounded-full overflow-hidden relative">
                        <div class="absolute top-0 left-0 h-full bg-brand-gold w-1/3 animate-loading-bar rounded-full"></div>
                    </div>
                </div>

                <div class="flex items-center justify-between gap-3">
                  <button id="prev-month-btn" class="btn-outline px-4 py-2">
                    <i data-lucide="chevron-left" class="w-4 h-4"></i>
                  </button>
                  <div class="text-xl font-bold text-brand-gold tracking-wide font-serif" id="calendar-month-label">—</div>
                  <button id="next-month-btn" class="btn-outline px-4 py-2">
                    <i data-lucide="chevron-right" class="w-4 h-4"></i>
                  </button>
                </div>

                <div class="mt-4 grid grid-cols-7 gap-2 text-center text-[10px] uppercase tracking-[0.2em] text-brand-dim">
                  <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
                </div>

                <div id="calendar-days" class="mt-3 grid grid-cols-7 gap-2"></div>

                <!-- Selected Date -->
                <div id="mobile-times-anchor" class="hidden"></div>

                <div id="selected-date-info" class="mt-8 hidden animate-fade-in-up">
                  <div class="text-[0.65rem] tracking-[0.35em] uppercase text-brand-gold font-bold mb-1">Step 2</div>
                  <h3 class="text-2xl font-serif mt-1">Select a Time</h3>
                  <div class="mt-3 pill border-brand-gold text-brand-gold bg-brand-gold/10">
                    <i data-lucide="calendar" class="w-4 h-4"></i>
                    <span id="selected-date-display" class="font-bold">—</span>
                  </div>
                </div>

                <!-- Time slots -->
                <div id="time-slots-container" class="mt-4 hidden animate-fade-in-up" style="animation-delay:0.1s">
                  <!-- UPDATED GRID: 4 columns on mobile -->
                  <div id="time-slots-grid" class="grid grid-cols-5 sm:grid-cols-3 md:grid-cols-4 gap-2"></div>
                </div>

                <div id="no-slots" class="mt-4 hidden card-fancy p-4 border-red-500/20">
                  <div class="flex items-start gap-3">
                    <i data-lucide="calendar-x" class="w-5 h-5 text-red-400 mt-0.5"></i>
                    <div>
                      <div class="font-bold text-brand-light">No slots available</div>
                      <div class="muted mt-1 text-sm">Please choose a different day.</div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Summary + confirm -->
              <div id="summary-confirm-anchor" class="hidden"></div>
              <div id="summary-confirm-panel" class="glass-panel p-6">
                <div class="text-[0.65rem] tracking-[0.35em] uppercase text-brand-gold font-bold mb-1">Step 3</div>
                <h3 class="text-2xl font-serif mt-1">Confirm</h3>
                <p class="muted mt-2 text-sm font-light">We will confirm your booking and send your confirmation automatically.</p>

                <hr class="divider my-5">

                <div class="space-y-3">
                  <div class="card-fancy p-4 border-l-2 border-l-brand-gold">
                    <div class="text-[0.65rem] tracking-[0.2em] uppercase text-brand-gold/60 mb-1">Client</div>
                    <div class="font-bold text-brand-light font-serif text-lg" id="summary-client">—</div>
                    <div class="muted mt-0 text-xs" id="summary-email">—</div>
                  </div>

                  <div class="card-fancy p-4">
                    <div class="text-[0.65rem] tracking-[0.2em] uppercase text-brand-gold/60 mb-1">Booking</div>
                    <div class="font-bold text-brand-light font-serif text-lg" id="summary-treatment">Select a treatment</div>
                    <div class="muted mt-0 text-xs" id="summary-datetime">Select a date and time</div>
                  </div>

                  <div class="card-fancy p-4">
                    <div class="text-[0.65rem] tracking-[0.2em] uppercase text-brand-gold/60 mb-1">Travel Fee</div>
                    <div class="font-bold text-brand-gold font-serif text-lg" id="summary-travel-fee">$0.00</div>
                    <div class="muted mt-0 text-xs" id="summary-drive-time">—</div>
                  </div>
                
              <div class="therapist-card mt-3">
                <img src="https://static.wixstatic.com/media/bf8fef_1f7ca3e3f4ed4260a2af32f574055d39~mv2.jpg"
                     alt="Cassandra S." class="therapist-avatar">
                <div class="therapist-info">
                  <div class="therapist-name">Cassandra S.</div>
                  <div class="therapist-title">Registered Massage Therapist</div>
                </div>
              </div>

</div>

                <button id="confirm-booking-btn" class="btn-filled w-full mt-8 btn-disabled py-4" disabled>
                  <i data-lucide="check-circle" class="w-5 h-5"></i>
                  <span id="confirm-btn-text">Confirm Booking</span>
                </button>

                <div class="muted mt-4 text-xs text-center opacity-60">
                  If you need to change your address, please contact us. Profile editing is <span class="pill text-[10px] py-0 px-1">Coming Soon</span>.
                </div>
              </div>
            </div>
          </div>

          <!-- Membership -->
          <div id="tab-membership" class="tab-content hidden animate-fade-in-up">
            <h2 class="text-3xl font-serif text-brand-light mb-6">Membership</h2>
            <div class="card-fancy p-6">
              <div class="pill">Coming Soon</div>
              <p class="muted mt-4">Membership management will be available here.</p>
            </div>
          </div>

          <!-- History -->
          <div id="tab-history" class="tab-content hidden animate-fade-in-up">
            <h2 class="text-3xl font-serif text-brand-light mb-6">Session History</h2>

            <!-- Post-session feedback prompt (History) -->
            <div id="history-review-prompt" class="hidden mb-6">
              <div class="glass-panel p-5">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                  <div>
                    <div class="text-sm tracking-[0.2em] uppercase text-brand-gold/60">Feedback</div>
                    <div class="font-serif text-xl text-brand-light mt-2">Enjoyed your session?</div>
                    <div class="muted text-sm mt-1" id="history-review-text">We’d really appreciate a quick review — it helps a lot.</div>
                  </div>
                  <div class="flex flex-col sm:flex-row gap-3 items-start sm:items-center">
                    <a class="btn-filled text-sm py-2 px-4" target="_blank" rel="noopener" href="https://g.page/r/CVMjbVYTDMv3EAE/review">Leave a Google Review</a>
                  </div>
                </div>
              </div>
            </div>


            <div id="history-loading" class="py-8 text-center">
              <div id="history-skeleton" class="space-y-3">
                <div class="card-fancy p-4">
                  <div class="flex items-center gap-4">
                    <div class="skeleton skeleton-avatar"></div>
                    <div class="flex-1">
                      <div class="skeleton skeleton-text-lg w-3/4"></div>
                      <div class="skeleton skeleton-text w-1/2"></div>
                    </div>
                  </div>
                </div>
                <div class="card-fancy p-4">
                  <div class="flex items-center gap-4">
                    <div class="skeleton skeleton-avatar"></div>
                    <div class="flex-1">
                      <div class="skeleton skeleton-text-lg w-2/3"></div>
                      <div class="skeleton skeleton-text w-1/3"></div>
                    </div>
                  </div>
                </div>
              </div>
              <p class="text-brand-dim text-sm mt-4">Loading history...</p>
            </div>

            <div id="history-error" class="hidden card-fancy p-6 border-red-500/30">
              <div class="flex items-start gap-3">
                <i data-lucide="alert-triangle" class="w-5 h-5 text-red-400 mt-0.5"></i>
                <div>
                  <div class="font-bold text-brand-light">Couldn’t load history</div>
                  <div class="muted mt-1 text-sm">Please try again.</div>
                </div>
              </div>
            </div>

            <div id="history-list" class="space-y-3 hidden"></div>

            <div id="history-empty" class="hidden card-fancy p-6">
              <div class="pill">No completed sessions yet</div>
              <p class="muted mt-4">Your completed appointments will appear here.</p>
            </div>

          </div>

          <!-- Profile -->
          <div id="tab-profile" class="tab-content hidden animate-fade-in-up">
            <div class="glass-panel p-6 mb-6">
              <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                <div>
                  <h2 class="text-3xl font-serif text-brand-light">Your Profile</h2>
                  <p class="muted mt-2 font-light">Review and update your personal details, contact info, and service address.</p>
                </div>

                <div class="flex items-center gap-2">
                  <button id="profile-edit-btn" class="btn btn-outline inline-flex items-center gap-2" onclick="setProfileEditMode(true)">
                    <i data-lucide="pencil" class="w-4 h-4"></i>
                    <span>Edit Details</span>
                  </button>

                  <button id="profile-save-btn" class="btn btn-filled hidden inline-flex items-center gap-2" onclick="saveProfileEdits()">
                    <i data-lucide="save" class="w-4 h-4"></i>
                    <span>Request Change</span>
                  </button>

                  <button id="profile-cancel-btn" class="btn btn-outline hidden inline-flex items-center gap-2" onclick="setProfileEditMode(false, { reset: true })">
                    <i data-lucide="x" class="w-4 h-4"></i>
                    <span>Cancel</span>
                  </button>
                </div>
              </div>

              <div id="profile-save-hint" class="mt-4 rounded-xl border border-brand-gold/25 bg-brand-gold/5 p-4 hidden">
                <div class="flex items-start gap-3">
                  <div class="w-9 h-9 shrink-0 bg-brand-gold/10 border border-brand-gold/25 rounded-full flex items-center justify-center text-brand-gold">
                    <i data-lucide="info" class="w-5 h-5"></i>
                  </div>
                  <div class="min-w-0">
                    <div class="text-brand-light font-serif">Change requests</div>
                    <p class="muted mt-1">Submit your request and we’ll update your details as soon as possible. If you don’t hear back within 48 hours, please contact us by phone or email.</p>
                  </div>
                </div>
              </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <!-- Personal -->
              <div class="card-fancy p-6">
                <div class="flex items-center gap-3 mb-4">
                  <div class="w-10 h-10 bg-brand-gold/10 border border-brand-gold/25 rounded-full flex items-center justify-center text-brand-gold">
                    <i data-lucide="user" class="w-5 h-5"></i>
                  </div>
                  <div>
                    <div class="text-brand-light font-serif text-xl">Personal details</div>
                    <div class="muted text-sm">Who you are</div>
                  </div>
                </div>

                <div id="profile-view-personal" class="space-y-4">
                  <div class="flex items-start justify-between gap-6">
                    <div class="muted text-sm">Full name</div>
                    <div class="text-brand-light text-sm text-right" id="profile-full-name">—</div>
                  </div>
                </div>

                <div id="profile-edit-personal" class="space-y-4 hidden">
                  <div>
                    <label class="muted text-xs uppercase tracking-widest">First name</label>
                    <input id="profile-first-name-input" class="mt-2 w-full input-dark" type="text" autocomplete="given-name" />
                  </div>
                  <div>
                    <label class="muted text-xs uppercase tracking-widest">Last name</label>
                    <input id="profile-last-name-input" class="mt-2 w-full input-dark" type="text" autocomplete="family-name" />
                  </div>
                </div>
              </div>

              <!-- Contact -->
              <div class="card-fancy p-6">
                <div class="flex items-center gap-3 mb-4">
                  <div class="w-10 h-10 bg-brand-gold/10 border border-brand-gold/25 rounded-full flex items-center justify-center text-brand-gold">
                    <i data-lucide="phone" class="w-5 h-5"></i>
                  </div>
                  <div>
                    <div class="text-brand-light font-serif text-xl">Contact</div>
                    <div class="muted text-sm">How we reach you</div>
                  </div>
                </div>

                <div id="profile-view-contact" class="space-y-4">
                  <div class="flex items-start justify-between gap-6">
                    <div class="muted text-sm">Email</div>
                    <div class="text-brand-light text-sm text-right break-all" id="profile-email">—</div>
                  </div>
                  <div class="flex items-start justify-between gap-6">
                    <div class="muted text-sm">Phone</div>
                    <div class="text-brand-light text-sm text-right" id="profile-phone">—</div>
                  </div>
                </div>

                <div id="profile-edit-contact" class="space-y-4 hidden">
                  <div>
                    <label class="muted text-xs uppercase tracking-widest">Email</label>
                    <input id="profile-email-input" class="mt-2 w-full input-dark" type="email" autocomplete="email" />
                  </div>
                  <div>
                    <label class="muted text-xs uppercase tracking-widest">Phone</label>
                    <input id="profile-phone-input" class="mt-2 w-full input-dark" type="tel" autocomplete="tel" />
                  </div>
                </div>
              </div>

              <!-- Address -->
              <div class="card-fancy p-6 lg:col-span-2">
                <div class="flex items-center gap-3 mb-4">
                  <div class="w-10 h-10 bg-brand-gold/10 border border-brand-gold/25 rounded-full flex items-center justify-center text-brand-gold">
                    <i data-lucide="map-pin" class="w-5 h-5"></i>
                  </div>
                  <div>
                    <div class="text-brand-light font-serif text-xl">Service address</div>
                    <div class="muted text-sm">Where we come to you</div>
                  </div>
                </div>

                <div id="profile-view-address" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <div class="rounded-xl border border-brand-gold/15 bg-black/20 p-4">
                    <div class="muted text-xs uppercase tracking-widest">Street</div>
                    <div class="text-brand-light mt-2 text-sm" id="profile-address">—</div>
                  </div>
                  <div class="rounded-xl border border-brand-gold/15 bg-black/20 p-4">
                    <div class="muted text-xs uppercase tracking-widest">City</div>
                    <div class="text-brand-light mt-2 text-sm" id="profile-city">—</div>
                  </div>
                  <div class="rounded-xl border border-brand-gold/15 bg-black/20 p-4">
                    <div class="muted text-xs uppercase tracking-widest">Postal code</div>
                    <div class="text-brand-light mt-2 text-sm" id="profile-postal">—</div>
                  </div>
                </div>

                <div id="profile-edit-address" class="grid grid-cols-1 md:grid-cols-3 gap-4 hidden">
                  <div>
                    <label class="muted text-xs uppercase tracking-widest">Street</label>
                    <input id="profile-address-input" class="mt-2 w-full input-dark" type="text" autocomplete="street-address" />
                  </div>
                  <div>
                    <label class="muted text-xs uppercase tracking-widest">City</label>
                    <input id="profile-city-input" class="mt-2 w-full input-dark" type="text" autocomplete="address-level2" />
                  </div>
                  <div>
                    <label class="muted text-xs uppercase tracking-widest">Postal code</label>
                    <input id="profile-postal-input" class="mt-2 w-full input-dark" type="text" autocomplete="postal-code" />
                  </div>
                </div>

                <div class="mt-4 muted text-sm">
                  Tip: This address is used for travel validation and availability buffers.
                </div>
              </div>
            </div>
          </div>
        </section>
      </div>
    </div>

<!-- Bug Report Footer -->
    <div class="w-full max-w-7xl mx-auto px-4 py-8">
      <div class="text-center">
        <p class="text-brand-dim text-sm">
          Experience an error or bug? 
          <a href="/cdn-cgi/l/email-protection#4d24232b220d3f28212c352c23293f2823283a632e2c723e382f27282e39701d223f392c216d0f382a6d1f283d223f39" class="text-brand-gold hover:text-brand-goldHover transition-colors underline decoration-brand-gold/30 hover:decoration-brand-gold">
            Please report it
          </a> 
          so we can investigate.
        </p>
      </div>
    </div>
  </main>


  <!-- Mobile Time Picker Overlay (mobile only) -->
  <div id="mobile-times-overlay" class="modal-overlay hidden">
    <div class="modal-card" style="max-width: 620px;">
      <div class="flex items-start justify-between gap-4 mb-3">
        <div class="flex-1">
          <div id="mobile-times-title" class="font-serif text-xl text-brand-light">Select a Time</div>
          <div id="mobile-times-subtitle" class="muted text-sm mt-1">Pick a day and time. Unavailable days are disabled.</div>
        </div>
        <button class="btn-outline px-3 py-2 text-xs" onclick="closeMobileTimesOverlay()">
          <i data-lucide="x" class="w-4 h-4"></i>
        </button>
      </div>

      <div id="mobile-strip-nav" class="flex items-center justify-between gap-3 mb-3">
        <button id="mobile-week-prev" class="btn-outline px-3 py-2" type="button" onclick="shiftMobileDateStrip(-7)">
          <i data-lucide="chevron-left" class="w-4 h-4"></i>
        </button>
        <div class="pill border-brand-gold text-brand-gold bg-brand-gold/10 flex-1 justify-center">
          <i data-lucide="calendar" class="w-4 h-4"></i>
          <span id="mobile-week-loading" class="rnr-spinner-sm hidden" aria-label="Loading"></span>
          <span id="mobile-strip-range" class="font-bold text-sm">—</span>
        </div>
        <button id="mobile-week-next" class="btn-outline px-3 py-2" type="button" onclick="shiftMobileDateStrip(7)">
          <i data-lucide="chevron-right" class="w-4 h-4"></i>
        </button>
      </div>

      <div id="mobile-times-scroll" class="rnr-modal-scroll">
        <div id="mobile-date-strip" class="grid grid-cols-7 gap-2 mb-4"></div>
        <div id="mobile-times-content"></div>
      </div>

      <div class="mt-5 flex gap-3">
        <button id="mobile-confirm-btn" class="btn-filled flex-1 btn-disabled py-3" disabled onclick="mobileConfirmBooking()">
          <i data-lucide="check-circle" class="w-4 h-4"></i>
          <span>Next</span>
        </button>
        <button class="btn-outline flex-1 py-2 text-xs" id="mobile-back-btn" onclick="mobileBackInOverlay()">Back</button>
      </div>
    </div>
  </div>

  <!-- Mobile Confirm Overlay (mobile only) -->
  <div id="mobile-confirm-overlay" class="modal-overlay hidden">
    <div class="modal-card" style="max-width: 620px;">
      <div class="flex items-start justify-between gap-4 mb-3">
        <div class="flex-1">
          <div class="font-serif text-xl text-brand-light">Confirm Booking</div>
          <div class="muted text-sm mt-1">Review your details, then confirm.</div>
        </div>
        <button class="btn-outline px-3 py-2 text-xs" onclick="closeMobileConfirmOverlay(false)">
          <i data-lucide="x" class="w-4 h-4"></i>
        </button>
      </div>

      <div id="mobile-confirm-scroll" class="rnr-modal-scroll">
        <div id="mobile-confirm-content"></div>
      </div>

      <div class="mt-5 flex gap-3">
        <button id="mobile-final-confirm-btn" class="btn-filled flex-1 py-3" onclick="mobileFinalConfirm()">
          <i data-lucide="check-circle" class="w-4 h-4"></i>
          <span>Confirm Booking</span>
        </button>
        <button class="btn-outline flex-1 py-2 text-xs" onclick="closeMobileConfirmOverlay(true)">Back</button>
      </div>
    </div>
  </div>

  <!-- Install App Prompt (Chromium/Android/Desktop) -->
  <div id="install-prompt-modal" class="modal-overlay hidden">
    <div class="modal-card" style="max-width: 520px;">
      <div class="flex items-start justify-between gap-4 mb-3">
        <div>
          <div class="font-serif text-xl text-brand-light">Install the app</div>
          <div class="muted text-sm mt-1">Add Relax & Renew Portal to your Home Screen for faster access.</div>
        </div>
        <button class="btn-outline px-3 py-2 text-xs" onclick="closeInstallPromptModal(true)">
          <i data-lucide="x" class="w-4 h-4"></i>
        </button>
      </div>

      <div class="flex gap-3 mt-5">
        <button class="btn-filled flex-1 py-3" onclick="triggerInstallPrompt()">
          <i data-lucide="download" class="w-4 h-4"></i>
          Install
        </button>
        <button class="btn-outline flex-1 py-3" onclick="closeInstallPromptModal(true)">Not now</button>
      </div>

      <div id="install-prompt-debug" class="hidden muted text-xs mt-4"></div>
    </div>
  </div>


  <!-- Toast -->
  <div id="toast" class="toast fixed left-1/2 bottom-6 -translate-x-1/2 flex items-center gap-3 py-3 px-5 rounded opacity-0 pointer-events-none transition-all z-50">
    <div class="bg-brand-gold/20 p-1.5 rounded-full"><i data-lucide="check" class="w-4 h-4 text-brand-gold"></i></div>
    <span id="toast-message" class="text-sm font-bold tracking-wide">Success</span>
  </div>

  <!-- Booking Confirmation Modal -->
  <div id="booking-modal-overlay">
    <div class="booking-modal-card">
      <div id="booking-modal-spinner" class="booking-spinner"></div>
      <div id="booking-modal-success" class="booking-success-icon hidden">
        <svg width="35" height="35" viewBox="0 0 24 24" fill="none" stroke="#4ade80" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="20 6 9 17 4 12"></polyline>
        </svg>
      </div>
      <div id="booking-modal-error" class="booking-error-icon hidden">
        <svg width="35" height="35" viewBox="0 0 24 24" fill="none" stroke="#f87171" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </div>
      <div id="booking-modal-status" class="booking-status-text">Preparing your booking...</div>
      <div id="booking-modal-substatus" class="booking-substatus">Please wait</div>
      <div id="booking-email-preview" class="hidden mt-4 text-sm text-brand-dim"></div>
      <div id="booking-success-actions" class="hidden mt-5 flex gap-3">
        <a href="/portal" class="btn-filled flex-1 text-center">To Client Portal</a>
        <a href="/" class="btn-outline flex-1 text-center">Go Home</a>
      </div>

    </div>
  </div>

  <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
    // =========================================================
    // STATE
    // =========================================================
    let lock = null;
    let portalProfile = null;

    let calendarCurrent = new Date((new Date()).getFullYear(), (new Date()).getMonth(), 1);
    let selectedDateStr = null;
    let selectedSlot = null;

    let availabilityByDate = {};
    let availabilityMeta = { maxDriveTimeMinutes: 0, effective_travel_buffer_minutes: 0, baseToClientDriveTimeMinutes: 0 };

    // Optional: raw Cliniko blocks/appointments per day (used for UI edge-cases like end-of-day blocks)
    // UI-only: does not affect booking logic.
    let dayApptsByDate = {};

    const availabilityCache = new Map();
    let __availabilityLoadedContextKey = null;
    let __availabilityLoadedRange = null;


    // Availability lock: preload two months once and keep range anchored until treatment/duration changes
    let availabilityAnchorMonth = null;
    let treatmentSelect = null;
    let durationSelect = null;

    let selectedServiceKey = null;
    let selectedStandardDuration = null;

    // Appointments state
    let upcomingAppointments = [];
    let cancelledAppointments = [];
    let completedAppointments = [];
    let historyAppointments = [];
    let lastBookingCache = null; // cache for Quick Rebook (avoids extra fetch)
    
    // Preload state
    let availabilityPreloaded = false;
    let availabilityPreloadInFlight = false;

    // Disable/enable Quick Rebook buttons until availability is fully preloaded
    function setQuickRebookEnabled(enabled) {
      const btnSelectors = [
        '#book-same-container button',
        '#rebook-book-same-container button'
      ];
      const summaryIds = ['last-booking-summary', 'rebook-last-booking-summary'];

      btnSelectors.forEach((sel) => {
        const btn = document.querySelector(sel);
        if (!btn) return;
        btn.disabled = !enabled;
        btn.setAttribute('aria-disabled', (!enabled).toString());
        if (!enabled) btn.classList.add('quickrebook-disabled');
        else btn.classList.remove('quickrebook-disabled');
      });

      // If we're disabling, hint that availability is still loading
      if (!enabled) {
        summaryIds.forEach((id) => {
          const el = document.getElementById(id);
          if (!el) return;
          const t = (el.textContent || '').trim();
          if (!t || t.toLowerCase() === 'loading...') {
            el.textContent = 'Loading availability...';
          }
        });
      }
    }


    let preloadedTreatment = null;
    let preloadedDuration = null;

    // PWA install prompt (Android/Chromium)
    let deferredInstallPrompt = null;

    const TREATMENT_RULES = {
      "relaxation":  { label: "Relaxation Massage", durations: [60,75,90,120] },
      "deep-tissue": { label: "Deep Tissue Massage", durations: [60,75,90,120] },
      "sports":      { label: "Sports Massage", durations: [60,75,90,120] },
      "senior":      { label: "Senior Massage", durations: [60,75,90,120] },
      "hot-stone":   { label: "Hot Stone Massage", durations: [60,75,90,120] },
      "cupping":     { label: "Cupping Therapy", durations: [60,75,90,120] },
      "prenatal":    { label: "Prenatal Massage", durations: [30,45,60] },
      "pediatric":   { label: "Pediatric Massage", durations: [30,45] },
      "infant":      { label: "Infant Massage", durations: [30,45] },
    };

    // =========================================================
    // UTIL
    // =========================================================
    function showToast(title, message, isError=false, durationMs=3200) {
      const toast = document.getElementById("toast");
      const msgEl = document.getElementById("toast-message");
      if (!toast || !msgEl) return;

      msgEl.textContent = message || title || "—";
      toast.classList.add("show");
      toast.style.opacity = "1";
      toast.style.transform = "translateX(-50%) translateY(-10px)";

      const iconWrap = toast.querySelector("i");
      if (iconWrap) iconWrap.setAttribute("data-lucide", isError ? "alert-circle" : "check");
      if (typeof lucide !== "undefined") lucide.createIcons();

      // Cancel any prior hide timers (prevents "sticky" toasts)
      try {
        if (toast._hideTimer) clearTimeout(toast._hideTimer);
      } catch (e) {}

      const d = Math.max(800, Number(durationMs) || 3200);
      toast._hideTimer = setTimeout(async () => {
        toast.style.opacity = "0";
        toast.style.transform = "translateX(-50%) translateY(0)";
        toast.classList.remove("show");
      }, d);
    }

    // =============================
    // Theme Toggle (Feature #16)
    // =============================
    function applySavedTheme() {
      const saved = localStorage.getItem("rnr_theme");
      const wantLight = saved === "light";
      document.documentElement.classList.toggle("light-mode", wantLight);
      updateThemeUI();
    }

    function toggleTheme() {
      const html = document.documentElement;
      const isLight = html.classList.toggle("light-mode");
      localStorage.setItem("rnr_theme", isLight ? "light" : "dark");
      updateThemeUI();
    }

    function updateThemeUI() {
      const isLight = document.documentElement.classList.contains("light-mode");
      const icon = document.getElementById("theme-icon");
      const label = document.getElementById("theme-label");
      if (icon) icon.setAttribute("data-lucide", isLight ? "moon" : "sun");
      if (label) label.textContent = isLight ? "Dark Mode" : "Light Mode";
      if (typeof lucide !== "undefined") lucide.createIcons();
    }

    // =============================
    // Offline Banner (Feature #22)
    // =============================
    function initOfflineBanner() {
      const banner = document.getElementById("offline-banner");
      if (!banner) return;
      const update = () => {
        banner.classList.toggle("show", !navigator.onLine);
      };
      window.addEventListener("online", update);
      window.addEventListener("offline", update);
      update();
    }

    // =============================
    // Booking Stepper (Feature #8/#9)
    // =============================
    function updateBookingStepper() {
      const s1 = document.getElementById("step-1");
      const s2 = document.getElementById("step-2");
      const s3 = document.getElementById("step-3");
      if (!s1 || !s2 || !s3) return;

      const hasTreatment = !!selectedServiceKey && !!selectedStandardDuration;
      const hasDate = !!selectedDateStr;
      const hasTime = !!selectedSlot;

      s1.classList.toggle("active", hasTreatment);
      s2.classList.toggle("active", hasTreatment && hasDate);
      s3.classList.toggle("active", hasTreatment && hasDate && hasTime);
    }

    // =============================
    // Cancel Appointment (Feature #5/#6)
    // =============================
    let pendingCancel = { appointmentId: null, startsAt: null };
    let cancelAutoCloseTimer = null;

    function getCancellationCutoffMessage(diffMs) {
      try {
        const ms = Number(diffMs);
        const sixHoursMs = 6 * 60 * 60 * 1000;
        const underSix = Number.isFinite(ms) && ms > 0 && ms <= sixHoursMs;
        if (underSix) {
          return 'This is under 6 hours. To cancel, you will be charged a fee of 100% of the treatment. If this is an emergency, please contact us directly at info@relaxandrenew.ca / 226 337 9064.';
        }
      } catch (e) {}
      return 'This is under 12 hours. To cancel, you will be charged a fee of 50% of the treatment. If under 6 hours, it is 100%. If this is an emergency, please contact us directly at info@relaxandrenew.ca / 226 337 9064.';
    }

    function setCancelModalState(state, message = '') {
      const statusWrap = document.getElementById('cancel-status-wrap');
      const spinner = document.getElementById('cancel-status-spinner');
      const check = document.getElementById('cancel-status-check');
      const x = document.getElementById('cancel-status-x');
      const statusText = document.getElementById('cancel-status-text');
      const statusSub = document.getElementById('cancel-status-subtext');

      const confirmBtn = document.getElementById('cancel-confirm-btn');
      const keepBtn = document.getElementById('cancel-keep-btn');
      const closeBtn = document.getElementById('cancel-close-btn');
      const reasonWrap = document.getElementById('cancel-reason-wrap');
      const cutoffBox = document.getElementById('cancel-cutoff-warning');

      // Reset visuals
      statusWrap?.classList.add('hidden');
      spinner?.classList.add('hidden');
      check?.classList.add('hidden');
      x?.classList.add('hidden');

      if (statusText) statusText.textContent = '';
      if (statusSub) statusSub.textContent = '';

      // Reset content visibility
      reasonWrap?.classList.remove('hidden');
      if (cutoffBox) cutoffBox.classList.add('hidden');

      // Reset buttons
      if (confirmBtn) {
        confirmBtn.disabled = false;
        confirmBtn.classList.remove('hidden');
        confirmBtn.textContent = 'Confirm cancel';
      }
      if (keepBtn) {
        keepBtn.disabled = false;
        keepBtn.classList.remove('hidden');
      }
      if (closeBtn) {
        closeBtn.disabled = false;
        closeBtn.classList.add('hidden');
        closeBtn.textContent = 'Done';
      }

      if (state === 'idle') return;

      if (state === 'loading') {
        // Smooth transition to a dedicated in-progress state
        reasonWrap?.classList.add('hidden');
        if (confirmBtn) confirmBtn.classList.add('hidden');
        if (keepBtn) keepBtn.classList.add('hidden');
        if (closeBtn) closeBtn.classList.add('hidden');

        statusWrap?.classList.remove('hidden');
        spinner?.classList.remove('hidden');
        if (statusText) statusText.textContent = 'Canceling…';
        if (statusSub) statusSub.textContent = message || 'Please wait';
        return;
      }

      if (state === 'success') {
        // Completed state with a manual close button
        reasonWrap?.classList.add('hidden');
        if (confirmBtn) confirmBtn.classList.add('hidden');
        if (keepBtn) keepBtn.classList.add('hidden');

        statusWrap?.classList.remove('hidden');
        check?.classList.remove('hidden');
        if (statusText) statusText.textContent = 'Completed';
        if (statusSub) statusSub.textContent = message || 'Your appointment has been cancelled.';

        if (closeBtn) {
          closeBtn.classList.remove('hidden');
          closeBtn.disabled = false;
          closeBtn.textContent = 'Done';
        }
        return;
      }

      if (state === 'cutoff') {
        // Under 12 hours: show policy message and a Done button
        reasonWrap?.classList.add('hidden');
        if (cutoffBox) cutoffBox.classList.remove('hidden');

        if (confirmBtn) confirmBtn.classList.add('hidden');
        if (keepBtn) keepBtn.classList.add('hidden');

        statusWrap?.classList.remove('hidden');
        x?.classList.remove('hidden');
        if (statusText) statusText.textContent = 'Instant cancellation unavailable';
        if (statusSub) statusSub.textContent = message || 'This is under 12 hours. To cancel, you will be charged a fee of 50% of the treatment. If under 6 hours, it is 100%. If this is an emergency, please contact us directly at info@relaxandrenew.ca / 226 337 9064.';

        if (closeBtn) {
          closeBtn.classList.remove('hidden');
          closeBtn.disabled = false;
          closeBtn.textContent = 'Done';
        }
        return;
      }

      if (state === 'error') {
        // Keep the textarea visible so they can retry with a note if needed
        statusWrap?.classList.remove('hidden');
        x?.classList.remove('hidden');
        if (statusText) statusText.textContent = 'Cancel failed';
        if (statusSub) statusSub.textContent = message || 'Please try again.';
        return;
      }
    }

    function initiateCancel(appointmentId, startsAt) {
      pendingCancel = { appointmentId, startsAt };
      if (cancelAutoCloseTimer) { clearTimeout(cancelAutoCloseTimer); cancelAutoCloseTimer = null; }
      const dt = startsAt ? new Date(startsAt) : null;
      document.getElementById('cancel-modal-datetime').textContent = dt
        ? dt.toLocaleString('en-CA', { timeZone: 'America/Toronto' })
        : '—';
      document.getElementById('cancel-reason').value = '';
      setCancelModalState('idle');
      document.getElementById('cancel-modal').classList.remove('hidden');
      if (typeof lucide !== 'undefined') lucide.createIcons();
    }

    function closeCancelModal() {
      document.getElementById('cancel-modal')?.classList.add('hidden');
      if (cancelAutoCloseTimer) { clearTimeout(cancelAutoCloseTimer); cancelAutoCloseTimer = null; }
      setCancelModalState('idle');
    }

    async function confirmCancelAppointment() {
      if (!pendingCancel.appointmentId || !portalProfile?.email) return;

      const reason = (document.getElementById('cancel-reason')?.value || '').trim();

      // Client-side 12-hour cutoff check (avoid hitting the workflow when instant cancellation is not allowed)
      // startsAt is ISO (UTC) from Cliniko; comparing epoch ms is timezone-safe.
      try {
        if (pendingCancel.startsAt) {
          const startsMs = new Date(pendingCancel.startsAt).getTime();
          const nowMs = Date.now();
          const diffMs = startsMs - nowMs;
          const twelveHoursMs = 12 * 60 * 60 * 1000;
          if (Number.isFinite(diffMs) && diffMs > 0 && diffMs <= twelveHoursMs) {
            setCancelModalState('cutoff', getCancellationCutoffMessage(diffMs));
            return;
          }
        }
      } catch (e) {
        // If parsing fails, fall through to server-side logic.
      }

      setCancelModalState('loading');

      try {
        const res = await fetch(CANCEL_WEBHOOK_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            appointmentId: pendingCancel.appointmentId,
            email: String(portalProfile.email).trim().toLowerCase(),
            reason: reason || 'Cancelled by client via portal'
          })
        });

        const data = await res.json().catch(() => ({}));

        if (data?.withinCutoff || data?.contactRequired) {
          setCancelModalState('cutoff', getCancellationCutoffMessage((pendingCancel?.startsAt ? (new Date(pendingCancel.startsAt).getTime() - Date.now()) : null)));
          return;
        }

        const emptyBody = data && typeof data === 'object' && Object.keys(data).length === 0;
        const okSuccess = (data?.success === true) || emptyBody;
        if (res.ok && okSuccess) {
          setCancelModalState('success');
          // Refresh list immediately; do not auto-close quickly (allow manual close).
          try { await loadUpcomingAppointments(); } catch (e) {}
          if (cancelAutoCloseTimer) { clearTimeout(cancelAutoCloseTimer); }
          cancelAutoCloseTimer = setTimeout(() => {
            try { closeCancelModal(); } catch (e) {}
          }, 15000);
          return;
        }

        setCancelModalState('error', data?.error || data?.message || 'Please try again.');

      } catch (e) {
        setCancelModalState('error', e?.message || 'Please try again.');
      }
    }

    // Left in place for future use (currently not shown to clients)
    async function submitUnder12HourCancellationRequest() {
      if (!pendingCancel.appointmentId || !portalProfile?.email) return;

      const reason = (document.getElementById('cancel-reason')?.value || '').trim();
      const starts = pendingCancel.startsAt ? new Date(pendingCancel.startsAt) : null;
      const appointmentDate = starts ? starts.toLocaleDateString('en-CA', { timeZone: 'America/Toronto' }) : '';
      const appointmentTime = starts ? starts.toLocaleTimeString('en-CA', { hour: 'numeric', minute: '2-digit', hour12: true, timeZone: 'America/Toronto' }) : '';

      const res = await fetch(REQUEST_CANCEL_WEBHOOK_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          appointmentId: pendingCancel.appointmentId,
          email: String(portalProfile.email).trim().toLowerCase(),
          firstName: portalProfile.firstName || '',
          lastName: portalProfile.lastName || '',
          phone: portalProfile.phone || '',
          reason: reason || 'Client requested cancellation (within 12 hours)',
          appointmentDate,
          appointmentTime
        })
      });

      const data = await res.json().catch(() => ({}));
      if (data.success) {
        showToast('Request sent', data.message || 'We’ll contact you shortly.');
        closeCancelModal();
      } else {
        showToast('Request failed', data.error || 'Please contact us directly.', true, 6500);
      }
    }

    // =============================
    // Waitlist (Feature #10)
    // =============================
    let pendingWaitlistDate = null;

    function showWaitlistModal(dateStr) {
      pendingWaitlistDate = dateStr;
      document.getElementById("waitlist-date-label").textContent = formatDatePretty(dateStr);
      document.getElementById("waitlist-notes").value = "";
      document.getElementById("waitlist-modal").classList.remove("hidden");
      if (typeof lucide !== "undefined") lucide.createIcons();
    }

    function closeWaitlistModal() {
      document.getElementById("waitlist-modal")?.classList.add("hidden");
    }

    async function submitWaitlist() {
      if (!pendingWaitlistDate || !portalProfile?.email) return;

      const notes = (document.getElementById("waitlist-notes")?.value || "").trim();

      const res = await fetch(WAITLIST_WEBHOOK_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          email: String(portalProfile.email).trim().toLowerCase(),
          firstName: portalProfile.firstName || "",
          lastName: portalProfile.lastName || "",
          phone: portalProfile.phone || "",
          preferredDate: pendingWaitlistDate,
          treatmentKey: selectedServiceKey || "",
          durationMinutes: Number(selectedStandardDuration || 0),
          notes: notes || ""
        })
      });

      const data = await res.json().catch(() => ({}));
      if (data.success) {
        showToast("Waitlist", data.message || "Added to waitlist.");
        closeWaitlistModal();
      } else {
        showToast("Waitlist failed", data.error || "Please try again.", true, 6500);
      }
    }

    // =============================
    // Invoice / Receipt (Portal - Get Invoice)
    // =============================
    async function openInvoice(appointmentId, subtitle) {
      if (!appointmentId || !portalProfile?.email) return;

      document.getElementById("invoice-modal-subtitle").textContent = subtitle || "";
      const body = document.getElementById("invoice-modal-body");
      body.innerHTML = '<div class="muted">Loading…</div>';
      document.getElementById("invoice-modal").classList.remove("hidden");

      try {
        const res = await fetch(INVOICE_WEBHOOK_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            appointmentId,
            email: String(portalProfile.email).trim().toLowerCase()
          })
        });

        const data = await res.json().catch(() => ({}));
        if (!data.success || !data.invoice) {
          body.innerHTML = '<div class="muted">No receipt available.</div>';
          return;
        }

        const inv = data.invoice;
        const items = Array.isArray(inv.items) ? inv.items : [];
        const rows = items.map(it => `
          <div class="flex justify-between gap-4 py-2 border-b border-brand-gold/10">
            <div>
              <div class="text-brand-light font-semibold">${it.description || "Item"}</div>
              ${it.quantity ? `<div class="muted text-xs">Qty: ${it.quantity}</div>` : ""}
            </div>
            <div class="text-brand-light font-semibold">$${Number(it.total || it.amount || 0).toFixed(2)}</div>
          </div>
        `).join("");

        body.innerHTML = `
          <div class="space-y-3">
            ${inv.receiptNumber ? `<div class="pill">Receipt: ${inv.receiptNumber}</div>` : ""}
            <div class="card-fancy p-3">
              ${rows || '<div class="muted">No line items.</div>'}
              <div class="flex justify-between gap-4 pt-3">
                <div class="muted">Total</div>
                <div class="text-brand-light font-bold">$${Number(inv.total || 0).toFixed(2)}</div>
              </div>
              ${inv.tax !== undefined ? `
                <div class="flex justify-between gap-4 pt-1">
                  <div class="muted">Tax</div>
                  <div class="text-brand-light">$${Number(inv.tax || 0).toFixed(2)}</div>
                </div>` : ""}
              ${inv.paid !== undefined ? `
                <div class="flex justify-between gap-4 pt-1">
                  <div class="muted">Paid</div>
                  <div class="text-brand-light">${inv.paid ? "Yes" : "No"}</div>
                </div>` : ""}
            </div>
          </div>
        `;
      } catch (e) {
        body.innerHTML = '<div class="muted">Unable to load receipt.</div>';
      }

      if (typeof lucide !== "undefined") lucide.createIcons();
    }

    function closeInvoiceModal() {
      document.getElementById("invoice-modal")?.classList.add("hidden");
    }

    // =============================
    // Book Same as Last Time (Feature #3/#4)
    // =============================
    async function loadLastBookingSummary() {
      const dashWrap = document.getElementById("book-same-container");
      const dashSummary = document.getElementById("last-booking-summary");
      const dashHelper = document.getElementById("book-first-helper");

      const rebookWrap = document.getElementById("rebook-book-same-container");
      const rebookSummary = document.getElementById("rebook-last-booking-summary");

      // If neither the dashboard banner nor the rebook banner exists, nothing to do.
      if ((!dashWrap || !dashSummary) && (!rebookWrap || !rebookSummary)) return;

      function hideAll() {
        try { dashWrap && dashWrap.classList.add("hidden"); } catch(e) {}
        try { rebookWrap && rebookWrap.classList.add("hidden"); } catch(e) {}
        try { dashHelper && dashHelper.classList.add("hidden"); } catch(e) {}
      }

      function showNoHistoryHelper() {
        // Only show on Dashboard. Rebook page already *is* the booking flow.
        try { dashWrap && dashWrap.classList.add("hidden"); } catch(e) {}
        try { rebookWrap && rebookWrap.classList.add("hidden"); } catch(e) {}
        try { dashHelper && dashHelper.classList.remove("hidden"); } catch(e) {}
      }

      function showBothBanners() {
        // Show dashboard + rebook containers (when a last booking exists)
        try { dashWrap && dashWrap.classList.remove("hidden"); } catch(e) {}
        try { rebookWrap && rebookWrap.classList.remove("hidden"); } catch(e) {}
        try { dashHelper && dashHelper.classList.add("hidden"); } catch(e) {}

        // Enable the buttons now that we have real data (skeleton/disabled is only for initial load)
        try {
          const b1 = dashWrap && dashWrap.querySelector("button");
          if (b1) b1.classList.remove("pointer-events-none", "opacity-60");
        } catch(e) {}
        try {
          const b2 = rebookWrap && rebookWrap.querySelector("button");
          if (b2) b2.classList.remove("pointer-events-none", "opacity-60");
        } catch(e) {}
      }

      // Prefer locally loaded completed appointments (faster + avoids dependency on last-booking webhook)
      try {
        const pool = Array.isArray(completedAppointments) ? completedAppointments.slice() : [];
        if (pool.length) {
          const last = pool
            .filter(a => a && a.starts_at && !a.cancelled_at)
            .sort((a,b) => new Date(b.starts_at) - new Date(a.starts_at))[0];

          if (last && last.starts_at) {
            const dt = new Date(last.starts_at);
            const dowNames = ["sunday","monday","tuesday","wednesday","thursday","friday","saturday"];
            const dow = dowNames[dt.getDay()];
            const timeLabel = dt.toLocaleTimeString("en-CA", { hour: "numeric", minute: "2-digit", hour12: true, timeZone: "America/Toronto" });

            // Best-effort mapping from appointment type label -> treatment-select key
            const name = (last.appointment_type?.name || last.treatment_label || last.treatment_type || "").toString().toLowerCase();
            const map = [
              ["relaxation", "relaxation"], ["swedish", "relaxation"],
              ["deep", "deep-tissue"], ["tissue", "deep-tissue"],
              ["sports", "sports"],
              ["senior", "senior"],
              ["hot stone", "hot-stone"], ["stone", "hot-stone"],
              ["cupping", "cupping"],
              ["prenatal", "prenatal"],
              ["pediatric", "pediatric"], ["paediatric", "pediatric"],
              ["infant", "infant"]
            ];
            let tKey = "";
            for (const [needle, key] of map) { if (name.includes(needle)) { tKey = key; break; } }

            lastBookingCache = {
              day_of_week: dow,
              start_time_local: timeLabel,
              starts_at: last.starts_at,
              duration: last.duration || last.duration_minutes || last.durationMinutes || 60,
              treatment_key: tKey || undefined
            };

            const treatmentLabel = (last.appointment_type?.name || last.treatment_label || last.treatment_type || "Massage").toString().trim();
            const dur = Number(last.duration || last.duration_minutes || last.durationMinutes || 60) || 60;
            const dayLabel = dow.charAt(0).toUpperCase() + dow.slice(1);
            const label = `${treatmentLabel} • ${dur} min • ${dayLabel}`;
            showBothBanners();
            if (dashSummary) dashSummary.textContent = label;
            if (rebookSummary) rebookSummary.textContent = label;
            return;
          }
        }
      } catch (e) {}

      if (!portalProfile?.email) {
        hideAll();
        return;
      }

      try {
        if (dashSummary) dashSummary.innerHTML = '<span class="skeleton skeleton-text block w-56"></span>';
        if (rebookSummary) rebookSummary.innerHTML = '<span class="skeleton skeleton-text block w-52"></span>';

        const res = await fetch(LAST_BOOKING_WEBHOOK_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email: String(portalProfile.email).trim().toLowerCase() })
        });
        const data = await res.json().catch(() => ({}));

        if (!data.success || !data.lastBooking) {
          // No previous completed appointment → show helper on Dashboard
          showNoHistoryHelper();
          return;
        }

        const lb = data.lastBooking;
        lastBookingCache = lb;
        const tLabel = (lb.treatment_label || lb.treatment || lb.treatment_key || "Massage").toString().trim();
        const dur = Number(lb.duration || lb.durationMinutes || 60) || 60;

        let dayPart = "";
        let timePart = "";
        try {
          if (lb.day_of_week) dayPart = String(lb.day_of_week).trim();
          if (lb.start_time_local) timePart = String(lb.start_time_local).trim();
        } catch (e) {}

        if ((!dayPart || !timePart) && lb.starts_at) {
          try {
            const dt = new Date(lb.starts_at);
            if (!dayPart) dayPart = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"][dt.getDay()];
            if (!timePart) timePart = dt.toLocaleTimeString("en-CA", { hour: "numeric", minute: "2-digit", hour12: true, timeZone: "America/Toronto" });
          } catch (e) {}
        }

        if (dayPart) dayPart = dayPart.charAt(0).toUpperCase() + dayPart.slice(1);
        const label = `${tLabel} • ${dur} min${dayPart ? " • " + dayPart : ""}`;

        showBothBanners();

        if (dashSummary) dashSummary.textContent = label;
        if (rebookSummary) rebookSummary.textContent = label;

      } catch (e) {
        hideAll();
      }
    }

    async function bookSameAsLastTime(ev) {
      try { if (ev && typeof ev.preventDefault === "function") ev.preventDefault(); } catch(e) {}
      try { if (ev && typeof ev.stopPropagation === "function") ev.stopPropagation(); } catch(e) {}

      // If disabled, do nothing (preload still running)
      try {
        const btn = ev && ev.currentTarget ? ev.currentTarget : null;
        if (btn && btn.disabled) return;
      } catch(e) {}

      if (!portalProfile?.email) return;

      // Helper: parse time minutes from various formats
      function minutesFromAny(v) {
        if (!v) return null;
        const raw = String(v).trim();

        const dt = new Date(raw);
        if (!isNaN(dt.getTime())) return dt.getHours() * 60 + dt.getMinutes();

        let m = raw.match(/^(\d{1,2}):(\d{2})$/);
        if (m) {
          const hh = Math.min(23, Math.max(0, parseInt(m[1], 10)));
          const mm = Math.min(59, Math.max(0, parseInt(m[2], 10)));
          return hh * 60 + mm;
        }

        m = raw.match(/^(\d{1,2})(?::(\d{2}))?\s*(AM|PM)$/i);
        if (m) {
          let hh = parseInt(m[1], 10);
          const mm = parseInt(m[2] || "0", 10);
          const ap = String(m[3]).toUpperCase();
          if (ap === "PM" && hh !== 12) hh += 12;
          if (ap === "AM" && hh === 12) hh = 0;
          return hh * 60 + mm;
        }
        return null;
      }

      function deriveDowAndMinutes(lb) {
        // Prefer parsing a full datetime if provided
        const dtRaw = lb.start_time_local || lb.starts_at_local || lb.starts_at || lb.start_time || lb.start || lb.start_at || lb.starts_at_utc;
        const dt = dtRaw ? new Date(String(dtRaw)) : null;
        if (dt && !isNaN(dt.getTime())) {
          return { dowNum: dt.getDay(), minutes: dt.getHours() * 60 + dt.getMinutes() };
        }

        const dow = (lb.day_of_week || "").toString().toLowerCase();
        const map = { sunday:0, monday:1, tuesday:2, wednesday:3, thursday:4, friday:5, saturday:6 };
        const dowNum = map[dow];

        const minutes = minutesFromAny(lb.time || lb.start_time_local || lb.start_time || lb.starts_at || lb.start || lb.start_at);
        return { dowNum: Number.isInteger(dowNum) ? dowNum : null, minutes };
      }

      function setCalendarToMonth(dateStr) {
        try {
          const dt = new Date(String(dateStr) + "T12:00:00");
          if (isNaN(dt.getTime())) return;
          calendarCurrent = new Date(dt.getFullYear(), dt.getMonth(), 1);
          renderCalendar();
        } catch (e) {}
      }

      function pickBestSlotOnDate(dateStr, targetMinutes) {
        const slots = (availabilityByDate?.[dateStr] || []).filter(s => isSlotAvailable(s) && slotPassesUiWindow(dateStr, s));
        if (!slots.length) return null;

        if (typeof targetMinutes !== "number" || !isFinite(targetMinutes)) return slots[0];

        let best = null;
        let bestDiff = Infinity;
        for (const s of slots) {
          const m = getTorontoMinutesFromSlot(s);
          if (m === null || m === undefined) continue;
          const diff = Math.abs(m - targetMinutes);
          if (diff < bestDiff) {
            bestDiff = diff;
            best = s;
          }
        }
        return best || slots[0];
      }

      function findNextAvailableMatch(targetDowNum, targetMinutes) {
        const todayStr = toDateStr(new Date());
        const rangeTo = __availabilityLoadedRange?.to || null;

        const dates = Object.keys(availabilityByDate || {}).filter(d => /^\d{4}-\d{2}-\d{2}$/.test(d)).sort();
        for (const d of dates) {
          if (d < todayStr) continue;
          if (rangeTo && d > rangeTo) break;

          if (Number.isInteger(targetDowNum)) {
            const dt = new Date(d + "T12:00:00");
            if (dt.getDay() !== targetDowNum) continue;
          }

          const bestSlot = pickBestSlotOnDate(d, targetMinutes);
          if (bestSlot) return { dateStr: d, slot: bestSlot };
        }
        return null;
      }

      try {
        // Use cached last booking (from locally loaded appointments or prior webhook call) when available
        let lb = (typeof lastBookingCache !== "undefined" && lastBookingCache) ? lastBookingCache : null;

        if (!lb) {
          const res = await fetch(LAST_BOOKING_WEBHOOK_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email: String(portalProfile.email).trim().toLowerCase() })
          });
          const data = await res.json().catch(() => ({}));
          if (!data.success || !data.lastBooking) {
            showToast("No previous booking found", "Please book manually.", true);
            switchTab("rebook");
            return;
          }
          lb = data.lastBooking;
          lastBookingCache = lb;
        }

        // Apply treatment + duration
        selectedServiceKey = lb.treatment_key || selectedServiceKey;
        selectedStandardDuration = Number(lb.duration || lb.durationMinutes || selectedStandardDuration || 60);

        const tSel = document.getElementById("treatment-select");
        const dSel = document.getElementById("duration-select");

        if (tSel) tSel.value = selectedServiceKey;
        if (typeof rebuildDurationOptions === "function") rebuildDurationOptions();
        if (dSel) dSel.value = String(selectedStandardDuration);

        // Move to Rebook tab
        switchTab("rebook");
        updateBookingStepper();

        // If the initial background preload is still running and we're using the same duration, wait briefly
        const desiredDuration = Number(selectedStandardDuration || 0) || null;
        const durationChangedFromPreload = (Number(preloadedDuration || 0) && desiredDuration)
          ? (Number(preloadedDuration) !== Number(desiredDuration))
          : false;

        if (availabilityPreloadInFlight && !durationChangedFromPreload) {
          const startedAt = Date.now();
          while (availabilityPreloadInFlight && Date.now() - startedAt < 12000) {
            await new Promise(r => setTimeout(r, 120));
          }
        }

        // Only load availability if the last booking duration differs from the preloaded/default duration
        if (!availabilityPreloaded || durationChangedFromPreload) {
          await maybeLoadAvailabilityForCurrentMonth();
        }

        // Must have a loaded range and dates
        if (!availabilityByDate || Object.keys(availabilityByDate).length === 0) {
          showToast("Availability not loaded yet", "Please wait for availability to finish loading.", true);
          return;
        }

        const { dowNum, minutes } = deriveDowAndMinutes(lb);

        // Search ONLY within the already-loaded 2-month window, and choose the next matching weekday/date.
        const found = findNextAvailableMatch(dowNum, minutes);

        if (!found) {
          showToast("No matching availability found", "Please select a date manually.", true);
          return;
        }

        // Jump the calendar to the month containing the found date, then select date + closest time.
        setCalendarToMonth(found.dateStr);

        // Ensure the calendar is in view (especially if clicked from dashboard)
        try {
          document.getElementById("calendar-month-label")?.scrollIntoView({ behavior: "smooth", block: "start" });
        } catch(e) {}

        // Select the date (user initiated so it loads times)
        selectDate(found.dateStr, { userInitiated: true });

        // Select the best slot in the UI after the slot grid has rendered.
        setTimeout(() => {
          try {
            const bestSlot = found.slot;
            if (!bestSlot) return;

            const grid = document.getElementById("time-slots-grid");
            if (!grid) return;

            const buttons = Array.from(grid.querySelectorAll("button.time-slot-btn"));
            if (!buttons.length) return;

            const desiredId = String(bestSlot.start || bestSlot.label || "");
            let btn = desiredId ? buttons.find(b => String(b.getAttribute("data-slot-id") || "") === desiredId) : null;

            // Fallback: pick closest by minutes if IDs don't match perfectly
            if (!btn && typeof minutes === "number" && isFinite(minutes)) {
              let best = null;
              let bestDiff = Infinity;
              for (const b of buttons) {
                const raw = b.getAttribute("data-slot-raw");
                if (!raw) continue;
                let slotObj = null;
                try { slotObj = JSON.parse(raw); } catch(e) {}
                if (!slotObj) continue;
                const m = getTorontoMinutesFromSlot(slotObj);
                if (m === null || m === undefined) continue;
                const diff = Math.abs(m - minutes);
                if (diff < bestDiff) { bestDiff = diff; best = { b, slotObj }; }
              }
              if (best) {
                btn = best.b;
                selectTimeSlot(best.slotObj, btn);
                return;
              }
            }

            if (btn) selectTimeSlot(bestSlot, btn);
          } catch (e) {}
        }, 120);

      } catch (e) {
        showToast("Unable to rebook", "Please book manually.", true);
        switchTab("rebook");
      }
    }


    // =============================
    // Session Countdown (Feature #19)
    // =============================
    let countdownTimer = null;

    function updateCountdown() {
      const card = document.getElementById("next-appt-countdown-card");
      const el = document.getElementById("next-appt-countdown");
      if (!card || !el) return;

      if (!Array.isArray(upcomingAppointments) || upcomingAppointments.length === 0) {
        card.classList.add("hidden");
        return;
      }

      const nextAppt = upcomingAppointments[0];
      const start = new Date(nextAppt.starts_at);
      const now = new Date();
      const diff = start - now;

      card.classList.remove("hidden");

      if (diff <= 0) {
        el.textContent = "Starting soon!";
        return;
      }

      const days = Math.floor(diff / (1000 * 60 * 60 * 24));
      const hours = Math.floor((diff / (1000 * 60 * 60)) % 24);
      const minutes = Math.floor((diff / (1000 * 60)) % 60);

      const parts = [];
      if (days) parts.push(`${days}d`);
      parts.push(`${hours}h`);
      parts.push(`${minutes}m`);
      el.textContent = parts.join(" ");
    }




// =========================================================
    // BOOKING MODAL FUNCTIONS
    // =========================================================
    const bookingMessages = [
      { text: "Preparing your booking...", sub: "Please wait" },
      { text: "Checking availability...", sub: "Making sure your slot is still open" },
      { text: "Reserving your time...", sub: "Almost there" },
      { text: "Confirming with therapist...", sub: "Just a moment" },
      { text: "Finalizing booking...", sub: "Nearly done" }
    ];

    let bookingMessageInterval = null;

    function showBookingModal() {
      const overlay = document.getElementById("booking-modal-overlay");
      const spinner = document.getElementById("booking-modal-spinner");
      const successIcon = document.getElementById("booking-modal-success");
      const errorIcon = document.getElementById("booking-modal-error");
      const statusText = document.getElementById("booking-modal-status");
      const substatusText = document.getElementById("booking-modal-substatus");

      // Reset to initial state
      spinner.classList.remove("hidden");
      successIcon.classList.add("hidden");
      errorIcon.classList.add("hidden");
      statusText.textContent = bookingMessages[0].text;
      substatusText.textContent = bookingMessages[0].sub;

      // Show modal
      overlay.classList.add("active");
      lockBodyScroll();

      // Cycle through messages every 2 seconds
      let messageIndex = 0;
      bookingMessageInterval = setInterval(() => {
        messageIndex = (messageIndex + 1) % bookingMessages.length;
        statusText.style.opacity = "0";
        setTimeout(async () => {
          statusText.textContent = bookingMessages[messageIndex].text;
          substatusText.textContent = bookingMessages[messageIndex].sub;
          statusText.style.opacity = "1";
        }, 200);
      }, 2000);
    }

    function hideBookingModal(success = true, errorMessage = null, clientEmail = null) {
      // Stop message cycling
      if (bookingMessageInterval) {
        clearInterval(bookingMessageInterval);
        bookingMessageInterval = null;
      }

      const spinner = document.getElementById("booking-modal-spinner");
      const successIcon = document.getElementById("booking-modal-success");
      const errorIcon = document.getElementById("booking-modal-error");
      const statusText = document.getElementById("booking-modal-status");
      const substatusText = document.getElementById("booking-modal-substatus");
      const overlay = document.getElementById("booking-modal-overlay");

      // Hide spinner, show appropriate icon
      spinner.classList.add("hidden");

      if (success) {
        successIcon.classList.remove("hidden");
        statusText.textContent = "Booking Confirmed!";
        substatusText.textContent = "Your appointment has been scheduled";
      } else {
        errorIcon.classList.remove("hidden");
        document.getElementById("booking-email-preview")?.classList.add("hidden");
        document.getElementById("booking-success-actions")?.classList.add("hidden");
        statusText.textContent = "Booking Failed";
        substatusText.textContent = errorMessage || "Please try again or contact support";
      }

      // Hide modal after showing result
      setTimeout(() => {
        overlay.classList.remove("active");
        unlockBodyScroll();
      }, success ? 2000 : 3000);
    }

    function resetBookingForm() {
      // Reset treatment dropdown to default
      if (treatmentSelect) {
        treatmentSelect.value = "";
        selectedServiceKey = null;
      }

      // Reset duration dropdown to default disabled state
      if (durationSelect) {
        durationSelect.innerHTML = '<option value="">Select a treatment first…</option>';
        durationSelect.disabled = true;
        selectedStandardDuration = null;
      }

      // Clear availability data (prevents auto-reload of calendar)
      availabilityByDate = {};
      availabilityMeta = { maxDriveTimeMinutes: 0, effective_travel_buffer_minutes: 0, baseToClientDriveTimeMinutes: 0 };
      dayApptsByDate = {};

      // Clear all selections
      clearSelectionUI();

      // Re-render calendar (will show all days as disabled since no treatment selected)
      renderCalendar();

      // Reset availability status message
      updateAvailabilityStatus("Select your treatment and duration to load live availability.", false);
        savePortalState();

      // Update summary to reflect reset state
      updateSummary();
      savePortalState();
    }

    function showAuthError(msg) {
      const el = document.getElementById('auth0-error');
      if (!el) return;
      el.textContent = msg || "Sign in failed. Please try again.";
      el.classList.remove('hidden');
    }

    function hideAuthError() {
      const el = document.getElementById('auth0-error');
      if (el) el.classList.add('hidden');
    }

    function toDateStr(date) {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, "0");
      const d = String(date.getDate()).padStart(2, "0");
      return `${y}-${m}-${d}`;
    }

    
    // MOBILE FIX: Normalize date to YYYY-MM-DD format
    function normalizeDateKey(dateInput) {
      if (!dateInput) return null;
      const str = String(dateInput).trim();

      // Already YYYY-MM-DD
      if (/^\d{4}-\d{2}-\d{2}$/.test(str)) return str;

      // ISO-like starts with YYYY-MM-DD
      const isoMatch = str.match(/^(\d{4}-\d{2}-\d{2})/);
      if (isoMatch) return isoMatch[1];

      // Try Date parse
      try {
        const d = new Date(str);
        if (!isNaN(d.getTime())) {
          // Use local date to match toDateStr()
          const y = d.getFullYear();
          const m = String(d.getMonth() + 1).padStart(2, '0');
          const day = String(d.getDate()).padStart(2, '0');
          return `${y}-${m}-${day}`;
        }
      } catch (e) {}

      return null;
    }

    // MOBILE FIX: Robust slot availability check

    function isSlotAvailable(slot) {
      if (slot == null) return false;

      // If backend ever returns plain strings (time labels), treat as available.
      if (typeof slot === "string") return true;

      // Common object shapes
      if (typeof slot.available === 'boolean') return slot.available;
      if (typeof slot.available === 'string') return ['true','1','yes'].indexOf(slot.available.toLowerCase().trim()) >= 0;
      if (typeof slot.available === 'number') return slot.available === 1;

      if (typeof slot.isAvailable === 'boolean') return slot.isAvailable;
      if (typeof slot.is_available === 'boolean') return slot.is_available;

      if (typeof slot.booked === 'boolean') return !slot.booked;
      if (slot.label && String(slot.label).toLowerCase().indexOf('(booked)') >= 0) return false;

      // If it has a start time but no availability flag, assume available
      if (slot.start) return true;

      return false;
    }

function computeMonthRange(date) {
      const first = new Date(date.getFullYear(), date.getMonth(), 1);
      const last  = new Date(date.getFullYear(), date.getMonth() + 1, 0);
      return { from: toDateStr(first), to: toDateStr(last) };
    }

    // Two-month range (current month + following month)
    function computeTwoMonthRange(date) {
      const first = new Date(date.getFullYear(), date.getMonth(), 1);
      const last  = new Date(date.getFullYear(), date.getMonth() + 2, 0);
      return { from: toDateStr(first), to: toDateStr(last) };
    }

    function normalizeAmPmLabel(label) {
      return String(label || "").toLowerCase().replace(/\s+/g, "").replace(/\./g, "");
    }

    function formatTimeLabel(slot) {
      if (slot && slot.label) return normalizeAmPmLabel(slot.label);
      if (slot && slot.start) {
        const d = new Date(slot.start);
        const raw = d.toLocaleTimeString("en-CA", { hour: "numeric", minute: "2-digit", hour12: true, timeZone: "America/Toronto" });
        return normalizeAmPmLabel(raw);
      }
      return "—";
    }

    // Mobile: compact 15-min labels (10, 1015, 1030, 1045, 11) to reduce vertical space.
    
    // Mobile: 12-hour label parts (bold time + small AM/PM) for compact grid.
    function formatTimeLabelCompactParts(slot) {
      if (!slot) return { time: '—', ampm: '' };

      const start = slot.start || slot.start_time || slot.startTime || slot.begin || null;
      if (start) {
        try {
          const d = new Date(start);
          if (!isNaN(d.getTime())) {
            const t = d.toLocaleTimeString('en-CA', {
              hour: 'numeric',
              minute: '2-digit',
              hour12: true,
              timeZone: 'America/Toronto'
            });
            const cleaned = String(t).replace(/\s+/g, ' ').trim();
            const m = cleaned.match(/^(\d{1,2})(?::(\d{2}))?\s*(AM|PM)$/i);
            if (m) {
              const hh = m[1];
              const mm = m[2] || '';
              const ampm = String(m[3]).toUpperCase();
              const time = (mm && mm !== '00') ? `${hh}:${mm}` : hh;
              return { time, ampm };
            }
            // Last-resort: split on space
            const parts = cleaned.split(' ');
            if (parts.length >= 2) {
              return { time: parts[0], ampm: String(parts[1]).toUpperCase() };
            }
            return { time: cleaned, ampm: '' };
          }
        } catch (e) {}
      }

      const raw = slot.label || slot.time || slot.startLabel || '';
      const cleaned = String(raw).replace(/\s+/g, ' ').trim();
      const m2 = cleaned.match(/(\d{1,2})(?::(\d{2}))?\s*(AM|PM)/i);
      if (m2) {
        const hh = m2[1];
        const mm = m2[2] || '';
        const ampm = String(m2[3]).toUpperCase();
        const time = (mm && mm !== '00') ? `${hh}:${mm}` : hh;
        return { time, ampm };
      }

      return { time: String(formatTimeLabel(slot) || '—').replace(/\(booked\)/ig, '').trim(), ampm: '' };
    }

    function formatTimeLabelCompact(slot) {
      const parts = formatTimeLabelCompactParts(slot);
      return parts.ampm ? `${parts.time} ${parts.ampm}` : parts.time;
    }

    function getSlotStartMs(slot) {
      const start = slot && (slot.start || slot.start_time || slot.startTime || slot.begin);
      if (!start) return 0;
      const d = new Date(start);
      const ms = d.getTime();
      return isNaN(ms) ? 0 : ms;
    }

    // =========================================================
    // UI-ONLY TIME WINDOW (Calendar + slot list)
    // - Hide any slots before 11:00 AM
    // - Non-Sundays: cap last visible start at 8:00 PM
    // - Sundays: cap last visible start at 5:00 PM (no 5:15/5:30/5:45/etc.)
    // - Special edge-case: if an unavailable block runs from <=11:00 AM to the
    //   day's final allowed start time, hide that boundary start time.
    // =========================================================
    function parseLabelMinutes(label) {
      try {
        let s = String(label || "").toLowerCase();
        s = s.replace(/\(booked\)/g, "").replace(/est/g, "").replace(/\s+/g, "").replace(/\./g, "");
        if (!s) return null;

        // 24-hour format: HH:MM
        let m = s.match(/^(\d{1,2}):(\d{2})$/);
        if (m) {
          const hh = parseInt(m[1], 10);
          const mm = parseInt(m[2], 10);
          if (isNaN(hh) || isNaN(mm)) return null;
          if (hh < 0 || hh > 23 || mm < 0 || mm > 59) return null;
          return (hh * 60) + mm;
        }

        // AM/PM format: H(:MM)?(am|pm)
        m = s.match(/^(\d{1,2})(?::(\d{2}))?(am|pm)$/);
        if (m) {
          let hh = parseInt(m[1], 10);
          const mm = m[2] ? (parseInt(m[2], 10) || 0) : 0;
          const ap = m[3];
          if (isNaN(hh) || isNaN(mm)) return null;
          if (hh < 1 || hh > 12 || mm < 0 || mm > 59) return null;
          if (ap === 'am') {
            if (hh === 12) hh = 0;
          } else {
            if (hh !== 12) hh = hh + 12;
          }
          return (hh * 60) + mm;
        }

        // Fallback: H(am|pm)
        m = s.match(/^(\d{1,2})(am|pm)$/);
        if (m) {
          let hh = parseInt(m[1], 10);
          const ap = m[2];
          if (isNaN(hh) || hh < 1 || hh > 12) return null;
          if (ap === 'am') {
            if (hh === 12) hh = 0;
          } else {
            if (hh !== 12) hh = hh + 12;
          }
          return hh * 60;
        }

        return null;
      } catch (e) {
        return null;
      }
    }

    function getTorontoMinutesFromSlot(slot) {
      try {
        // Prefer slot.start when present (most reliable)
        if (slot && slot.start) {
          const d = new Date(slot.start);
          if (!isNaN(d.getTime())) {
            const fmt = new Intl.DateTimeFormat('en-CA', {
              hour: '2-digit',
              minute: '2-digit',
              hour12: false,
              timeZone: 'America/Toronto'
            });

            if (typeof fmt.formatToParts === 'function') {
              const parts = fmt.formatToParts(d);
              let hh = 0, mm = 0;
              for (const p of parts) {
                if (p.type === 'hour') hh = parseInt(p.value, 10) || 0;
                if (p.type === 'minute') mm = parseInt(p.value, 10) || 0;
              }
              return (hh * 60) + mm;
            }

            // Fallback if formatToParts is unavailable
            const s = d.toLocaleTimeString('en-CA', {
              hour: '2-digit',
              minute: '2-digit',
              hour12: false,
              timeZone: 'America/Toronto'
            });
            const m = String(s).match(/^(\d{1,2}):(\d{2})/);
            if (m) return (parseInt(m[1], 10) * 60) + (parseInt(m[2], 10) || 0);
          }
        }

        // Fallback to label parsing (some payloads may omit start)
        if (slot && slot.label) return parseLabelMinutes(slot.label);
        return null;
      } catch (e) {
        return null;
      }
    }

    function isSundayToronto(dateStr) {
      try {
        const m = String(dateStr || '').match(/^(\d{4})-(\d{2})-(\d{2})$/);
        if (!m) return false;
        const y = Number(m[1]);
        const mo = Number(m[2]) - 1;
        const d = Number(m[3]);
        const dt = new Date(Date.UTC(y, mo, d, 12, 0, 0));
        const wd = new Intl.DateTimeFormat('en-US', { weekday: 'short', timeZone: 'America/Toronto' }).format(dt);
        return wd === 'Sun';
      } catch (e) {
        return false;
      }
    }

    function hasClosingUnavailableBlock(dateStr) {
      try {
        const OPEN_MIN = 11 * 60;
        const CLOSE_NON_SUN_MIN = 20 * 60;
        const CLOSE_SUN_MIN = 17 * 60;
        const closeMin = isSundayToronto(dateStr) ? CLOSE_SUN_MIN : CLOSE_NON_SUN_MIN;

        // Primary: use raw Cliniko unavailable blocks/appointments if present in the availability response.
        const appts = dayApptsByDate && dayApptsByDate[dateStr];
        if (Array.isArray(appts) && appts.length) {
          for (const a of appts) {
            if (!a) continue;
            const kind = String(a.kind || a.type || a.category || '').toLowerCase();
            if (!(kind.includes('unavailable') || kind.includes('block'))) continue;

            const startIso = a.start || a.starts_at || a.startsAt || a.begin || a.begins_at || a.beginsAt || null;
            const endIso   = a.end   || a.ends_at   || a.endsAt   || a.finish || a.finishes_at || a.finishesAt || null;

            const startMin = startIso ? getTorontoMinutesFromSlot({ start: startIso }) : null;
            const endMin   = endIso   ? getTorontoMinutesFromSlot({ start: endIso })   : null;

            if (startMin === null || endMin === null) continue;
            if (startMin <= OPEN_MIN && endMin === closeMin) return true;
          }
          return false;
        }

        // Fallback (defensive): if blocks are not provided, infer a "blocked-through-close" day from slots.
        // This only triggers when the final start-time slot exists and is available, but essentially every
        // other slot from opening up to (close - interval) is unavailable/booked.
        const slots = availabilityByDate && availabilityByDate[dateStr];
        if (!Array.isArray(slots) || !slots.length) return false;

        const inWindow = slots.filter(s => {
          const m = getTorontoMinutesFromSlot(s);
          return (m !== null) && (m >= OPEN_MIN) && (m <= closeMin);
        });
        if (!inWindow.length) return false;

        // Find boundary slot (at closeMin)
        const boundary = inWindow.find(s => getTorontoMinutesFromSlot(s) === closeMin);
        if (!boundary) return false;
        if (!isSlotAvailable(boundary)) return false;

        const nonBoundary = inWindow.filter(s => getTorontoMinutesFromSlot(s) !== closeMin);
        // Require a meaningful sample size to reduce false positives.
        if (nonBoundary.length < 12) return false;

        const allBlocked = nonBoundary.every(s => !isSlotAvailable(s));
        return allBlocked;
      } catch (e) {}
      return false;
    }

    function slotPassesUiWindow(dateStr, slot) {
      const mins = getTorontoMinutesFromSlot(slot);
      // If we cannot parse, do not hide (display-only rule).
      if (mins === null) return true;

      const START_MIN = 11 * 60;   // 11:00
      const END_NON_SUN = 20 * 60; // 20:00 (cap non-Sunday to 8:00 PM)
      const END_SUN = 17 * 60;     // 17:00 (cap Sunday to 5:00 PM)

      if (mins < START_MIN) return false;

      const isSun = isSundayToronto(dateStr);
      const dayEnd = isSun ? END_SUN : END_NON_SUN;

      // Special-case: if Cliniko shows a full-day unavailable block ending at the final start time,
      // hide that boundary start time so the day correctly appears fully blocked.
      if (mins === dayEnd && hasClosingUnavailableBlock(dateStr)) return false;

      if (isSun) return mins <= END_SUN;
      return mins <= END_NON_SUN;
    }

    function formatDatePretty(dateStr) {
      const [y,m,d] = dateStr.split("-").map(Number);
      const dt = new Date(y, m-1, d);
      return dt.toLocaleDateString("en-CA", { weekday:"long", month:"long", day:"numeric", year:"numeric" });
    }

    function calcTravelFee(driveTimeMinutes) {
      const driveTime = Number(driveTimeMinutes) || 0;
      
      // Check each tier from highest to lowest
      for (const tier of TRAVEL_FEE_TIERS) {
        if (driveTime >= tier.minMinutes) {
          return tier.fee;
        }
      }
      return 0; // No fee for drives under 36 min
    }

    function setConfirmEnabled(enabled) {
      const btn = document.getElementById("confirm-booking-btn");
      btn.disabled = !enabled;
      btn.classList.toggle("btn-disabled", !enabled);
      
      // Also sync the mobile confirm button
      try {
        syncMobileConfirmButton();
      } catch (e) {}
    }

    function updateSummary() {
      document.getElementById("summary-client").textContent = portalProfile
        ? `${portalProfile.firstName || ""} ${portalProfile.lastName || ""}`.trim() || "—"
        : "—";
      document.getElementById("summary-email").textContent = portalProfile?.email || "—";

      const treat = selectedServiceKey ? TREATMENT_RULES[selectedServiceKey] : null;
      if (treat && selectedStandardDuration) {
        document.getElementById("summary-treatment").textContent = `${treat.label} — ${selectedStandardDuration} min`;
      } else {
        document.getElementById("summary-treatment").textContent = "Select a treatment";
      }

      if (selectedDateStr && selectedSlot) {
        document.getElementById("summary-datetime").textContent = `${formatDatePretty(selectedDateStr)} at ${formatTimeLabel(selectedSlot)}`;
      } else {
        document.getElementById("summary-datetime").textContent = "Select a date and time";
      }

     // Only show drive time and travel fee AFTER a slot is selected
let driveTime = 0;
let travelFee = 0;

if (selectedSlot) {
  driveTime = selectedSlot.driveTimeMinutes || 0;
  travelFee = calcTravelFee(driveTime);
}

document.getElementById("summary-travel-fee").textContent = selectedSlot 
  ? `$${Number(travelFee || 0).toFixed(2)}`
  : "—";

// Show drive time info only when slot is selected
if (selectedSlot && driveTime > 0) {
  let feeNote;
  if (driveTime >= 120) {
    feeNote = " — $200 travel fee (2+ hours)";
  } else if (driveTime >= 60) {
    feeNote = " — $100 travel fee (60+ min)";
  } else if (driveTime >= 45) {
    feeNote = " — $40 travel fee (45+ min)";
  } else if (driveTime >= TRAVEL_FEE_THRESHOLD_MINUTES) {
    feeNote = " — $20 travel fee (36+ min)";
  } else {
    feeNote = " — no travel fee";
  }
  document.getElementById("summary-drive-time").textContent = `${driveTime} min drive time${feeNote}`;
} else if (selectedSlot && driveTime === 0) {
  document.getElementById("summary-drive-time").textContent = "No travel fee";
} else {
  document.getElementById("summary-drive-time").textContent = "Select a time to see travel fee";
}

      setConfirmEnabled(!!(portalProfile && selectedServiceKey && selectedStandardDuration && selectedDateStr && selectedSlot));

      try {
        const overlay = document.getElementById("mobile-times-overlay");
        if (overlay && !overlay.classList.contains("hidden")) {
          syncMobileConfirmButton();
        }
      } catch (e) {}

    }

    function updateAvailabilityStatus(body, loaded) {
      // Elements removed from UI - function kept for compatibility
      try {
        const titleEl = document.getElementById("availability-status-title");
        const bodyEl = document.getElementById("availability-status-body");
        const metaEl = document.getElementById("availability-meta");
        
        if (titleEl) titleEl.textContent = loaded ? "Availability loaded" : "Availability";
        if (bodyEl) bodyEl.textContent = body || "";

        if (metaEl) {
          const buffer = availabilityMeta.effective_travel_buffer_minutes || 0;
          const maxDrive = availabilityMeta.maxDriveTimeMinutes || 0;
          const baseDrive = availabilityMeta.baseToClientDriveTimeMinutes || 0;

          const show = loaded && (
            (maxDrive > 0 && baseDrive > maxDrive) ||
            (baseDrive >= TRAVEL_FEE_THRESHOLD_MINUTES)
          );

          metaEl.textContent = show
            ? `Travel time from base: ${baseDrive} min${buffer ? ` • Buffer applied: ${buffer} min` : ""}`
            : "";
        }
      } catch (e) {
        // Silent fail - elements may not exist in UI
      }
    }

    function setCalendarLoading(isLoading) {
      // Toggle progress bar
      const loader = document.getElementById("availability-loading");
      if (isLoading) {
        loader.classList.remove("hidden");
        document.getElementById("calendar-days").classList.add("opacity-50");
      } else {
        loader.classList.add("hidden");
        document.getElementById("calendar-days").classList.remove("opacity-50");
      }
    }

    // =========================================================
    // LOGIN OVERLAY CONTROL
    // =========================================================
    function showAuthCheckOverlay() {
      const el = document.getElementById("auth-check-overlay");
      if (!el) return;
      el.classList.remove("hidden");
      lockBodyScroll();
      try { window.scrollTo(0, 0); } catch (e) {}
    }

    function hideAuthCheckOverlay() {
      const el = document.getElementById("auth-check-overlay");
      if (!el) return;
      el.classList.add("hidden");
      unlockBodyScroll();
    }

    function showLoginOverlay() {
      try { hideAuthCheckOverlay(); } catch (e) {}
      document.getElementById("login-overlay").classList.remove("hidden");
      lockBodyScroll();
      try { window.scrollTo(0, 0); } catch (e) {}
    }

    function hideLoginOverlay() {
      document.getElementById("login-overlay").classList.add("hidden");
      unlockBodyScroll();
    }

    // =========================================================
    // STATE PERSISTENCE (DISABLED)
    // =========================================================
    // Per latest requirements: always default to the current month, and do not persist
    // selected date/service/duration/month across refreshes. We also clear any legacy
    // saved state so old months (e.g., May) cannot force the UI.
    const PORTAL_STATE_KEY = "rnr_portal_state_v1";

    function savePortalState() { /* disabled */ }

    function loadPortalState() { return null; }

    function clearPortalState() {
      try { localStorage.removeItem(PORTAL_STATE_KEY); } catch (e) {}
    }

    async function restorePortalStateIfPossible() {
      // Always clear legacy persisted state and reset the calendar to the current month.
      clearPortalState();
      const now = new Date();
      calendarCurrent = new Date(now.getFullYear(), now.getMonth(), 1);
      // Do not restore any selections.
      return;
    }

    function maybeAutoSelectRestoredSlot(dateStr) {
      const s = loadPortalState();
      if (!s || !s.selectedSlotStart || !dateStr) return;

      // Do not auto-select stale saved slots.
      try {
        const TTL_MS = 7 * 24 * 60 * 60 * 1000;
        const savedAt = Number(s.savedAt || 0);
        const isFresh = !!(savedAt && (Date.now() - savedAt) < TTL_MS);
        if (!isFresh) return;
      } catch (e) { return; }
      const target = String(s.selectedSlotStart);

      // Find the button corresponding to the stored slot id
      const grid = document.getElementById("time-slots-grid");
      if (!grid) return;

      const btns = Array.from(grid.querySelectorAll("button.time-slot-btn"));
      for (const btn of btns) {
        const slotId = btn.getAttribute("data-slot-id");
        if (slotId && slotId === target) {
          // Rebuild a slot object from dataset when possible
          const raw = btn.getAttribute("data-slot-raw");
          try {
            const slot = raw ? JSON.parse(raw) : null;
            if (slot) selectTimeSlot(slot, btn);
          } catch (e) {}
          break;
        }
      }
    }


    // =========================================================
    // PROFILE
    // =========================================================
    function hydrateProfileUI() {
      document.getElementById("nav-user-name").textContent = portalProfile?.firstName || portalProfile?.email || "—";
      document.getElementById("welcome-pill").textContent = portalProfile?.firstName ? `Hi ${portalProfile.firstName}` : (portalProfile?.email || "Profile loaded");

      // Profile page fields (safe updates)
      const safeSet = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };

      const first = (portalProfile?.firstName || "").trim();
      const last  = (portalProfile?.lastName  || "").trim();
      const full  = (first || last) ? `${first} ${last}`.replace(/\s+/g," ").trim() : "—";

      safeSet("profile-full-name", full);
      safeSet("profile-email", portalProfile?.email || "—");
      safeSet("profile-phone", portalProfile?.phone || "—");
      safeSet("profile-address", _streetOnly(portalProfile?.address) || "—");
      safeSet("profile-city", portalProfile?.city || "—");
      safeSet("profile-postal", portalProfile?.postal_code || "—");
      try { fillProfileEditForm(); } catch(e) {}


      const addrLine = portalProfile?.address ? `${portalProfile.address}, ${portalProfile.city || ""} ${portalProfile.postal_code || ""}`.replace(/\s+/g," ").trim() : "—";
      
      // Pills removed from UI - keep for backwards compatibility
      const pillAddress = document.getElementById("pill-address");
      const pillPhone = document.getElementById("pill-phone");
      if (pillAddress) pillAddress.textContent = `Address: ${addrLine}`;
      if (pillPhone) pillPhone.textContent = `Phone: ${portalProfile?.phone || "—"}`;

      // Dashboard location
      const dashLoc = document.getElementById("dash-location");
      if (dashLoc) {
        // Prefer full service address (street) so the dashboard doesn't only show the town.
        const addr = (portalProfile && portalProfile.address) ? String(portalProfile.address).trim() : "";
        const city = (portalProfile && portalProfile.city) ? String(portalProfile.city).trim() : "";
        let loc = "—";
        if (addr) {
          const addrLower = addr.toLowerCase();
          const cityLower = city.toLowerCase();
          // If city isn't already in the address, append it for clarity.
          loc = (city && cityLower && addrLower.indexOf(cityLower) === -1)
            ? `${addr}, ${city}`
            : addr;
          loc = String(loc).replace(/\s+/g, " ").trim();
        } else if (city) {
          loc = String(city).replace(/\s+/g, " ").trim();
        }
        dashLoc.textContent = loc;
      }

      const missing = !(portalProfile && portalProfile.address && portalProfile.city && portalProfile.postal_code && portalProfile.email);
      document.getElementById("profile-missing").classList.toggle("hidden", !missing);

      if (missing) {
        updateAvailabilityStatus("Missing address/city/postal code in portal profile.", false);
        availabilityByDate = {};
        renderCalendar();
        clearSelectionUI();
        setConfirmEnabled(false);
      }
      updateSummary();
    }

    // =========================================================
    // PROFILE EDITING (Optimistic UI + background sync)
    // =========================================================
    function saveProfileToLocalStorage(profile) {
      try {
        if (!profile) return;
        localStorage.setItem("rnr_portal_profile", JSON.stringify(profile));
      } catch (e) {}
    }

    function _profileEl(id) { return document.getElementById(id); }

    function fillProfileEditForm() {
      _profileEl("profile-first-name-input") && (_profileEl("profile-first-name-input").value = portalProfile?.firstName || "");
      _profileEl("profile-last-name-input") && (_profileEl("profile-last-name-input").value = portalProfile?.lastName || "");
      _profileEl("profile-email-input") && (_profileEl("profile-email-input").value = portalProfile?.email || "");
      _profileEl("profile-phone-input") && (_profileEl("profile-phone-input").value = portalProfile?.phone || "");
      _profileEl("profile-address-input") && (_profileEl("profile-address-input").value = _streetOnly(portalProfile?.address) || "");
      _profileEl("profile-city-input") && (_profileEl("profile-city-input").value = portalProfile?.city || "");
      _profileEl("profile-postal-input") && (_profileEl("profile-postal-input").value = portalProfile?.postal_code || "");
    }

    function setProfileEditMode(enabled, opts) {
      const options = opts || {};
      const viewBlocks = ["profile-view-personal","profile-view-contact","profile-view-address"];
      const editBlocks = ["profile-edit-personal","profile-edit-contact","profile-edit-address"];

      viewBlocks.forEach(id => _profileEl(id)?.classList.toggle("hidden", !!enabled));
      editBlocks.forEach(id => _profileEl(id)?.classList.toggle("hidden", !enabled));

      _profileEl("profile-edit-btn")?.classList.toggle("hidden", !!enabled);
      _profileEl("profile-save-btn")?.classList.toggle("hidden", !enabled);
      _profileEl("profile-cancel-btn")?.classList.toggle("hidden", !enabled);
      _profileEl("profile-save-hint")?.classList.toggle("hidden", !enabled);

      if (enabled) {
        try { fillProfileEditForm(); } catch(e) {}
        if (options.focus !== false) setTimeout(() => _profileEl("profile-first-name-input")?.focus(), 50);
      } else if (options.reset) {
        try { fillProfileEditForm(); } catch(e) {}
      }

      try { if (typeof lucide !== "undefined") lucide.createIcons(); } catch(e) {}
    }

    function openProfileView() {
      switchTab("profile");
      // Ensure we land in view mode by default
      setTimeout(() => setProfileEditMode(false, { reset: false }), 0);
    }

    // Backwards compatibility (older buttons/bookmarks)
    function openProfileEditor() {
      switchTab("profile");
      setTimeout(() => setProfileEditMode(true), 0);
    }

    function _normStr(v) { return String(v || "").trim(); }

    
    function _streetOnly(addr) {
      const s = (addr || "").toString().trim();
      if (!s) return "";
      // If a full formatted address is provided, keep only the street portion (before the first comma)
      const first = s.split(",")[0].trim();
      return first;
    }

function _collectProfileEdits() {
      return {
        firstName: _normStr(_profileEl("profile-first-name-input")?.value),
        lastName: _normStr(_profileEl("profile-last-name-input")?.value),
        email: _normStr(_profileEl("profile-email-input")?.value).toLowerCase(),
        phone: _normStr(_profileEl("profile-phone-input")?.value),
        address: _streetOnly(_normStr(_profileEl("profile-address-input")?.value)),
        city: _normStr(_profileEl("profile-city-input")?.value),
        postal_code: _normStr(_profileEl("profile-postal-input")?.value)
      };
    }

    function _diffProfile(before, after) {
      const keys = ["firstName","lastName","email","phone","address","city","postal_code"];
      const changes = {};
      for (const k of keys) {
        const a = _normStr(after?.[k]);
        const b = _normStr(before?.[k]);
        if (a !== b) changes[k] = after?.[k] || "";
      }
      return changes;
    }

    function _queuePendingProfileUpdate(payload) {
      try {
        const raw = localStorage.getItem("rnr_profile_pending_updates");
        const arr = raw ? (JSON.parse(raw) || []) : [];
        arr.push(payload);
        localStorage.setItem("rnr_profile_pending_updates", JSON.stringify(arr.slice(-10)));
      } catch(e) {}
    }

    async function _flushPendingProfileUpdates() {
      try {
        const raw = localStorage.getItem("rnr_profile_pending_updates");
        const arr = raw ? (JSON.parse(raw) || []) : [];
        if (!Array.isArray(arr) || !arr.length) return;

        const remaining = [];
        for (const payload of arr) {
          const ok = await _sendProfileUpdateWebhook(payload, { quiet: true });
          if (!ok) remaining.push(payload);
        }
        localStorage.setItem("rnr_profile_pending_updates", JSON.stringify(remaining));
      } catch(e) {}
    }

    async function _sendProfileUpdateWebhook(payload, options) {
      const opts = options || {};
      try {
        const res = await fetch(PROFILE_UPDATE_WEBHOOK_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
          keepalive: true
        });
        return !!res.ok;
      } catch (e) {
        if (!opts.quiet) {
          showToast("Sync failed", "Your changes were saved in the portal, but we couldn't sync them right now. We'll retry automatically.", true);
        }
        return false;
      }
    }

    async async function saveProfileEdits() {
      if (!portalProfile) {
        showToast("Profile not loaded", "Please sign in again and try.", true);
        return;
      }

      const before = { ...(portalProfile || {}) };
      const after = { ...(portalProfile || {}), ..._collectProfileEdits() };

      if (!after.email || !after.email.includes("@")) {
        showToast("Invalid email", "Please enter a valid email address.", true);
        return;
      }

      const changes = _diffProfile(before, after);
      if (!Object.keys(changes).length) {
        showToast("No changes", "Nothing to request.", true);
        setProfileEditMode(false, { reset: true });
        return;
      }

      // Submit a change request (do not update the portal profile automatically)
      const payload = {
        event: "profile_update_request",
        ts: new Date().toISOString(),
        auth0_sub: before?.auth0_sub || "",
        cliniko_patient_id: before?.cliniko_patient_id || "",
        email_before: (before?.email || "").trim().toLowerCase(),
        email: (after?.email || "").trim().toLowerCase(),
        changes,
        profile: {
          firstName: after?.firstName || "",
          lastName: after?.lastName || "",
          email: (after?.email || "").trim().toLowerCase(),
          phone: after?.phone || "",
          address: after?.address || "",
          city: after?.city || "",
          postal_code: after?.postal_code || "",
          cliniko_patient_id: before?.cliniko_patient_id || ""
        }
      };

      const ok = await _sendProfileUpdateWebhook(payload);
      if (!ok) _queuePendingProfileUpdate(payload);

      // Revert UI back to stored profile values
      setProfileEditMode(false, { reset: true });

      if (ok) {
        showToast(
          "Request sent",
          "We’ll review and update your details as soon as possible. If you don’t hear back within 48 hours, please contact us by phone or email.",
          false,
          6500
        );
      } else {
        showToast(
          "Request not sent",
          "We couldn't submit your request right now. Please contact us by phone or email.",
          true,
          6500
        );
      }
    }

    function loadProfileFromLocalStorage() {
      try {
        const raw = localStorage.getItem("rnr_portal_profile");
        if (!raw) return null;
        const p = JSON.parse(raw);
        if (!p) return null;
        return {
          firstName: p.firstName || p.given_name || "",
          lastName:  p.lastName || p.family_name || "",
          email:     p.email || "",
          phone:     p.phone || p.phone_number || "",
          address:   p.address || "",
          city:      p.city || "",
          postal_code: p.postal_code || p.postal || "",
          auth0_sub: p.auth0_sub || p.sub || p.user_id || "",
          cliniko_patient_id: p.cliniko_patient_id || ""
        };
      } catch (e) {
        return null;
      }
    }

    // =========================================================
    // TOKEN / JWT HELPERS
    // =========================================================
    function base64UrlDecode(str) {
      try {
        const pad = str.length % 4;
        const base64 = (str + (pad ? "=".repeat(4 - pad) : "")).replace(/-/g, "+").replace(/_/g, "/");
        const decoded = atob(base64);
        try { return decodeURIComponent(decoded.split("").map(c => "%" + ("00" + c.charCodeAt(0).toString(16)).slice(-2)).join("")); }
        catch { return decoded; }
      } catch (e) { return null; }
    }

    function decodeJwtPayload(token) {
      if (!token || typeof token !== "string" || token.split(".").length < 2) return null;
      const payloadB64 = token.split(".")[1];
      const json = base64UrlDecode(payloadB64);
      if (!json) return null;
      try { return JSON.parse(json); } catch { return null; }
    }

    function isJwtExpired(payload) {
      const exp = payload && payload.exp ? Number(payload.exp) : 0;
      if (!exp) return false;
      const now = Math.floor(Date.now() / 1000);
      return now >= exp;
    }

    function isEmailLike(str) {
      const s = String(str || "").trim();
      return !!s && s.includes("@") && s.includes(".");
    }

    function buildProfileFromJwtPayload(payload) {
      if (!payload) return null;

      const email = payload.email || "";

      // Prefer your custom profile object if present
      const claimObj = payload[CLAIM_PROFILE_OBJ] || null;

      // Name sources (priority order)
      const given = (claimObj && (claimObj.firstName || claimObj.given_name)) || payload.given_name || "";
      const family = (claimObj && (claimObj.lastName || claimObj.family_name)) || payload.family_name || "";

      // Fallback to payload.name ONLY if it looks like a real name (not an email)
      const rawName = payload.name ? String(payload.name).trim() : "";
      const canUseNameFallback = rawName && !isEmailLike(rawName) && rawName.includes(" ");

      const nameFirst = canUseNameFallback ? rawName.split(" ")[0] : "";
      const nameLast  = canUseNameFallback ? rawName.split(" ").slice(1).join(" ") : "";

      const firstName = String(given || nameFirst || "").trim();
      const lastName  = String(family || nameLast || "").trim();

      const phone = payload.phone_number || payload[CLAIM_PHONE] || (claimObj && claimObj.phone) || "";

      const address = (claimObj && claimObj.address) || payload[CLAIM_ADDRESS] || "";
      const city    = (claimObj && claimObj.city) || payload[CLAIM_CITY] || "";
      const postal  = (claimObj && (claimObj.postal_code || claimObj.postal)) || payload[CLAIM_POSTAL] || "";

      const addrObj = payload.address || null;
      const addr2 = addrObj && (addrObj.street_address || addrObj.formatted)
        ? (addrObj.street_address || addrObj.formatted)
        : "";
      const city2 = addrObj && addrObj.locality ? addrObj.locality : "";
      const postal2 = addrObj && addrObj.postal_code ? addrObj.postal_code : "";

      return {
        auth0_sub: payload.sub || payload.user_id || "",
                cliniko_patient_id: String((claimObj && (claimObj.cliniko_patient_id || claimObj.clinikoPatientId || claimObj.cliniko_id)) || payload[CLAIM_CLINIKO_PATIENT_ID] || payload.cliniko_patient_id || payload.clinikoPatientId || "").trim(),
        firstName,
        lastName,
        email,
        phone,
        address: address || addr2 || "",
        city: city || city2 || "",
        postal_code: postal || postal2 || ""
      };
    }

    function getStoredLockTokens() {
      try {
        const idToken = localStorage.getItem("rnr_id_token") || "";
        const accessToken = localStorage.getItem("rnr_auth_token") || "";
        return { idToken, accessToken };
      } catch (e) {
        return { idToken: "", accessToken: "" };
      }
    }

    function getRememberEmailPref() {
      try {
        const v = localStorage.getItem("rnr_remember_email");
        return (v === null) ? true : (String(v) === "true");
      } catch (e) { return true; }
    }

    function setRememberEmailPref(v) {
      try { localStorage.setItem("rnr_remember_email", v ? "true" : "false"); } catch (e) {}
    }

    function getRememberedEmail() {
      try { return localStorage.getItem("rnr_remembered_email") || ""; } catch (e) { return ""; }
    }

    function setRememberedEmail(email) {
      try {
        const e = String(email || "").trim();
        if (!e) return;
        localStorage.setItem("rnr_remembered_email", e);
      } catch (e) {}
    }

    function clearRememberedEmail() {
      try { localStorage.removeItem("rnr_remembered_email"); } catch (e) {}
    }
    async function tryEnrichProfileFromUserInfo(accessToken, currentProfile) {
      if (!accessToken) return currentProfile;
      try {
        const res = await fetch(`https://${AUTH0_DOMAIN}/userinfo`, {
          headers: { "Authorization": "Bearer " + accessToken }
        });
        if (!res.ok) return currentProfile;
        const u = await res.json();
        
        const claimObj = u[CLAIM_PROFILE_OBJ] || u.profile || u.user_metadata || null;
        const addressObj = u.address || null;

        const firstName = u.given_name || (u.name ? String(u.name).split(" ")[0] : "") || "";
        const lastName  = u.family_name || (u.name ? String(u.name).split(" ").slice(1).join(" ") : "") || "";

        const address = (claimObj && claimObj.address) || u[CLAIM_ADDRESS] || (addressObj && (addressObj.street_address || addressObj.formatted)) || "";
        const city    = (claimObj && claimObj.city) || u[CLAIM_CITY] || (addressObj && addressObj.locality) || "";
        const postal  = (claimObj && (claimObj.postal_code || claimObj.postal)) || u[CLAIM_POSTAL] || (addressObj && addressObj.postal_code) || "";
        const phone   = (claimObj && claimObj.phone) || u[CLAIM_PHONE] || u.phone_number || "";

        const clinikoId =
          (claimObj && (claimObj.cliniko_patient_id || claimObj.clinikoPatientId || claimObj.cliniko_id)) ||
          u[CLAIM_CLINIKO_PATIENT_ID] ||
          u.cliniko_patient_id ||
          u.clinikoPatientId ||
          (currentProfile && currentProfile.cliniko_patient_id) ||
          "";

        const p2 = {
          auth0_sub: u.sub || u.user_id || (currentProfile && currentProfile.auth0_sub) || "",
          cliniko_patient_id: String(clinikoId || "").trim(),
          firstName,
          lastName,
          email: u.email || "",
          phone,
          address,
          city,
          postal_code: postal
        };
        return { ...(currentProfile || {}), ...p2 };
      } catch (e) {
        return currentProfile;
      }
    }


    

    // =========================================================
    // REVIEW PROMPT (POST-SESSION FEEDBACK)
    // =========================================================
    function _rnrSafeJsonParse(str, fallback) {
      try { return JSON.parse(str); } catch (e) { return fallback; }
    }

    function _rnrFormatDatePrettyFromIso(iso) {
      try {
        const d = iso ? new Date(iso) : null;
        if (!d || isNaN(d.getTime())) return '';
        // e.g., "January 17, 2026"
        return d.toLocaleDateString('en-CA', { year: 'numeric', month: 'long', day: 'numeric', timeZone: 'America/Toronto' });
      } catch (e) { return ''; }
    }

    function _rnrGetCompletedApptKey(appt) {
      try {
        return String(
          appt?.id || appt?.appointment_id || appt?.appointmentId || appt?.cliniko_id || appt?.starts_at || appt?.startsAt || ''
        );
      } catch (e) {
        return '';
      }
    }

    function _rnrGetLatestCompletedAppt() {
      try {
        const arr = Array.isArray(completedAppointments) ? completedAppointments : (Array.isArray(historyAppointments) ? historyAppointments : []);
        if (!arr.length) return null;
        // Prefer those that clearly look like completed sessions
        const sorted = arr.slice().sort((a,b) => {
          const da = new Date(a?.starts_at || a?.startsAt || 0).getTime() || 0;
          const db = new Date(b?.starts_at || b?.startsAt || 0).getTime() || 0;
          return db - da;
        });
        return sorted[0] || null;
      } catch (e) {
        return null;
      }
    }

    
    // =====================================================
    // Server-side Review "Dismiss Forever" flag (n8n Data Table)
    // Uses two webhooks:
    //   GET  /review-flag-get?key=reviewpref:<email>
    //   POST /review-flag-set   { key, dismissForever:true }
    // =====================================================
    let _rnrReviewFlagChecked = false;
    let _rnrReviewDismissForever = false;
    let _rnrReviewFlagPromise = null;

    function _rnrNormalizeN8nPayload(payload) {
      try {
        if (Array.isArray(payload)) return payload[0] || {};
        return payload || {};
      } catch (e) {
        return {};
      }
    }

    function _rnrBuildReviewPrefKeyFromEmail(email) {
      const e = (email || "").toString().trim().toLowerCase();
      return e ? `reviewpref:${e}` : "";
    }

    function _rnrApplyReviewDismissUIState() {
      try {
        const dashWrap = document.getElementById('dash-review-prompt');
        if (dashWrap) dashWrap.classList.add('hidden');
      } catch (e) {}
      try {
        const histWrap = document.getElementById('history-review-prompt');
        if (histWrap) histWrap.classList.add('hidden');
      } catch (e) {}
    }

    async function _rnrEnsureServerReviewFlagLoaded() {
      if (_rnrReviewFlagChecked) return { checked: true, dismissForever: _rnrReviewDismissForever };
      if (_rnrReviewFlagPromise) return _rnrReviewFlagPromise;

      _rnrReviewFlagPromise = (async () => {
        try {
          const email = portalProfile?.email || portalProfile?.Email || portalProfile?.user_email || "";
          const key = _rnrBuildReviewPrefKeyFromEmail(email);
          if (!key) {
            _rnrReviewFlagChecked = true;
            _rnrReviewDismissForever = false;
            return { checked: true, dismissForever: false };
          }

          const url = `${REVIEW_FLAG_GET_WEBHOOK_URL}?key=${encodeURIComponent(key)}`;
          const res = await fetch(url, { method: "GET", credentials: "omit" });
          const payload = _rnrNormalizeN8nPayload(await res.json().catch(() => ({})));

          // Your GET workflow returns: [{ ok:true, key:"reviewpref:...", dismissForever:true/false, lastUpdated:"..." }]
          const dismiss = payload?.dismissForever === true;

          _rnrReviewFlagChecked = true;
          _rnrReviewDismissForever = dismiss;

          if (dismiss) {
            try { localStorage.setItem(LS_REVIEW_DISABLED, '1'); } catch (e) {}
            _rnrApplyReviewDismissUIState();
          }

          return { checked: true, dismissForever: dismiss };
        } catch (e) {
          // Fail-open (do not block review prompts if the flag check fails)
          _rnrReviewFlagChecked = true;
          _rnrReviewDismissForever = false;
          return { checked: true, dismissForever: false };
        } finally {
          // Keep the promise reference, but the checked flag prevents re-fetching
        }
      })();

      return _rnrReviewFlagPromise;
    }

    function _rnrFireAndForgetSetDismissForever() {
      try {
        const email = portalProfile?.email || portalProfile?.Email || portalProfile?.user_email || "";
        const key = _rnrBuildReviewPrefKeyFromEmail(email);
        if (!key) return;

        fetch(REVIEW_FLAG_SET_WEBHOOK_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ key, dismissForever: true })
        })
        .then(r => r.json().catch(() => ({})))
        .then(payloadRaw => {
          const payload = _rnrNormalizeN8nPayload(payloadRaw);
          // Accept either ok:true or success:true from future revisions
          const ok = (payload?.ok === true) || (payload?.success === true) || (payload?.ok === undefined && payload?.success === undefined);
          if (ok) {
            _rnrReviewDismissForever = true;
            _rnrReviewFlagChecked = true;
            try { localStorage.setItem(LS_REVIEW_DISABLED, '1'); } catch (e) {}
            _rnrApplyReviewDismissUIState();
          } else {
            console.warn("Review flag SET returned non-ok payload:", payload);
          }
        })
        .catch(() => {});
      } catch (e) {}
    }


    function _rnrShouldShowReviewPromptFor(apptKey) {
      try {
        if (!apptKey) return false;
        const disabled = localStorage.getItem(LS_REVIEW_DISABLED) === '1';
        if (disabled) { try { _rnrApplyReviewDismissUIState(); } catch(e) {} return false; }
        const prompted = _rnrSafeJsonParse(localStorage.getItem(LS_REVIEW_PROMPTED) || '[]', []);
        return !(Array.isArray(prompted) && prompted.includes(apptKey));
      } catch (e) {
        return false;
      }
    }

    function _rnrMarkReviewPrompted(apptKey) {
      try {
        if (!apptKey) return;
        const prompted = _rnrSafeJsonParse(localStorage.getItem(LS_REVIEW_PROMPTED) || '[]', []);
        const arr = Array.isArray(prompted) ? prompted : [];
        if (!arr.includes(apptKey)) arr.push(apptKey);
        localStorage.setItem(LS_REVIEW_PROMPTED, JSON.stringify(arr));
      } catch (e) {}
    }

    function closeReviewPromptModal() {
      const modal = document.getElementById('review-prompt-modal');
      if (!modal) return;
      modal.classList.add('hidden');
      modal.setAttribute('aria-hidden', 'true');
      unlockBodyScroll();
    }

    function openReviewPromptModal(appt) {
      const modal = document.getElementById('review-prompt-modal');
      if (!modal) return;

      const dateStr = _rnrFormatDatePrettyFromIso(appt?.starts_at || appt?.startsAt || '');
      const subtitle = document.getElementById('review-prompt-subtitle');
      if (subtitle) subtitle.textContent = dateStr ? `From your session on ${dateStr}` : '—';

      const link = document.getElementById('review-prompt-link');
      if (link) link.href = GOOGLE_REVIEW_URL;

      // Reset checkbox each time we open
      const cb = document.getElementById('review-prompt-disable');
      if (cb) cb.checked = false;

      modal.classList.remove('hidden');
      modal.setAttribute('aria-hidden', 'false');
      lockBodyScroll();
      try { if (typeof lucide !== 'undefined') lucide.createIcons(); } catch (e) {}
    }

    async function maybeShowReviewPromptOncePerCompletedAppt() {
      try {
        const latest = _rnrGetLatestCompletedAppt();
        if (!latest) return;

        // Delay review prompt until server-side dismiss flag is checked
        try {
          const flag = await _rnrEnsureServerReviewFlagLoaded();
          if (flag && flag.dismissForever) {
            _rnrApplyReviewDismissUIState();
            return;
          }
        } catch (e) {}

        const key = _rnrGetCompletedApptKey(latest);
        if (!_rnrShouldShowReviewPromptFor(key)) return;

        // Update inline prompts on dashboard/history as well
        const dateStr = _rnrFormatDatePrettyFromIso(latest?.starts_at || latest?.startsAt || '');
        const dashWrap = document.getElementById('dash-review-prompt');
        const dashText = document.getElementById('dash-review-text');
        if (dashText) {
          dashText.textContent = dateStr
            ? `We hope you enjoyed your massage on ${dateStr}. If you have a moment, we’d really appreciate your feedback.`
            : `If you have a moment, we’d really appreciate your feedback.`;
        }
        if (dashWrap) dashWrap.classList.remove('hidden');

        const histWrap = document.getElementById('history-review-prompt');
        const histText = document.getElementById('history-review-text');
        if (histText) {
          histText.textContent = dateStr
            ? `We hope you enjoyed your massage on ${dateStr}. If you have a moment, we’d really appreciate your feedback.`
            : `We’d really appreciate a quick review — it helps a lot.`;
        }
        if (histWrap) histWrap.classList.remove('hidden');

        // Show modal prompt
        openReviewPromptModal(latest);

        // Wire close controls (X + Dismiss only)
        const x = document.getElementById('review-prompt-x');
        const dismiss = document.getElementById('review-prompt-dismiss');
        const modal = document.getElementById('review-prompt-modal');
        const cb = document.getElementById('review-prompt-disable');

        const closeHandler = () => {
          // Mark prompted for this completed appointment
          _rnrMarkReviewPrompted(key);
          // If they opted out, disable forever
          if (cb && cb.checked) {
            try { localStorage.setItem(LS_REVIEW_DISABLED, '1'); } catch (e) {}
            try { _rnrApplyReviewDismissUIState(); } catch (e) {}
            // Persist server-side so it survives new browsers/devices
            try { _rnrFireAndForgetSetDismissForever(); } catch (e) {}
          }
          closeReviewPromptModal();
        };

        if (x && !x.__rnr_bound) {
          x.addEventListener('click', closeHandler);
          x.__rnr_bound = true;
        }
        if (dismiss && !dismiss.__rnr_bound) {
          dismiss.addEventListener('click', closeHandler);
          dismiss.__rnr_bound = true;
        }

        // Prevent closing via backdrop click
        if (modal && !modal.__rnr_bound) {
          modal.addEventListener('click', (e) => {
            // Ignore clicks on backdrop; only allow inside card
            const card = modal.querySelector('.modal-card');
            if (card && !card.contains(e.target)) {
              e.stopPropagation();
              e.preventDefault();
            }
          });
          // Stop propagation from card
          const card = modal.querySelector('.modal-card');
          if (card) {
            card.addEventListener('click', (e) => e.stopPropagation());
          }
          modal.__rnr_bound = true;
        }

      } catch (e) {}
    }


    // =========================================================
    // APPOINTMENT CARD RENDERER
    // =========================================================
    function renderAppointmentCard(appt, isCancelled = false, isHistory = false) {
      const start = appt?.starts_at ? new Date(appt.starts_at) : null;
      const dateStr = start ? start.toLocaleDateString("en-CA", { month: "long", day: "numeric", year: "numeric", timeZone: "America/Toronto" }) : "—";
      const timeStr = start ? start.toLocaleTimeString("en-CA", { hour: "numeric", minute: "2-digit", hour12: true, timeZone: "America/Toronto" }) : "";
      // Treatment + duration (robust across webhook shapes)
      const treatmentRaw = (
        appt?.appointment_type?.name ||
        appt?.appointment_type?.label ||
        appt?.appointment_type_name ||
        appt?.appointmentTypeName ||
        appt?.treatment_label ||
        appt?.treatment_type ||
        appt?.service_name ||
        appt?.service ||
        appt?.type ||
        appt?.reason ||
        "Massage"
      );
      const treatment = String(treatmentRaw || "Massage").trim() || "Massage";

      // Prefer explicit duration, otherwise compute from start/end if available
      let duration = Number(
        appt?.duration ||
        appt?.duration_minutes ||
        appt?.durationMinutes ||
        appt?.appointment_type?.duration ||
        appt?.appointment_type?.duration_minutes ||
        appt?.appointment_type?.length ||
        appt?.minutes ||
        0
      );
      if (!Number.isFinite(duration) || duration <= 0) {
        const end = appt?.ends_at ? new Date(appt.ends_at) : null;
        if (start && end && !isNaN(start.getTime()) && !isNaN(end.getTime())) {
          const diff = Math.round((end.getTime() - start.getTime()) / 60000);
          if (Number.isFinite(diff) && diff > 0) duration = diff;
        }
      }
      if (!Number.isFinite(duration) || duration <= 0) duration = 60;

      const statusClass = isCancelled ? "text-red-400" : (isHistory ? "text-brand-dim" : "text-green-400");
      const statusText = isCancelled ? "Cancelled" : (isHistory ? "Completed" : "Confirmed");
      const statusIcon = isCancelled ? "x-circle" : (isHistory ? "check-circle" : "calendar-check");

      const canCancel = (!isCancelled && !isHistory);
      const canReceipt = (isHistory && !isCancelled);

      return `
        <div class="card-fancy p-4 ${isCancelled ? 'opacity-60' : ''}">
          <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
            <div class="flex-1">
              <div class="font-serif text-lg text-brand-light">${treatment} <span class="text-brand-dim text-sm">(${duration} min)</span></div>
              <div class="text-brand-dim text-sm mt-1">${dateStr} at ${timeStr}</div>
              <div class="flex items-center gap-2 mt-2">
                <span class="text-xs ${statusClass} flex items-center gap-1">
                  <i data-lucide="${statusIcon}" class="w-3 h-3"></i>
                  ${statusText}
                </span>
                
              </div>

              ${canCancel ? `
                <div class="text-xs text-brand-dim mt-3">
                  Free cancellation until 12 hours before. After that, contact us directly.
                </div>
                <button class="btn-danger text-xs mt-3" onclick="initiateCancel('${appt?.id || ""}', '${appt?.starts_at || ""}')">
                  <i data-lucide="x" class="w-3 h-3"></i>
                  Cancel
                </button>
              ` : ''}

              ${canReceipt ? `
                <div class="mt-3 p-2 bg-brand-gold/5 border border-brand-gold/10 rounded">
                  <div class="text-xs text-brand-gold uppercase tracking-wider mb-1">Session Notes</div>
                  <div class="pill text-xs">Coming Soon</div>
                </div>
                <button class="btn-outline text-xs mt-3" onclick="openInvoice('${appt?.id || ""}', '${dateStr} ${timeStr}')">
                  <i data-lucide="receipt" class="w-3 h-3"></i>
                  View Receipt
                </button>
              ` : ''}

            </div>
          </div>
        </div>
      `;
    }

    // =========================================================
    // LOAD UPCOMING APPOINTMENTS
    // =========================================================
    async function loadUpcomingAppointments() {
      if (!portalProfile || !portalProfile.email) {
        console.warn("No profile/email to load appointments");
        document.getElementById("appointments-loading")?.classList.add("hidden");
        document.getElementById("appointments-empty")?.classList.remove("hidden");
        document.getElementById("history-loading")?.classList.add("hidden");
        document.getElementById("history-empty")?.classList.remove("hidden");
        return;
      }

      // Show loading states
      document.getElementById("appointments-loading")?.classList.remove("hidden");
      document.getElementById("appointments-list")?.classList.add("hidden");
      document.getElementById("appointments-empty")?.classList.add("hidden");
      document.getElementById("appointments-error")?.classList.add("hidden");
      
      document.getElementById("history-loading")?.classList.remove("hidden");
      document.getElementById("history-list")?.classList.add("hidden");
      document.getElementById("history-empty")?.classList.add("hidden");
      document.getElementById("history-error")?.classList.add("hidden");

      // Set timeout to show empty state if request takes too long
      const loadingTimeout = setTimeout(() => {
        console.warn("Appointments loading timeout - showing empty state");
        document.getElementById("appointments-loading")?.classList.add("hidden");
        document.getElementById("appointments-empty")?.classList.remove("hidden");
        document.getElementById("history-loading")?.classList.add("hidden");
        document.getElementById("history-empty")?.classList.remove("hidden");
        
        const dashUpcoming = document.getElementById("dash-upcoming-count");
        if (dashUpcoming) dashUpcoming.textContent = "0";
      }, 10000);

      try {
        const res = await fetch(APPOINTMENTS_WEBHOOK_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            email: portalProfile.email,
            firstName: portalProfile.firstName || "",
            lastName: portalProfile.lastName || ""
          })
        });

        clearTimeout(loadingTimeout);

        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        const data = await res.json();
        const all = Array.isArray(data.appointments) ? data.appointments : [];
        const now = new Date();

        // Separate appointments
        cancelledAppointments = all.filter(a => {
          const s = String(a?.status || "").toLowerCase();
          return s.includes("cancel");
        });

        completedAppointments = all.filter(a => {
          const s = String(a?.status || "").toLowerCase();
          if (s.includes("cancel")) return false;
          const start = a?.starts_at ? new Date(a.starts_at) : null;
          return start && start <= now;
        });

        upcomingAppointments = all.filter(a => {
          const s = String(a?.status || "").toLowerCase();
          if (s.includes("cancel")) return false;
          const start = a?.starts_at ? new Date(a.starts_at) : null;
          return start && start > now;
        });

        historyAppointments = [...cancelledAppointments, ...completedAppointments].sort((a, b) => {
          const as = a?.starts_at ? new Date(a.starts_at).getTime() : 0;
          const bs = b?.starts_at ? new Date(b.starts_at).getTime() : 0;
          return bs - as;
        });

        // Load "Book Same as Last Time" banner immediately (parallel with other renders)
        try { loadLastBookingSummary(); } catch (e) {}

        // Store last treatment for preloading
        if (completedAppointments.length > 0 || upcomingAppointments.length > 0) {
          const lastAppt = upcomingAppointments[0] || completedAppointments[0];
          if (lastAppt) {
            try {
              localStorage.setItem("rnr_portal_last_treatment", JSON.stringify({
                treatment_type: lastAppt.appointment_type?.name || lastAppt.treatment_type || "",
                duration: lastAppt.duration || 60
              }));
            } catch(e) {}
          }
        }

        renderAppointments();
          try { await maybeShowReviewPromptOncePerCompletedAppt(); } catch (e) {}
        renderHistory();
        updateCountdown();
        if (countdownTimer) clearInterval(countdownTimer);
        countdownTimer = setInterval(updateCountdown, 60000);


      } catch (e) {
        clearTimeout(loadingTimeout);
        console.error("Failed to load appointments:", e);

        document.getElementById("appointments-loading")?.classList.add("hidden");
        document.getElementById("appointments-error")?.classList.remove("hidden");
        const errMsg = document.getElementById("appointments-error-message");
        if (errMsg) errMsg.textContent = e.message || "Please try again.";

        document.getElementById("history-loading")?.classList.add("hidden");
        document.getElementById("history-error")?.classList.remove("hidden");
      }
    }

    function renderAppointments() {
      document.getElementById("appointments-loading")?.classList.add("hidden");

      const listEl = document.getElementById("appointments-list");
      const emptyEl = document.getElementById("appointments-empty");
      const badge = document.getElementById("appt-count-badge");
      const dashUpcoming = document.getElementById("dash-upcoming-count");
      const dashTotalTreatments = document.getElementById("dash-total-treatments");
      const dashTotalHours = document.getElementById("dash-total-hours");

      if (dashUpcoming) dashUpcoming.textContent = upcomingAppointments.length;
      
      // Calculate total treatments and hours from completedAppointments
      if (dashTotalTreatments) dashTotalTreatments.textContent = completedAppointments.length;
      
      if (dashTotalHours) {
        const totalMinutes = completedAppointments.reduce((sum, appt) => {
          const duration = Number(appt?.duration || appt?.duration_minutes || appt?.durationMinutes || 0);
          return sum + duration;
        }, 0);
        const totalHours = Math.round(totalMinutes / 60 * 10) / 10; // Round to 1 decimal
        dashTotalHours.textContent = `${totalHours} hours`;
      }

      if (upcomingAppointments.length > 0) {
        if (badge) {
          badge.textContent = upcomingAppointments.length;
          badge.classList.remove("hidden");
        }
      } else {
        badge?.classList.add("hidden");
      }

      if (upcomingAppointments.length === 0) {
        listEl?.classList.add("hidden");
        emptyEl?.classList.remove("hidden");
      } else {
        emptyEl?.classList.add("hidden");
        listEl?.classList.remove("hidden");
        if (listEl) {
          listEl.innerHTML = upcomingAppointments.map(appt => renderAppointmentCard(appt, false, false)).join("");
        }
      }

      if (typeof lucide !== "undefined") lucide.createIcons();
    }

    function renderHistory() {
      document.getElementById("history-loading")?.classList.add("hidden");

      const listEl = document.getElementById("history-list");
      const emptyEl = document.getElementById("history-empty");

      if (!historyAppointments || historyAppointments.length === 0) {
        listEl?.classList.add("hidden");
        emptyEl?.classList.remove("hidden");
      } else {
        emptyEl?.classList.add("hidden");
        listEl?.classList.remove("hidden");
        if (listEl) {
          listEl.innerHTML = historyAppointments.map(appt => {
            const isCancelled = String(appt?.status || "").toLowerCase().includes("cancel");
            return renderAppointmentCard(appt, isCancelled, !isCancelled);
          }).join("");
        }
      }

      if (typeof lucide !== "undefined") lucide.createIcons();
    }

    // =========================================================
    // PRELOAD AVAILABILITY IN BACKGROUND
    // =========================================================
    async function preloadAvailabilityInBackground(forceReload = false) {
      console.log("preloadAvailabilityInBackground called, forceReload:", forceReload);
      
      const addrOk = portalProfile && portalProfile.address && portalProfile.city && portalProfile.postal_code;
      if (!addrOk) {
        console.log("Cannot preload: missing address info");
        setQuickRebookEnabled(false);
        return;
      }

      if (availabilityPreloaded && !forceReload) {
        console.log("Already preloaded, skipping");
        setQuickRebookEnabled(true);
        return;
      }

      // Determine treatment from last booking or default
      let preloadTreatment = "relaxation";
      let preloadDuration = 60;

      try {
        const lastRaw = localStorage.getItem("rnr_portal_last_treatment");
        if (lastRaw) {
          const last = JSON.parse(lastRaw);
          const name = String(last.treatment_type || "").toLowerCase();
          if (name.includes("deep tissue")) preloadTreatment = "deep-tissue";
          else if (name.includes("sport")) preloadTreatment = "sports";
          else if (name.includes("senior")) preloadTreatment = "senior";
          else if (name.includes("hot stone")) preloadTreatment = "hot-stone";
          else if (name.includes("cupping")) preloadTreatment = "cupping";
          else if (name.includes("prenatal")) preloadTreatment = "prenatal";
          else if (name.includes("pediatric")) preloadTreatment = "pediatric";
          else if (name.includes("infant")) preloadTreatment = "infant";
          
          const dur = Number(last.duration);
          if (dur && [30, 45, 60, 75, 90, 120].includes(dur)) {
            preloadDuration = dur;
          }
        }
      } catch (e) {
        console.warn("Could not parse last treatment:", e);
      }

      console.log("Preloading:", preloadTreatment, preloadDuration + "min");
      setQuickRebookEnabled(false);
      availabilityPreloadInFlight = true;

      const treatRule = TREATMENT_RULES[preloadTreatment];
      if (!treatRule) return;

      if (!treatRule.durations.includes(preloadDuration)) {
        preloadDuration = treatRule.durations[0] || 60;
      }

      // Set state
      selectedServiceKey = preloadTreatment;
      selectedStandardDuration = preloadDuration;
      preloadedTreatment = preloadTreatment;
      preloadedDuration = preloadDuration;

      // Update UI
      if (treatmentSelect) treatmentSelect.value = preloadTreatment;
      rebuildDurationOptions();
      if (durationSelect) durationSelect.value = String(preloadDuration);

      // Build request
      const baseMonth = availabilityAnchorMonth || calendarCurrent;
      const { from, to } = computeTwoMonthRange(baseMonth);
      const blockMinutes = preloadDuration + STATIC_SETUP_MINUTES;

      const payload = {
        address: portalProfile.address,
        city: portalProfile.city,
        postal_code: portalProfile.postal_code,
        from,
        to,
        standardDurationMinutes: preloadDuration,
        blockDurationMinutes: blockMinutes,
        slotIntervalMinutes: 15,
        practitionerId: DEFAULT_PRACTITIONER_ID,
        travel_time_buffer_minutes: 0
      };

      updateAvailabilityStatus("Loading availability...", false);
      // Ensure the calendar loading bar appears for the initial preload as well.
      // (Previously it only showed for month nav / duration change.)
      try { setCalendarLoading(true); } catch (e) {}

      try {
        const res = await fetch(AVAILABILITY_WEBHOOK_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if (res.ok) {
          const data = await res.json();
          const cacheKey = getRequestCacheKey(payload);
          availabilityCache.set(cacheKey, data);
          parseAvailabilityResponse(data);
          // Track the loaded context + range so we can avoid re-fetching when browsing months
          const contextKey = [
            payload.standardDurationMinutes,
            payload.blockDurationMinutes,
            payload.practitionerId,
            payload.address, payload.city, payload.postal_code
          ].join("|");
          __availabilityLoadedContextKey = contextKey;
          __availabilityLoadedRange = { from: payload.from, to: payload.to };

          // If backend returned no usable dates, do not claim "loaded"
          const hasDates = availabilityByDate && Object.keys(availabilityByDate).length > 0;
          if (!hasDates) {
            availabilityPreloaded = false;
            renderCalendar();
            updateAvailabilityStatus("Availability returned no dates for this month. Try a different duration or verify your address in Profile.", false);
            showToast("No availability", "No open slots were returned. Try another duration or month.", true, 6500);
            return;
          }

          availabilityPreloaded = true;

          setQuickRebookEnabled(true);
          renderCalendar();
          setTimeout(ensureCalendarClickableAfterPreload, 60);
          updateAvailabilityStatus(`Showing ${treatRule.label} (${preloadDuration} min). Select a date.`, true);
          updateSummary();
          console.log("Availability preloaded successfully");
        } else {
          console.warn("Preload failed:", res.status);
          updateAvailabilityStatus("Select treatment and duration to load availability.", false);
        }
      } catch (e) {
        console.warn("Preload error:", e);
        updateAvailabilityStatus("Select treatment and duration to load availability.", false);
      } finally {
        try { setCalendarLoading(false); } catch (e) {}
      }

      availabilityPreloadInFlight = false;
    setQuickRebookEnabled(!!availabilityPreloaded);
    }

    // =========================================================
    // AUTH CHECK ON LOAD
    // =========================================================
    async function checkExistingAuth() {
      // Prevent Auth0 flash: show a neutral session-check overlay first
      try { hideLoginOverlay(); } catch (e) {}
      try { showAuthCheckOverlay(); } catch (e) {}

      const { idToken, accessToken } = getStoredLockTokens();

      if (idToken) {
        const payload = decodeJwtPayload(idToken);
        if (payload && !isJwtExpired(payload)) {
          // Valid token exists - user is authenticated
          try {
            portalProfile = buildProfileFromJwtPayload(payload) || null;

            // Merge with localStorage profile if exists
            const local = loadProfileFromLocalStorage();
            if (local) portalProfile = { ...(portalProfile || {}), ...local };

            // Try to enrich from userinfo (don't let this block login)
            try {
              portalProfile = await tryEnrichProfileFromUserInfo(accessToken, portalProfile);
            } catch (e) {
              console.warn("Could not enrich profile from userinfo:", e);
            }

            // Track login
            try {
              if (typeof gtag === "function") gtag("event", "client_portal_session_restored");
            } catch (e) {}
          } catch (e) {
            console.error("Error building profile:", e);
          }

          // Hide overlays immediately now that we know the session is valid
          try { hideAuthCheckOverlay(); } catch (e) {}
          try { hideLoginOverlay(); } catch (e) {}

          hydrateProfileUI();
          renderCalendar();

          // Start server-side review flag check early (does not touch Auth0)
          try { _rnrEnsureServerReviewFlagLoaded(); } catch (e) {}

          // Load appointments and preload availability
          loadUpcomingAppointments();
          if (!availabilityPreloaded) preloadAvailabilityInBackground();

          return true;
        } else {
          // Token expired - clear it
          try { localStorage.removeItem("rnr_id_token"); } catch (e) {}
          try { localStorage.removeItem("rnr_auth_token"); } catch (e) {}
        }
      }

      // No valid auth - show login overlay and initialize Lock
      try { hideAuthCheckOverlay(); } catch (e) {}
      showLoginOverlay();
      initAuth0Lock();
      return false;
    }

    // =========================================================
    // AUTH0 LOCK INITIALIZATION
    // =========================================================
    function initAuth0Lock() {
      const rememberedEmail = (typeof getRememberEmailPref === 'function' && getRememberEmailPref())
        ? (typeof getRememberedEmail === 'function' ? getRememberedEmail() : '')
        : '';
      const containerEl = document.getElementById('auth0-lock-container');
      // If a lock instance exists but the container was cleared (e.g., after logout),
      // force a full re-init so the embed can render again.
      if (lock) {
        try {
          const hasWidget = containerEl && containerEl.querySelector('.auth0-lock');
          if (!hasWidget) {
            try { lock.hide(); } catch (e) {}
            lock = null;
          } else {
            lock.show();
            return;
          }
        } catch (e) {
          lock = null;
        }
      }
      if (typeof Auth0Lock === 'undefined') {
        showAuthError('Auth0 failed to load. Please disable ad-blockers for this site or refresh.');
        console.error('Auth0Lock is undefined — lock.min.js did not load.');
        return;
      }

      lock = new Auth0Lock(AUTH0_CLIENT_ID, AUTH0_DOMAIN, {
        container: 'auth0-lock-container',
        allowSignUp: false,
        theme: {
          logo: 'https://static.wixstatic.com/media/bf8fef_511df25fad074d79a408119293545f75~mv2.png',
          primaryColor: '#E0C584'
        },
        languageDictionary: { 
          title: "", 
          emailInputPlaceholder: "Email", 
          passwordInputPlaceholder: "Password" 
        },
                prefill: { email: (rememberedEmail && rememberedEmail.length ? rememberedEmail : undefined) },
        auth: {
          redirect: false,
          responseType: 'token id_token',
          sso: false,
          params: { scope: 'openid profile email' }
        },
        allowedConnections: [AUTH0_DB_CONNECTION],
        usernameStyle: "email",
        rememberLastLogin: true,
        autofocus: true,
        autoclose: false,
        closable: false
      });

      // Show the Lock widget
      lock.show();

      // Handle successful authentication
      lock.on('authenticated', async function(authResult) {
        hideAuthError();
        
        try {
          // Store tokens
          if (authResult && authResult.accessToken) {
            localStorage.setItem('rnr_auth_token', authResult.accessToken);
          }
          if (authResult && authResult.idToken) {
            localStorage.setItem('rnr_id_token', authResult.idToken);
          }

          // Build profile from ID token
          const payload = decodeJwtPayload(authResult.idToken);
          portalProfile = buildProfileFromJwtPayload(payload) || null;

          // Merge with localStorage profile
          const local = loadProfileFromLocalStorage();
          if (local) portalProfile = { ...(portalProfile || {}), ...local };

          // Try to enrich from userinfo
          portalProfile = await tryEnrichProfileFromUserInfo(authResult.accessToken, portalProfile);

          // Remember email for future logins (optional)
          try {
            const rememberEmailCb = document.getElementById('remember-email');
            const remember = (rememberEmailCb ? !!rememberEmailCb.checked : (getRememberEmailPref ? getRememberEmailPref() : true));
            setRememberEmailPref(remember);
            if (remember) {
              setRememberedEmail((portalProfile && portalProfile.email) || (payload && payload.email) || '');
            } else {
              clearRememberedEmail();
            }
          } catch (e) {}

          // Track login success
          try {
            if (typeof gtag === "function") gtag("event", "client_portal_login_success");
            if (typeof fbq === "function") fbq("trackCustom", "ClientPortalLoginSuccess");
          } catch (e) {}

          // Hide login overlay with slight delay for smooth transition
          setTimeout(async () => {
            hideLoginOverlay();
            hydrateProfileUI();
            renderCalendar();
            const _n = (portalProfile && (`${portalProfile.firstName || ""} ${portalProfile.lastName || ""}`.trim())) || "Client";
            const _isMobile = (window.matchMedia && window.matchMedia("(max-width: 640px)").matches);
            showToast("Welcome!", `Signed in as ${_n}.`, false, _isMobile ? 1100 : 2200);
            // After sign-in, restore any in-progress selection and ensure availability loads
            try { await restorePortalStateIfPossible(); } catch (e) {}

      // Mobile-only: the selects can appear preloaded visually, but globals may not hydrate without a stored state.
      // This causes the calendar to render as fully disabled. On mobile, synchronize selection from UI and load availability if needed.
      if (window.matchMedia && window.matchMedia("(max-width: 640px)").matches) {
        try {
          const uiServiceKey = (treatmentSelect && treatmentSelect.value) ? String(treatmentSelect.value).trim() : "";
          const uiDurVal = (durationSelect && durationSelect.value) ? Number(durationSelect.value) : NaN;

          if (!selectedServiceKey && uiServiceKey) selectedServiceKey = uiServiceKey;
          if ((!selectedStandardDuration || isNaN(Number(selectedStandardDuration))) && !isNaN(uiDurVal) && uiDurVal > 0) {
            selectedStandardDuration = uiDurVal;
          }

          const hasAvailabilityData = availabilityByDate && Object.keys(availabilityByDate).length > 0;

          if (selectedServiceKey && selectedStandardDuration && !hasAvailabilityData) {
            await maybeLoadAvailabilityForCurrentMonth();
          } else {
            renderCalendar();
          }
        } catch (e) {
          console.warn("Mobile calendar hydration failed:", e);
          renderCalendar();
        }
      }

            try {
              if (portalProfile) {
                if (!selectedServiceKey && treatmentSelect && treatmentSelect.value && TREATMENT_RULES[treatmentSelect.value]) {
                  selectedServiceKey = treatmentSelect.value;
                  rebuildDurationOptions();
                }
                if (!selectedStandardDuration && durationSelect && durationSelect.value) {
                  selectedStandardDuration = Number(durationSelect.value);
                }
                if (selectedServiceKey && selectedStandardDuration) {
                  await maybeLoadAvailabilityForCurrentMonth();
                }
                renderCalendar();
              }
            } catch (e) {}

            
            // Load appointments and preload availability
            loadUpcomingAppointments();
            preloadAvailabilityInBackground();
          }, 300);

        } catch (e) {
          console.error("Auth processing error:", e);
          showAuthError("Sign in succeeded but there was an error loading your profile. Please refresh.");
        }
      });

      // Handle auth errors
      lock.on('authorization_error', function(err) {
        console.error('Auth0 authorization_error:', err);
        showAuthError("Sign in failed. Please check your email/password and try again.");
      });

      lock.on('unrecoverable_error', function(err) {
        console.error('Auth0 unrecoverable_error:', err);
        showAuthError("An error occurred. Please refresh the page and try again.");
      });
    }

    // =========================================================
    // LOGOUT
    // =========================================================
    async function handleLogout() {
      clearPortalState();
      // Clear tokens
      try {
        localStorage.removeItem("rnr_portal_profile");
        localStorage.removeItem("rnr_id_token");
        localStorage.removeItem("rnr_auth_token");
      } catch(e) {}

      // Reset state
      portalProfile = null;
      
      // Show login overlay and reinitialize Lock
      showLoginOverlay();
      
      // Destroy existing Lock instance and create new one
      if (lock) {
        try { lock.hide(); } catch(e) {}
      }
      // Destroy lock instance so embedded container is re-bound correctly
      lock = null;

      // Clear the container and reinitialize
      document.getElementById("auth0-lock-container").innerHTML = "";
      initAuth0Lock();
      
      showToast("Signed out", "You have been signed out successfully.");
    }

    // =========================================================
    // TREATMENT / DURATION
    // =========================================================
    function rebuildDurationOptions() {
      if (!durationSelect) {
        console.error("durationSelect not found");
        return;
      }

      // Preserve any previously selected duration if it is still valid for the chosen treatment.
      const prevDuration = Number(selectedStandardDuration) || null;

      durationSelect.innerHTML = "";

      const rule = selectedServiceKey ? TREATMENT_RULES[selectedServiceKey] : null;
      if (!rule) {
        durationSelect.disabled = true;
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "Select a treatment first…";
        durationSelect.appendChild(opt);
        selectedStandardDuration = null;
        updateSummary();
        return;
      }

      const firstOpt = document.createElement("option");
      firstOpt.value = "";
      firstOpt.textContent = "Select…";
      durationSelect.appendChild(firstOpt);

      rule.durations.forEach(min => {
        const opt = document.createElement("option");
        opt.value = String(min);
        opt.textContent = `${min} min`;
        durationSelect.appendChild(opt);
      });

      durationSelect.disabled = false;

      // If a duration was already selected (e.g., preloading), keep it if it remains valid.
      if (prevDuration && rule.durations.includes(prevDuration)) {
        selectedStandardDuration = prevDuration;
        durationSelect.value = String(prevDuration);
      } else {
        selectedStandardDuration = null;
        durationSelect.value = "";
      }

      updateSummary();
    }

    // =========================================================
    // AVAILABILITY
    // =========================================================
    function clearSelectionUI() {
      selectedDateStr = null;
      selectedSlot = null;

      document.getElementById("selected-date-info").classList.add("hidden");
      document.getElementById("time-slots-container").classList.add("hidden");
      document.getElementById("no-slots").classList.add("hidden");
      document.getElementById("confirm-booking-btn").classList.add("btn-disabled");
      setConfirmEnabled(false);
      updateSummary();
    }

    function buildAvailabilityPayload() {
      const addrOk = portalProfile && portalProfile.address && portalProfile.city && portalProfile.postal_code;
      if (!addrOk) return { error: "Missing address/city/postal code in portal profile." };
      if (!selectedServiceKey || !selectedStandardDuration) return { error: "Select treatment and duration first." };

      const { from, to } = computeTwoMonthRange(calendarCurrent);
      const blockMinutes = Number(selectedStandardDuration) + Number(STATIC_SETUP_MINUTES);

      return {
        address: portalProfile.address,
        city: portalProfile.city,
        postal_code: portalProfile.postal_code,
        from,
        to,
        standardDurationMinutes: Number(selectedStandardDuration),
        blockDurationMinutes: Number(blockMinutes),
        slotIntervalMinutes: 15,
        practitionerId: DEFAULT_PRACTITIONER_ID,
        travel_time_buffer_minutes: 0
      };
    }

    function getRequestCacheKey(payload) {
      return [
        payload.from, payload.to,
        payload.standardDurationMinutes, payload.blockDurationMinutes,
        payload.practitionerId,
        payload.address, payload.city, payload.postal_code
      ].join("|");
    }

        function parseAvailabilityResponse(data) {
      availabilityByDate = {};
      availabilityMeta = { maxDriveTimeMinutes: 0, effective_travel_buffer_minutes: 0, baseToClientDriveTimeMinutes: 0 };
      dayApptsByDate = {};

      if (!data) return;

      // Unwrap common webhook wrappers if present
      if (data && typeof data === "object") {
        if (data.success === true && data.data && typeof data.data === "object") data = data.data;
        if (data.body && typeof data.body === "object") data = data.body;
      }

// MOBILE FIX: Check multiple possible field names for metadata
      availabilityMeta.maxDriveTimeMinutes = Number(
        data.maxDriveTimeMinutes || data.max_drive_time_minutes ||
        data.driveTimeMinutes || data.drive_time_minutes || 0
      );
      availabilityMeta.effective_travel_buffer_minutes = Number(
        data.effective_travel_buffer_minutes || data.effectiveTravelBufferMinutes ||
        data.travel_buffer_minutes || data.travelBufferMinutes || 0
      );

      availabilityMeta.baseToClientDriveTimeMinutes = Number(
        data.baseToClientDriveTimeMinutes || data.base_to_client_drive_time_minutes ||
        data.baseToClientDriveTime || data.base_to_client_drive_time || 0
      );

      // Find dates array in response
      var datesArray = null;
      if (data.dates && Array.isArray(data.dates)) datesArray = data.dates;
      else if (Array.isArray(data)) datesArray = data;
      else if (data.availability && Array.isArray(data.availability)) datesArray = data.availability;
      else if (data.days && Array.isArray(data.days)) datesArray = data.days;

      if (!datesArray) return;

      datesArray.forEach(function(day) {
        if (!day) return;
        var rawDate = day.date || day.day || day.dateStr || day.date_str;
        if (!rawDate) return;

        // MOBILE FIX: Normalize date key
        var normalizedDate = normalizeDateKey(rawDate);
        if (!normalizedDate) return;

        var slots = day.slots || day.timeSlots || day.times || [];
        if (!Array.isArray(slots)) return;

        // Preserve any per-day blocks/appointments if present (backend may include Cliniko unavailable blocks here)
        var appts = day.appts || day.appointments || day.blocks || day.unavailableBlocks || day.unavailable_blocks || day.unavailable || [];
        if (Array.isArray(appts)) dayApptsByDate[normalizedDate] = appts;

        availabilityByDate[normalizedDate] = slots;
      });
    }

    async function maybeLoadAvailabilityForCurrentMonth() {
      const payload = buildAvailabilityPayload();
      // Anchor the 2-month preload window on first load; keep it fixed until treatment/duration changes.
      try {
        if (!availabilityAnchorMonth) availabilityAnchorMonth = new Date(calendarCurrent.getFullYear(), calendarCurrent.getMonth(), 1);
      } catch (e) {}
      if (payload.error) {
        updateAvailabilityStatus(payload.error, false);
        availabilityByDate = {};
        renderCalendar();
        clearSelectionUI();
        return;
      }

      // Two-month preload optimization:
      // If we already have availability loaded for this month (and the next month) for the same
      // address + treatment + duration context, do not re-fetch when the user browses forward/back.
      const contextKey = [
        payload.standardDurationMinutes,
        payload.blockDurationMinutes,
        payload.practitionerId,
        payload.address, payload.city, payload.postal_code
      ].join("|");

      try {
        const baseMonth = availabilityAnchorMonth || calendarCurrent;
        const monthRange = computeTwoMonthRange(baseMonth); // locked two-month window anchored to initial load
        if (__availabilityLoadedContextKey === contextKey &&
            __availabilityLoadedRange &&
            __availabilityLoadedRange.from <= monthRange.from &&
            __availabilityLoadedRange.to >= monthRange.to) {

          clearSelectionUI();
          renderCalendar();
          try { if (typeof isMobileTimesOverlayOpen === 'function' && isMobileTimesOverlayOpen()) renderMobileDateStrip(); } catch(e) {}
          updateAvailabilityStatus("Availability already loaded for this month (next month preloaded).", true);
          savePortalState();
          return;
        }
      } catch (e) {}

      const cacheKey = getRequestCacheKey(payload);
      clearSelectionUI();
      setCalendarLoading(true);
      updateAvailabilityStatus("Checking live availability for this month (and next)…", false);

      try {
        if (availabilityCache.has(cacheKey)) {
          const cached = availabilityCache.get(cacheKey);
          parseAvailabilityResponse(cached);
          __availabilityLoadedContextKey = contextKey;
          __availabilityLoadedRange = { from: payload.from, to: payload.to };
          renderCalendar();
          try { if (typeof isMobileTimesOverlayOpen === 'function' && isMobileTimesOverlayOpen()) renderMobileDateStrip(); } catch(e) {}
          setTimeout(ensureCalendarClickableAfterPreload, 60);
          updateAvailabilityStatus("Availability loaded from cache for this month (next month preloaded).", true);
          savePortalState();
          // Restore date selection (if any) after availability is loaded
          const s = loadPortalState();
          if (s?.selectedDateStr && availabilityByDate?.[s.selectedDateStr]) selectDate(s.selectedDateStr, { userInitiated: false });
          return;
        }

        const res = await fetch(AVAILABILITY_WEBHOOK_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          const text = await res.text().catch(() => "");
          throw new Error("Availability error (" + res.status + "): " + (text || res.statusText));
        }

        const data = await res.json();
        availabilityCache.set(cacheKey, data);
        parseAvailabilityResponse(data);
        renderCalendar();
        try { if (typeof isMobileTimesOverlayOpen === 'function' && isMobileTimesOverlayOpen()) renderMobileDateStrip(); } catch(e) {}
        setTimeout(ensureCalendarClickableAfterPreload, 60);
        updateAvailabilityStatus("Live availability loaded for this month (next month preloaded).", true);

      } catch (e) {
        console.error(e);
        availabilityByDate = {};
        renderCalendar();
        updateAvailabilityStatus("Could not load availability. Please try again or contact support.", false);
        showToast("Availability error", "Unable to load availability.", true);
      } finally {
        setCalendarLoading(false);
      }
    }


    function renderCalendar() {
      const monthLabelEl = document.getElementById("calendar-month-label");
      const daysContainer = document.getElementById("calendar-days");
      if (!monthLabelEl || !daysContainer) {
        // DOM not ready yet; try again next frame
        requestAnimationFrame(() => renderCalendar());
        return;
      }
const monthName = calendarCurrent.toLocaleDateString("en-CA", { month: "long", year: "numeric" });
      monthLabelEl.textContent = monthName;

      const year = calendarCurrent.getFullYear();
      const month = calendarCurrent.getMonth();

      const firstDay = new Date(year, month, 1);
      const startDayOfWeek = firstDay.getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();

      daysContainer.innerHTML = "";

      for (let i = 0; i < startDayOfWeek; i++) {
        const blank = document.createElement("div");
        blank.className = "opacity-0";
        blank.textContent = ".";
        daysContainer.appendChild(blank);
      }

      const todayStr = toDateStr(new Date());

      for (let day = 1; day <= daysInMonth; day++) {
        const dayDate = new Date(year, month, day);
        const dateStr = toDateStr(dayDate);

        const slots = availabilityByDate[dateStr] || [];
        const hasAnyAvailable = Array.isArray(slots) && slots.some(function(s) { return isSlotAvailable(s) && slotPassesUiWindow(dateStr, s); });

        const isPast = dateStr < todayStr;
        const isSelected = selectedDateStr === dateStr;
        const isToday = dateStr === todayStr;

        const cell = document.createElement("button");
        cell.type = "button";
        cell.className = "calendar-day";

        if (isPast || !hasAnyAvailable || !selectedServiceKey || !selectedStandardDuration) {
          cell.classList.add("calendar-day-disabled");
          cell.disabled = true;
        } else {
          cell.classList.add("calendar-day-available");
          if (isToday) cell.classList.add("calendar-day-today");
          if (isSelected) cell.classList.add("calendar-day-selected");
          cell.addEventListener("click", () => selectDate(dateStr, { userInitiated: true }));
        }

        cell.textContent = String(day);
        daysContainer.appendChild(cell);
      }

      
      if (typeof lucide !== "undefined") lucide.createIcons();
    }

    // Mobile/Browser robustness: if availability data exists but all days render as disabled,
    // trigger a single refresh through the existing duration-change path (this matches the
    // user action that makes availability appear).
    function ensureCalendarClickableAfterPreload() {
      try {
        const daysContainer = document.getElementById("calendar-days");
        if (!daysContainer) return;

        const anyClickable = daysContainer.querySelector(".calendar-day-available:not([disabled])");
        if (anyClickable) return;

        const hasData = availabilityByDate && Object.keys(availabilityByDate).length > 0;
        const hasSelection = !!(selectedServiceKey && selectedStandardDuration);

        if (!hasData || !hasSelection) return;

        if (window.__rnr_calendar_auto_refresh_done) return;
        window.__rnr_calendar_auto_refresh_done = true;

        // Prefer the established flow (duration change -> maybeLoadAvailabilityForCurrentMonth)
        if (durationSelect) {
          durationSelect.dispatchEvent(new Event("change", { bubbles: true }));
        } else if (typeof maybeLoadAvailabilityForCurrentMonth === "function") {
          maybeLoadAvailabilityForCurrentMonth();
        }
      } catch (e) {
        console.warn("ensureCalendarClickableAfterPreload error:", e);
      }
    }

    function selectDate(dateStr, opts) {
      const options = opts && typeof opts === 'object' ? opts : {};
      const userInitiated = options.userInitiated !== false; // default true

      const norm = (typeof normalizeDateKey === 'function' ? (normalizeDateKey(dateStr) || dateStr) : dateStr);
      selectedDateStr = norm;
      selectedSlot = null;

      const mobile = (typeof isMobileUI === 'function' && isMobileUI());

      // On mobile: only open the picker + render times when the user explicitly clicks a date.
      if (mobile && userInitiated) {
        try { openMobileTimesOverlay(); } catch (e) {}
      }

      renderCalendar();
      updateSummary();
      updateBookingStepper();
      savePortalState();

      // Do not auto-expand the time list / modal from restored state or programmatic selection.
      if (!userInitiated) return;

      document.getElementById("selected-date-info").classList.remove("hidden");
      document.getElementById("selected-date-display").textContent = formatDatePretty(norm);

      loadTimeSlots(norm);
    }


    function loadTimeSlots(dateStr) {
      const container = document.getElementById("time-slots-container");
      const grid = document.getElementById("time-slots-grid");
      const noSlots = document.getElementById("no-slots");

      container.classList.remove("hidden");
      grid.innerHTML = "";

      const key = (typeof normalizeDateKey === 'function' ? (normalizeDateKey(dateStr) || dateStr) : dateStr);
      const slots = availabilityByDate[key] || [];
      const usable = Array.isArray(slots) ? slots : [];

      // UI-only: constrain visible slots to the current operating window
      const filtered = usable.filter(s => slotPassesUiWindow(key, s));

      if (!filtered.length) {
        noSlots.classList.remove("hidden");
        container.classList.add("hidden");
        return;
      }

      filtered.sort((a,b) => {
        const am = getTorontoMinutesFromSlot(a);
        const bm = getTorontoMinutesFromSlot(b);
        const ak = (am === null ? 99999 : am);
        const bk = (bm === null ? 99999 : bm);
        return ak - bk;
      });

      let anyAvailable = false;

      filtered.forEach(slot => {
        const btn = document.createElement("button");
        // Persistable slot identifiers for refresh recovery
        try {
          btn.setAttribute("data-slot-id", String(slot.start || slot.label || ""));
          btn.setAttribute("data-slot-raw", JSON.stringify(slot));
        } catch (e) {}
        btn.type = "button";
        // Base class: we add 'time-slot-btn' and specific styles for available/booked below
        btn.className = "time-slot-btn w-full rounded-lg border";
        
        // Mobile gets compact numeric labels; desktop keeps existing label normalization.
        let labelClean = "—";
        if (typeof isMobileUI === 'function' && isMobileUI()) {
          labelClean = formatTimeLabelCompact(slot);
        } else {
          const labelRaw = formatTimeLabel(slot);
          labelClean = String(labelRaw).replace(/est/g, "").replace(/\(booked\)/g, "").trim();
        }

        if (isSlotAvailable(slot)) {
          btn.classList.add("border-brand-gold/30", "bg-black/40", "text-brand-light", "hover:bg-brand-gold/15", "hover:border-brand-gold");
          if (typeof isMobileUI === 'function' && isMobileUI()) {
          const p = formatTimeLabelCompactParts(slot);
          btn.innerHTML = `<span class="time-main whitespace-nowrap">${p.time}</span>` + (p.ampm ? `<span class="time-ampm uppercase whitespace-nowrap">${p.ampm}</span>` : '');
        } else {
          btn.innerHTML = `<span class="font-bold text-sm whitespace-nowrap">${labelClean}</span>`;
        }
          anyAvailable = true;
          btn.addEventListener("click", () => selectTimeSlot(slot, btn));
        } else {
          btn.classList.add("border-white/5", "bg-white/5", "text-white/30", "cursor-not-allowed", "opacity-50");
          if (typeof isMobileUI === 'function' && isMobileUI()) {
          const p = formatTimeLabelCompactParts(slot);
          const inner = `<span class="time-main whitespace-nowrap line-through decoration-brand-gold/40 decoration-2">${p.time}</span>` + (p.ampm ? `<span class="time-ampm uppercase whitespace-nowrap">${p.ampm}</span>` : '');
          btn.innerHTML = inner;
        } else {
          btn.innerHTML = `<span class="font-bold text-sm whitespace-nowrap line-through decoration-brand-gold/40 decoration-2">${labelClean}</span>`;
        }
          btn.disabled = true;
        }

        grid.appendChild(btn);
      });

      if (!anyAvailable) {
        noSlots.classList.remove("hidden");
        noSlots.innerHTML = `
          <div class="flex items-start gap-3">
            <i data-lucide="calendar-x" class="w-5 h-5 text-amber-400 mt-0.5"></i>
            <div class="flex-1">
              <div class="font-bold text-brand-light">Fully Booked</div>
              <div class="muted mt-1 text-sm">This day has no available slots.</div>
              <button onclick="showWaitlistModal('${dateStr}')" class="btn-outline text-xs mt-3">
                <i data-lucide="bell" class="w-3 h-3"></i>
                Join Waitlist
              </button>
            </div>
          </div>
        `;
      } else {
        noSlots.classList.add("hidden");
        noSlots.innerHTML = "";
      }

      container.classList.toggle("hidden", !anyAvailable);

      if (typeof lucide !== "undefined") lucide.createIcons();
    }

    function selectTimeSlot(slot, btnElement) {
      selectedSlot = slot;

      document.querySelectorAll(".time-slot-btn").forEach(btn => btn.classList.remove("time-slot-selected"));
      btnElement.classList.add("time-slot-selected");

      updateSummary();
      updateBookingStepper();
      savePortalState();
    }

    function prevMonth() {
      calendarCurrent = new Date(calendarCurrent.getFullYear(), calendarCurrent.getMonth() - 1, 1);
      renderCalendar();
      // Availability is preloaded/locked (2 months). Do not refetch on month navigation.
      savePortalState();
}

    function nextMonth() {
      calendarCurrent = new Date(calendarCurrent.getFullYear(), calendarCurrent.getMonth() + 1, 1);
      renderCalendar();
      // Availability is preloaded/locked (2 months). Do not refetch on month navigation.
      savePortalState();
}

    // =========================================================
    // BOOKING CONFIRMATION
    // =========================================================
    async function confirmBooking() {
      try { closeMobileTimesOverlay(); } catch (e) {}
      if (!(portalProfile && selectedServiceKey && selectedStandardDuration && selectedDateStr && selectedSlot)) {
        showToast("Missing info", "Please select a treatment, duration, date, and time.", true);
        return;
      }

      const treat = TREATMENT_RULES[selectedServiceKey];
      const driveTime = selectedSlot?.driveTimeMinutes || 0;
      const travelFee = calcTravelFee(driveTime);

      const bookingPayload = {
        firstName: portalProfile.firstName || "",
        lastName:  portalProfile.lastName || "",
        email:     portalProfile.email || "",
        phone:     portalProfile.phone || "",
        address: portalProfile.address,
        city: portalProfile.city,
        postal_code: portalProfile.postal_code,
        treatment_key: selectedServiceKey,
        treatment_label: treat ? treat.label : "",
        duration: Number(selectedStandardDuration),
        standardDurationMinutes: Number(selectedStandardDuration),
        participants: 1,
        participant_count: 1,
        slot_start: selectedSlot.start,
        slot_end: selectedSlot.end,
        date: selectedDateStr,
        times_already_utc: true,
        travel_charge: Number(travelFee || 0),
        drive_time_minutes: Number(driveTime || 0),
        travel_fee_cents: Math.round(Number(travelFee || 0) * 100),
        notes: "Booked via Client Portal."
      };

      try { localStorage.setItem("rnr_portal_last_booking_payload", JSON.stringify(bookingPayload)); } catch(e) {}

      const btn = document.getElementById("confirm-booking-btn");
      btn.disabled = true;
      btn.classList.add("btn-disabled");

      // Show the booking modal with cycling messages
      showBookingModal();

      try {
        const res = await fetch(BOOKING_WEBHOOK_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(bookingPayload)
        });

        if (!res.ok) {
          const text = await res.text().catch(() => "");
          throw new Error(`Booking error (${res.status}): ${text || res.statusText}`);
        }

        const result = await res.json().catch(() => ({}));

        // Show success in modal
        hideBookingModal(true, null, portalProfile?.email || null);

        console.log("Booking confirmed:", result);

        // Clear the cache so fresh data loads next time
        availabilityCache.clear();

        // Wait for modal to close, then go to dashboard
        setTimeout(() => {
          resetBookingForm();
          showToast("Success", "Your appointment has been confirmed!");
          switchTab('dashboard');
          loadUpcomingAppointments();
          preloadAvailabilityInBackground(true);
        }, 2200);

      } catch (e) {
        console.error(e);
        
        // Show error in modal
        hideBookingModal(false, "Unable to complete booking");

        // Re-enable button after modal closes
        setTimeout(() => {
          btn.disabled = false;
          btn.classList.remove("btn-disabled");
          showToast("Booking failed", "Please try again or contact support.", true);
        }, 3200);
      }
    }

    // =========================================================
    // TAB SWITCHING
    // =========================================================
    function switchTab(tabId) {
      document.querySelectorAll(".tab-content").forEach(el => el.classList.add("hidden"));
      const active = document.getElementById("tab-" + tabId);
      if (active) active.classList.remove("hidden");

      try { if (typeof lucide !== "undefined") lucide.createIcons(); } catch(e) {}
      document.querySelectorAll(".sidebar-btn").forEach(btn => {
        btn.classList.toggle("active", btn.dataset.tab === tabId);
      });

      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    // =========================================================
    // INIT
    // =========================================================
    async function init() {
      if (typeof lucide !== "undefined") lucide.createIcons();

      applySavedTheme();
      initOfflineBanner();

      // Mobile menu (portal navigation)
      const mm = document.getElementById("mobile-menu");
      const mmBackdrop = document.getElementById("mobile-menu-backdrop");

      let mobileMenuScrollY = 0;

      const openMobileMenu = () => {
        mobileMenuScrollY = window.scrollY || 0;

        mm?.classList.add("open");
        mmBackdrop?.classList.add("open");

        document.documentElement.classList.add("menu-open");
        document.body.classList.add("menu-open");

        // Prevent background scrolling (including iOS)
        document.body.style.position = "fixed";
        document.body.style.top = `-${mobileMenuScrollY}px`;
        document.body.style.width = "100%";
      };

      const closeMobileMenu = () => {
        mm?.classList.remove("open");
        mmBackdrop?.classList.remove("open");

        document.documentElement.classList.remove("menu-open");
        document.body.classList.remove("menu-open");

        // Restore scroll position
        document.body.style.position = "";
        document.body.style.top = "";
        document.body.style.width = "";
        window.scrollTo(0, mobileMenuScrollY);
      };

      document.getElementById("mobile-menu-btn")?.addEventListener("click", openMobileMenu);
      document.getElementById("mobile-menu-close")?.addEventListener("click", closeMobileMenu);
      mmBackdrop?.addEventListener("click", closeMobileMenu);

      // Close menu on ESC
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") closeMobileMenu();
      });

      // Wire portal tab buttons inside the mobile menu
      document.querySelectorAll(".mobile-portal-btn").forEach(btn => {
        const tab = btn.dataset.tab;
        if (!tab) return;
        btn.addEventListener("click", () => {
          switchTab(tab);
          closeMobileMenu();
        });
      });

      // Add-to-Home-Screen / Install (PWA)
      const installBtn = document.getElementById("install-app-btn");
      const installIosBtn = document.getElementById("install-app-ios-btn");

      const isIOS = () => /iphone|ipad|ipod/i.test(navigator.userAgent || "");
      const isStandalone = () =>
        (window.matchMedia && window.matchMedia("(display-mode: standalone)").matches) ||
        (window.navigator && window.navigator.standalone === true);

      // Install prompt modal helpers
      function maybeShowInstallPromptModal(force) {
        try {
          if (isStandalone()) return;
          if (!deferredInstallPrompt) return;

          const key = "rnr_install_prompt_dismissed_at";
          const last = Number(localStorage.getItem(key) || 0);
          const now = Date.now();
          const sevenDays = 7 * 24 * 60 * 60 * 1000;

          if (!force && last && (now - last) < sevenDays) return;

          const modal = document.getElementById("install-prompt-modal");
          if (!modal) return;
          modal.classList.remove("hidden");
          lockBodyScroll();
          try { if (typeof lucide !== "undefined") lucide.createIcons(); } catch (e) {}
        } catch (e) {}
      }

      function closeInstallPromptModal(setCooldown) {
        const modal = document.getElementById("install-prompt-modal");
        if (!modal) return;
        modal.classList.add("hidden");
        unlockBodyScroll();
        if (setCooldown) {
          try { localStorage.setItem("rnr_install_prompt_dismissed_at", String(Date.now())); } catch (e) {}
        }
      }

      async function triggerInstallPrompt() {
        try {
          if (isStandalone()) return;
          if (!deferredInstallPrompt) {
            const dbg = document.getElementById("install-prompt-debug");
            if (dbg) {
              dbg.classList.remove("hidden");
              dbg.textContent = (!window.isSecureContext)
                ? "Install requires HTTPS. Open this page using https:// and refresh."
                : "Install isn’t available yet. Ensure /manifest.json and /sw.js are deployed and refresh.";
            } else {
              showToast("Install not available", (!window.isSecureContext) ? "Use https:// then refresh." : "Ensure manifest + service worker are deployed, then refresh.", true, 6500);
            }
            return;
          }

          deferredInstallPrompt.prompt();
          try { await deferredInstallPrompt.userChoice; } catch (e) {}
          deferredInstallPrompt = null;
          refreshInstallButtons();
          closeInstallPromptModal(true);
        } catch (e) {
          closeInstallPromptModal(true);
        }
      }

const refreshInstallButtons = () => {
        // If already installed as an app, hide install UI
        if (isStandalone()) {
          installBtn?.classList.add("hidden");
          installIosBtn?.classList.add("hidden");
          return;
        }

        // Always show a single "Download App" entry on Android/desktop browsers;
        // it will either trigger the install prompt (if available) or show instructions.
        installBtn?.classList.remove("hidden");

        // On iOS Safari, also show the dedicated instruction entry (optional).
        if (isIOS()) installIosBtn?.classList.remove("hidden");
        else installIosBtn?.classList.add("hidden");
      };

      // Android/Chromium: capture prompt when available
      window.addEventListener("beforeinstallprompt", (e) => {
        try { e.preventDefault(); } catch (err) {}
        deferredInstallPrompt = e;
        refreshInstallButtons();
        // Show our own in-app prompt (browser prompt requires a user gesture)
        setTimeout(() => maybeShowInstallPromptModal(false), 800);
      });

      // Initial state
      refreshInstallButtons();

      installBtn?.addEventListener("click", async () => {
        try {
          if (isStandalone()) return;

          if (!window.isSecureContext) {
            showToast("Install requires HTTPS", "Open this page using https:// and refresh.", true, 6500);
            return;
          }

          if (deferredInstallPrompt) {
            deferredInstallPrompt.prompt();
            try { await deferredInstallPrompt.userChoice; } catch (e) {}
            deferredInstallPrompt = null;
            refreshInstallButtons();
          } else if (isIOS()) {
            showToast("Add to Home Screen", "On iPhone/iPad: tap Share, then ‘Add to Home Screen’.", false, 6500);
          } else {
            showToast("Install the app", "In Chrome: tap the menu (⋮) then choose ‘Install app’ or ‘Add to Home screen’.", false, 6500);
          }
        } finally {
          closeMobileMenu();
        }
      });

      installIosBtn?.addEventListener("click", () => {
        showToast("Add to Home Screen", "On iPhone/iPad: tap Share, then ‘Add to Home Screen’.", false, 6500);
        closeMobileMenu();
      });

// Get form elements
      treatmentSelect = document.getElementById("treatment-select");
      durationSelect = document.getElementById("duration-select");

      // Tabs
      document.querySelectorAll(".sidebar-btn").forEach(btn => {
        const tab = btn.dataset.tab;
        if (!tab) return;
        if (btn.disabled) {
          // btn.addEventListener("click", () => showToast("Coming Soon", "That feature is not available yet."));
          return;
        }
        btn.addEventListener("click", () => switchTab(tab));
      });

      // Calendar nav
      document.getElementById("prev-month-btn").addEventListener("click", prevMonth);
      document.getElementById("next-month-btn").addEventListener("click", nextMonth);

      // Treatment selection
      treatmentSelect.addEventListener("change", () => {
        selectedServiceKey = treatmentSelect.value || null;
        selectedStandardDuration = null;
        rebuildDurationOptions();

        availabilityByDate = {};
        availabilityMeta = { maxDriveTimeMinutes: 0, effective_travel_buffer_minutes: 0 };
        availabilityPreloaded = false;
        clearSelectionUI();
        renderCalendar();

        // Reset the locked preload window when treatment changes
        availabilityAnchorMonth = new Date(calendarCurrent.getFullYear(), calendarCurrent.getMonth(), 1);
        __availabilityLoadedContextKey = null;
        __availabilityLoadedRange = null;
        if (!selectedServiceKey) {
          updateAvailabilityStatus("Select your treatment and duration to load live availability.", false);
        } else {
          updateAvailabilityStatus("Now choose a duration to load live availability.", false);
          savePortalState();
        }
      });

      // Duration selection
      durationSelect.addEventListener("change", () => {
        selectedStandardDuration = durationSelect.value ? Number(durationSelect.value) : null;

        availabilityByDate = {};
        availabilityMeta = { maxDriveTimeMinutes: 0, effective_travel_buffer_minutes: 0 };
        availabilityPreloaded = false;
        clearSelectionUI();
        renderCalendar();

        // Reset the locked preload window when duration changes
        availabilityAnchorMonth = new Date(calendarCurrent.getFullYear(), calendarCurrent.getMonth(), 1);
        __availabilityLoadedContextKey = null;
        __availabilityLoadedRange = null;

        if (selectedStandardDuration) {
          maybeLoadAvailabilityForCurrentMonth();
        }
        updateSummary();
        savePortalState();
      });

      // Confirm booking
      document.getElementById("confirm-booking-btn").addEventListener("click", confirmBooking);

      // Logout
      document.getElementById("logout-btn").addEventListener("click", handleLogout);
      document.getElementById("logout-btn-mobile").addEventListener("click", handleLogout);

      // Initial tab
      switchTab("dashboard");

      // Check for existing authentication - this will either show login or load the portal
      await checkExistingAuth();

      // After auth/profile init, restore prior in-progress booking selections (if any)
      try { await restorePortalStateIfPossible(); } catch (e) {}
    }

    // Run on DOM ready
    document.addEventListener("DOMContentLoaded", init);
  </script>
  <!-- Cancel Appointment Modal -->
  <div id="cancel-modal" class="modal-overlay hidden">
    <div class="modal-card">
      <div class="flex items-start justify-between gap-4 mb-3">
        <div>
          <div class="font-serif text-xl text-brand-light">Cancel appointment</div>
          <div class="muted text-sm mt-1" id="cancel-modal-datetime">—</div>
        </div>
        <button class="btn-outline px-3 py-2" onclick="closeCancelModal()">
          <i data-lucide="x" class="w-4 h-4"></i>
        </button>
      </div>

      <!-- Status (loading / success / error) -->
      <div id="cancel-status-wrap" class="hidden mt-2 mb-4">
        <div class="flex items-center gap-3 p-3 border border-brand-gold/20 bg-brand-gold/5 rounded">
          <div id="cancel-status-spinner" class="booking-spinner hidden shrink-0" style="width:28px;height:28px;"></div>
          <div id="cancel-status-check" class="hidden shrink-0" style="width:28px;height:28px;">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#4ade80" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
          </div>
          <div id="cancel-status-x" class="hidden shrink-0" style="width:28px;height:28px;">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#f87171" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </div>
          <div class="min-w-0">
            <div id="cancel-status-text" class="text-sm text-brand-light font-semibold">—</div>
            <div id="cancel-status-subtext" class="muted text-xs mt-0.5">—</div>
          </div>
        </div>
      </div>

      <div class="muted text-sm mb-4">
        Free cancellation until 12 hours before your appointment.
      </div>

      <div id="cancel-reason-wrap">
      <textarea id="cancel-reason" class="input w-full" rows="3" placeholder="Optional: reason for cancelling"></textarea>
      </div>

      <div id="cancel-cutoff-warning" class="hidden mt-4 p-3 border border-amber-500/30 bg-amber-500/10 rounded">
        <div class="font-bold text-brand-light mb-1">This appointment is within 12 hours</div>
        <div class="muted text-sm">
          This is under 12 hours. To cancel, you will be charged a fee of 50% of the treatment. If under 6 hours, it is 100%. If this is an emergency, please contact us directly at <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="056c6b636a45776069647d646b6177606b60722b6664">[email&#160;protected]</a> / 226 337 9064.
        </div>
      </div>

      <div class="flex gap-3 mt-5">
        <button id="cancel-confirm-btn" class="btn-danger flex-1" onclick="confirmCancelAppointment()">Confirm cancel</button>
        <button id="cancel-keep-btn" class="btn-outline flex-1" onclick="closeCancelModal()">Keep appointment</button>
        <button id="cancel-close-btn" class="btn-outline flex-1 hidden" onclick="closeCancelModal()">Done</button>
      </div>
    </div>
  </div>

  <!-- Waitlist Modal -->
  <div id="waitlist-modal" class="modal-overlay hidden">
    <div class="modal-card">
      <div class="flex items-start justify-between gap-4 mb-3">
        <div>
          <div class="font-serif text-xl text-brand-light">Join the waitlist</div>
          <div class="muted text-sm mt-1" id="waitlist-date-label">—</div>
        </div>
        <button class="btn-outline px-3 py-2" onclick="closeWaitlistModal()">
          <i data-lucide="x" class="w-4 h-4"></i>
        </button>
      </div>

      <div class="muted text-sm mb-4">
        If a spot opens up, we’ll notify you.
      </div>

      <textarea id="waitlist-notes" class="input w-full" rows="3" placeholder="Optional: preferences (time of day, notes)"></textarea>

      <div class="flex gap-3 mt-5">
        <button class="btn-filled flex-1" onclick="submitWaitlist()">Join Waitlist</button>
        <button class="btn-outline flex-1" onclick="closeWaitlistModal()">Close</button>
      </div>
    </div>
  </div>

  

  <!-- Review Prompt Modal -->
  <div id="review-prompt-modal" class="modal-overlay hidden" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="review-prompt-title">
      <div class="flex items-start justify-between gap-4 mb-3">
        <div>
          <div id="review-prompt-title" class="font-serif text-xl text-brand-light">We hope you enjoyed your massage</div>
          <div class="muted text-sm mt-1" id="review-prompt-subtitle">—</div>
        </div>
        <button id="review-prompt-x" class="btn-outline px-3 py-2" type="button">
          <i data-lucide="x" class="w-4 h-4"></i>
        </button>
      </div>

      <div class="grid sm:grid-cols-2 gap-4">
        <div>
          <div class="muted text-sm" id="review-prompt-body">
            We hope your massage left you feeling better. If you’re comfortable sharing, we’d love to hear how your experience was. Your feedback helps us continue providing thoughtful, quality care.
          </div>
          <div class="mt-4 flex flex-col gap-2">
            <a id="review-prompt-link" class="btn-filled text-sm py-2 px-4 w-full text-center" target="_blank" rel="noopener" href="https://g.page/r/CVMjbVYTDMv3EAE/review">Leave a Google Review</a>
            <div class="text-xs muted">Or scan the QR code.</div>
          </div>

          <label class="mt-4 flex items-start gap-3 text-sm cursor-pointer select-none">
            <input id="review-prompt-disable" type="checkbox" class="mt-1" />
            <span class="muted">Stop this from popping up in the future</span>
          </label>
        </div>

        <div class="card-fancy p-4 flex items-center justify-center">
          <div class="w-48 max-w-full" id="review-prompt-qr">
<svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
width="2277px" height="2277px" viewBox="0 0 2277 2277" enable-background="new 0 0 2277 2277" xml:space="preserve">
<rect x="0" y="0" width="2277" height="2277" fill="rgb(0,0,0)" /><g transform="translate(138,138)"><g><defs>
    <linearGradient gradientTransform="rotate(90)" id="grad">
    <stop offset="5%" stop-color="rgb(224,197,132)" />
    <stop offset="95%" stop-color="rgb(240,213,148)" />
    </linearGradient>
<mask id="gmask"><g>
<g transform="translate(690,0) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="5,25 75,5 95,75 25,95"/>
</g>
</g></g><g transform="translate(759,0) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(828,0) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(897,0) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(966,0) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1035,0) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="22,0 0,78 78,100 100,22"/>
</g>
</g></g><g transform="translate(552,69) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="5,25 75,5 95,75 25,95"/>
</g>
</g></g><g transform="translate(621,69) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="22,0 0,78 78,100 100,22"/>
</g>
</g></g><g transform="translate(759,69) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,10 90,0 100,90 10,100"/>
</g>
</g></g><g transform="translate(897,69) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,10 90,0 100,90 10,100"/>
</g>
</g></g><g transform="translate(1035,69) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1242,69) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,12 88,0 100,88 12,100"/>
</g>
</g></g><g transform="translate(1311,69) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="22,0 0,78 78,100 100,22"/>
</g>
</g></g><g transform="translate(621,138) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,10 90,0 100,90 10,100"/>
</g>
</g></g><g transform="translate(1035,138) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1242,138) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1311,138) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1380,138) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="15,5 5,85 85,95 95,15"/>
</g>
</g></g><g transform="translate(690,207) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,15 85,0 100,85 15,100"/>
</g>
</g></g><g transform="translate(828,207) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,5 95,0 100,95 5,100"/>
</g>
</g></g><g transform="translate(966,207) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,12 88,0 100,88 12,100"/>
</g>
</g></g><g transform="translate(1035,207) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1104,207) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1173,207) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1242,207) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1311,207) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(552,276) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,15 85,0 100,85 15,100"/>
</g>
</g></g><g transform="translate(828,276) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,10 90,0 100,90 10,100"/>
</g>
</g></g><g transform="translate(966,276) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1035,276) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1173,276) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1311,276) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(690,345) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,12 88,0 100,88 12,100"/>
</g>
</g></g><g transform="translate(759,345) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="15,5 5,85 85,95 95,15"/>
</g>
</g></g><g transform="translate(897,345) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="5,25 75,5 95,75 25,95"/>
</g>
</g></g><g transform="translate(966,345) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1035,345) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1104,345) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1173,345) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,17 83,0 100,83 17,100"/>
</g>
</g></g><g transform="translate(1311,345) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,10 90,0 100,90 10,100"/>
</g>
</g></g><g transform="translate(552,414) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,15 85,0 100,85 15,100"/>
</g>
</g></g><g transform="translate(690,414) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,10 90,0 100,90 10,100"/>
</g>
</g></g><g transform="translate(828,414) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,5 95,0 100,95 5,100"/>
</g>
</g></g><g transform="translate(966,414) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1104,414) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1242,414) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,5 95,0 100,95 5,100"/>
</g>
</g></g><g transform="translate(1380,414) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,15 85,0 100,85 15,100"/>
</g>
</g></g><g transform="translate(621,483) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,5 95,0 100,95 5,100"/>
</g>
</g></g><g transform="translate(828,483) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="13,0 0,87 87,100 100,13"/>
</g>
</g></g><g transform="translate(897,483) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(966,483) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1035,483) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1104,483) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1173,483) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1242,483) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,17 83,0 100,83 17,100"/>
</g>
</g></g><g transform="translate(0,552) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,15 85,0 100,85 15,100"/>
</g>
</g></g><g transform="translate(138,552) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,5 95,0 100,95 5,100"/>
</g>
</g></g><g transform="translate(276,552) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,15 85,0 100,85 15,100"/>
</g>
</g></g><g transform="translate(414,552) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,15 85,0 100,85 15,100"/>
</g>
</g></g><g transform="translate(621,552) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,10 90,0 100,90 10,100"/>
</g>
</g></g><g transform="translate(897,552) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1104,552) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1311,552) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="5,25 75,5 95,75 25,95"/>
</g>
</g></g><g transform="translate(1380,552) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="22,0 0,78 78,100 100,22"/>
</g>
</g></g><g transform="translate(1656,552) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,15 85,0 100,85 15,100"/>
</g>
</g></g><g transform="translate(1863,552) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,15 85,0 100,85 15,100"/>
</g>
</g></g><g transform="translate(69,621) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,12 88,0 100,88 12,100"/>
</g>
</g></g><g transform="translate(138,621) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(207,621) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="22,0 0,78 78,100 100,22"/>
</g>
</g></g><g transform="translate(345,621) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,5 95,0 100,95 5,100"/>
</g>
</g></g><g transform="translate(552,621) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,15 85,0 100,85 15,100"/>
</g>
</g></g><g transform="translate(897,621) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(966,621) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="15,5 5,85 85,95 95,15"/>
</g>
</g></g><g transform="translate(1104,621) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1173,621) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1242,621) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="15,5 5,85 85,95 95,15"/>
</g>
</g></g><g transform="translate(1380,621) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="13,0 0,87 87,100 100,13"/>
</g>
</g></g><g transform="translate(1449,621) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1518,621) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="22,0 0,78 78,100 100,22"/>
</g>
</g></g><g transform="translate(1725,621) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,15 85,0 100,85 15,100"/>
</g>
</g></g><g transform="translate(1932,621) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,5 95,0 100,95 5,100"/>
</g>
</g></g><g transform="translate(0,690) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,12 88,0 100,88 12,100"/>
</g>
</g></g><g transform="translate(69,690) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(138,690) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(207,690) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(276,690) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(345,690) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(414,690) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="15,5 5,85 85,95 95,15"/>
</g>
</g></g><g transform="translate(690,690) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,15 85,0 100,85 15,100"/>
</g>
</g></g><g transform="translate(897,690) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1104,690) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,10 90,0 100,90 10,100"/>
</g>
</g></g><g transform="translate(1449,690) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="13,0 0,87 87,100 100,13"/>
</g>
</g></g><g transform="translate(1518,690) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1587,690) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1656,690) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="15,5 5,85 85,95 95,15"/>
</g>
</g></g><g transform="translate(1794,690) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="5,25 75,5 95,75 25,95"/>
</g>
</g></g><g transform="translate(1863,690) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1932,690) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,17 83,0 100,83 17,100"/>
</g>
</g></g><g transform="translate(0,759) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,10 90,0 100,90 10,100"/>
</g>
</g></g><g transform="translate(483,759) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="5,25 75,5 95,75 25,95"/>
</g>
</g></g><g transform="translate(552,759) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(621,759) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="15,5 5,85 85,95 95,15"/>
</g>
</g></g><g transform="translate(897,759) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="13,0 0,87 87,100 100,13"/>
</g>
</g></g><g transform="translate(966,759) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="22,0 0,78 78,100 100,22"/>
</g>
</g></g><g transform="translate(1173,759) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,15 85,0 100,85 15,100"/>
</g>
</g></g><g transform="translate(1311,759) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,12 88,0 100,88 12,100"/>
</g>
</g></g><g transform="translate(1380,759) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="22,0 0,78 78,100 100,22"/>
</g>
</g></g><g transform="translate(1518,759) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1587,759) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,17 83,0 100,83 17,100"/>
</g>
</g></g><g transform="translate(1863,759) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(138,828) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="5,25 75,5 95,75 25,95"/>
</g>
</g></g><g transform="translate(207,828) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="22,0 0,78 78,100 100,22"/>
</g>
</g></g><g transform="translate(414,828) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,15 85,0 100,85 15,100"/>
</g>
</g></g><g transform="translate(552,828) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(690,828) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="5,25 75,5 95,75 25,95"/>
</g>
</g></g><g transform="translate(759,828) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(828,828) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="15,5 5,85 85,95 95,15"/>
</g>
</g></g><g transform="translate(966,828) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,10 90,0 100,90 10,100"/>
</g>
</g></g><g transform="translate(1311,828) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1380,828) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1449,828) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1518,828) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1725,828) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,5 95,0 100,95 5,100"/>
</g>
</g></g><g transform="translate(1863,828) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="13,0 0,87 87,100 100,13"/>
</g>
</g></g><g transform="translate(1932,828) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="22,0 0,78 78,100 100,22"/>
</g>
</g></g><g transform="translate(0,897) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,15 85,0 100,85 15,100"/>
</g>
</g></g><g transform="translate(207,897) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(276,897) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="15,5 5,85 85,95 95,15"/>
</g>
</g></g><g transform="translate(483,897) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,12 88,0 100,88 12,100"/>
</g>
</g></g><g transform="translate(552,897) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(621,897) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="15,5 5,85 85,95 95,15"/>
</g>
</g></g><g transform="translate(1104,897) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="5,25 75,5 95,75 25,95"/>
</g>
</g></g><g transform="translate(1173,897) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="15,5 5,85 85,95 95,15"/>
</g>
</g></g><g transform="translate(1311,897) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="13,0 0,87 87,100 100,13"/>
</g>
</g></g><g transform="translate(1380,897) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1449,897) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1518,897) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1725,897) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1932,897) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(69,966) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,15 85,0 100,85 15,100"/>
</g>
</g></g><g transform="translate(207,966) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(345,966) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,12 88,0 100,88 12,100"/>
</g>
</g></g><g transform="translate(414,966) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(483,966) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(552,966) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(759,966) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,12 88,0 100,88 12,100"/>
</g>
</g></g><g transform="translate(828,966) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(897,966) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="15,5 5,85 85,95 95,15"/>
</g>
</g></g><g transform="translate(1380,966) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1449,966) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1518,966) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,17 83,0 100,83 17,100"/>
</g>
</g></g><g transform="translate(1656,966) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="5,25 75,5 95,75 25,95"/>
</g>
</g></g><g transform="translate(1725,966) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1863,966) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,12 88,0 100,88 12,100"/>
</g>
</g></g><g transform="translate(1932,966) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,17 83,0 100,83 17,100"/>
</g>
</g></g><g transform="translate(138,1035) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,12 88,0 100,88 12,100"/>
</g>
</g></g><g transform="translate(207,1035) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(345,1035) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(552,1035) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(621,1035) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="22,0 0,78 78,100 100,22"/>
</g>
</g></g><g transform="translate(759,1035) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(828,1035) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,17 83,0 100,83 17,100"/>
</g>
</g></g><g transform="translate(1104,1035) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,12 88,0 100,88 12,100"/>
</g>
</g></g><g transform="translate(1173,1035) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="15,5 5,85 85,95 95,15"/>
</g>
</g></g><g transform="translate(1380,1035) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,10 90,0 100,90 10,100"/>
</g>
</g></g><g transform="translate(1587,1035) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,5 95,0 100,95 5,100"/>
</g>
</g></g><g transform="translate(1725,1035) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1863,1035) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(138,1104) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="13,0 0,87 87,100 100,13"/>
</g>
</g></g><g transform="translate(207,1104) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(276,1104) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(345,1104) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(414,1104) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="15,5 5,85 85,95 95,15"/>
</g>
</g></g><g transform="translate(552,1104) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="13,0 0,87 87,100 100,13"/>
</g>
</g></g><g transform="translate(621,1104) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(759,1104) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1035,1104) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="5,25 75,5 95,75 25,95"/>
</g>
</g></g><g transform="translate(1104,1104) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,17 83,0 100,83 17,100"/>
</g>
</g></g><g transform="translate(1518,1104) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,12 88,0 100,88 12,100"/>
</g>
</g></g><g transform="translate(1587,1104) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,17 83,0 100,83 17,100"/>
</g>
</g></g><g transform="translate(1725,1104) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1863,1104) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="13,0 0,87 87,100 100,13"/>
</g>
</g></g><g transform="translate(1932,1104) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="22,0 0,78 78,100 100,22"/>
</g>
</g></g><g transform="translate(69,1173) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,15 85,0 100,85 15,100"/>
</g>
</g></g><g transform="translate(276,1173) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,10 90,0 100,90 10,100"/>
</g>
</g></g><g transform="translate(621,1173) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(690,1173) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(759,1173) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(897,1173) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,15 85,0 100,85 15,100"/>
</g>
</g></g><g transform="translate(1311,1173) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="5,25 75,5 95,75 25,95"/>
</g>
</g></g><g transform="translate(1380,1173) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1449,1173) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1518,1173) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,17 83,0 100,83 17,100"/>
</g>
</g></g><g transform="translate(1725,1173) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="13,0 0,87 87,100 100,13"/>
</g>
</g></g><g transform="translate(1794,1173) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="15,5 5,85 85,95 95,15"/>
</g>
</g></g><g transform="translate(1932,1173) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(0,1242) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,15 85,0 100,85 15,100"/>
</g>
</g></g><g transform="translate(207,1242) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,15 85,0 100,85 15,100"/>
</g>
</g></g><g transform="translate(414,1242) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="5,25 75,5 95,75 25,95"/>
</g>
</g></g><g transform="translate(483,1242) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(552,1242) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(621,1242) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(759,1242) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(966,1242) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,5 95,0 100,95 5,100"/>
</g>
</g></g><g transform="translate(1449,1242) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,10 90,0 100,90 10,100"/>
</g>
</g></g><g transform="translate(1863,1242) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,12 88,0 100,88 12,100"/>
</g>
</g></g><g transform="translate(1932,1242) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,17 83,0 100,83 17,100"/>
</g>
</g></g><g transform="translate(69,1311) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="5,25 75,5 95,75 25,95"/>
</g>
</g></g><g transform="translate(138,1311) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="22,0 0,78 78,100 100,22"/>
</g>
</g></g><g transform="translate(483,1311) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(552,1311) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(621,1311) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(759,1311) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,10 90,0 100,90 10,100"/>
</g>
</g></g><g transform="translate(897,1311) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="5,25 75,5 95,75 25,95"/>
</g>
</g></g><g transform="translate(966,1311) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1035,1311) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1104,1311) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1173,1311) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1242,1311) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="15,5 5,85 85,95 95,15"/>
</g>
</g></g><g transform="translate(1518,1311) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,5 95,0 100,95 5,100"/>
</g>
</g></g><g transform="translate(1656,1311) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,12 88,0 100,88 12,100"/>
</g>
</g></g><g transform="translate(1725,1311) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="15,5 5,85 85,95 95,15"/>
</g>
</g></g><g transform="translate(1863,1311) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,10 90,0 100,90 10,100"/>
</g>
</g></g><g transform="translate(0,1380) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,15 85,0 100,85 15,100"/>
</g>
</g></g><g transform="translate(138,1380) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,10 90,0 100,90 10,100"/>
</g>
</g></g><g transform="translate(276,1380) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="5,25 75,5 95,75 25,95"/>
</g>
</g></g><g transform="translate(345,1380) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(414,1380) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(483,1380) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(552,1380) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(621,1380) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,17 83,0 100,83 17,100"/>
</g>
</g></g><g transform="translate(828,1380) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,15 85,0 100,85 15,100"/>
</g>
</g></g><g transform="translate(966,1380) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1104,1380) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1173,1380) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1380,1380) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,12 88,0 100,88 12,100"/>
</g>
</g></g><g transform="translate(1449,1380) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1518,1380) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1587,1380) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1656,1380) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(552,1449) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,10 90,0 100,90 10,100"/>
</g>
</g></g><g transform="translate(690,1449) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,15 85,0 100,85 15,100"/>
</g>
</g></g><g transform="translate(966,1449) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="13,0 0,87 87,100 100,13"/>
</g>
</g></g><g transform="translate(1035,1449) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1104,1449) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1173,1449) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1242,1449) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1311,1449) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1380,1449) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1656,1449) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1794,1449) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="5,25 75,5 95,75 25,95"/>
</g>
</g></g><g transform="translate(1863,1449) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1932,1449) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="22,0 0,78 78,100 100,22"/>
</g>
</g></g><g transform="translate(759,1518) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="5,25 75,5 95,75 25,95"/>
</g>
</g></g><g transform="translate(828,1518) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(897,1518) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="15,5 5,85 85,95 95,15"/>
</g>
</g></g><g transform="translate(1173,1518) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1380,1518) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1518,1518) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,15 85,0 100,85 15,100"/>
</g>
</g></g><g transform="translate(1656,1518) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1725,1518) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="22,0 0,78 78,100 100,22"/>
</g>
</g></g><g transform="translate(1863,1518) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="13,0 0,87 87,100 100,13"/>
</g>
</g></g><g transform="translate(1932,1518) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(621,1587) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,5 95,0 100,95 5,100"/>
</g>
</g></g><g transform="translate(1035,1587) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,15 85,0 100,85 15,100"/>
</g>
</g></g><g transform="translate(1173,1587) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1380,1587) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1656,1587) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1725,1587) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,17 83,0 100,83 17,100"/>
</g>
</g></g><g transform="translate(1932,1587) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(552,1656) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="5,25 75,5 95,75 25,95"/>
</g>
</g></g><g transform="translate(621,1656) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(690,1656) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="22,0 0,78 78,100 100,22"/>
</g>
</g></g><g transform="translate(828,1656) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,5 95,0 100,95 5,100"/>
</g>
</g></g><g transform="translate(1104,1656) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,12 88,0 100,88 12,100"/>
</g>
</g></g><g transform="translate(1173,1656) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1242,1656) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="22,0 0,78 78,100 100,22"/>
</g>
</g></g><g transform="translate(1380,1656) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1449,1656) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1518,1656) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1587,1656) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1656,1656) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1863,1656) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,12 88,0 100,88 12,100"/>
</g>
</g></g><g transform="translate(1932,1656) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(690,1725) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="13,0 0,87 87,100 100,13"/>
</g>
</g></g><g transform="translate(759,1725) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(828,1725) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,17 83,0 100,83 17,100"/>
</g>
</g></g><g transform="translate(1035,1725) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="5,25 75,5 95,75 25,95"/>
</g>
</g></g><g transform="translate(1104,1725) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1173,1725) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1242,1725) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1380,1725) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,10 90,0 100,90 10,100"/>
</g>
</g></g><g transform="translate(1587,1725) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="13,0 0,87 87,100 100,13"/>
</g>
</g></g><g transform="translate(1656,1725) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1794,1725) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="5,25 75,5 95,75 25,95"/>
</g>
</g></g><g transform="translate(1863,1725) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1932,1725) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(552,1794) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="5,25 75,5 95,75 25,95"/>
</g>
</g></g><g transform="translate(621,1794) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="15,5 5,85 85,95 95,15"/>
</g>
</g></g><g transform="translate(966,1794) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,15 85,0 100,85 15,100"/>
</g>
</g></g><g transform="translate(1173,1794) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1242,1794) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1311,1794) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="22,0 0,78 78,100 100,22"/>
</g>
</g></g><g transform="translate(1449,1794) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,5 95,0 100,95 5,100"/>
</g>
</g></g><g transform="translate(1656,1794) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1725,1794) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="15,5 5,85 85,95 95,15"/>
</g>
</g></g><g transform="translate(1932,1794) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,10 90,0 100,90 10,100"/>
</g>
</g></g><g transform="translate(759,1863) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="5,25 75,5 95,75 25,95"/>
</g>
</g></g><g transform="translate(828,1863) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(897,1863) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="22,0 0,78 78,100 100,22"/>
</g>
</g></g><g transform="translate(1035,1863) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="5,25 75,5 95,75 25,95"/>
</g>
</g></g><g transform="translate(1104,1863) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1173,1863) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1242,1863) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1311,1863) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1380,1863) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1449,1863) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,17 83,0 100,83 17,100"/>
</g>
</g></g><g transform="translate(1656,1863) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(1863,1863) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,5 95,0 100,95 5,100"/>
</g>
</g></g><g transform="translate(552,1932) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="5,25 75,5 95,75 25,95"/>
</g>
</g></g><g transform="translate(621,1932) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<polygon points="8,4 4,92 92,96 96,8"/>
</g></g><g transform="translate(690,1932) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="15,5 5,85 85,95 95,15"/>
</g>
</g></g><g transform="translate(897,1932) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,10 90,0 100,90 10,100"/>
</g>
</g></g><g transform="translate(1104,1932) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,10 90,0 100,90 10,100"/>
</g>
</g></g><g transform="translate(1380,1932) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,10 90,0 100,90 10,100"/>
</g>
</g></g><g transform="translate(1587,1932) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="5,25 75,5 95,75 25,95"/>
</g>
</g></g><g transform="translate(1656,1932) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="0,17 83,0 100,83 17,100"/>
</g>
</g></g><g transform="translate(1863,1932) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="13,0 0,87 87,100 100,13"/>
</g>
</g></g><g transform="translate(1932,1932) scale(0.69,0.69)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
	<polygon points="15,5 5,85 85,95 95,15"/>
</g>
</g></g><g transform="translate(0,0) scale(4.83, 4.83)"><g transform=" translate(0,100) scale(1,-1) " style="fill: rgb(255, 255, 255);">
<g>
</g>
<g>
	<path fill="none" d="M15.02,34.145L15.004,85H66.25C76.589,85,85,76.414,85,65.86V15H33.78C23.436,15,15.02,23.586,15.02,34.145z"
		/>
	<path d="M66.25,0H33.78C15.16,0,0.02,15.32,0.02,34.14L0,100h66.25C84.86,100,100,84.68,100,65.86V34.14V0H66.25z M85,65.86
		C85,76.414,76.589,85,66.25,85H15.004l0.016-50.855C15.02,23.586,23.436,15,33.78,15H85V65.86z"/>
</g>
</g></g><g transform="translate(1518,0) scale(4.83, 4.83)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
</g>
<g>
	<path fill="none" d="M15.02,34.145L15.004,85H66.25C76.589,85,85,76.414,85,65.86V15H33.78C23.436,15,15.02,23.586,15.02,34.145z"
		/>
	<path d="M66.25,0H33.78C15.16,0,0.02,15.32,0.02,34.14L0,100h66.25C84.86,100,100,84.68,100,65.86V34.14V0H66.25z M85,65.86
		C85,76.414,76.589,85,66.25,85H15.004l0.016-50.855C15.02,23.586,23.436,15,33.78,15H85V65.86z"/>
</g>
</g></g><g transform="translate(0,1518) scale(4.83, 4.83)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
</g>
<g>
	<path fill="none" d="M15.02,34.145L15.004,85H66.25C76.589,85,85,76.414,85,65.86V15H33.78C23.436,15,15.02,23.586,15.02,34.145z"
		/>
	<path d="M66.25,0H33.78C15.16,0,0.02,15.32,0.02,34.14L0,100h66.25C84.86,100,100,84.68,100,65.86V34.14V0H66.25z M85,65.86
		C85,76.414,76.589,85,66.25,85H15.004l0.016-50.855C15.02,23.586,23.436,15,33.78,15H85V65.86z"/>
</g>
</g></g><g transform="translate(138,138) scale(2.07, 2.07)"><g transform=" translate(0,100) scale(1,-1) " style="fill: rgb(255, 255, 255);">
<g>
</g>
<path d="M72.744-0.021H27.23c-2.341,0-4.612,0.297-6.771,0.875C15.679,2.11,11.418,4.648,8.04,8.09
	c-0.617,0.621-1.206,1.284-1.752,1.96c-3.883,4.767-6.21,10.903-6.21,17.561L0.05,99.979h72.694
	c14.971,0,27.138-12.397,27.138-27.63V27.625v-0.014l0.168-27.617C100.05-0.006,82.107-0.021,72.744-0.021z"/>
</g></g><g transform="translate(1656,138) scale(2.07, 2.07)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
</g>
<path d="M72.744-0.021H27.23c-2.341,0-4.612,0.297-6.771,0.875C15.679,2.11,11.418,4.648,8.04,8.09
	c-0.617,0.621-1.206,1.284-1.752,1.96c-3.883,4.767-6.21,10.903-6.21,17.561L0.05,99.979h72.694
	c14.971,0,27.138-12.397,27.138-27.63V27.625v-0.014l0.168-27.617C100.05-0.006,82.107-0.021,72.744-0.021z"/>
</g></g><g transform="translate(138,1656) scale(2.07, 2.07)"><g transform="" style="fill: rgb(255, 255, 255);">
<g>
</g>
<path d="M72.744-0.021H27.23c-2.341,0-4.612,0.297-6.771,0.875C15.679,2.11,11.418,4.648,8.04,8.09
	c-0.617,0.621-1.206,1.284-1.752,1.96c-3.883,4.767-6.21,10.903-6.21,17.561L0.05,99.979h72.694
	c14.971,0,27.138-12.397,27.138-27.63V27.625v-0.014l0.168-27.617C100.05-0.006,82.107-0.021,72.744-0.021z"/>
</g></g></g></mask></defs></g><rect x="0" y="0" width="2001" height="2001" fill="url(#grad)" mask="url(#gmask)" /></g></svg>
          </div>
        </div>
      </div>

      <div class="flex gap-3 mt-5">
        <button id="review-prompt-dismiss" class="btn-outline flex-1" type="button">Dismiss</button>
      </div>
    </div>
  </div>


  <!-- Receipt / Invoice Modal -->
  <div id="invoice-modal" class="modal-overlay hidden">
    <div class="modal-card">
      <div class="flex items-start justify-between gap-4 mb-3">
        <div>
          <div class="font-serif text-xl text-brand-light">Receipt</div>
          <div class="muted text-sm mt-1" id="invoice-modal-subtitle">—</div>
        </div>
        <button class="btn-outline px-3 py-2" onclick="closeInvoiceModal()">
          <i data-lucide="x" class="w-4 h-4"></i>
        </button>
      </div>

      <div id="invoice-modal-body" class="text-sm">
        <div class="muted">Loading…</div>
      </div>

      <div class="flex gap-3 mt-5">
        <button class="btn-outline flex-1" onclick="closeInvoiceModal()">Close</button>
      </div>
    </div>
  </div>

  <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
    // PWA SW registration (v4)
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', async () => {
        try {
          const reg = await navigator.serviceWorker.register('/sw.js');

          // If there's a waiting worker, trigger it to activate immediately
          if (reg.waiting) {
            reg.waiting.postMessage({ type: 'SKIP_WAITING' });
          }

          reg.addEventListener('updatefound', () => {
            const sw = reg.installing;
            if (!sw) return;
            sw.addEventListener('statechange', () => {
              if (sw.state === 'installed' && navigator.serviceWorker.controller) {
                // New version installed; activate ASAP
                reg.waiting && reg.waiting.pos
