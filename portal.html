<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Client Portal | Relax & Renew RMT</title>
  <meta name="description" content="Relax & Renew Client Portal — rebook appointments, view your details, and manage your membership." />

  <!-- Meta Pixel -->
  <script>
  !function(f,b,e,v,n,t,s)
  {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
  n.callMethod.apply(n,arguments):n.queue.push(arguments)};
  if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
  n.queue=[];t=b.createElement(e);t.async=!0;
  t.src=v;s=b.getElementsByTagName(e)[0];
  s.parentNode.insertBefore(t,s)}(window, document,'script',
  'https://connect.facebook.net/en_US/fbevents.js');
  fbq('init', '701194265870298');
  fbq('track', 'PageView');
  </script>
  <noscript><img height="1" width="1" style="display:none"
  src="https://www.facebook.com/tr?id=701194265870298&ev=PageView&noscript=1"
  /></noscript>

  <!-- Google Analytics / Ads -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=AW-17575022013"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-J4NC9FL44H');
    gtag('config', 'AW-17575022013');
  </script>

  <!-- Suppress noisy third-party errors -->
  <script>
    window.onerror = function(msg, url, line, col, error) {
      if (!url || (msg && String(msg).toLowerCase().indexOf("script error") > -1)) return true;
      return false;
    };
    window.addEventListener('unhandledrejection', function(event) { event.preventDefault(); });
  </script>

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;0,700;1,400&display=swap" rel="stylesheet">

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            gold: '#E0C584',
                            goldHover: '#F0D594',
                            light: '#F0E2C0', 
                            dim: 'rgba(240, 226, 192, 0.6)',
                            black: '#050505',
                            dark: '#0a0a0a',
                            panel: 'rgba(20, 20, 20, 0.7)',
                        }
                    },
                    fontFamily: {
                        serif: ['"Cormorant Garamond"', 'serif'],
                    },
                    backgroundImage: {
                        'hero-pattern': "linear-gradient(to bottom, rgba(0,0,0,0.3), rgba(0,0,0,0.9)), url('https://static.wixstatic.com/media/bf8fef_94f8be278f0f4b8abaee73b95d03b5e2~mv2.png')",
                        'alternate-pattern': "linear-gradient(to bottom, rgba(0,0,0,0.8), rgba(0,0,0,0.95)), url('https://static.wixstatic.com/media/bf8fef_7776f5b067be4025a75ed7e149bb1d7e~mv2.jpg')",
                        'gift-card-bg': "url('https://static.wixstatic.com/media/bf8fef_9da7c8e6be37443d89cac9f6884ec878~mv2.jpg')"
                    },
                    animation: {
                        'fade-in-up': 'fadeInUp 1s ease-out forwards',
                        'subtle-bounce': 'subtleBounce 3s ease-in-out infinite',
                        'loading-bar': 'loadingBar 1.5s ease-in-out infinite',
                    },
                    keyframes: {
                        fadeInUp: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' }
                        },
                        subtleBounce: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-3px)' }
                        },
                        loadingBar: {
                            '0%': { transform: 'translateX(-100%)' },
                            '100%': { transform: 'translateX(300%)' }
                        }
                    }
                }
            }
        };
  </script>

  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <!-- Auth0 Lock (Embedded Email + Password Window) -->
  <script src="https://cdn.auth0.com/js/lock/14.2.0/lock.min.js"></script>

  <style>
    :root {
      --brand-black: #050505;
      --brand-gold: #E0C584;
      --brand-gold-hover: #F0D594;
      --brand-light: #F0E2C0;
      --brand-dim: rgba(240, 226, 192, 0.6);
      --radius: 0.25rem;
      --shadow: 0 10px 30px rgba(0,0,0,0.55);
    }

    html, body { min-height: 100vh; height: auto; }
    html { background-color: #050505; }
    html, body { min-height: 100%; height: auto; }
    body { min-height: 100vh; }

    
    body {
      font-family: 'Cormorant Garamond', serif;
      background-color: #050505; 
      color: var(--brand-light);
      overflow-x: hidden;
    }

    /* =========================================
       FIXED: Header Navigation (From Index.html)
       ========================================= */
    .fixed-nav { 
        position: fixed; top: 0; left: 0; width: 100%; height: 80px; 
        z-index: 50; 
        transition: all 0.4s ease; 
        background: rgba(5, 5, 5, 0.95); 
        backdrop-filter: blur(15px); 
        border-bottom: 1px solid rgba(224, 197, 132, 0.2); 
        display: flex; align-items: center; 
    }
    
    .nav-link { 
        color: #F0E2C0; 
        text-transform: uppercase; 
        font-size: 0.8rem; 
        font-weight: 600; 
        letter-spacing: 0.15em; 
        text-decoration: none; 
        position: relative; 
        padding-bottom: 5px; 
    }
    .nav-link::after { 
        content: ''; position: absolute; bottom: 0; left: 0; width: 0; height: 1px; 
        background: #E0C584; transition: width 0.3s ease; 
    }
    .nav-link:hover::after { width: 100%; }

    /* Mobile Menu (Portal) */
    .mobile-menu {
      background: #050505;
      transform: translateX(100%);
      transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
      overscroll-behavior: contain;
      -webkit-overflow-scrolling: touch;
      will-change: transform;
    }
    .mobile-menu.open { transform: translateX(0); }

    .mobile-menu-backdrop.open {
      opacity: 1;
      pointer-events: auto;
    }

    html.menu-open,
    body.menu-open {
      overflow: hidden !important;
      height: 100%;
    }

    .header-hero { background: linear-gradient(145deg, rgba(8,8,8,0.95), rgba(5,5,5,0.98)); }

    /* Cards */
    .card-fancy, .glass-panel {
      background: linear-gradient(145deg, rgba(20,20,20,0.8), rgba(10,10,10,0.9));
      border: 1px solid rgba(224, 197, 132, 0.1);
      backdrop-filter: blur(10px);
      transition: all 0.4s ease;
      position: relative;
      overflow: hidden;
      border-radius: var(--radius);
    }
    .card-fancy::before, .glass-panel::before {
      content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 2px;
      background: linear-gradient(90deg, transparent, #E0C584, transparent);
      transform: scaleX(0); transition: transform 0.5s ease;
    }
    .card-fancy:hover, .glass-panel:hover { border-color: rgba(224, 197, 132, 0.3); }
    .card-fancy:hover::before, .glass-panel:hover::before { transform: scaleX(1); }

    /* Buttons */
    .btn-outline {
      border: 1px solid #E0C584; color: #E0C584; background: transparent;
      padding: 0.6rem 1.5rem; text-transform: uppercase; font-weight: 700; letter-spacing: 0.1em;
      transition: 0.3s; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; cursor: pointer;
    }
    .btn-outline:hover {
      background: rgba(224, 197, 132, 0.1); color: #F0E2C0; border-color: #F0D594;
      box-shadow: 0 0 15px rgba(224, 197, 132, 0.2);
    }
    .btn-filled {
      background: #E0C584; color: #000; border: 1px solid #E0C584;
      padding: 0.6rem 1.5rem; text-transform: uppercase; font-weight: 700; letter-spacing: 0.1em;
      transition: 0.3s; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; cursor: pointer;
    }
    .btn-filled:hover {
      background: #F0D594; border-color: #F0D594; transform: translateY(-1px);
      box-shadow: 0 5px 15px rgba(224, 197, 132, 0.3);
    }
    .btn-disabled {
      opacity: 0.5; cursor: not-allowed; background: #333 !important; border-color: #444 !important; color: #777 !important;
      box-shadow: none !important; transform: none !important;
    }

    /* Inputs */
    .input {
      width: 100%; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(224, 197, 132, 0.3);
      color: var(--brand-light); padding: 0.6rem 1rem; border-radius: 0.25rem; outline: none; font-size: 1rem;
      min-height: 48px;
      max-width: 100%; /* Prevent overflow */
    }
    /* Fixed Dropdowns: Custom arrow, dark background for options */
    select.input {
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      padding-right: 2.5rem;
      background-color: rgba(5,5,5,0.8);
      /* Custom Gold Chevron */
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23E0C584' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
      background-position: right 0.5rem center;
      background-repeat: no-repeat;
      background-size: 1.5em 1.5em;
    }
    .input:focus { border-color: #E0C584; background-color: rgba(255, 255, 255, 0.1); }
    
    /* Ensure Dropdown Options are Black */
    select.input option {
      background-color: #050505;
      color: #F0E2C0;
      padding: 10px;
    }

    /* Sidebar */
    .sidebar-btn {
      width: 100%; display: flex; gap: 0.7rem; align-items: center; padding: 0.75rem 1rem;
      border: 1px solid transparent; border-radius: var(--radius); color: rgba(240, 226, 192, 0.6);
      transition: all 0.3s ease; font-size: 1.05rem; background: transparent;
    }
    .sidebar-btn:hover { background: rgba(224, 197, 132, 0.05); color: #E0C584; }
    .sidebar-btn.active { background: rgba(224, 197, 132, 0.1); border: 1px solid rgba(224, 197, 132, 0.2); color: #E0C584; }

    /* Calendar */
    .calendar-day {
      width: 100%; aspect-ratio: 1/1; display: flex; align-items: center; justify-content: center;
      border: 1px solid rgba(224, 197, 132, 0.1); background: rgba(255,255,255,0.02);
      border-radius: var(--radius); font-weight: 600; transition: all 0.2s ease; user-select: none; color: var(--brand-light);
    }
    .calendar-day-available { cursor: pointer; }
    .calendar-day-available:hover { border-color: #E0C584; background: rgba(224, 197, 132, 0.1); transform: scale(1.05); }
    .calendar-day-disabled { background: rgba(0, 0, 0, 0.3); color: rgba(240, 226, 192, 0.2); cursor: not-allowed; border-color: transparent; }
    .calendar-day-selected { background: #E0C584 !important; color: #000 !important; border-color: #E0C584 !important; font-weight: bold; box-shadow: 0 0 10px rgba(224,197,132,0.3); }
    .calendar-day-today { border-color: #F0E2C0; }

    /* Slots */
    .time-slot-btn {
      width: 100%; display: flex; align-items: center; justify-content: center; gap: 0.5rem;
      padding: 0.6rem; border: 1px solid rgba(224, 197, 132, 0.2); background: rgba(255,255,255,0.03);
      border-radius: var(--radius); transition: all 0.2s ease; font-weight: 600; color: var(--brand-light);
    }
    .time-slot-btn:hover { border-color: #E0C584; background: rgba(224, 197, 132, 0.1); }
    .time-slot-selected { background: #E0C584 !important; color: #000 !important; border-color: #E0C584 !important; }
    .time-slot-unavailable { opacity: 0.4; cursor: not-allowed; border-color: transparent; }

    .pill {
      background: rgba(224, 197, 132, 0.08); border: 1px solid rgba(224, 197, 132, 0.2); color: #F0E2C0;
      display: inline-flex; align-items: center; gap: 0.4rem; padding: 0.3rem 0.8rem; border-radius: 4px;
      font-size: 0.9rem; letter-spacing: 0.05em;
    }
    .muted { color: var(--brand-dim); }
    .divider { border-color: rgba(224, 197, 132, 0.15); }
    
    .toast {
      background: rgba(20, 20, 20, 0.95); border: 1px solid #E0C584; color: #E0C584;
      box-shadow: 0 10px 30px rgba(0,0,0,0.8); backdrop-filter: blur(10px);
    }

    /* =========================================
       FIXED: Login Overlay CSS
       ========================================= */
    #login-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 200; /* Higher than nav */
      background: #000000;
      /* backdrop-filter removed for solid overlay */
      display: flex;
      align-items: center;
      justify-content: center;
      transition: opacity 0.4s ease, visibility 0.4s ease;
    
      height: 100dvh;
    
      overflow: auto;
    
      pointer-events: auto;
      touch-action: manipulation;
    }
    #login-overlay.hidden {
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
    }
    .login-card {
      background: #050505;
      border: 1px solid rgba(224, 197, 132, 0.25);
      backdrop-filter: blur(10px);
      padding: 2.5rem 2rem;
      max-width: 420px;
      width: 90%;
      position: relative;
    }
    .login-card::before {
      content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 2px;
      background: linear-gradient(90deg, transparent, #E0C584, transparent);
    }

    /* =========================================
       FIXED: Auth0 Lock Styles (Robust Overrides)
       ========================================= */
    #auth0-lock-container { width: 100% !important; }
    #auth0-lock-container .auth0-lock,
    #auth0-lock-container .auth0-lock * {
      font-family: 'Cormorant Garamond', serif !important;
      border-radius: 0px !important;
      box-shadow: none !important;
    }
    #auth0-lock-container .auth0-lock .auth0-lock-widget {
      background: #050505 !important;
      border: 1px solid rgba(224,197,132,0.45) !important;
      overflow: hidden !important;
    }
    #auth0-lock-container .auth0-lock .auth0-lock-header,
    #auth0-lock-container .auth0-lock .auth0-lock-header-bg,
    #auth0-lock-container .auth0-lock .auth0-lock-footer,
    #auth0-lock-container .auth0-lock .auth0-lock-name,
    #auth0-lock-container .auth0-lock .auth0-lock-badge {
      display: none !important;
    }
    #auth0-lock-container .auth0-lock,
    #auth0-lock-container .auth0-lock .auth0-lock-content,
    #auth0-lock-container .auth0-lock .auth0-lock-pane,
    #auth0-lock-container .auth0-lock .auth0-lock-cred-pane,
    #auth0-lock-container .auth0-lock .auth0-lock-center,
    #auth0-lock-container .auth0-lock .auth0-lock-form,
    #auth0-lock-container .auth0-lock .auth0-lock-body-content,
    #auth0-lock-container .auth0-lock .auth0-lock-signup,
    #auth0-lock-container .auth0-lock .auth0-lock-terms,
    #auth0-lock-container .auth0-lock .auth0-lock-message,
    #auth0-lock-container .auth0-lock .auth0-lock-warning,
    #auth0-lock-container .auth0-lock .auth0-lock-error,
    #auth0-lock-container .auth0-lock .auth0-lock-error-msg {
      background: #050505 !important;
    }
    #auth0-lock-container .auth0-lock,
    #auth0-lock-container .auth0-lock label,
    #auth0-lock-container .auth0-lock p,
    #auth0-lock-container .auth0-lock .auth0-lock-alternative,
    #auth0-lock-container .auth0-lock .auth0-lock-terms {
      color: rgba(240,226,192,0.92) !important;
    }
    #auth0-lock-container .auth0-lock label {
      color: #E0C584 !important;
      font-weight: 700 !important;
      letter-spacing: 0.04em !important;
    }
    #auth0-lock-container .auth0-lock .auth0-lock-tabs,
    #auth0-lock-container .auth0-lock .auth0-lock-tabs-container {
      background: #050505 !important;
      border-bottom: 1px solid rgba(224,197,132,0.25) !important;
    }
    #auth0-lock-container .auth0-lock .auth0-lock-tabs li a,
    #auth0-lock-container .auth0-lock .auth0-lock-tabs li span {
      background: #050505 !important;
      color: rgba(240,226,192,0.70) !important;
      text-transform: uppercase !important;
      letter-spacing: 0.14em !important;
      font-weight: 700 !important;
      font-size: 0.72rem !important;
      padding: 18px 16px !important;
    }
    #auth0-lock-container .auth0-lock .auth0-lock-tabs li.auth0-lock-tabs-current a,
    #auth0-lock-container .auth0-lock .auth0-lock-tabs li.auth0-lock-tabs-current span {
      color: #E0C584 !important;
    }
    #auth0-lock-container .auth0-lock .auth0-lock-input-wrap {
      background: #050505 !important;
      border: 1px solid rgba(224,197,132,0.55) !important;
      padding: 0 !important;
    }
    #auth0-lock-container .auth0-lock .auth0-lock-input-wrap input,
    #auth0-lock-container .auth0-lock .auth0-lock-input-wrap textarea {
      background: #050505 !important;
      color: rgba(240,226,192,0.95) !important;
      font-size: 1.05rem !important;
    }
    #auth0-lock-container .auth0-lock .auth0-lock-input-wrap input::placeholder,
    #auth0-lock-container .auth0-lock .auth0-lock-input-wrap textarea::placeholder {
      color: rgba(240,226,192,0.45) !important;
    }
    #auth0-lock-container .auth0-lock .auth0-lock-input-wrap:focus-within {
      border-color: #F0D594 !important;
      box-shadow: 0 0 0 3px rgba(224,197,132,0.18) !important;
    }
    #auth0-lock-container .auth0-lock .auth0-lock-input-wrap .auth0-lock-input-icon {
      color: rgba(224,197,132,0.90) !important;
    }
    #auth0-lock-container .auth0-lock button.auth0-lock-submit,
    #auth0-lock-container .auth0-lock .auth0-lock-submit button {
      background: #E0C584 !important;
      border: 1px solid #E0C584 !important;
      color: #000 !important;
      text-transform: uppercase !important;
      letter-spacing: 0.12em !important;
      font-weight: 800 !important;
      padding: 14px 16px !important;
    }
    #auth0-lock-container .auth0-lock button.auth0-lock-submit:hover,
    #auth0-lock-container .auth0-lock .auth0-lock-submit button:hover {
      background: #F0D594 !important;
      border-color: #F0D594 !important;
    }
    #auth0-lock-container .auth0-lock .auth0-lock-separator span {
      background: #050505 !important;
      color: rgba(240,226,192,0.85) !important;
    }
    #auth0-lock-container .auth0-lock .auth0-lock-separator:before,
    #auth0-lock-container .auth0-lock .auth0-lock-separator:after {
      background: rgba(224,197,132,0.25) !important;
    }
    #auth0-lock-container .auth0-lock a {
      color: #E0C584 !important;
    }
    #auth0-lock-container .auth0-lock a:hover {
      color: #F0D594 !important;
    }

    /* CRITICAL FIX: Collapse Auth0 Lock's excessive internal height */
    #auth0-lock-container .auth0-lock .auth0-lock-cred-pane-internal-wrapper {
      min-height: auto !important;
      height: auto !important;
    }

    #auth0-lock-container .auth0-lock .auth0-lock-content-wrapper {
      min-height: auto !important;
      height: auto !important;
    }

    #auth0-lock-container .auth0-lock .auth0-lock-body-content {
      min-height: auto !important;
      height: auto !important;
    }

    #auth0-lock-container .auth0-lock .auth0-lock-submit {
      margin-top: 1rem !important; /* Reduce gap above button */
    }

    /* Remove any fixed heights Auth0 might be setting */
    #auth0-lock-container .auth0-lock-center {
      min-height: auto !important;
      height: auto !important;
      padding-bottom: 0 !important;
    }

/* =========================================
   BOOKING CONFIRMATION MODAL
   ========================================= */
#booking-modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: 300;
  background: rgba(0,0,0,0.9);
  backdrop-filter: blur(15px);
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.3s ease, visibility 0.3s ease;
}
#booking-modal-overlay.active {
  opacity: 1;
  visibility: visible;
}
.booking-modal-card {
  background: linear-gradient(145deg, rgba(20,20,20,0.98), rgba(10,10,10,0.99));
  border: 1px solid rgba(224, 197, 132, 0.3);
  padding: 3rem 2.5rem;
  max-width: 400px;
  width: 90%;
  text-align: center;
  position: relative;
}
.booking-modal-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 2px;
  background: linear-gradient(90deg, transparent, #E0C584, transparent);
}
.booking-spinner {
  width: 60px;
  height: 60px;
  border: 3px solid rgba(224, 197, 132, 0.2);
  border-top-color: #E0C584;
  border-radius: 50%;
  animation: booking-spin 1s linear infinite;
  margin: 0 auto 1.5rem;
}
@keyframes booking-spin {
  to { transform: rotate(360deg); }
}
.booking-status-text {
  color: #E0C584;
  font-size: 1.25rem;
  font-weight: 600;
  letter-spacing: 0.05em;
  min-height: 2rem;
  transition: opacity 0.2s ease;
}
.booking-substatus {
  color: rgba(240, 226, 192, 0.6);
  font-size: 0.85rem;
  margin-top: 0.5rem;
  letter-spacing: 0.1em;
  text-transform: uppercase;
}
.booking-success-icon {
  width: 70px;
  height: 70px;
  border: 3px solid #4ade80;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto 1.5rem;
  animation: booking-success-pop 0.4s ease;
}
@keyframes booking-success-pop {
  0% { transform: scale(0); opacity: 0; }
  50% { transform: scale(1.2); }
  100% { transform: scale(1); opacity: 1; }
}
.booking-error-icon {
  width: 70px;
  height: 70px;
  border: 3px solid #f87171;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto 1.5rem;
  animation: booking-success-pop 0.4s ease;
}


    /* =========================================
       MOBILE HARDENING: Auth0 overlay + keyboard
       - Prevent underlay scroll/bleed
       - Keep Lock visible above mobile keyboard
       ========================================= */
/* On short screens, start from top so Lock isn't trapped */
    
    /* =========================================================
       MOBILE OPTIMIZATION (visual + performance)
       - Reduce oversizing on small screens
       - Reduce heavy blur/background-fixed
       - Center Auth0 Lock cleanly
       - Make touch targets comfortable without being oversized
       ========================================================= */

    @media (max-width: 768px) {
      body { background-attachment: scroll !important; }
      .card-fancy, .glass-panel { backdrop-filter: none; }
    }

    @media (max-width: 640px) {
      /* Global sizing */
      html { font-size: 15px; }
      .header-hero { padding-top: 1.5rem !important; padding-bottom: 1.5rem !important; }
      .header-hero h1 { font-size: clamp(1.6rem, 6vw, 2.2rem) !important; line-height: 1.15 !important; }
      .header-hero p { font-size: 0.95rem !important; }

      /* Cards / panels */
      .card-fancy, .glass-panel { padding: 1rem !important; }
      .divider { margin: 0.75rem 0 !important; }

      /* Inputs / buttons */
      select, input {
        min-height: 44px !important;
        padding: 0.65rem 0.8rem !important;
        font-size: 0.95rem !important;
      }
      .btn-filled, .btn-outline {
        padding: 0.6rem 0.85rem !important;
        font-size: 0.95rem !important;
      }

      /* Time slot buttons */
      .slot-btn { padding: 0.55rem 0.6rem !important; font-size: 0.9rem !important; }

      /* Login overlay and Auth0 Lock */
      #login-overlay { padding: 16px !important; }
      .login-card {
        width: 100% !important;
        max-width: 420px !important;
        margin: 0 auto !important;
        padding: 0 !important;
        border: none !important;
        background: transparent !important;
        box-shadow: none !important;
      }
      .login-card::before { display: none !important; }
      #auth0-lock-container {
        width: 100% !important;
        display: flex !important;
        justify-content: center !important;
      }
      #auth0-lock-container .auth0-lock,
      #auth0-lock-container .auth0-lock-widget {
        width: 100% !important;
        max-width: 420px !important;
        margin: 0 auto !important;
      }
      /* Keep just one clean border on mobile (Auth0 widget only) */
      #auth0-lock-container .auth0-lock-widget {
        border: 1px solid rgba(224, 197, 132, 0.35) !important;
      }

      /* Mobile menu: keep content stable and prevent behind-scroll */
      #mobile-menu { padding-bottom: env(safe-area-inset-bottom); }
    }

    /* Desktop-only: remove website header on portal (keep banner/hero) */
    @media (min-width: 641px) {
      #navbar { display: none !important; }
      #navbar + div[aria-hidden="true"].h-20 { display: none !important; }
    }

@media (max-height: 700px) {
      #login-overlay { align-items: flex-start; justify-content: flex-start; }
      .login-card { margin-top: 8px; }
    }
</style>

  <script>
    // =========================================================
    // CONFIG
    // =========================================================
    const N8N_WEBHOOK_BASE = "https://primary-production-efcf.up.railway.app/webhook";
    const AVAILABILITY_WEBHOOK_URL = `${N8N_WEBHOOK_BASE}/portal-availability-gate`;
    const BOOKING_WEBHOOK_URL      = `${N8N_WEBHOOK_BASE}/portal-booking-confirmed`;
    const APPOINTMENTS_WEBHOOK_URL = `${N8N_WEBHOOK_BASE}/portal-get-appointments`;
    const DEFAULT_PRACTITIONER_ID  = "1834304626376050851";
    const STATIC_SETUP_MINUTES = 25;
    const TRAVEL_FEE_THRESHOLD_MINUTES = 36; // Fee applies when drive time meets or exceeds this
    
    // Travel fee tiers based on drive time
    const TRAVEL_FEE_TIERS = [
      { minMinutes: 120, fee: 200 },
      { minMinutes: 60, fee: 100 },
      { minMinutes: 45, fee: 40 },
      { minMinutes: 36, fee: 20 },
    ];

    // Auth0 Config
    const AUTH0_DOMAIN = "auth.relaxandrenew.ca";
    const AUTH0_CLIENT_ID = "T8FERqkpcryRN77voMnLeaXIkha1eqK1";
    const AUTH0_DB_CONNECTION = "Username-Password-Authentication";

    // Custom claim keys
    const CLAIM_PROFILE_OBJ  = "https://relaxandrenew.ca/profile";
    const CLAIM_ADDRESS      = "https://relaxandrenew.ca/address";
    const CLAIM_CITY         = "https://relaxandrenew.ca/city";
    const CLAIM_POSTAL       = "https://relaxandrenew.ca/postal_code";
    const CLAIM_PHONE        = "https://relaxandrenew.ca/phone";
  </script>
</head>

<body class="bg-hero-pattern bg-cover bg-center bg-fixed bg-no-repeat bg-gray-900 text-brand-light">
  
  <!-- =========================================================
       LOGIN OVERLAY (shows on top of portal until authenticated)
       ========================================================= -->
  <div id="login-overlay">
    <div class="login-card">
      <div class="text-center">
        <div class="mx-auto flex items-center justify-center">
          <img src="https://static.wixstatic.com/media/bf8fef_511df25fad074d79a408119293545f75~mv2.png"
               alt="Relax & Renew"
               class="w-16 h-16 object-contain opacity-95" />
        </div>
        <h2 class="text-3xl text-brand-gold mt-5 font-bold">Welcome</h2>
        <p class="text-brand-dim text-sm mt-2">
          Sign in to your client portal to continue.
        </p>
      </div>

      <div class="mt-6">
        <div id="auth0-lock-container"></div>
      </div>

      <p class="text-[11px] text-brand-dim leading-snug mt-4 text-center opacity-80">
        By logging in, you agree to our
        <a href="/privacy-policy" class="underline text-brand-gold hover:text-brand-light">Privacy Policy</a>
        and
        <a href="/terms" class="underline text-brand-gold hover:text-brand-light">Terms</a>.
      </p>

      <div id="auth0-error" class="hidden mt-4 text-sm border border-red-500/30 bg-red-500/10 p-3 text-red-300"></div>

      <p class="text-xs text-brand-dim mt-6 text-center opacity-70">
        Note: This portal is for returning clients only. New to Relax &amp; Renew?
        <a href="index.html" class="text-brand-gold underline hover:text-brand-light">Book your first session here</a>.
      </p>
    </div>
  </div>

  <!-- NAV -->
  <nav id="navbar" class="fixed-nav h-20 flex items-center">
    <div class="container mx-auto px-6 flex justify-between items-center h-full">
      <a href="index.html" class="flex items-center gap-3 no-underline group">
        <img src="https://static.wixstatic.com/media/bf8fef_511df25fad074d79a408119293545f75~mv2.png" alt="Relax & Renew Logo" class="h-10 w-auto transition-transform group-hover:scale-105">
        <div class="hidden md:flex flex-col">
          <span class="text-brand-gold font-bold tracking-[0.2em] text-sm leading-none">RELAX & RENEW</span>
          <span class="text-brand-light text-[0.65rem] tracking-[0.4em] uppercase opacity-70 leading-tight mt-1">Mobile RMT</span>
        </div>
      </a>

      <!-- Desktop Menu -->
      <div class="hidden lg:flex items-center space-x-8 whitespace-nowrap">
        <a href="index.html#services" class="nav-link">Services</a>
        <a href="index.html#pricing" class="nav-link">Pricing</a>
        <a href="index.html#giftcards" class="nav-link">Gift Cards</a>
        <a href="index.html#area" class="nav-link">Service Area</a>
        <a href="index.html#faq" class="nav-link">FAQ</a>
        <a href="therapists.html" class="nav-link">Our Therapists</a>
        <a href="membership.html" class="nav-link">Membership</a>
        <span class="nav-link text-brand-gold font-bold border-b border-brand-gold">
          <i data-lucide="user-check" class="w-4 h-4 inline mr-1"></i>
          Client Portal
        </span>
      </div>

      <!-- Mobile Menu Button -->
      <button id="mobile-menu-btn" class="lg:hidden text-brand-gold p-2 hover:text-brand-light transition-colors">
        <i data-lucide="menu" class="w-8 h-8"></i>
      </button>
    </div>
  </nav>

  <!-- Mobile Menu Backdrop -->
  <div id="mobile-menu-backdrop" class="mobile-menu-backdrop fixed inset-0 bg-black/70 opacity-0 pointer-events-none transition-opacity z-40 lg:hidden"></div>

  <!-- Mobile Menu Overlay -->
  <div id="mobile-menu" class="mobile-menu fixed top-0 right-0 h-[100dvh] w-[88vw] max-w-[380px] bg-black border-l border-brand-gold/30 z-50 lg:hidden overflow-y-auto">
    <div class="p-6">
      <div class="flex justify-between items-center mb-8">
        <span class="text-brand-gold font-bold tracking-[0.2em] text-sm">PORTAL</span>
        <button id="mobile-menu-close" class="text-brand-gold p-2 hover:rotate-90 transition-transform" aria-label="Close menu">
          <i data-lucide="x" class="w-8 h-8"></i>
        </button>
      </div>

      <div class="flex flex-col space-y-4">
        <button class="mobile-portal-btn text-left nav-link text-lg flex items-center gap-3" data-tab="dashboard">
          <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
          Dashboard
        </button>

        <button class="mobile-portal-btn text-left nav-link text-lg flex items-center gap-3" data-tab="rebook">
          <i data-lucide="calendar-days" class="w-5 h-5"></i>
          Book / Rebook
        </button>

        <button class="mobile-portal-btn text-left nav-link text-lg flex items-center gap-3" data-tab="history">
          <i data-lucide="history" class="w-5 h-5"></i>
          Appointment History
        </button>

        <button class="mobile-portal-btn text-left nav-link text-lg flex items-center gap-3" data-tab="membership">
          <i data-lucide="badge-percent" class="w-5 h-5"></i>
          Membership
        </button>

        <button class="text-left nav-link text-lg flex items-center gap-3 opacity-60 cursor-not-allowed" disabled>
          <i data-lucide="user" class="w-5 h-5"></i>
          Profile (Coming Soon)
        </button>

        <hr class="divider mt-2">

        <button id="install-app-btn" class="text-left nav-link text-lg flex items-center gap-3">
          <i data-lucide="download" class="w-5 h-5"></i>
          Download App
        </button>

        <button id="install-app-ios-btn" class="hidden text-left nav-link text-lg flex items-center gap-3">
          <i data-lucide="square-plus" class="w-5 h-5"></i>
          Add to Home Screen
        </button>

        <a href="index.html" class="nav-link text-lg flex items-center gap-3">
          <i data-lucide="arrow-left" class="w-5 h-5"></i>
          Return to Website
        </a>

        <button id="logout-btn-mobile" class="text-left nav-link text-lg text-red-300 hover:text-red-200 flex items-center gap-3">
          <i data-lucide="log-out" class="w-5 h-5"></i>
          Sign Out
        </button>
      </div>
    </div>
  </div>

  <!-- Spacer -->
  <div aria-hidden="true" class="h-20"></div>

  <!-- HEADER HERO -->
  <header class="header-hero pt-12 pb-10 border-b border-brand-gold/20">
    <div class="container mx-auto px-6 max-w-6xl">
      <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-6">
        <div class="animate-fade-in-up">
          <div class="text-[0.75rem] tracking-[0.45em] uppercase text-brand-dim">Relax & Renew RMT</div>
          <h1 class="text-4xl md:text-5xl font-serif text-brand-gold mt-2">Client Portal</h1>
          <p class="text-brand-dim mt-3 text-lg font-light">Rebook quickly using your saved profile.</p>
        </div>
        <div class="flex items-center gap-3 animate-fade-in-up" style="animation-delay:0.1s">
          <div class="pill">
            <i data-lucide="user" class="w-4 h-4 text-brand-gold"></i>
            <span id="welcome-pill">Loading profile…</span>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- MAIN -->
  <main class="min-h-screen">
    <div class="container mx-auto max-w-7xl px-4 md:px-6 py-14 mt-6">
      <div class="grid grid-cols-1 lg:grid-cols-[260px_1fr] gap-8">
        <!-- SIDEBAR -->
        <aside class="hidden lg:block">
          <div class="glass-panel p-5 sticky top-[110px]">
            <div class="flex items-center gap-3 mb-6 pb-6 border-b border-brand-gold/10">
              <div class="w-11 h-11 border border-brand-gold/20 bg-brand-gold/5 flex items-center justify-center text-brand-gold rounded">
                <i data-lucide="user" class="w-5 h-5"></i>
              </div>
              <div class="flex-1 min-w-0">
                <div class="text-[0.65rem] text-brand-dim uppercase tracking-widest">Welcome back</div>
                <div class="text-brand-light font-serif text-sm leading-tight truncate" id="nav-user-name">—</div>
              </div>
            </div>

            <div class="space-y-2">
              <button class="sidebar-btn active" data-tab="dashboard">
                <i data-lucide="layout-dashboard" class="w-5 h-5 text-brand-gold"></i>
                <span>Dashboard</span>
                <span id="appt-count-badge" class="ml-auto text-[10px] bg-brand-gold/20 text-brand-gold px-1.5 py-0.5 rounded hidden">0</span>
              </button>
              <button class="sidebar-btn" data-tab="rebook">
                <i data-lucide="calendar-plus" class="w-5 h-5 text-brand-gold"></i>
                <span>Rebook</span>
              </button>
              <button class="sidebar-btn" data-tab="history">
                <i data-lucide="history" class="w-5 h-5 text-brand-gold"></i>
                <span>History</span>
              </button>
              <button class="sidebar-btn" data-tab="membership" disabled>
                <i data-lucide="badge-percent" class="w-5 h-5 text-brand-dim"></i>
                <span>Membership</span>
                <span class="ml-auto pill text-[10px] px-1.5 py-0.5">Soon</span>
              </button>
              <hr class="divider my-3">
              <button id="logout-btn" class="sidebar-btn text-red-400 hover:text-red-200 hover:bg-red-900/10 hover:border-red-900/30">
                <i data-lucide="log-out" class="w-5 h-5"></i>
                <span>Sign Out</span>
              </button>
            </div>
          </div>
        </aside>

        <!-- CONTENT -->
        <section>
          <!-- DASHBOARD TAB -->
          <div id="tab-dashboard" class="tab-content animate-fade-in-up">
            <!-- Welcome Header -->
            <div class="glass-panel p-6 mb-6">
              <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                <div>
                  <h2 class="text-3xl font-serif text-brand-light">Welcome Back</h2>
                  <p class="muted mt-2 font-light">Here's an overview of your account.</p>
                </div>
                <button onclick="switchTab('rebook')" class="btn-filled text-sm py-2 px-4">
                  <i data-lucide="calendar-plus" class="w-4 h-4"></i>
                  Book Appointment
                </button>
              </div>
            </div>

            <!-- Dashboard Stats Grid -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
              <div class="card-fancy p-5">
                <div class="flex items-center gap-3 mb-3">
                  <div class="w-10 h-10 border border-brand-gold/20 bg-brand-gold/5 flex items-center justify-center text-brand-gold rounded">
                    <i data-lucide="calendar-check" class="w-5 h-5"></i>
                  </div>
                  <div class="text-[0.65rem] tracking-[0.2em] uppercase text-brand-gold/60">Upcoming</div>
                </div>
                <div class="text-3xl font-serif text-brand-light" id="dash-upcoming-count">0</div>
                <div class="muted text-xs mt-1">Scheduled appointments</div>
              </div>
              <div class="card-fancy p-5">
                <div class="flex items-center gap-3 mb-3">
                  <div class="w-10 h-10 border border-brand-gold/20 bg-brand-gold/5 flex items-center justify-center text-brand-gold rounded">
                    <i data-lucide="history" class="w-5 h-5"></i>
                  </div>
                  <div class="text-[0.65rem] tracking-[0.2em] uppercase text-brand-gold/60">Completed</div>
                </div>
                <div class="text-3xl font-serif text-brand-light" id="dash-completed-count">0</div>
                <div class="muted text-xs mt-1">Past sessions</div>
              </div>
              <div class="card-fancy p-5">
                <div class="flex items-center gap-3 mb-3">
                  <div class="w-10 h-10 border border-brand-gold/20 bg-brand-gold/5 flex items-center justify-center text-brand-gold rounded">
                    <i data-lucide="map-pin" class="w-5 h-5"></i>
                  </div>
                  <div class="text-[0.65rem] tracking-[0.2em] uppercase text-brand-gold/60">Location</div>
                </div>
                <div class="text-lg font-serif text-brand-light truncate" id="dash-location">—</div>
                <div class="muted text-xs mt-1">Service address</div>
              </div>
            </div>

            <!-- Upcoming Appointments Section -->
            <div class="glass-panel p-6 mb-6">
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-serif text-brand-light flex items-center gap-2">
                  <i data-lucide="calendar-clock" class="w-5 h-5 text-brand-gold"></i>
                  Upcoming Appointments
                </h3>
                <button onclick="loadUpcomingAppointments()" class="btn-outline text-xs py-1.5 px-3">
                  <i data-lucide="refresh-cw" class="w-3 h-3"></i>
                  Refresh
                </button>
              </div>

              <!-- Appointments Loading State -->
              <div id="appointments-loading" class="py-8 text-center">
                <div class="w-12 h-12 mx-auto mb-4 border border-brand-gold/20 rounded-full flex items-center justify-center">
                  <i data-lucide="loader-2" class="w-6 h-6 text-brand-gold animate-spin"></i>
                </div>
                <p class="text-brand-dim text-sm">Loading appointments...</p>
              </div>

              <!-- Appointments List -->
              <div id="appointments-list" class="space-y-3 hidden"></div>

              <!-- No Appointments State -->
              <div id="appointments-empty" class="hidden py-8 text-center">
                <div class="w-12 h-12 mx-auto mb-4 border border-brand-gold/20 rounded-full flex items-center justify-center">
                  <i data-lucide="calendar-x" class="w-6 h-6 text-brand-gold/50"></i>
                </div>
                <h4 class="text-lg font-serif text-brand-light mb-2">No Upcoming Appointments</h4>
                <p class="muted text-sm mb-4">You don't have any scheduled sessions.</p>
                <button onclick="switchTab('rebook')" class="btn-outline text-sm py-2 px-4">
                  <i data-lucide="calendar-plus" class="w-4 h-4"></i>
                  Book Now
                </button>
              </div>

              <!-- Error State -->
              <div id="appointments-error" class="hidden py-6">
                <div class="card-fancy p-4 border-red-500/30">
                  <div class="flex items-start gap-3">
                    <i data-lucide="alert-circle" class="w-5 h-5 text-red-400 mt-0.5"></i>
                    <div>
                      <div class="font-bold text-brand-light">Unable to load appointments</div>
                      <div class="muted mt-1 text-sm" id="appointments-error-message">Please try again.</div>
                      <button onclick="loadUpcomingAppointments()" class="btn-outline text-xs py-1.5 mt-3">
                        <i data-lucide="refresh-cw" class="w-3 h-3"></i>
                        Try Again
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Quick Actions -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <button onclick="switchTab('rebook')" class="card-fancy p-5 text-left hover:border-brand-gold/40 transition-all group">
                <div class="flex items-center gap-4">
                  <div class="w-12 h-12 border border-brand-gold/20 bg-brand-gold/5 flex items-center justify-center text-brand-gold rounded group-hover:bg-brand-gold/10 transition-all">
                    <i data-lucide="calendar-plus" class="w-6 h-6"></i>
                  </div>
                  <div>
                    <div class="font-serif text-lg text-brand-light">Rebook</div>
                    <div class="muted text-sm">Schedule your next session</div>
                  </div>
                </div>
              </button>
              <button onclick="switchTab('history')" class="card-fancy p-5 text-left hover:border-brand-gold/40 transition-all group">
                <div class="flex items-center gap-4">
                  <div class="w-12 h-12 border border-brand-gold/20 bg-brand-gold/5 flex items-center justify-center text-brand-gold rounded group-hover:bg-brand-gold/10 transition-all">
                    <i data-lucide="history" class="w-6 h-6"></i>
                  </div>
                  <div>
                    <div class="font-serif text-lg text-brand-light">View History</div>
                    <div class="muted text-sm">See past appointments</div>
                  </div>
                </div>
              </button>
            </div>
          </div>

          <!-- REBOOK TAB -->
          <div id="tab-rebook" class="tab-content hidden animate-fade-in-up">
            <!-- Profile summary -->
            <div class="glass-panel p-6 mb-8">
              <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-6">
                <div>
                  <h2 class="text-3xl font-serif text-brand-light">Quick Rebook</h2>
                  <p class="muted mt-2 font-light">We use your saved client profile. No typing required.</p>
                </div>
                <div class="flex flex-wrap gap-2">
                  <span class="pill"><i data-lucide="map-pin" class="w-4 h-4 text-brand-gold"></i><span id="pill-address">Address: —</span></span>
                  <span class="pill"><i data-lucide="phone" class="w-4 h-4 text-brand-gold"></i><span id="pill-phone">Phone: —</span></span>
                </div>
              </div>

              <div id="profile-missing" class="mt-6 card-fancy p-4 hidden border-red-500/30">
                <div class="flex items-start gap-3">
                  <i data-lucide="alert-triangle" class="w-5 h-5 text-red-400 mt-0.5"></i>
                  <div>
                    <div class="font-bold text-brand-light">Profile data is missing</div>
                    <div class="muted mt-1 text-sm">
                      We could not find a saved address (and/or city/postal code) for your portal account. Because this is a mobile service, we cannot load availability without it.
                      Please contact us to update your profile.
                    </div>
                    <div class="mt-3">
                      <a class="btn-outline text-xs py-2" href="/cdn-cgi/l/email-protection#264f4840496654434a475e4748425443484351084547">
                        <i data-lucide="mail" class="w-4 h-4"></i> Contact Support
                      </a>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Booking UI -->
            <div class="grid grid-cols-1 lg:grid-cols-[1fr_360px] gap-8">
              <!-- Calendar + slots -->
              <div class="glass-panel p-6">
                <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-5">
                  <div>
                    <div class="text-[0.65rem] tracking-[0.35em] uppercase text-brand-gold font-bold mb-1">Step 1</div>
                    <h3 class="text-2xl font-serif mt-1">Select Treatment</h3>
                    <p class="muted mt-2 text-sm">Choose a treatment and duration to load availability.</p>
                  </div>
                  <div class="flex flex-col gap-3 w-full md:w-72">
                    <select id="treatment-select" class="input w-full">
                      <option value="">Select treatment…</option>
                      <option value="relaxation">Relaxation Massage</option>
                      <option value="deep-tissue">Deep Tissue Massage</option>
                      <option value="sports">Sports Massage</option>
                      <option value="senior">Senior Massage</option>
                      <option value="hot-stone">Hot Stone Massage</option>
                      <option value="cupping">Cupping Therapy</option>
                      <option value="prenatal">Prenatal Massage</option>
                      <option value="pediatric">Pediatric Massage</option>
                      <option value="infant">Infant Massage</option>
                    </select>

                    <select id="duration-select" class="input w-full" disabled>
                      <option value="">Select a treatment first…</option>
                    </select>
                  </div>
                </div>

                <hr class="divider my-6">

                <!-- NEW PROGRESS BAR LOADER -->
                <div id="availability-loading" class="hidden mb-6">
                    <div class="flex justify-between text-xs uppercase tracking-wider text-brand-gold/80 mb-2 font-bold">
                        <span>Checking Availability...</span>
                        <span class="animate-pulse">Please Wait</span>
                    </div>
                    <div class="h-1.5 w-full bg-brand-gold/10 rounded-full overflow-hidden relative">
                        <div class="absolute top-0 left-0 h-full bg-brand-gold w-1/3 animate-loading-bar rounded-full"></div>
                    </div>
                </div>

                <div class="flex items-center justify-between gap-3">
                  <button id="prev-month-btn" class="btn-outline px-4 py-2">
                    <i data-lucide="chevron-left" class="w-4 h-4"></i>
                  </button>
                  <div class="text-xl font-bold text-brand-gold tracking-wide font-serif" id="calendar-month-label">—</div>
                  <button id="next-month-btn" class="btn-outline px-4 py-2">
                    <i data-lucide="chevron-right" class="w-4 h-4"></i>
                  </button>
                </div>

                <div class="mt-4 grid grid-cols-7 gap-2 text-center text-[10px] uppercase tracking-[0.2em] text-brand-dim">
                  <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
                </div>

                <div id="calendar-days" class="mt-3 grid grid-cols-7 gap-2"></div>

                <div class="mt-5 card-fancy p-4 border-brand-gold/20 bg-brand-gold/5">
                  <div class="flex items-start gap-3">
                    <i data-lucide="info" class="w-5 h-5 text-brand-gold mt-0.5"></i>
                    <div class="flex-1">
                      <div class="font-bold text-brand-light text-sm" id="availability-status-title">Availability</div>
                      <div class="muted mt-1 text-sm font-light" id="availability-status-body">Select your treatment and duration to load live availability.</div>
                      <div class="text-brand-gold/60 mt-2 text-xs uppercase tracking-wider" id="availability-meta"></div>
                    </div>
                  </div>
                </div>

                <!-- Selected Date -->
                <div id="selected-date-info" class="mt-8 hidden animate-fade-in-up">
                  <div class="text-[0.65rem] tracking-[0.35em] uppercase text-brand-gold font-bold mb-1">Step 2</div>
                  <h3 class="text-2xl font-serif mt-1">Select a Time</h3>
                  <div class="mt-3 pill border-brand-gold text-brand-gold bg-brand-gold/10">
                    <i data-lucide="calendar" class="w-4 h-4"></i>
                    <span id="selected-date-display" class="font-bold">—</span>
                  </div>
                </div>

                <!-- Time slots -->
                <div id="time-slots-container" class="mt-4 hidden animate-fade-in-up" style="animation-delay:0.1s">
                  <!-- UPDATED GRID: 4 columns on mobile -->
                  <div id="time-slots-grid" class="grid grid-cols-4 sm:grid-cols-3 md:grid-cols-4 gap-2"></div>
                </div>

                <div id="no-slots" class="mt-4 hidden card-fancy p-4 border-red-500/20">
                  <div class="flex items-start gap-3">
                    <i data-lucide="calendar-x" class="w-5 h-5 text-red-400 mt-0.5"></i>
                    <div>
                      <div class="font-bold text-brand-light">No slots available</div>
                      <div class="muted mt-1 text-sm">Please choose a different day.</div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Summary + confirm -->
              <div class="glass-panel p-6">
                <div class="text-[0.65rem] tracking-[0.35em] uppercase text-brand-gold font-bold mb-1">Step 3</div>
                <h3 class="text-2xl font-serif mt-1">Confirm</h3>
                <p class="muted mt-2 text-sm font-light">We will confirm your booking and send your confirmation automatically.</p>

                <hr class="divider my-5">

                <div class="space-y-3">
                  <div class="card-fancy p-4 border-l-2 border-l-brand-gold">
                    <div class="text-[0.65rem] tracking-[0.2em] uppercase text-brand-gold/60 mb-1">Client</div>
                    <div class="font-bold text-brand-light font-serif text-lg" id="summary-client">—</div>
                    <div class="muted mt-0 text-xs" id="summary-email">—</div>
                  </div>

                  <div class="card-fancy p-4">
                    <div class="text-[0.65rem] tracking-[0.2em] uppercase text-brand-gold/60 mb-1">Booking</div>
                    <div class="font-bold text-brand-light font-serif text-lg" id="summary-treatment">Select a treatment</div>
                    <div class="muted mt-0 text-xs" id="summary-datetime">Select a date and time</div>
                  </div>

                  <div class="card-fancy p-4">
                    <div class="text-[0.65rem] tracking-[0.2em] uppercase text-brand-gold/60 mb-1">Travel Fee</div>
                    <div class="font-bold text-brand-gold font-serif text-lg" id="summary-travel-fee">$0.00</div>
                    <div class="muted mt-0 text-xs" id="summary-drive-time">—</div>
                  </div>
                </div>

                <button id="confirm-booking-btn" class="btn-filled w-full mt-8 btn-disabled py-4" disabled>
                  <i data-lucide="check-circle" class="w-5 h-5"></i>
                  <span id="confirm-btn-text">Confirm Booking</span>
                </button>

                <div class="muted mt-4 text-xs text-center opacity-60">
                  If you need to change your address, please contact us. Profile editing is <span class="pill text-[10px] py-0 px-1">Coming Soon</span>.
                </div>
              </div>
            </div>
          </div>

          <!-- Membership -->
          <div id="tab-membership" class="tab-content hidden animate-fade-in-up">
            <h2 class="text-3xl font-serif text-brand-light mb-6">Membership</h2>
            <div class="card-fancy p-6">
              <div class="pill">Coming Soon</div>
              <p class="muted mt-4">Membership management will be available here.</p>
            </div>
          </div>

          <!-- History -->
          <div id="tab-history" class="tab-content hidden animate-fade-in-up">
            <h2 class="text-3xl font-serif text-brand-light mb-6">Session History</h2>
            <div class="card-fancy p-6">
              <div class="pill">Coming Soon</div>
              <p class="muted mt-4">Your session history will appear here.</p>
            </div>
          </div>

          <!-- Profile -->
          <div id="tab-profile" class="tab-content hidden animate-fade-in-up">
            <h2 class="text-3xl font-serif text-brand-light mb-6">Profile</h2>
            <div class="card-fancy p-6">
              <div class="pill">Coming Soon</div>
              <p class="muted mt-4">Profile updates will be available here.</p>
            </div>
          </div>
        </section>
      </div>
    </div>
  </main>

  <!-- Toast -->
  <div id="toast" class="toast fixed left-1/2 bottom-6 -translate-x-1/2 flex items-center gap-3 py-3 px-5 rounded opacity-0 pointer-events-none transition-all z-50">
    <div class="bg-brand-gold/20 p-1.5 rounded-full"><i data-lucide="check" class="w-4 h-4 text-brand-gold"></i></div>
    <span id="toast-message" class="text-sm font-bold tracking-wide">Success</span>
  </div>

  <!-- Booking Confirmation Modal -->
  <div id="booking-modal-overlay">
    <div class="booking-modal-card">
      <div id="booking-modal-spinner" class="booking-spinner"></div>
      <div id="booking-modal-success" class="booking-success-icon hidden">
        <svg width="35" height="35" viewBox="0 0 24 24" fill="none" stroke="#4ade80" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="20 6 9 17 4 12"></polyline>
        </svg>
      </div>
      <div id="booking-modal-error" class="booking-error-icon hidden">
        <svg width="35" height="35" viewBox="0 0 24 24" fill="none" stroke="#f87171" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </div>
      <div id="booking-modal-status" class="booking-status-text">Preparing your booking...</div>
      <div id="booking-modal-substatus" class="booking-substatus">Please wait</div>
    </div>
  </div>

  <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
    // =========================================================
    // STATE
    // =========================================================
    let lock = null;
    let portalProfile = null;

    let calendarCurrent = new Date();
    let selectedDateStr = null;
    let selectedSlot = null;

    let availabilityByDate = {};
    let availabilityMeta = { maxDriveTimeMinutes: 0, effective_travel_buffer_minutes: 0 };

    const availabilityCache = new Map();

    let treatmentSelect = null;
    let durationSelect = null;

    let selectedServiceKey = null;
    let selectedStandardDuration = null;

    // Appointments state
    let upcomingAppointments = [];
    let cancelledAppointments = [];
    let completedAppointments = [];
    let historyAppointments = [];
    
    // Preload state
    let availabilityPreloaded = false;
    let preloadedTreatment = null;
    let preloadedDuration = null;

    // PWA install prompt (Android/Chromium)
    let deferredInstallPrompt = null;

    const TREATMENT_RULES = {
      "relaxation":  { label: "Relaxation Massage", durations: [60,75,90,120] },
      "deep-tissue": { label: "Deep Tissue Massage", durations: [60,75,90,120] },
      "sports":      { label: "Sports Massage", durations: [60,75,90,120] },
      "senior":      { label: "Senior Massage", durations: [60,75,90,120] },
      "hot-stone":   { label: "Hot Stone Massage", durations: [60,75,90,120] },
      "cupping":     { label: "Cupping Therapy", durations: [60,75,90,120] },
      "prenatal":    { label: "Prenatal Massage", durations: [30,45,60] },
      "pediatric":   { label: "Pediatric Massage", durations: [30,45] },
      "infant":      { label: "Infant Massage", durations: [30,45] },
    };

    // =========================================================
    // UTIL
    // =========================================================
    function showToast(title, message, isError=false, durationMs=3200) {
      const toast = document.getElementById("toast");
      const msgEl = document.getElementById("toast-message");
      if (!toast || !msgEl) return;

      msgEl.textContent = message || title || "—";
      toast.classList.add("show");
      toast.style.opacity = "1";
      toast.style.transform = "translateX(-50%) translateY(-10px)";

      const iconWrap = toast.querySelector("i");
      if (iconWrap) iconWrap.setAttribute("data-lucide", isError ? "alert-circle" : "check");
      if (typeof lucide !== "undefined") lucide.createIcons();

      // Cancel any prior hide timers (prevents "sticky" toasts)
      try {
        if (toast._hideTimer) clearTimeout(toast._hideTimer);
      } catch (e) {}

      const d = Math.max(800, Number(durationMs) || 3200);
      toast._hideTimer = setTimeout(async () => {
        toast.style.opacity = "0";
        toast.style.transform = "translateX(-50%) translateY(0)";
        toast.classList.remove("show");
      }, d);
    }



// =========================================================
    // BOOKING MODAL FUNCTIONS
    // =========================================================
    const bookingMessages = [
      { text: "Preparing your booking...", sub: "Please wait" },
      { text: "Checking availability...", sub: "Making sure your slot is still open" },
      { text: "Reserving your time...", sub: "Almost there" },
      { text: "Confirming with therapist...", sub: "Just a moment" },
      { text: "Finalizing booking...", sub: "Nearly done" }
    ];

    let bookingMessageInterval = null;

    function showBookingModal() {
      const overlay = document.getElementById("booking-modal-overlay");
      const spinner = document.getElementById("booking-modal-spinner");
      const successIcon = document.getElementById("booking-modal-success");
      const errorIcon = document.getElementById("booking-modal-error");
      const statusText = document.getElementById("booking-modal-status");
      const substatusText = document.getElementById("booking-modal-substatus");

      // Reset to initial state
      spinner.classList.remove("hidden");
      successIcon.classList.add("hidden");
      errorIcon.classList.add("hidden");
      statusText.textContent = bookingMessages[0].text;
      substatusText.textContent = bookingMessages[0].sub;

      // Show modal
      overlay.classList.add("active");
      document.body.style.overflow = "hidden";

      // Cycle through messages every 2 seconds
      let messageIndex = 0;
      bookingMessageInterval = setInterval(() => {
        messageIndex = (messageIndex + 1) % bookingMessages.length;
        statusText.style.opacity = "0";
        setTimeout(async () => {
          statusText.textContent = bookingMessages[messageIndex].text;
          substatusText.textContent = bookingMessages[messageIndex].sub;
          statusText.style.opacity = "1";
        }, 200);
      }, 2000);
    }

    function hideBookingModal(success = true, errorMessage = null) {
      // Stop message cycling
      if (bookingMessageInterval) {
        clearInterval(bookingMessageInterval);
        bookingMessageInterval = null;
      }

      const spinner = document.getElementById("booking-modal-spinner");
      const successIcon = document.getElementById("booking-modal-success");
      const errorIcon = document.getElementById("booking-modal-error");
      const statusText = document.getElementById("booking-modal-status");
      const substatusText = document.getElementById("booking-modal-substatus");
      const overlay = document.getElementById("booking-modal-overlay");

      // Hide spinner, show appropriate icon
      spinner.classList.add("hidden");

      if (success) {
        successIcon.classList.remove("hidden");
        statusText.textContent = "Booking Confirmed!";
        substatusText.textContent = "Your appointment has been scheduled";
      } else {
        errorIcon.classList.remove("hidden");
        statusText.textContent = "Booking Failed";
        substatusText.textContent = errorMessage || "Please try again or contact support";
      }

      // Hide modal after showing result
      setTimeout(() => {
        overlay.classList.remove("active");
        document.body.style.overflow = "";
      }, success ? 2000 : 3000);
    }

    function resetBookingForm() {
      // Reset treatment dropdown to default
      if (treatmentSelect) {
        treatmentSelect.value = "";
        selectedServiceKey = null;
      }

      // Reset duration dropdown to default disabled state
      if (durationSelect) {
        durationSelect.innerHTML = '<option value="">Select a treatment first…</option>';
        durationSelect.disabled = true;
        selectedStandardDuration = null;
      }

      // Clear availability data (prevents auto-reload of calendar)
      availabilityByDate = {};
      availabilityMeta = { maxDriveTimeMinutes: 0, effective_travel_buffer_minutes: 0 };

      // Clear all selections
      clearSelectionUI();

      // Re-render calendar (will show all days as disabled since no treatment selected)
      renderCalendar();

      // Reset availability status message
      updateAvailabilityStatus("Select your treatment and duration to load live availability.", false);
        savePortalState();

      // Update summary to reflect reset state
      updateSummary();
      savePortalState();
    }

    function showAuthError(msg) {
      const el = document.getElementById('auth0-error');
      if (!el) return;
      el.textContent = msg || "Sign in failed. Please try again.";
      el.classList.remove('hidden');
    }

    function hideAuthError() {
      const el = document.getElementById('auth0-error');
      if (el) el.classList.add('hidden');
    }

    function toDateStr(date) {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, "0");
      const d = String(date.getDate()).padStart(2, "0");
      return `${y}-${m}-${d}`;
    }

    
    // MOBILE FIX: Normalize date to YYYY-MM-DD format
    function normalizeDateKey(dateInput) {
      if (!dateInput) return null;
      var str = String(dateInput).trim();
      if (/^\d{4}-\d{2}-\d{2}$/.test(str)) return str;
      var isoMatch = str.match(/^(\d{4}-\d{2}-\d{2})/);
      if (isoMatch) return isoMatch[1];
      try {
        if (str.indexOf('T') >= 0 || str.indexOf('Z') >= 0) {
          var parts = str.split('T')[0];
          if (/^\d{4}-\d{2}-\d{2}$/.test(parts)) return parts;
        }
        var d = new Date(str);
        if (!isNaN(d.getTime())) {
          return d.getUTCFullYear() + '-' + String(d.getUTCMonth()+1).padStart(2,'0') + '-' + String(d.getUTCDate()).padStart(2,'0');
        }
      } catch(e) {}
      return null;
    }

    // MOBILE FIX: Robust slot availability check
    function isSlotAvailable(slot) {
      if (!slot) return false;
      if (typeof slot.available === 'boolean') return slot.available;
      if (typeof slot.available === 'string') return ['true','1','yes'].indexOf(slot.available.toLowerCase().trim()) >= 0;
      if (typeof slot.available === 'number') return slot.available === 1;
      if (typeof slot.isAvailable === 'boolean') return slot.isAvailable;
      if (typeof slot.is_available === 'boolean') return slot.is_available;
      if (typeof slot.booked === 'boolean') return !slot.booked;
      if (slot.label && slot.label.toLowerCase().indexOf('(booked)') >= 0) return false;
      if (slot.start) return true;
      return false;
    }

function computeMonthRange(date) {
      const first = new Date(date.getFullYear(), date.getMonth(), 1);
      const last  = new Date(date.getFullYear(), date.getMonth() + 1, 0);
      return { from: toDateStr(first), to: toDateStr(last) };
    }

    function normalizeAmPmLabel(label) {
      return String(label || "").toLowerCase().replace(/\s+/g, "").replace(/\./g, "");
    }

    function formatTimeLabel(slot) {
      if (slot && slot.label) return normalizeAmPmLabel(slot.label);
      if (slot && slot.start) {
        const d = new Date(slot.start);
        const raw = d.toLocaleTimeString("en-CA", { hour: "numeric", minute: "2-digit", hour12: true, timeZone: "America/Toronto" });
        return normalizeAmPmLabel(raw);
      }
      return "—";
    }

    function formatDatePretty(dateStr) {
      const [y,m,d] = dateStr.split("-").map(Number);
      const dt = new Date(y, m-1, d);
      return dt.toLocaleDateString("en-CA", { weekday:"long", month:"long", day:"numeric", year:"numeric" });
    }

    function calcTravelFee(driveTimeMinutes) {
      const driveTime = Number(driveTimeMinutes) || 0;
      
      // Check each tier from highest to lowest
      for (const tier of TRAVEL_FEE_TIERS) {
        if (driveTime >= tier.minMinutes) {
          return tier.fee;
        }
      }
      return 0; // No fee for drives under 36 min
    }

    function setConfirmEnabled(enabled) {
      const btn = document.getElementById("confirm-booking-btn");
      btn.disabled = !enabled;
      btn.classList.toggle("btn-disabled", !enabled);
    }

    function updateSummary() {
      document.getElementById("summary-client").textContent = portalProfile
        ? `${portalProfile.firstName || ""} ${portalProfile.lastName || ""}`.trim() || "—"
        : "—";
      document.getElementById("summary-email").textContent = portalProfile?.email || "—";

      const treat = selectedServiceKey ? TREATMENT_RULES[selectedServiceKey] : null;
      if (treat && selectedStandardDuration) {
        document.getElementById("summary-treatment").textContent = `${treat.label} — ${selectedStandardDuration} min`;
      } else {
        document.getElementById("summary-treatment").textContent = "Select a treatment";
      }

      if (selectedDateStr && selectedSlot) {
        document.getElementById("summary-datetime").textContent = `${formatDatePretty(selectedDateStr)} at ${formatTimeLabel(selectedSlot)}`;
      } else {
        document.getElementById("summary-datetime").textContent = "Select a date and time";
      }

     // Only show drive time and travel fee AFTER a slot is selected
let driveTime = 0;
let travelFee = 0;

if (selectedSlot) {
  driveTime = selectedSlot.driveTimeMinutes || 0;
  travelFee = calcTravelFee(driveTime);
}

document.getElementById("summary-travel-fee").textContent = selectedSlot 
  ? `$${Number(travelFee || 0).toFixed(2)}`
  : "—";

// Show drive time info only when slot is selected
if (selectedSlot && driveTime > 0) {
  let feeNote;
  if (driveTime >= 120) {
    feeNote = " — $200 travel fee (2+ hours)";
  } else if (driveTime >= 60) {
    feeNote = " — $100 travel fee (60+ min)";
  } else if (driveTime >= 45) {
    feeNote = " — $40 travel fee (45+ min)";
  } else if (driveTime >= TRAVEL_FEE_THRESHOLD_MINUTES) {
    feeNote = " — $20 travel fee (36+ min)";
  } else {
    feeNote = " — no travel fee";
  }
  document.getElementById("summary-drive-time").textContent = `${driveTime} min drive time${feeNote}`;
} else if (selectedSlot && driveTime === 0) {
  document.getElementById("summary-drive-time").textContent = "No travel fee";
} else {
  document.getElementById("summary-drive-time").textContent = "Select a time to see travel fee";
}

      setConfirmEnabled(!!(portalProfile && selectedServiceKey && selectedStandardDuration && selectedDateStr && selectedSlot));
    }

    function updateAvailabilityStatus(body, loaded) {
      document.getElementById("availability-status-title").textContent = loaded ? "Availability loaded" : "Availability";
      document.getElementById("availability-status-body").textContent = body || "";
      const metaEl = document.getElementById("availability-meta");
      const buffer = availabilityMeta.effective_travel_buffer_minutes || 0;
      const maxDrive = availabilityMeta.maxDriveTimeMinutes || 0;
      metaEl.textContent = (loaded && (buffer || maxDrive))
        ? `Travel buffer applied: ${buffer} min • Max drive time used: ${maxDrive} min`
        : "";
    }

    function setCalendarLoading(isLoading) {
      // Toggle progress bar
      const loader = document.getElementById("availability-loading");
      if (isLoading) {
        loader.classList.remove("hidden");
        document.getElementById("calendar-days").classList.add("opacity-50");
      } else {
        loader.classList.add("hidden");
        document.getElementById("calendar-days").classList.remove("opacity-50");
      }
    }

    // =========================================================
    // LOGIN OVERLAY CONTROL
    // =========================================================
    function showLoginOverlay() {
      document.getElementById("login-overlay").classList.remove("hidden");
      document.body.style.overflow = "hidden";
    }

    function hideLoginOverlay() {
      document.getElementById("login-overlay").classList.add("hidden");
      document.body.style.overflow = "";
    }
    // =========================================================
    // STATE PERSISTENCE (survive refresh / accidental close)
    // =========================================================
    const PORTAL_STATE_KEY = "rnr_portal_state_v1";

    function savePortalState() {
      try {
        const state = {
          selectedServiceKey,
          selectedStandardDuration,
          selectedDateStr,
          // Prefer a stable identifier for the selected slot
          selectedSlotStart: selectedSlot?.start || selectedSlot?.label || null,
          // Preserve the month user is browsing
          calendarMonth: `${calendarCurrent.getFullYear()}-${String(calendarCurrent.getMonth()+1).padStart(2,"0")}`
        };
        localStorage.setItem(PORTAL_STATE_KEY, JSON.stringify(state));
      } catch (e) {}
    }

    function loadPortalState() {
      try {
        const raw = localStorage.getItem(PORTAL_STATE_KEY);
        if (!raw) return null;
        const s = JSON.parse(raw);
        return s && typeof s === "object" ? s : null;
      } catch (e) { return null; }
    }

    function clearPortalState() {
      try { localStorage.removeItem(PORTAL_STATE_KEY); } catch (e) {}
    }

    async function restorePortalStateIfPossible() {
      const s = loadPortalState();
      if (!s) return;

      // Restore calendar month first (pure UI)
      if (s.calendarMonth && /^\d{4}-\d{2}$/.test(String(s.calendarMonth))) {
        const parts = String(s.calendarMonth).split("-");
        const y = Number(parts[0]);
        const m = Number(parts[1]) - 1;
        if (!isNaN(y) && !isNaN(m)) calendarCurrent = new Date(y, m, 1);
      }

      // Restore treatment + duration selections
      if (s.selectedServiceKey && TREATMENT_RULES[s.selectedServiceKey]) {
        selectedServiceKey = s.selectedServiceKey;
        if (treatmentSelect) treatmentSelect.value = selectedServiceKey;
        rebuildDurationOptions();
      }

      if (s.selectedStandardDuration && !isNaN(Number(s.selectedStandardDuration))) {
        selectedStandardDuration = Number(s.selectedStandardDuration);
        if (durationSelect) durationSelect.value = String(selectedStandardDuration);
      }

      // If we have enough to fetch availability, load it
      if (portalProfile && selectedServiceKey && selectedStandardDuration) {
        await maybeLoadAvailabilityForCurrentMonth();
      }

      // After availability exists, restore date selection if that date has any data
      if (s.selectedDateStr && availabilityByDate && availabilityByDate[s.selectedDateStr]) {
        selectDate(s.selectedDateStr);
        // Slot restoration happens inside loadTimeSlots via maybeAutoSelectRestoredSlot()
      }
    }

    function maybeAutoSelectRestoredSlot(dateStr) {
      const s = loadPortalState();
      if (!s || !s.selectedSlotStart || !dateStr) return;
      const target = String(s.selectedSlotStart);

      // Find the button corresponding to the stored slot id
      const grid = document.getElementById("time-slots-grid");
      if (!grid) return;

      const btns = Array.from(grid.querySelectorAll("button.time-slot-btn"));
      for (const btn of btns) {
        const slotId = btn.getAttribute("data-slot-id");
        if (slotId && slotId === target) {
          // Rebuild a slot object from dataset when possible
          const raw = btn.getAttribute("data-slot-raw");
          try {
            const slot = raw ? JSON.parse(raw) : null;
            if (slot) selectTimeSlot(slot, btn);
          } catch (e) {}
          break;
        }
      }
    }


    // =========================================================
    // PROFILE
    // =========================================================
    function hydrateProfileUI() {
      document.getElementById("nav-user-name").textContent = portalProfile?.firstName || portalProfile?.email || "—";
      document.getElementById("welcome-pill").textContent = portalProfile?.firstName ? `Hi ${portalProfile.firstName}` : (portalProfile?.email || "Profile loaded");

      const addrLine = portalProfile?.address ? `${portalProfile.address}, ${portalProfile.city || ""} ${portalProfile.postal_code || ""}`.replace(/\s+/g," ").trim() : "—";
      document.getElementById("pill-address").textContent = `Address: ${addrLine}`;
      document.getElementById("pill-phone").textContent = `Phone: ${portalProfile?.phone || "—"}`;

      // Dashboard location
      const dashLoc = document.getElementById("dash-location");
      if (dashLoc) {
        dashLoc.textContent = portalProfile?.city || portalProfile?.address?.split(",")[0] || "—";
      }

      const missing = !(portalProfile && portalProfile.address && portalProfile.city && portalProfile.postal_code && portalProfile.email);
      document.getElementById("profile-missing").classList.toggle("hidden", !missing);

      if (missing) {
        updateAvailabilityStatus("Missing address/city/postal code in portal profile.", false);
        availabilityByDate = {};
        renderCalendar();
        clearSelectionUI();
        setConfirmEnabled(false);
      }
      updateSummary();
    }

    function loadProfileFromLocalStorage() {
      try {
        const raw = localStorage.getItem("rnr_portal_profile");
        if (!raw) return null;
        const p = JSON.parse(raw);
        if (!p) return null;
        return {
          firstName: p.firstName || p.given_name || "",
          lastName:  p.lastName || p.family_name || "",
          email:     p.email || "",
          phone:     p.phone || p.phone_number || "",
          address:   p.address || "",
          city:      p.city || "",
          postal_code: p.postal_code || p.postal || ""
        };
      } catch (e) {
        return null;
      }
    }

    // =========================================================
    // TOKEN / JWT HELPERS
    // =========================================================
    function base64UrlDecode(str) {
      try {
        const pad = str.length % 4;
        const base64 = (str + (pad ? "=".repeat(4 - pad) : "")).replace(/-/g, "+").replace(/_/g, "/");
        const decoded = atob(base64);
        try { return decodeURIComponent(decoded.split("").map(c => "%" + ("00" + c.charCodeAt(0).toString(16)).slice(-2)).join("")); }
        catch { return decoded; }
      } catch (e) { return null; }
    }

    function decodeJwtPayload(token) {
      if (!token || typeof token !== "string" || token.split(".").length < 2) return null;
      const payloadB64 = token.split(".")[1];
      const json = base64UrlDecode(payloadB64);
      if (!json) return null;
      try { return JSON.parse(json); } catch { return null; }
    }

    function isJwtExpired(payload) {
      const exp = payload && payload.exp ? Number(payload.exp) : 0;
      if (!exp) return false;
      const now = Math.floor(Date.now() / 1000);
      return now >= exp;
    }

    function isEmailLike(str) {
      const s = String(str || "").trim();
      return !!s && s.includes("@") && s.includes(".");
    }

    function buildProfileFromJwtPayload(payload) {
      if (!payload) return null;

      const email = payload.email || "";

      // Prefer your custom profile object if present
      const claimObj = payload[CLAIM_PROFILE_OBJ] || null;

      // Name sources (priority order)
      const given = (claimObj && (claimObj.firstName || claimObj.given_name)) || payload.given_name || "";
      const family = (claimObj && (claimObj.lastName || claimObj.family_name)) || payload.family_name || "";

      // Fallback to payload.name ONLY if it looks like a real name (not an email)
      const rawName = payload.name ? String(payload.name).trim() : "";
      const canUseNameFallback = rawName && !isEmailLike(rawName) && rawName.includes(" ");

      const nameFirst = canUseNameFallback ? rawName.split(" ")[0] : "";
      const nameLast  = canUseNameFallback ? rawName.split(" ").slice(1).join(" ") : "";

      const firstName = String(given || nameFirst || "").trim();
      const lastName  = String(family || nameLast || "").trim();

      const phone = payload.phone_number || payload[CLAIM_PHONE] || (claimObj && claimObj.phone) || "";

      const address = (claimObj && claimObj.address) || payload[CLAIM_ADDRESS] || "";
      const city    = (claimObj && claimObj.city) || payload[CLAIM_CITY] || "";
      const postal  = (claimObj && (claimObj.postal_code || claimObj.postal)) || payload[CLAIM_POSTAL] || "";

      const addrObj = payload.address || null;
      const addr2 = addrObj && (addrObj.street_address || addrObj.formatted)
        ? (addrObj.street_address || addrObj.formatted)
        : "";
      const city2 = addrObj && addrObj.locality ? addrObj.locality : "";
      const postal2 = addrObj && addrObj.postal_code ? addrObj.postal_code : "";

      return {
        firstName,
        lastName,
        email,
        phone,
        address: address || addr2 || "",
        city: city || city2 || "",
        postal_code: postal || postal2 || ""
      };
    }

    function getStoredLockTokens() {
      try {
        const idToken = localStorage.getItem("rnr_id_token") || "";
        const accessToken = localStorage.getItem("rnr_auth_token") || "";
        return { idToken, accessToken };
      } catch (e) {
        return { idToken: "", accessToken: "" };
      }
    }

    async function tryEnrichProfileFromUserInfo(accessToken, currentProfile) {
      if (!accessToken) return currentProfile;
      try {
        const res = await fetch(`https://${AUTH0_DOMAIN}/userinfo`, {
          headers: { "Authorization": "Bearer " + accessToken }
        });
        if (!res.ok) return currentProfile;
        const u = await res.json();
        
        const claimObj = u[CLAIM_PROFILE_OBJ] || u.profile || u.user_metadata || null;
        const addressObj = u.address || null;

        const firstName = u.given_name || (u.name ? String(u.name).split(" ")[0] : "") || "";
        const lastName  = u.family_name || (u.name ? String(u.name).split(" ").slice(1).join(" ") : "") || "";

        const address = (claimObj && claimObj.address) || u[CLAIM_ADDRESS] || (addressObj && (addressObj.street_address || addressObj.formatted)) || "";
        const city    = (claimObj && claimObj.city) || u[CLAIM_CITY] || (addressObj && addressObj.locality) || "";
        const postal  = (claimObj && (claimObj.postal_code || claimObj.postal)) || u[CLAIM_POSTAL] || (addressObj && addressObj.postal_code) || "";
        const phone   = (claimObj && claimObj.phone) || u[CLAIM_PHONE] || u.phone_number || "";

        const p2 = { firstName, lastName, email: u.email || "", phone, address, city, postal_code: postal };
        return { ...(currentProfile || {}), ...p2 };
      } catch (e) {
        return currentProfile;
      }
    }


    // =========================================================
    // APPOINTMENT CARD RENDERER
    // =========================================================
    function renderAppointmentCard(appt, isCancelled = false, isHistory = false) {
      const start = appt?.starts_at ? new Date(appt.starts_at) : null;
      const dateStr = start ? start.toLocaleDateString("en-CA", { weekday: "long", month: "long", day: "numeric", year: "numeric", timeZone: "America/Toronto" }) : "—";
      const timeStr = start ? start.toLocaleTimeString("en-CA", { hour: "numeric", minute: "2-digit", hour12: true, timeZone: "America/Toronto" }) : "";
      const treatment = appt?.appointment_type?.name || appt?.treatment_type || "Massage";
      const duration = appt?.duration || 60;
      
      const statusClass = isCancelled ? "text-red-400" : (isHistory ? "text-brand-dim" : "text-green-400");
      const statusText = isCancelled ? "Cancelled" : (isHistory ? "Completed" : "Confirmed");
      const statusIcon = isCancelled ? "x-circle" : (isHistory ? "check-circle" : "calendar-check");
      
      return `
        <div class="card-fancy p-4 ${isCancelled ? 'opacity-60' : ''}">
          <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
            <div class="flex-1">
              <div class="font-serif text-lg text-brand-light">${treatment}</div>
              <div class="text-brand-dim text-sm mt-1">${dateStr} at ${timeStr}</div>
              <div class="flex items-center gap-2 mt-2">
                <span class="text-xs ${statusClass} flex items-center gap-1">
                  <i data-lucide="${statusIcon}" class="w-3 h-3"></i>
                  ${statusText}
                </span>
                <span class="text-xs text-brand-dim">${duration} min</span>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // =========================================================
    // LOAD UPCOMING APPOINTMENTS
    // =========================================================
    async function loadUpcomingAppointments() {
      if (!portalProfile || !portalProfile.email) {
        console.warn("No profile/email to load appointments");
        document.getElementById("appointments-loading")?.classList.add("hidden");
        document.getElementById("appointments-empty")?.classList.remove("hidden");
        document.getElementById("history-loading")?.classList.add("hidden");
        document.getElementById("history-empty")?.classList.remove("hidden");
        return;
      }

      // Show loading states
      document.getElementById("appointments-loading")?.classList.remove("hidden");
      document.getElementById("appointments-list")?.classList.add("hidden");
      document.getElementById("appointments-empty")?.classList.add("hidden");
      document.getElementById("appointments-error")?.classList.add("hidden");
      
      document.getElementById("history-loading")?.classList.remove("hidden");
      document.getElementById("history-list")?.classList.add("hidden");
      document.getElementById("history-empty")?.classList.add("hidden");
      document.getElementById("history-error")?.classList.add("hidden");

      // Set timeout to show empty state if request takes too long
      const loadingTimeout = setTimeout(() => {
        console.warn("Appointments loading timeout - showing empty state");
        document.getElementById("appointments-loading")?.classList.add("hidden");
        document.getElementById("appointments-empty")?.classList.remove("hidden");
        document.getElementById("history-loading")?.classList.add("hidden");
        document.getElementById("history-empty")?.classList.remove("hidden");
        
        const dashUpcoming = document.getElementById("dash-upcoming-count");
        const dashCompleted = document.getElementById("dash-completed-count");
        if (dashUpcoming) dashUpcoming.textContent = "0";
        if (dashCompleted) dashCompleted.textContent = "0";
      }, 10000);

      try {
        const res = await fetch(APPOINTMENTS_WEBHOOK_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            email: portalProfile.email,
            firstName: portalProfile.firstName || "",
            lastName: portalProfile.lastName || ""
          })
        });

        clearTimeout(loadingTimeout);

        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        const data = await res.json();
        const all = Array.isArray(data.appointments) ? data.appointments : [];
        const now = new Date();

        // Separate appointments
        cancelledAppointments = all.filter(a => {
          const s = String(a?.status || "").toLowerCase();
          return s.includes("cancel");
        });

        completedAppointments = all.filter(a => {
          const s = String(a?.status || "").toLowerCase();
          if (s.includes("cancel")) return false;
          const start = a?.starts_at ? new Date(a.starts_at) : null;
          return start && start <= now;
        });

        upcomingAppointments = all.filter(a => {
          const s = String(a?.status || "").toLowerCase();
          if (s.includes("cancel")) return false;
          const start = a?.starts_at ? new Date(a.starts_at) : null;
          return start && start > now;
        });

        historyAppointments = [...cancelledAppointments, ...completedAppointments].sort((a, b) => {
          const as = a?.starts_at ? new Date(a.starts_at).getTime() : 0;
          const bs = b?.starts_at ? new Date(b.starts_at).getTime() : 0;
          return bs - as;
        });

        // Store last treatment for preloading
        if (completedAppointments.length > 0 || upcomingAppointments.length > 0) {
          const lastAppt = upcomingAppointments[0] || completedAppointments[0];
          if (lastAppt) {
            try {
              localStorage.setItem("rnr_portal_last_treatment", JSON.stringify({
                treatment_type: lastAppt.appointment_type?.name || lastAppt.treatment_type || "",
                duration: lastAppt.duration || 60
              }));
            } catch(e) {}
          }
        }

        renderAppointments();
        renderHistory();

      } catch (e) {
        clearTimeout(loadingTimeout);
        console.error("Failed to load appointments:", e);

        document.getElementById("appointments-loading")?.classList.add("hidden");
        document.getElementById("appointments-error")?.classList.remove("hidden");
        const errMsg = document.getElementById("appointments-error-message");
        if (errMsg) errMsg.textContent = e.message || "Please try again.";

        document.getElementById("history-loading")?.classList.add("hidden");
        document.getElementById("history-error")?.classList.remove("hidden");
      }
    }

    function renderAppointments() {
      document.getElementById("appointments-loading")?.classList.add("hidden");

      const listEl = document.getElementById("appointments-list");
      const emptyEl = document.getElementById("appointments-empty");
      const badge = document.getElementById("appt-count-badge");
      const dashUpcoming = document.getElementById("dash-upcoming-count");
      const dashCompleted = document.getElementById("dash-completed-count");

      if (dashUpcoming) dashUpcoming.textContent = upcomingAppointments.length;
      if (dashCompleted) dashCompleted.textContent = completedAppointments.length;

      if (upcomingAppointments.length > 0) {
        if (badge) {
          badge.textContent = upcomingAppointments.length;
          badge.classList.remove("hidden");
        }
      } else {
        badge?.classList.add("hidden");
      }

      if (upcomingAppointments.length === 0) {
        listEl?.classList.add("hidden");
        emptyEl?.classList.remove("hidden");
      } else {
        emptyEl?.classList.add("hidden");
        listEl?.classList.remove("hidden");
        if (listEl) {
          listEl.innerHTML = upcomingAppointments.map(appt => renderAppointmentCard(appt, false, false)).join("");
        }
      }

      if (typeof lucide !== "undefined") lucide.createIcons();
    }

    function renderHistory() {
      document.getElementById("history-loading")?.classList.add("hidden");

      const listEl = document.getElementById("history-list");
      const emptyEl = document.getElementById("history-empty");

      if (!historyAppointments || historyAppointments.length === 0) {
        listEl?.classList.add("hidden");
        emptyEl?.classList.remove("hidden");
      } else {
        emptyEl?.classList.add("hidden");
        listEl?.classList.remove("hidden");
        if (listEl) {
          listEl.innerHTML = historyAppointments.map(appt => {
            const isCancelled = String(appt?.status || "").toLowerCase().includes("cancel");
            return renderAppointmentCard(appt, isCancelled, !isCancelled);
          }).join("");
        }
      }

      if (typeof lucide !== "undefined") lucide.createIcons();
    }

    // =========================================================
    // PRELOAD AVAILABILITY IN BACKGROUND
    // =========================================================
    async function preloadAvailabilityInBackground(forceReload = false) {
      console.log("preloadAvailabilityInBackground called, forceReload:", forceReload);
      
      const addrOk = portalProfile && portalProfile.address && portalProfile.city && portalProfile.postal_code;
      if (!addrOk) {
        console.log("Cannot preload: missing address info");
        return;
      }

      if (availabilityPreloaded && !forceReload) {
        console.log("Already preloaded, skipping");
        return;
      }

      // Determine treatment from last booking or default
      let preloadTreatment = "relaxation";
      let preloadDuration = 60;

      try {
        const lastRaw = localStorage.getItem("rnr_portal_last_treatment");
        if (lastRaw) {
          const last = JSON.parse(lastRaw);
          const name = String(last.treatment_type || "").toLowerCase();
          if (name.includes("deep tissue")) preloadTreatment = "deep-tissue";
          else if (name.includes("sport")) preloadTreatment = "sports";
          else if (name.includes("senior")) preloadTreatment = "senior";
          else if (name.includes("hot stone")) preloadTreatment = "hot-stone";
          else if (name.includes("cupping")) preloadTreatment = "cupping";
          else if (name.includes("prenatal")) preloadTreatment = "prenatal";
          else if (name.includes("pediatric")) preloadTreatment = "pediatric";
          else if (name.includes("infant")) preloadTreatment = "infant";
          
          const dur = Number(last.duration);
          if (dur && [30, 45, 60, 75, 90, 120].includes(dur)) {
            preloadDuration = dur;
          }
        }
      } catch (e) {
        console.warn("Could not parse last treatment:", e);
      }

      console.log("Preloading:", preloadTreatment, preloadDuration + "min");

      const treatRule = TREATMENT_RULES[preloadTreatment];
      if (!treatRule) return;

      if (!treatRule.durations.includes(preloadDuration)) {
        preloadDuration = treatRule.durations[0] || 60;
      }

      // Set state
      selectedServiceKey = preloadTreatment;
      selectedStandardDuration = preloadDuration;
      preloadedTreatment = preloadTreatment;
      preloadedDuration = preloadDuration;

      // Update UI
      if (treatmentSelect) treatmentSelect.value = preloadTreatment;
      rebuildDurationOptions();
      if (durationSelect) durationSelect.value = String(preloadDuration);

      // Build request
      const { from, to } = computeMonthRange(calendarCurrent);
      const blockMinutes = preloadDuration + STATIC_SETUP_MINUTES;

      const payload = {
        address: portalProfile.address,
        city: portalProfile.city,
        postal_code: portalProfile.postal_code,
        from,
        to,
        standardDurationMinutes: preloadDuration,
        blockDurationMinutes: blockMinutes,
        slotIntervalMinutes: 15,
        practitionerId: DEFAULT_PRACTITIONER_ID,
        travel_time_buffer_minutes: 0
      };

      updateAvailabilityStatus("Loading availability...", false);

      try {
        const res = await fetch(AVAILABILITY_WEBHOOK_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if (res.ok) {
          const data = await res.json();
          const cacheKey = getRequestCacheKey(payload);
          availabilityCache.set(cacheKey, data);
          parseAvailabilityResponse(data);
          availabilityPreloaded = true;
          
          renderCalendar();
          updateAvailabilityStatus(`Showing ${treatRule.label} (${preloadDuration} min). Select a date.`, true);
          updateSummary();
          console.log("Availability preloaded successfully");
        } else {
          console.warn("Preload failed:", res.status);
          updateAvailabilityStatus("Select treatment and duration to load availability.", false);
        }
      } catch (e) {
        console.warn("Preload error:", e);
        updateAvailabilityStatus("Select treatment and duration to load availability.", false);
      }
    }

    // =========================================================
    // AUTH CHECK ON LOAD
    // =========================================================
    async function checkExistingAuth() {
      const { idToken, accessToken } = getStoredLockTokens();
      
      if (idToken) {
        const payload = decodeJwtPayload(idToken);
        if (payload && !isJwtExpired(payload)) {
          // Valid token exists - user is authenticated
          try {
            portalProfile = buildProfileFromJwtPayload(payload) || null;

            // Merge with localStorage profile if exists
            const local = loadProfileFromLocalStorage();
            if (local) portalProfile = { ...(portalProfile || {}), ...local };

            // Try to enrich from userinfo (don't let this block login)
            try {
              portalProfile = await tryEnrichProfileFromUserInfo(accessToken, portalProfile);
            } catch (e) {
              console.warn("Could not enrich profile from userinfo:", e);
            }

            // Track login
            try {
              if (typeof gtag === "function") gtag("event", "client_portal_session_restored");
            } catch (e) {}
          } catch (e) {
            console.error("Error building profile:", e);
          }
          
          // ALWAYS hide login overlay if we have a valid token
          hideLoginOverlay();
          hydrateProfileUI();
          renderCalendar();
          
          // Load appointments and preload availability
          loadUpcomingAppointments();
          if (!availabilityPreloaded) preloadAvailabilityInBackground();
          
          return true;
        } else {
          // Token expired - clear it
          localStorage.removeItem("rnr_id_token");
          localStorage.removeItem("rnr_auth_token");
        }
      }
      
      // No valid auth - show login overlay and initialize Lock
      showLoginOverlay();
      initAuth0Lock();
      return false;
    }

    // =========================================================
    // AUTH0 LOCK INITIALIZATION
    // =========================================================
    function initAuth0Lock() {
      lock = new Auth0Lock(AUTH0_CLIENT_ID, AUTH0_DOMAIN, {
        container: 'auth0-lock-container',
        allowSignUp: false,
        theme: {
          logo: 'https://static.wixstatic.com/media/bf8fef_511df25fad074d79a408119293545f75~mv2.png',
          primaryColor: '#E0C584'
        },
        languageDictionary: { 
          title: "", 
          emailInputPlaceholder: "Email", 
          passwordInputPlaceholder: "Password" 
        },
        auth: {
          redirect: false,
          responseType: 'token id_token',
          sso: false,
          params: { scope: 'openid profile email' }
        },
        allowedConnections: [AUTH0_DB_CONNECTION],
        usernameStyle: "email",
        rememberLastLogin: true,
        autofocus: true,
        autoclose: false,
        closable: false
      });

      // Show the Lock widget
      lock.show();

      // Handle successful authentication
      lock.on('authenticated', async function(authResult) {
        hideAuthError();
        
        try {
          // Store tokens
          if (authResult && authResult.accessToken) {
            localStorage.setItem('rnr_auth_token', authResult.accessToken);
          }
          if (authResult && authResult.idToken) {
            localStorage.setItem('rnr_id_token', authResult.idToken);
          }

          // Build profile from ID token
          const payload = decodeJwtPayload(authResult.idToken);
          portalProfile = buildProfileFromJwtPayload(payload) || null;

          // Merge with localStorage profile
          const local = loadProfileFromLocalStorage();
          if (local) portalProfile = { ...(portalProfile || {}), ...local };

          // Try to enrich from userinfo
          portalProfile = await tryEnrichProfileFromUserInfo(authResult.accessToken, portalProfile);

          // Track login success
          try {
            if (typeof gtag === "function") gtag("event", "client_portal_login_success");
            if (typeof fbq === "function") fbq("trackCustom", "ClientPortalLoginSuccess");
          } catch (e) {}

          // Hide login overlay with slight delay for smooth transition
          setTimeout(async () => {
            hideLoginOverlay();
            hydrateProfileUI();
            renderCalendar();
            const _n = (portalProfile && (`${portalProfile.firstName || ""} ${portalProfile.lastName || ""}`.trim())) || "Client";
            const _isMobile = (window.matchMedia && window.matchMedia("(max-width: 640px)").matches);
            showToast("Welcome!", `Signed in as ${_n}.`, false, _isMobile ? 1100 : 2200);
            // After sign-in, restore any in-progress selection and ensure availability loads
            try { await restorePortalStateIfPossible(); } catch (e) {}

      // Mobile-only: the selects can appear preloaded visually, but globals may not hydrate without a stored state.
      // This causes the calendar to render as fully disabled. On mobile, synchronize selection from UI and load availability if needed.
      if (window.matchMedia && window.matchMedia("(max-width: 640px)").matches) {
        try {
          const uiServiceKey = (treatmentSelect && treatmentSelect.value) ? String(treatmentSelect.value).trim() : "";
          const uiDurVal = (durationSelect && durationSelect.value) ? Number(durationSelect.value) : NaN;

          if (!selectedServiceKey && uiServiceKey) selectedServiceKey = uiServiceKey;
          if ((!selectedStandardDuration || isNaN(Number(selectedStandardDuration))) && !isNaN(uiDurVal) && uiDurVal > 0) {
            selectedStandardDuration = uiDurVal;
          }

          const hasAvailabilityData = availabilityByDate && Object.keys(availabilityByDate).length > 0;

          if (selectedServiceKey && selectedStandardDuration && !hasAvailabilityData) {
            await maybeLoadAvailabilityForCurrentMonth();
          } else {
            renderCalendar();
          }
        } catch (e) {
          console.warn("Mobile calendar hydration failed:", e);
          renderCalendar();
        }
      }

            try {
              if (portalProfile) {
                if (!selectedServiceKey && treatmentSelect && treatmentSelect.value && TREATMENT_RULES[treatmentSelect.value]) {
                  selectedServiceKey = treatmentSelect.value;
                  rebuildDurationOptions();
                }
                if (!selectedStandardDuration && durationSelect && durationSelect.value) {
                  selectedStandardDuration = Number(durationSelect.value);
                }
                if (selectedServiceKey && selectedStandardDuration) {
                  await maybeLoadAvailabilityForCurrentMonth();
                }
                renderCalendar();
              }
            } catch (e) {}

            
            // Load appointments and preload availability
            loadUpcomingAppointments();
            preloadAvailabilityInBackground();
          }, 300);

        } catch (e) {
          console.error("Auth processing error:", e);
          showAuthError("Sign in succeeded but there was an error loading your profile. Please refresh.");
        }
      });

      // Handle auth errors
      lock.on('authorization_error', function(err) {
        console.error('Auth0 authorization_error:', err);
        showAuthError("Sign in failed. Please check your email/password and try again.");
      });

      lock.on('unrecoverable_error', function(err) {
        console.error('Auth0 unrecoverable_error:', err);
        showAuthError("An error occurred. Please refresh the page and try again.");
      });
    }

    // =========================================================
    // LOGOUT
    // =========================================================
    async function handleLogout() {
      clearPortalState();
      // Clear tokens
      try {
        localStorage.removeItem("rnr_portal_profile");
        localStorage.removeItem("rnr_id_token");
        localStorage.removeItem("rnr_auth_token");
      } catch(e) {}

      // Reset state
      portalProfile = null;
      
      // Show login overlay and reinitialize Lock
      showLoginOverlay();
      
      // Destroy existing Lock instance and create new one
      if (lock) {
        try { lock.hide(); } catch(e) {}
      }
      
      // Clear the container and reinitialize
      document.getElementById("auth0-lock-container").innerHTML = "";
      initAuth0Lock();
      
      showToast("Signed out", "You have been signed out successfully.");
    }

    // =========================================================
    // TREATMENT / DURATION
    // =========================================================
    function rebuildDurationOptions() {
      if (!durationSelect) {
        console.error("durationSelect not found");
        return;
      }
      durationSelect.innerHTML = "";

      const rule = selectedServiceKey ? TREATMENT_RULES[selectedServiceKey] : null;
      if (!rule) {
        durationSelect.disabled = true;
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "Select a treatment first…";
        durationSelect.appendChild(opt);
        selectedStandardDuration = null;
        updateSummary();
        return;
      }

      const firstOpt = document.createElement("option");
      firstOpt.value = "";
      firstOpt.textContent = "Select…";
      durationSelect.appendChild(firstOpt);

      rule.durations.forEach(min => {
        const opt = document.createElement("option");
        opt.value = String(min);
        opt.textContent = `${min} min`;
        durationSelect.appendChild(opt);
      });

      durationSelect.disabled = false;
      selectedStandardDuration = null;
      updateSummary();
    }

    // =========================================================
    // AVAILABILITY
    // =========================================================
    function clearSelectionUI() {
      selectedDateStr = null;
      selectedSlot = null;

      document.getElementById("selected-date-info").classList.add("hidden");
      document.getElementById("time-slots-container").classList.add("hidden");
      document.getElementById("no-slots").classList.add("hidden");
      document.getElementById("confirm-booking-btn").classList.add("btn-disabled");
      setConfirmEnabled(false);
      updateSummary();
    }

    function buildAvailabilityPayload() {
      const addrOk = portalProfile && portalProfile.address && portalProfile.city && portalProfile.postal_code;
      if (!addrOk) return { error: "Missing address/city/postal code in portal profile." };
      if (!selectedServiceKey || !selectedStandardDuration) return { error: "Select treatment and duration first." };

      const { from, to } = computeMonthRange(calendarCurrent);
      const blockMinutes = Number(selectedStandardDuration) + Number(STATIC_SETUP_MINUTES);

      return {
        address: portalProfile.address,
        city: portalProfile.city,
        postal_code: portalProfile.postal_code,
        from,
        to,
        standardDurationMinutes: Number(selectedStandardDuration),
        blockDurationMinutes: Number(blockMinutes),
        slotIntervalMinutes: 15,
        practitionerId: DEFAULT_PRACTITIONER_ID,
        travel_time_buffer_minutes: 0
      };
    }

    function getRequestCacheKey(payload) {
      return [
        payload.from, payload.to,
        payload.standardDurationMinutes, payload.blockDurationMinutes,
        payload.practitionerId,
        payload.address, payload.city, payload.postal_code
      ].join("|");
    }

        function parseAvailabilityResponse(data) {
      availabilityByDate = {};
      availabilityMeta = { maxDriveTimeMinutes: 0, effective_travel_buffer_minutes: 0 };

      if (!data) return;

      // MOBILE FIX: Check multiple possible field names for metadata
      availabilityMeta.maxDriveTimeMinutes = Number(
        data.maxDriveTimeMinutes || data.max_drive_time_minutes ||
        data.driveTimeMinutes || data.drive_time_minutes || 0
      );
      availabilityMeta.effective_travel_buffer_minutes = Number(
        data.effective_travel_buffer_minutes || data.effectiveTravelBufferMinutes ||
        data.travel_buffer_minutes || data.travelBufferMinutes || 0
      );

      // Find dates array in response
      var datesArray = null;
      if (data.dates && Array.isArray(data.dates)) datesArray = data.dates;
      else if (Array.isArray(data)) datesArray = data;
      else if (data.availability && Array.isArray(data.availability)) datesArray = data.availability;
      else if (data.days && Array.isArray(data.days)) datesArray = data.days;

      if (!datesArray) return;

      datesArray.forEach(function(day) {
        if (!day) return;
        var rawDate = day.date || day.day || day.dateStr || day.date_str;
        if (!rawDate) return;

        // MOBILE FIX: Normalize date key
        var normalizedDate = normalizeDateKey(rawDate);
        if (!normalizedDate) return;

        var slots = day.slots || day.timeSlots || day.times || [];
        if (!Array.isArray(slots)) return;

        availabilityByDate[normalizedDate] = slots;
      });
    }

    async function maybeLoadAvailabilityForCurrentMonth() {
      const payload = buildAvailabilityPayload();
      if (payload.error) {
        updateAvailabilityStatus(payload.error, false);
        availabilityByDate = {};
        renderCalendar();
        clearSelectionUI();
        return;
      }

      const cacheKey = getRequestCacheKey(payload);
      clearSelectionUI();
      setCalendarLoading(true);
      updateAvailabilityStatus("Checking live availability for this month…", false);

      try {
        if (availabilityCache.has(cacheKey)) {
          const cached = availabilityCache.get(cacheKey);
          parseAvailabilityResponse(cached);
          renderCalendar();
          updateAvailabilityStatus("Availability loaded from cache for this month.", true);
          savePortalState();
          // Restore date selection (if any) after availability is loaded
          const s = loadPortalState();
          if (s?.selectedDateStr && availabilityByDate?.[s.selectedDateStr]) selectDate(s.selectedDateStr);
          return;
        }

        const res = await fetch(AVAILABILITY_WEBHOOK_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          const text = await res.text().catch(() => "");
          throw new Error("Availability error (" + res.status + "): " + (text || res.statusText));
        }

        const data = await res.json();
        availabilityCache.set(cacheKey, data);
        parseAvailabilityResponse(data);

        renderCalendar();
        updateAvailabilityStatus("Live availability loaded for this month.", true);

      } catch (e) {
        console.error(e);
        availabilityByDate = {};
        renderCalendar();
        updateAvailabilityStatus("Could not load availability. Please try again or contact support.", false);
        showToast("Availability error", "Unable to load availability.", true);
      } finally {
        setCalendarLoading(false);
      }
    }


    function renderCalendar() {
      const monthLabelEl = document.getElementById("calendar-month-label");
      const daysContainer = document.getElementById("calendar-days");

      const monthName = calendarCurrent.toLocaleDateString("en-CA", { month: "long", year: "numeric" });
      monthLabelEl.textContent = monthName;

      const year = calendarCurrent.getFullYear();
      const month = calendarCurrent.getMonth();

      const firstDay = new Date(year, month, 1);
      const startDayOfWeek = firstDay.getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();

      daysContainer.innerHTML = "";

      for (let i = 0; i < startDayOfWeek; i++) {
        const blank = document.createElement("div");
        blank.className = "opacity-0";
        blank.textContent = ".";
        daysContainer.appendChild(blank);
      }

      const todayStr = toDateStr(new Date());

      for (let day = 1; day <= daysInMonth; day++) {
        const dayDate = new Date(year, month, day);
        const dateStr = toDateStr(dayDate);

        const slots = availabilityByDate[dateStr] || [];
        const hasAnyAvailable = Array.isArray(slots) && slots.some(function(s) { return isSlotAvailable(s); });

        const isPast = dateStr < todayStr;
        const isSelected = selectedDateStr === dateStr;
        const isToday = dateStr === todayStr;

        const cell = document.createElement("button");
        cell.type = "button";
        cell.className = "calendar-day";

        if (isPast || !hasAnyAvailable || !selectedServiceKey || !selectedStandardDuration) {
          cell.classList.add("calendar-day-disabled");
          cell.disabled = true;
        } else {
          cell.classList.add("calendar-day-available");
          if (isToday) cell.classList.add("calendar-day-today");
          if (isSelected) cell.classList.add("calendar-day-selected");
          cell.addEventListener("click", () => selectDate(dateStr));
        }

        cell.textContent = String(day);
        daysContainer.appendChild(cell);
      }

      if (typeof lucide !== "undefined") lucide.createIcons();
    }

    function selectDate(dateStr) {
      selectedDateStr = dateStr;
      selectedSlot = null;
      renderCalendar();
      updateSummary();
      savePortalState();

      document.getElementById("selected-date-info").classList.remove("hidden");
      document.getElementById("selected-date-display").textContent = formatDatePretty(dateStr);

      loadTimeSlots(dateStr);
    }

    function loadTimeSlots(dateStr) {
      const container = document.getElementById("time-slots-container");
      const grid = document.getElementById("time-slots-grid");
      const noSlots = document.getElementById("no-slots");

      container.classList.remove("hidden");
      grid.innerHTML = "";

      const slots = availabilityByDate[dateStr] || [];
      const usable = Array.isArray(slots) ? slots : [];

      if (!usable.length) {
        noSlots.classList.remove("hidden");
        container.classList.add("hidden");
        return;
      }

      usable.sort((a,b) => new Date(a.start).getTime() - new Date(b.start).getTime());

      let anyAvailable = false;

      usable.forEach(slot => {
        const btn = document.createElement("button");
        // Persistable slot identifiers for refresh recovery
        try {
          btn.setAttribute("data-slot-id", String(slot.start || slot.label || ""));
          btn.setAttribute("data-slot-raw", JSON.stringify(slot));
        } catch (e) {}
        btn.type = "button";
        // Base class: we add 'time-slot-btn' and specific styles for available/booked below
        btn.className = "time-slot-btn px-1 py-2 flex items-center justify-center w-full rounded-lg border";
        
        // Clean label: strip EST, (Booked)
        const labelRaw = formatTimeLabel(slot); 
        // formatTimeLabel returns lower case.
        const labelClean = labelRaw.replace(/est/g, "").replace(/\(booked\)/g, "").trim();

        if (isSlotAvailable(slot)) {
          btn.classList.add("border-brand-gold/30", "bg-black/40", "text-brand-light", "hover:bg-brand-gold/15", "hover:border-brand-gold");
          btn.innerHTML = `<span class="font-bold text-sm whitespace-nowrap">${labelClean}</span>`;
          anyAvailable = true;
          btn.addEventListener("click", () => selectTimeSlot(slot, btn));
        } else {
          btn.classList.add("border-white/5", "bg-white/5", "text-white/30", "cursor-not-allowed", "opacity-50");
          btn.innerHTML = `<span class="font-bold text-sm whitespace-nowrap line-through decoration-brand-gold/40 decoration-2">${labelClean}</span>`;
          btn.disabled = true;
        }

        grid.appendChild(btn);
      });

      noSlots.classList.toggle("hidden", anyAvailable);
      container.classList.toggle("hidden", !anyAvailable);

      if (typeof lucide !== "undefined") lucide.createIcons();
    }

    function selectTimeSlot(slot, btnElement) {
      selectedSlot = slot;

      document.querySelectorAll(".time-slot-btn").forEach(btn => btn.classList.remove("time-slot-selected"));
      btnElement.classList.add("time-slot-selected");

      updateSummary();
    }

    function prevMonth() {
      calendarCurrent = new Date(calendarCurrent.getFullYear(), calendarCurrent.getMonth() - 1, 1);
      renderCalendar();
      maybeLoadAvailabilityForCurrentMonth();
    }

    function nextMonth() {
      calendarCurrent = new Date(calendarCurrent.getFullYear(), calendarCurrent.getMonth() + 1, 1);
      renderCalendar();
      maybeLoadAvailabilityForCurrentMonth();
    }

    // =========================================================
    // BOOKING CONFIRMATION
    // =========================================================
    async function confirmBooking() {
      if (!(portalProfile && selectedServiceKey && selectedStandardDuration && selectedDateStr && selectedSlot)) {
        showToast("Missing info", "Please select a treatment, duration, date, and time.", true);
        return;
      }

      const treat = TREATMENT_RULES[selectedServiceKey];
      const driveTime = selectedSlot?.driveTimeMinutes || 0;
      const travelFee = calcTravelFee(driveTime);

      const bookingPayload = {
        firstName: portalProfile.firstName || "",
        lastName:  portalProfile.lastName || "",
        email:     portalProfile.email || "",
        phone:     portalProfile.phone || "",
        address: portalProfile.address,
        city: portalProfile.city,
        postal_code: portalProfile.postal_code,
        treatment_key: selectedServiceKey,
        treatment_label: treat ? treat.label : "",
        duration: Number(selectedStandardDuration),
        standardDurationMinutes: Number(selectedStandardDuration),
        participants: 1,
        participant_count: 1,
        slot_start: selectedSlot.start,
        slot_end: selectedSlot.end,
        date: selectedDateStr,
        times_already_utc: true,
        travel_charge: Number(travelFee || 0),
        drive_time_minutes: Number(driveTime || 0),
        travel_fee_cents: Math.round(Number(travelFee || 0) * 100),
        notes: "Booked via Client Portal."
      };

      try { localStorage.setItem("rnr_portal_last_booking_payload", JSON.stringify(bookingPayload)); } catch(e) {}

      const btn = document.getElementById("confirm-booking-btn");
      btn.disabled = true;
      btn.classList.add("btn-disabled");

      // Show the booking modal with cycling messages
      showBookingModal();

      try {
        const res = await fetch(BOOKING_WEBHOOK_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(bookingPayload)
        });

        if (!res.ok) {
          const text = await res.text().catch(() => "");
          throw new Error(`Booking error (${res.status}): ${text || res.statusText}`);
        }

        const result = await res.json().catch(() => ({}));

        // Show success in modal
        hideBookingModal(true);

        console.log("Booking confirmed:", result);

        // Clear the cache so fresh data loads next time
        availabilityCache.clear();

        // Wait for modal to close, then go to dashboard
        setTimeout(() => {
          resetBookingForm();
          showToast("Success", "Your appointment has been confirmed!");
          switchTab('dashboard');
          loadUpcomingAppointments();
          preloadAvailabilityInBackground(true);
        }, 2200);

      } catch (e) {
        console.error(e);
        
        // Show error in modal
        hideBookingModal(false, "Unable to complete booking");

        // Re-enable button after modal closes
        setTimeout(() => {
          btn.disabled = false;
          btn.classList.remove("btn-disabled");
          showToast("Booking failed", "Please try again or contact support.", true);
        }, 3200);
      }
    }

    // =========================================================
    // TAB SWITCHING
    // =========================================================
    function switchTab(tabId) {
      document.querySelectorAll(".tab-content").forEach(el => el.classList.add("hidden"));
      const active = document.getElementById("tab-" + tabId);
      if (active) active.classList.remove("hidden");

      document.querySelectorAll(".sidebar-btn").forEach(btn => {
        btn.classList.toggle("active", btn.dataset.tab === tabId);
      });

      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    // =========================================================
    // INIT
    // =========================================================
    async function init() {
      if (typeof lucide !== "undefined") lucide.createIcons();

      // Mobile menu (portal navigation)
      const mm = document.getElementById("mobile-menu");
      const mmBackdrop = document.getElementById("mobile-menu-backdrop");

      let mobileMenuScrollY = 0;

      const openMobileMenu = () => {
        mobileMenuScrollY = window.scrollY || 0;

        mm?.classList.add("open");
        mmBackdrop?.classList.add("open");

        document.documentElement.classList.add("menu-open");
        document.body.classList.add("menu-open");

        // Prevent background scrolling (including iOS)
        document.body.style.position = "fixed";
        document.body.style.top = `-${mobileMenuScrollY}px`;
        document.body.style.width = "100%";
      };

      const closeMobileMenu = () => {
        mm?.classList.remove("open");
        mmBackdrop?.classList.remove("open");

        document.documentElement.classList.remove("menu-open");
        document.body.classList.remove("menu-open");

        // Restore scroll position
        document.body.style.position = "";
        document.body.style.top = "";
        document.body.style.width = "";
        window.scrollTo(0, mobileMenuScrollY);
      };

      document.getElementById("mobile-menu-btn")?.addEventListener("click", openMobileMenu);
      document.getElementById("mobile-menu-close")?.addEventListener("click", closeMobileMenu);
      mmBackdrop?.addEventListener("click", closeMobileMenu);

      // Close menu on ESC
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") closeMobileMenu();
      });

      // Wire portal tab buttons inside the mobile menu
      document.querySelectorAll(".mobile-portal-btn").forEach(btn => {
        const tab = btn.dataset.tab;
        if (!tab) return;
        btn.addEventListener("click", () => {
          switchTab(tab);
          closeMobileMenu();
        });
      });

      // Add-to-Home-Screen / Install (PWA)
      const installBtn = document.getElementById("install-app-btn");
      const installIosBtn = document.getElementById("install-app-ios-btn");

      const isIOS = () => /iphone|ipad|ipod/i.test(navigator.userAgent || "");
      const isStandalone = () =>
        (window.matchMedia && window.matchMedia("(display-mode: standalone)").matches) ||
        (window.navigator && window.navigator.standalone === true);

      const refreshInstallButtons = () => {
        // If already installed as an app, hide install UI
        if (isStandalone()) {
          installBtn?.classList.add("hidden");
          installIosBtn?.classList.add("hidden");
          return;
        }

        // Always show a single "Download App" entry on Android/desktop browsers;
        // it will either trigger the install prompt (if available) or show instructions.
        installBtn?.classList.remove("hidden");

        // On iOS Safari, also show the dedicated instruction entry (optional).
        if (isIOS()) installIosBtn?.classList.remove("hidden");
        else installIosBtn?.classList.add("hidden");
      };

      // Android/Chromium: capture prompt when available
      window.addEventListener("beforeinstallprompt", (e) => {
        try { e.preventDefault(); } catch (err) {}
        deferredInstallPrompt = e;
        refreshInstallButtons();
      });

      // Initial state
      refreshInstallButtons();

      installBtn?.addEventListener("click", async () => {
        try {
          if (isStandalone()) return;

          if (deferredInstallPrompt) {
            deferredInstallPrompt.prompt();
            try { await deferredInstallPrompt.userChoice; } catch (e) {}
            deferredInstallPrompt = null;
            refreshInstallButtons();
          } else if (isIOS()) {
            showToast("Add to Home Screen", "On iPhone/iPad: tap Share, then ‘Add to Home Screen’.", false, 6500);
          } else {
            showToast("Install the app", "In Chrome: tap the menu (⋮) then choose ‘Install app’ or ‘Add to Home screen’.", false, 6500);
          }
        } finally {
          closeMobileMenu();
        }
      });

      installIosBtn?.addEventListener("click", () => {
        showToast("Add to Home Screen", "On iPhone/iPad: tap Share, then ‘Add to Home Screen’.", false, 6500);
        closeMobileMenu();
      });

// Get form elements
      treatmentSelect = document.getElementById("treatment-select");
      durationSelect = document.getElementById("duration-select");

      // Tabs
      document.querySelectorAll(".sidebar-btn").forEach(btn => {
        const tab = btn.dataset.tab;
        if (!tab) return;
        if (btn.disabled) {
          // btn.addEventListener("click", () => showToast("Coming Soon", "That feature is not available yet."));
          return;
        }
        btn.addEventListener("click", () => switchTab(tab));
      });

      // Calendar nav
      document.getElementById("prev-month-btn").addEventListener("click", prevMonth);
      document.getElementById("next-month-btn").addEventListener("click", nextMonth);

      // Treatment selection
      treatmentSelect.addEventListener("change", () => {
        selectedServiceKey = treatmentSelect.value || null;
        rebuildDurationOptions();

        availabilityByDate = {};
        availabilityMeta = { maxDriveTimeMinutes: 0, effective_travel_buffer_minutes: 0 };
        availabilityPreloaded = false;
        clearSelectionUI();
        renderCalendar();

        if (!selectedServiceKey) {
          updateAvailabilityStatus("Select your treatment and duration to load live availability.", false);
        } else {
          updateAvailabilityStatus("Now choose a duration to load live availability.", false);
          savePortalState();
        }
      });

      // Duration selection
      durationSelect.addEventListener("change", () => {
        selectedStandardDuration = durationSelect.value ? Number(durationSelect.value) : null;

        availabilityByDate = {};
        availabilityMeta = { maxDriveTimeMinutes: 0, effective_travel_buffer_minutes: 0 };
        availabilityPreloaded = false;
        clearSelectionUI();
        renderCalendar();

        if (selectedStandardDuration) {
          maybeLoadAvailabilityForCurrentMonth();
        }
        updateSummary();
        savePortalState();
      });

      // Confirm booking
      document.getElementById("confirm-booking-btn").addEventListener("click", confirmBooking);

      // Logout
      document.getElementById("logout-btn").addEventListener("click", handleLogout);
      document.getElementById("logout-btn-mobile").addEventListener("click", handleLogout);

      // Initial tab
      switchTab("dashboard");

      // Check for existing authentication - this will either show login or load the portal
      await checkExistingAuth();

      // After auth/profile init, restore prior in-progress booking selections (if any)
      try { await restorePortalStateIfPossible(); } catch (e) {}
    }

    // Run on DOM ready
    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
