<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Client Portal | Relax & Renew RMT</title>
  <meta name="description" content="Relax & Renew Client Portal — rebook appointments, view your details, and manage your membership." />

  <!-- Meta Pixel -->
  <script>
  !function(f,b,e,v,n,t,s)
  {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
  n.callMethod.apply(n,arguments):n.queue.push(arguments)};
  if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
  n.queue=[];t=b.createElement(e);t.async=!0;
  t.src=v;s=b.getElementsByTagName(e)[0];
  s.parentNode.insertBefore(t,s)}(window, document,'script',
  'https://connect.facebook.net/en_US/fbevents.js');
  fbq('init', '701194265870298');
  fbq('track', 'PageView');
  </script>
  <noscript><img height="1" width="1" style="display:none"
  src="https://www.facebook.com/tr?id=701194265870298&ev=PageView&noscript=1"
  /></noscript>

  <!-- Google Analytics / Ads -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=AW-17575022013"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-J4NC9FL44H');
    gtag('config', 'AW-17575022013');
  </script>

  <!-- Suppress noisy third-party errors -->
  <script>
    window.onerror = function(msg, url, line, col, error) {
      if (!url || (msg && String(msg).toLowerCase().indexOf("script error") > -1)) return true;
      return false;
    };
    window.addEventListener('unhandledrejection', function(event) { event.preventDefault(); });
  </script>

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;0,700;1,400&display=swap" rel="stylesheet">

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            gold: '#E0C584',
                            goldHover: '#F0D594',
                            light: '#F0E2C0', 
                            dim: 'rgba(240, 226, 192, 0.6)',
                            black: '#050505',
                            dark: '#0a0a0a',
                            panel: 'rgba(20, 20, 20, 0.7)',
                        }
                    },
                    fontFamily: {
                        serif: ['"Cormorant Garamond"', 'serif'],
                    },
                    backgroundImage: {
                        'hero-pattern': "linear-gradient(to bottom, rgba(0,0,0,0.3), rgba(0,0,0,0.9)), url('https://static.wixstatic.com/media/bf8fef_94f8be278f0f4b8abaee73b95d03b5e2~mv2.png')",
                        'alternate-pattern': "linear-gradient(to bottom, rgba(0,0,0,0.8), rgba(0,0,0,0.95)), url('https://static.wixstatic.com/media/bf8fef_7776f5b067be4025a75ed7e149bb1d7e~mv2.jpg')",
                        'gift-card-bg': "url('https://static.wixstatic.com/media/bf8fef_9da7c8e6be37443d89cac9f6884ec878~mv2.jpg')"
                    },
                    animation: {
                        'fade-in-up': 'fadeInUp 1s ease-out forwards',
                        'subtle-bounce': 'subtleBounce 3s ease-in-out infinite',
                        'loading-bar': 'loadingBar 1.5s ease-in-out infinite',
                    },
                    keyframes: {
                        fadeInUp: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' }
                        },
                        subtleBounce: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-3px)' }
                        },
                        loadingBar: {
                            '0%': { transform: 'translateX(-100%)' },
                            '100%': { transform: 'translateX(300%)' }
                        }
                    }
                }
            }
        };
  </script>

  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <!-- Auth0 Lock (Embedded Email + Password Window) -->
  <script src="https://cdn.auth0.com/js/lock/14.2.0/lock.min.js"></script>

  <style>
    :root {
      --brand-black: #050505;
      --brand-gold: #E0C584;
      --brand-gold-hover: #F0D594;
      --brand-light: #F0E2C0;
      --brand-dim: rgba(240, 226, 192, 0.6);
      --radius: 0.25rem;
      --shadow: 0 10px 30px rgba(0,0,0,0.55);
    }

    html, body { height:100%; }
    
    body {
      font-family: 'Cormorant Garamond', serif;
      background-color: #050505; 
      color: var(--brand-light);
      overflow-x: hidden;
    }

    /* =========================================
       FIXED: Header Navigation (From Index.html)
       ========================================= */
    .fixed-nav { 
        position: fixed; top: 0; left: 0; width: 100%; height: 80px; 
        z-index: 50; 
        transition: all 0.4s ease; 
        background: rgba(5, 5, 5, 0.95); 
        backdrop-filter: blur(15px); 
        border-bottom: 1px solid rgba(224, 197, 132, 0.2); 
        display: flex; align-items: center; 
    }
    
    .nav-link { 
        color: #F0E2C0; 
        text-transform: uppercase; 
        font-size: 0.8rem; 
        font-weight: 600; 
        letter-spacing: 0.15em; 
        text-decoration: none; 
        position: relative; 
        padding-bottom: 5px; 
    }
    .nav-link::after { 
        content: ''; position: absolute; bottom: 0; left: 0; width: 0; height: 1px; 
        background: #E0C584; transition: width 0.3s ease; 
    }
    .nav-link:hover::after { width: 100%; }

    /* Mobile Menu */
    .mobile-menu {
      background: #050505;
      transform: translateX(100%);
      transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .mobile-menu.open { transform: translateX(0); }

    .header-hero { background: transparent; }

    /* Cards */
    .card-fancy, .glass-panel {
      background: linear-gradient(145deg, rgba(20,20,20,0.8), rgba(10,10,10,0.9));
      border: 1px solid rgba(224, 197, 132, 0.1);
      backdrop-filter: blur(10px);
      transition: all 0.4s ease;
      position: relative;
      overflow: hidden;
      border-radius: var(--radius);
    }
    .card-fancy::before, .glass-panel::before {
      content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 2px;
      background: linear-gradient(90deg, transparent, #E0C584, transparent);
      transform: scaleX(0); transition: transform 0.5s ease;
    }
    .card-fancy:hover, .glass-panel:hover { border-color: rgba(224, 197, 132, 0.3); }
    .card-fancy:hover::before, .glass-panel:hover::before { transform: scaleX(1); }

    /* Buttons */
    .btn-outline {
      border: 1px solid #E0C584; color: #E0C584; background: transparent;
      padding: 0.6rem 1.5rem; text-transform: uppercase; font-weight: 700; letter-spacing: 0.1em;
      transition: 0.3s; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; cursor: pointer;
    }
    .btn-outline:hover {
      background: rgba(224, 197, 132, 0.1); color: #F0E2C0; border-color: #F0D594;
      box-shadow: 0 0 15px rgba(224, 197, 132, 0.2);
    }
    .btn-filled {
      background: #E0C584; color: #000; border: 1px solid #E0C584;
      padding: 0.6rem 1.5rem; text-transform: uppercase; font-weight: 700; letter-spacing: 0.1em;
      transition: 0.3s; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; cursor: pointer;
    }
    .btn-filled:hover {
      background: #F0D594; border-color: #F0D594; transform: translateY(-1px);
      box-shadow: 0 5px 15px rgba(224, 197, 132, 0.3);
    }
    .btn-disabled {
      opacity: 0.5; cursor: not-allowed; background: #333 !important; border-color: #444 !important; color: #777 !important;
      box-shadow: none !important; transform: none !important;
    }

    /* Inputs */
    .input {
      width: 100%; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(224, 197, 132, 0.3);
      color: var(--brand-light); padding: 0.6rem 1rem; border-radius: 0.25rem; outline: none; font-size: 1rem;
      min-height: 48px;
      max-width: 100%;
    }
    /* Fixed Dropdowns: Custom arrow, dark background for options */
    select.input {
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      padding-right: 2.5rem;
      background-color: rgba(5,5,5,0.8);
      /* Custom Gold Chevron */
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23E0C584' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
      background-position: right 0.5rem center;
      background-repeat: no-repeat;
      background-size: 1.5em 1.5em;
    }
    .input:focus { border-color: #E0C584; background-color: rgba(255, 255, 255, 0.1); }
    
    /* Ensure Dropdown Options are Black */
    select.input option {
      background-color: #050505;
      color: #F0E2C0;
      padding: 10px;
    }

    /* Sidebar */
    .sidebar-btn {
      width: 100%; display: flex; gap: 0.7rem; align-items: center; padding: 0.75rem 1rem;
      border: 1px solid transparent; border-radius: var(--radius); color: rgba(240, 226, 192, 0.6);
      transition: all 0.3s ease; font-size: 1.05rem; background: transparent;
    }
    .sidebar-btn:hover { background: rgba(224, 197, 132, 0.05); color: #E0C584; }
    .sidebar-btn.active { background: rgba(224, 197, 132, 0.1); border: 1px solid rgba(224, 197, 132, 0.2); color: #E0C584; }

    /* Calendar */
    .calendar-day {
      width: 100%; aspect-ratio: 1/1; display: flex; align-items: center; justify-content: center;
      border: 1px solid rgba(224, 197, 132, 0.1); background: rgba(255,255,255,0.02);
      border-radius: var(--radius); font-weight: 600; transition: all 0.2s ease; user-select: none; color: var(--brand-light);
    }
    .calendar-day-available { cursor: pointer; }
    .calendar-day-available:hover { border-color: #E0C584; background: rgba(224, 197, 132, 0.1); transform: scale(1.05); }
    .calendar-day-disabled { background: rgba(0, 0, 0, 0.3); color: rgba(240, 226, 192, 0.2); cursor: not-allowed; border-color: transparent; }
    .calendar-day-selected { background: #E0C584 !important; color: #000 !important; border-color: #E0C584 !important; font-weight: bold; box-shadow: 0 0 10px rgba(224,197,132,0.3); }
    .calendar-day-today { border-color: #F0E2C0; }

    /* Slots */
    .time-slot-btn {
      width: 100%; display: flex; align-items: center; justify-content: center; gap: 0.5rem;
      padding: 0.6rem; border: 1px solid rgba(224, 197, 132, 0.2); background: rgba(255,255,255,0.03);
      border-radius: var(--radius); transition: all 0.2s ease; font-weight: 600; color: var(--brand-light);
    }
    .time-slot-btn:hover { border-color: #E0C584; background: rgba(224, 197, 132, 0.1); }
    .time-slot-selected { background: #E0C584 !important; color: #000 !important; border-color: #E0C584 !important; }
    .time-slot-unavailable { opacity: 0.4; cursor: not-allowed; border-color: transparent; }

    .pill {
      background: rgba(224, 197, 132, 0.08); border: 1px solid rgba(224, 197, 132, 0.2); color: #F0E2C0;
      display: inline-flex; align-items: center; gap: 0.4rem; padding: 0.3rem 0.8rem; border-radius: 4px;
      font-size: 0.9rem; letter-spacing: 0.05em;
    }
    .muted { color: var(--brand-dim); }
    .divider { border-color: rgba(224, 197, 132, 0.15); }
    
    .toast {
      background: rgba(20, 20, 20, 0.95); border: 1px solid #E0C584; color: #E0C584;
      box-shadow: 0 10px 30px rgba(0,0,0,0.8); backdrop-filter: blur(10px);
    }

    /* =========================================
       FIXED: Login Overlay CSS - MOBILE OPTIMIZED
       ========================================= */
    /* =========================================
   LOGIN OVERLAY (Android-safe): lock background + prevent scroll chaining
   ========================================= */

/* When overlay is open, hard-lock the page behind it */
body.portal-scroll-locked {
  overflow: hidden !important;
  height: 100% !important;
  position: fixed !important;
  width: 100% !important;
  left: 0 !important;
  right: 0 !important;
}

/* Overlay must NEVER scroll. Only the card scrolls. */
#login-overlay {
  position: fixed;
  inset: 0;
  z-index: 200;
  width: 100vw;
  height: 100dvh;         /* Android address-bar safe */
  height: 100vh;          /* fallback */
  background: #050505;    /* fully blocks underlay (no page showing through) */
  display: flex;
  align-items: flex-start;
  justify-content: center;

  /* critical: stop scroll chaining / bounce showing background */
  overflow: hidden;
  overscroll-behavior: none;
  touch-action: none;

  padding: 96px 12px 18px; /* top clears fixed nav; card scroll handles the rest */
}

#login-overlay.hidden {
  opacity: 0;
  visibility: hidden;
  pointer-events: none;
}

.login-card {
  background: linear-gradient(145deg, rgba(20,20,20,0.95), rgba(10,10,10,0.98));
  border: 1px solid rgba(224, 197, 132, 0.25);
  backdrop-filter: blur(10px);

  width: 96%;
  max-width: 420px;

  /* card scrolls, not the overlay */
  max-height: calc(100dvh - 120px);
  max-height: calc(100vh - 120px);
  overflow-y: auto;
  overscroll-behavior: contain;
  touch-action: pan-y;

  padding: 1.25rem 0.5rem;
  position: relative;
}

.login-card::before {
  content: '';
  position: absolute;
  top: 0; left: 0;
  width: 100%; height: 2px;
  background: linear-gradient(90deg, transparent, #E0C584, transparent);
}

/* Desktop spacing stays the same */
@media (min-width: 640px) {
  #login-overlay {
    align-items: center;
    padding: 1rem;
    touch-action: auto;
  }
  .login-card {
    padding: 2.5rem 2rem;
    max-height: none;
    overflow: visible;
  }
}


    /* =========================================
       FIXED: Auth0 Lock Styles (Robust Overrides)
       ========================================= */
    #auth0-lock-container { 
        width: 100% !important; 
        max-width: 100% !important;
    }
    
    /* Ensure Lock Widget is Fluid on Mobile */
    #auth0-lock-container .auth0-lock {
        width: 100% !important;
        box-sizing: border-box !important;
    }
    
    #auth0-lock-container .auth0-lock.auth0-lock-opened {
        width: 100% !important;
        height: auto !important;
        position: static !important;
        display: block !important;
    }

    #auth0-lock-container .auth0-lock,
    #auth0-lock-container .auth0-lock * {
      font-family: 'Cormorant Garamond', serif !important;
      border-radius: 0px !important;
      box-shadow: none !important;
    }
    
    /* Specific Widget Overrides */
    #auth0-lock-container .auth0-lock .auth0-lock-widget {
      background: #050505 !important;
      border: 1px solid rgba(224,197,132,0.45) !important;
      overflow: hidden !important;
      width: 100% !important;
      max-width: 100% !important;
      min-width: 0 !important; /* Allow shrinking */
      margin: 0 auto !important;
      box-sizing: border-box !important;
    }
    
    #auth0-lock-container .auth0-lock .auth0-lock-header,
    #auth0-lock-container .auth0-lock .auth0-lock-header-bg,
    #auth0-lock-container .auth0-lock .auth0-lock-footer,
    #auth0-lock-container .auth0-lock .auth0-lock-name,
    #auth0-lock-container .auth0-lock .auth0-lock-badge {
      display: none !important;
    }

    /* Internal Content Wrapper */
    #auth0-lock-container .auth0-lock-widget-container,
    #auth0-lock-container .auth0-lock-cred-pane {
        width: 100% !important;
        max-width: 100% !important;
    }

    #auth0-lock-container .auth0-lock,
    #auth0-lock-container .auth0-lock .auth0-lock-content,
    #auth0-lock-container .auth0-lock .auth0-lock-pane,
    #auth0-lock-container .auth0-lock .auth0-lock-cred-pane,
    #auth0-lock-container .auth0-lock .auth0-lock-center,
    #auth0-lock-container .auth0-lock .auth0-lock-form,
    #auth0-lock-container .auth0-lock .auth0-lock-body-content,
    #auth0-lock-container .auth0-lock .auth0-lock-signup,
    #auth0-lock-container .auth0-lock .auth0-lock-terms,
    #auth0-lock-container .auth0-lock .auth0-lock-message,
    #auth0-lock-container .auth0-lock .auth0-lock-warning,
    #auth0-lock-container .auth0-lock .auth0-lock-error,
    #auth0-lock-container .auth0-lock .auth0-lock-error-msg {
      background: #050505 !important;
      width: 100% !important; /* Force width */
      box-sizing: border-box !important;
    }
    #auth0-lock-container .auth0-lock,
    #auth0-lock-container .auth0-lock label,
    #auth0-lock-container .auth0-lock p,
    #auth0-lock-container .auth0-lock .auth0-lock-alternative,
    #auth0-lock-container .auth0-lock .auth0-lock-terms {
      color: rgba(240,226,192,0.92) !important;
    }
    #auth0-lock-container .auth0-lock label {
      color: #E0C584 !important;
      font-weight: 700 !important;
      letter-spacing: 0.04em !important;
    }
    #auth0-lock-container .auth0-lock .auth0-lock-tabs,
    #auth0-lock-container .auth0-lock .auth0-lock-tabs-container {
      background: #050505 !important;
      border-bottom: 1px solid rgba(224,197,132,0.25) !important;
    }
    #auth0-lock-container .auth0-lock .auth0-lock-tabs li a,
    #auth0-lock-container .auth0-lock .auth0-lock-tabs li span {
      background: #050505 !important;
      color: rgba(240,226,192,0.70) !important;
      text-transform: uppercase !important;
      letter-spacing: 0.14em !important;
      font-weight: 700 !important;
      font-size: 0.72rem !important;
      padding: 18px 16px !important;
    }
    #auth0-lock-container .auth0-lock .auth0-lock-tabs li.auth0-lock-tabs-current a,
    #auth0-lock-container .auth0-lock .auth0-lock-tabs li.auth0-lock-tabs-current span {
      color: #E0C584 !important;
    }

    /* INPUT FIELD FIXES - THE NUCLEAR OPTION */
    #auth0-lock-container .auth0-lock-input-block {
        margin-bottom: 10px !important;
        width: 100% !important;
    }

    /* Force wrapper to be flex to handle icon + input side-by-side without overflow */
    #auth0-lock-container .auth0-lock-input-wrap {
      background: #050505 !important;
      border: 1px solid rgba(224,197,132,0.55) !important;
      border-radius: 0 !important;
      padding: 0 !important;
      width: 100% !important;
      box-sizing: border-box !important;
      height: 44px !important; 
      display: flex !important;
      align-items: center !important;
      position: relative !important;
    }

    /* Absolute position the icon within the flex container's relative context */
    #auth0-lock-container .auth0-lock-input-wrap .auth0-lock-input-icon {
        position: absolute !important;
        left: 0 !important;
        top: 0 !important;
        bottom: 0 !important;
        width: 40px !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        color: rgba(224,197,132,0.90) !important;
        z-index: 10 !important;
    }
    
    /* Input takes full width but has padding-left to clear the icon */
    #auth0-lock-container .auth0-lock-input-wrap input,
    #auth0-lock-container .auth0-lock-input-wrap textarea {
      background: #050505 !important;
      color: rgba(240,226,192,0.95) !important;
      font-size: 1.05rem !important;
      width: 100% !important;
      height: 100% !important;
      padding-left: 45px !important; /* Space for icon */
      padding-right: 10px !important; /* Prevent right edge collision */
      border: none !important;
      margin: 0 !important;
      box-sizing: border-box !important;
    }
    
    #auth0-lock-container .auth0-lock-input-wrap input::placeholder,
    #auth0-lock-container .auth0-lock-input-wrap textarea::placeholder {
      color: rgba(240,226,192,0.45) !important;
    }
    #auth0-lock-container .auth0-lock-input-wrap:focus-within {
      border-color: #F0D594 !important;
      box-shadow: 0 0 0 3px rgba(224,197,132,0.18) !important;
    }
    
    #auth0-lock-container .auth0-lock button.auth0-lock-submit,
    #auth0-lock-container .auth0-lock .auth0-lock-submit button {
      background: #E0C584 !important;
      border: 1px solid #E0C584 !important;
      color: #000 !important;
      text-transform: uppercase !important;
      letter-spacing: 0.12em !important;
      font-weight: 800 !important;
      padding: 14px 16px !important;
      width: 100% !important; /* Force full width */
      box-sizing: border-box !important;
    }
    #auth0-lock-container .auth0-lock button.auth0-lock-submit:hover,
    #auth0-lock-container .auth0-lock .auth0-lock-submit button:hover {
      background: #F0D594 !important;
      border-color: #F0D594 !important;
    }
    #auth0-lock-container .auth0-lock .auth0-lock-separator span {
      background: #050505 !important;
      color: rgba(240,226,192,0.85) !important;
    }
    #auth0-lock-container .auth0-lock .auth0-lock-separator:before,
    #auth0-lock-container .auth0-lock .auth0-lock-separator:after {
      background: rgba(224,197,132,0.25) !important;
    }
    #auth0-lock-container .auth0-lock a {
      color: #E0C584 !important;
    }
    #auth0-lock-container .auth0-lock a:hover {
      color: #F0D594 !important;
    }

    /* =========================================
   MOBILE FIX (AGGRESSIVE): Kill Lock reserved space + let card size naturally
   ========================================= */

/* =========================================
   Auth0 Lock: ANDROID HEIGHT FIX (kills reserved blank space)
   ========================================= */
@media (max-width: 640px) {

  /* Force Lock to size to content (Auth0 often sets min-heights internally) */
  #auth0-lock-container,
  #auth0-lock-container .auth0-lock,
  #auth0-lock-container .auth0-lock-widget,
  #auth0-lock-container .auth0-lock-widget-container,
  #auth0-lock-container .auth0-lock-content,
  #auth0-lock-container .auth0-lock-pane,
  #auth0-lock-container .auth0-lock-cred-pane,
  #auth0-lock-container .auth0-lock-center,
  #auth0-lock-container .auth0-lock-body,
  #auth0-lock-container .auth0-lock-body-content,
  #auth0-lock-container .auth0-lock-form {
    height: auto !important;
    min-height: 0 !important;
    max-height: none !important;
  }

  /* The big culprit: widget often gets a min-height; hard reset it */
  #auth0-lock-container .auth0-lock-widget {
    min-height: unset !important;
    height: fit-content !important;
    display: block !important;
    padding-bottom: 0 !important;
    margin-bottom: 0 !important;
  }

  /* Remove internal padding/margins that create a fake “empty panel” */
  #auth0-lock-container .auth0-lock-content,
  #auth0-lock-container .auth0-lock-body-content,
  #auth0-lock-container .auth0-lock-widget-container,
  #auth0-lock-container .auth0-lock-cred-pane {
    padding-bottom: 0 !important;
    margin-bottom: 0 !important;
  }

  /* Submit must remain in normal flow */
  #auth0-lock-container .auth0-lock-submit {
    position: static !important;
    margin-top: 10px !important;
    padding: 0 !important;
  }

  /* Tighten input spacing slightly (reduces vertical bloat without changing look) */
  #auth0-lock-container .auth0-lock-input-block {
    margin-bottom: 8px !important;
  }
}

  </style>

  <script>
    // =========================================================
    // CONFIG
    // =========================================================
    const N8N_WEBHOOK_BASE = "https://primary-production-efcf.up.railway.app/webhook";
    const AVAILABILITY_WEBHOOK_URL = `${N8N_WEBHOOK_BASE}/portal-availability-gate`;
    const BOOKING_WEBHOOK_URL      = `${N8N_WEBHOOK_BASE}/portal-booking-confirmed`;
    const DEFAULT_PRACTITIONER_ID  = "1834304626376050851";
    const STATIC_SETUP_MINUTES = 25;
    const TRAVEL_FEE_THRESHOLD_MINUTES = 36; // Fee applies when drive time meets or exceeds this
    
    // Travel fee tiers based on drive time
    const TRAVEL_FEE_TIERS = [
      { minMinutes: 120, fee: 200 },
      { minMinutes: 60, fee: 100 },
      { minMinutes: 45, fee: 40 },
      { minMinutes: 36, fee: 20 },
    ];

    // Auth0 Config
    const AUTH0_DOMAIN = "auth.relaxandrenew.ca";
    const AUTH0_CLIENT_ID = "T8FERqkpcryRN77voMnLeaXIkha1eqK1";
    const AUTH0_DB_CONNECTION = "Username-Password-Authentication";

    // Custom claim keys
    const CLAIM_PROFILE_OBJ  = "https://relaxandrenew.ca/profile";
    const CLAIM_ADDRESS      = "https://relaxandrenew.ca/address";
    const CLAIM_CITY         = "https://relaxandrenew.ca/city";
    const CLAIM_POSTAL       = "https://relaxandrenew.ca/postal_code";
    const CLAIM_PHONE        = "https://relaxandrenew.ca/phone";
  </script>
</head>

<body class="bg-hero-pattern bg-cover bg-center bg-fixed bg-no-repeat bg-gray-900 text-brand-light">
  
  <!-- =========================================================
       LOGIN OVERLAY (shows on top of portal until authenticated)
       ========================================================= -->
  <div id="login-overlay">
    <div class="login-card">
      <div class="text-center">
        <div class="mx-auto flex items-center justify-center">
          <img src="https://static.wixstatic.com/media/bf8fef_511df25fad074d79a408119293545f75~mv2.png"
               alt="Relax & Renew"
               class="w-16 h-16 object-contain opacity-95" />
        </div>
        <h2 class="text-3xl text-brand-gold mt-5 font-bold">Welcome</h2>
        <p class="text-brand-dim text-sm mt-2">
          Sign in to your client portal to continue.
        </p>
      </div>

      <div class="mt-6">
        <div id="auth0-lock-container"></div>
      </div>

      <p class="text-[11px] text-brand-dim leading-snug mt-4 text-center opacity-80">
        By logging in, you agree to our
        <a href="/privacy-policy" class="underline text-brand-gold hover:text-brand-light">Privacy Policy</a>
        and
        <a href="/terms" class="underline text-brand-gold hover:text-brand-light">Terms</a>.
      </p>

      <div id="auth0-error" class="hidden mt-4 text-sm border border-red-500/30 bg-red-500/10 p-3 text-red-300"></div>

      <p class="text-xs text-brand-dim mt-6 text-center opacity-70">
        Note: This portal is for returning clients only. New to Relax &amp; Renew?
        <a href="index.html" class="text-brand-gold underline hover:text-brand-light">Book your first session here</a>.
      </p>
    </div>
  </div>

  <!-- NAV -->
  <nav id="navbar" class="fixed-nav h-20 flex items-center">
    <div class="container mx-auto px-6 flex justify-between items-center h-full">
      <a href="index.html" class="flex items-center gap-3 no-underline group">
        <img src="https://static.wixstatic.com/media/bf8fef_511df25fad074d79a408119293545f75~mv2.png" alt="Relax & Renew Logo" class="h-10 w-auto transition-transform group-hover:scale-105">
        <div class="hidden md:flex flex-col">
          <span class="text-brand-gold font-bold tracking-[0.2em] text-sm leading-none">RELAX & RENEW</span>
          <span class="text-brand-light text-[0.65rem] tracking-[0.4em] uppercase opacity-70 leading-tight mt-1">Mobile RMT</span>
        </div>
      </a>

      <!-- Desktop Menu -->
      <div class="hidden lg:flex items-center space-x-8 whitespace-nowrap">
        <a href="index.html#services" class="nav-link">Services</a>
        <a href="index.html#pricing" class="nav-link">Pricing</a>
        <a href="index.html#giftcards" class="nav-link">Gift Cards</a>
        <a href="index.html#area" class="nav-link">Service Area</a>
        <a href="index.html#faq" class="nav-link">FAQ</a>
        <a href="therapists.html" class="nav-link">Our Therapists</a>
        <a href="membership.html" class="nav-link">Membership</a>
        <span class="nav-link text-brand-gold font-bold border-b border-brand-gold">
          <i data-lucide="user-check" class="w-4 h-4 inline mr-1"></i>
          Client Portal
        </span>
      </div>

      <!-- Mobile Menu Button -->
      <button id="mobile-menu-btn" class="lg:hidden text-brand-gold p-2 hover:text-brand-light transition-colors">
        <i data-lucide="menu" class="w-8 h-8"></i>
      </button>
    </div>
  </nav>

  <!-- Mobile Menu Overlay -->
  <div id="mobile-menu" class="mobile-menu fixed top-0 right-0 h-full w-full md:w-80 bg-brand-black border-l border-brand-gold/30 z-50 lg:hidden overflow-y-auto">
    <div class="p-6">
      <div class="flex justify-between items-center mb-8">
        <span class="text-brand-gold font-bold tracking-[0.2em] text-sm">MENU</span>
        <button id="mobile-menu-close" class="text-brand-gold p-2 hover:rotate-90 transition-transform">
          <i data-lucide="x" class="w-8 h-8"></i>
        </button>
      </div>
      <div class="flex flex-col space-y-6">
        <a href="index.html#services" class="nav-link text-lg">Services</a>
        <a href="index.html#pricing" class="nav-link text-lg">Pricing</a>
        <a href="index.html#giftcards" class="nav-link text-lg">Gift Cards</a>
        <a href="index.html#area" class="nav-link text-lg">Service Area</a>
        <a href="index.html#faq" class="nav-link text-lg">FAQ</a>
        <a href="therapists.html" class="nav-link text-lg">Our Therapists</a>
        <a href="membership.html" class="nav-link text-lg">Membership</a>

        <hr class="divider mt-2">

        <button id="logout-btn-mobile" class="text-left nav-link text-lg text-red-300 hover:text-red-200">
          <i data-lucide="log-out" class="w-5 h-5 inline mr-2"></i>
          Sign Out
        </button>
      </div>
    </div>
  </div>

  <!-- Spacer -->
  <div aria-hidden="true" class="h-20"></div>

  <!-- HEADER HERO -->
  <header class="header-hero pt-12 pb-10 border-b border-brand-gold/20">
    <div class="container mx-auto px-6 max-w-6xl">
      <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-6">
        <div class="animate-fade-in-up">
          <div class="text-[0.75rem] tracking-[0.45em] uppercase text-brand-dim">Relax & Renew RMT</div>
          <h1 class="text-4xl md:text-5xl font-serif text-brand-gold mt-2">Client Portal</h1>
          <p class="text-brand-dim mt-3 text-lg font-light">Rebook quickly using your saved profile.</p>
        </div>
        <div class="flex items-center gap-3 animate-fade-in-up" style="animation-delay:0.1s">
          <div class="pill">
            <i data-lucide="user" class="w-4 h-4 text-brand-gold"></i>
            <span id="welcome-pill">Loading profile…</span>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- MAIN -->
  <main class="min-h-screen">
    <div class="container mx-auto max-w-7xl px-4 md:px-6 py-8">
      <div class="grid grid-cols-1 lg:grid-cols-[260px_1fr] gap-8">
        <!-- SIDEBAR -->
        <aside class="hidden lg:block">
          <div class="glass-panel p-5 sticky top-[110px]">
            <div class="flex items-center gap-3 mb-6 pb-6 border-b border-brand-gold/10">
              <div class="w-11 h-11 border border-brand-gold/20 bg-brand-gold/5 flex items-center justify-center text-brand-gold rounded">
                <i data-lucide="user" class="w-5 h-5"></i>
              </div>
              <div class="flex-1 min-w-0">
                <div class="text-[0.65rem] text-brand-dim uppercase tracking-widest">Welcome back</div>
                <div class="text-brand-light font-serif text-sm leading-tight truncate" id="nav-user-name">—</div>
              </div>
            </div>

            <div class="space-y-2">
              <button class="sidebar-btn active" data-tab="dashboard">
                <i data-lucide="calendar-check" class="w-5 h-5 text-brand-gold"></i>
                <span>Rebook</span>
              </button>
              <button class="sidebar-btn" data-tab="membership" disabled>
                <i data-lucide="badge-percent" class="w-5 h-5 text-brand-dim"></i>
                <span>Membership</span>
                <span class="ml-auto pill text-[10px] px-1.5 py-0.5">Soon</span>
              </button>
              <button class="sidebar-btn" data-tab="history" disabled>
                <i data-lucide="history" class="w-5 h-5 text-brand-dim"></i>
                <span>History</span>
                <span class="ml-auto pill text-[10px] px-1.5 py-0.5">Soon</span>
              </button>
              <button class="sidebar-btn" data-tab="profile" disabled>
                <i data-lucide="settings" class="w-5 h-5 text-brand-dim"></i>
                <span>Profile</span>
                <span class="ml-auto pill text-[10px] px-1.5 py-0.5">Soon</span>
              </button>
              <hr class="divider my-3">
              <button id="logout-btn" class="sidebar-btn text-red-400 hover:text-red-200 hover:bg-red-900/10 hover:border-red-900/30">
                <i data-lucide="log-out" class="w-5 h-5"></i>
                <span>Sign Out</span>
              </button>
            </div>
          </div>
        </aside>

        <!-- CONTENT -->
        <section>
          <!-- Dashboard / Rebook -->
          <div id="tab-dashboard" class="tab-content animate-fade-in-up">
            <!-- Profile summary -->
            <div class="glass-panel p-6 mb-8">
              <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-6">
                <div>
                  <h2 class="text-3xl font-serif text-brand-light">Quick Rebook</h2>
                  <p class="muted mt-2 font-light">We use your saved client profile. No typing required.</p>
                </div>
                <div class="flex flex-wrap gap-2">
                  <span class="pill"><i data-lucide="map-pin" class="w-4 h-4 text-brand-gold"></i><span id="pill-address">Address: —</span></span>
                  <span class="pill"><i data-lucide="phone" class="w-4 h-4 text-brand-gold"></i><span id="pill-phone">Phone: —</span></span>
                </div>
              </div>

              <div id="profile-missing" class="mt-6 card-fancy p-4 hidden border-red-500/30">
                <div class="flex items-start gap-3">
                  <i data-lucide="alert-triangle" class="w-5 h-5 text-red-400 mt-0.5"></i>
                  <div>
                    <div class="font-bold text-brand-light">Profile data is missing</div>
                    <div class="muted mt-1 text-sm">
                      We could not find a saved address (and/or city/postal code) for your portal account. Because this is a mobile service, we cannot load availability without it.
                      Please contact us to update your profile.
                    </div>
                    <div class="mt-3">
                      <a class="btn-outline text-xs py-2" href="/cdn-cgi/l/email-protection#264f4840496654434a475e4748425443484351084547">
                        <i data-lucide="mail" class="w-4 h-4"></i> Contact Support
                      </a>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Booking UI -->
            <div class="grid grid-cols-1 lg:grid-cols-[1fr_360px] gap-8">
              <!-- Calendar + slots -->
              <div class="glass-panel p-6">
                <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-5">
                  <div>
                    <div class="text-[0.65rem] tracking-[0.35em] uppercase text-brand-gold font-bold mb-1">Step 1</div>
                    <h3 class="text-2xl font-serif mt-1">Select Treatment</h3>
                    <p class="muted mt-2 text-sm">Choose a treatment and duration to load availability.</p>
                  </div>
                  <div class="flex flex-col gap-3 w-full md:w-72">
                    <select id="treatment-select" class="input w-full">
                      <option value="">Select treatment…</option>
                      <option value="relaxation">Relaxation Massage</option>
                      <option value="deep-tissue">Deep Tissue Massage</option>
                      <option value="sports">Sports Massage</option>
                      <option value="senior">Senior Massage</option>
                      <option value="hot-stone">Hot Stone Massage</option>
                      <option value="cupping">Cupping Therapy</option>
                      <option value="prenatal">Prenatal Massage</option>
                      <option value="pediatric">Pediatric Massage</option>
                      <option value="infant">Infant Massage</option>
                    </select>

                    <select id="duration-select" class="input w-full" disabled>
                      <option value="">Select a treatment first…</option>
                    </select>
                  </div>
                </div>

                <hr class="divider my-6">

                <!-- NEW PROGRESS BAR LOADER -->
                <div id="availability-loading" class="hidden mb-6">
                    <div class="flex justify-between text-xs uppercase tracking-wider text-brand-gold/80 mb-2 font-bold">
                        <span>Checking Availability...</span>
                        <span class="animate-pulse">Please Wait</span>
                    </div>
                    <div class="h-1.5 w-full bg-brand-gold/10 rounded-full overflow-hidden relative">
                        <div class="absolute top-0 left-0 h-full bg-brand-gold w-1/3 animate-loading-bar rounded-full"></div>
                    </div>
                </div>

                <div class="flex items-center justify-between gap-3">
                  <button id="prev-month-btn" class="btn-outline px-4 py-2">
                    <i data-lucide="chevron-left" class="w-4 h-4"></i>
                  </button>
                  <div class="text-xl font-bold text-brand-gold tracking-wide font-serif" id="calendar-month-label">—</div>
                  <button id="next-month-btn" class="btn-outline px-4 py-2">
                    <i data-lucide="chevron-right" class="w-4 h-4"></i>
                  </button>
                </div>

                <div class="mt-4 grid grid-cols-7 gap-2 text-center text-[10px] uppercase tracking-[0.2em] text-brand-dim">
                  <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
                </div>

                <div id="calendar-days" class="mt-3 grid grid-cols-7 gap-2"></div>

                <div class="mt-5 card-fancy p-4 border-brand-gold/20 bg-brand-gold/5">
                  <div class="flex items-start gap-3">
                    <i data-lucide="info" class="w-5 h-5 text-brand-gold mt-0.5"></i>
                    <div class="flex-1">
                      <div class="font-bold text-brand-light text-sm" id="availability-status-title">Availability</div>
                      <div class="muted mt-1 text-sm font-light" id="availability-status-body">Select your treatment and duration to load live availability.</div>
                      <div class="text-brand-gold/60 mt-2 text-xs uppercase tracking-wider" id="availability-meta"></div>
                    </div>
                  </div>
                </div>

                <!-- Selected Date -->
                <div id="selected-date-info" class="mt-8 hidden animate-fade-in-up">
                  <div class="text-[0.65rem] tracking-[0.35em] uppercase text-brand-gold font-bold mb-1">Step 2</div>
                  <h3 class="text-2xl font-serif mt-1">Select a Time</h3>
                  <div class="mt-3 pill border-brand-gold text-brand-gold bg-brand-gold/10">
                    <i data-lucide="calendar" class="w-4 h-4"></i>
                    <span id="selected-date-display" class="font-bold">—</span>
                  </div>
                </div>

                <!-- Time slots -->
                <div id="time-slots-container" class="mt-4 hidden animate-fade-in-up" style="animation-delay:0.1s">
                  <!-- UPDATED GRID: 4 columns on mobile -->
                  <div id="time-slots-grid" class="grid grid-cols-4 sm:grid-cols-3 md:grid-cols-4 gap-2"></div>
                </div>

                <div id="no-slots" class="mt-4 hidden card-fancy p-4 border-red-500/20">
                  <div class="flex items-start gap-3">
                    <i data-lucide="calendar-x" class="w-5 h-5 text-red-400 mt-0.5"></i>
                    <div>
                      <div class="font-bold text-brand-light">No slots available</div>
                      <div class="muted mt-1 text-sm">Please choose a different day.</div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Summary + confirm -->
              <div class="glass-panel p-6">
                <div class="text-[0.65rem] tracking-[0.35em] uppercase text-brand-gold font-bold mb-1">Step 3</div>
                <h3 class="text-2xl font-serif mt-1">Confirm</h3>
                <p class="muted mt-2 text-sm font-light">We will confirm your booking and send your confirmation automatically.</p>

                <hr class="divider my-5">

                <div class="space-y-3">
                  <div class="card-fancy p-4 border-l-2 border-l-brand-gold">
                    <div class="text-[0.65rem] tracking-[0.2em] uppercase text-brand-gold/60 mb-1">Client</div>
                    <div class="font-bold text-brand-light font-serif text-lg" id="summary-client">—</div>
                    <div class="muted mt-0 text-xs" id="summary-email">—</div>
                  </div>

                  <div class="card-fancy p-4">
                    <div class="text-[0.65rem] tracking-[0.2em] uppercase text-brand-gold/60 mb-1">Booking</div>
                    <div class="font-bold text-brand-light font-serif text-lg" id="summary-treatment">Select a treatment</div>
                    <div class="muted mt-0 text-xs" id="summary-datetime">Select a date and time</div>
                  </div>

                  <div class="card-fancy p-4">
                    <div class="text-[0.65rem] tracking-[0.2em] uppercase text-brand-gold/60 mb-1">Travel Fee</div>
                    <div class="font-bold text-brand-gold font-serif text-lg" id="summary-travel-fee">$0.00</div>
                    <div class="muted mt-0 text-xs" id="summary-drive-time">—</div>
                  </div>
                </div>

                <button id="confirm-booking-btn" class="btn-filled w-full mt-8 btn-disabled py-4" disabled>
                  <i data-lucide="check-circle" class="w-5 h-5"></i>
                  <span id="confirm-btn-text">Confirm Booking</span>
                </button>

                <div class="muted mt-4 text-xs text-center opacity-60">
                  If you need to change your address, please contact us. Profile editing is <span class="pill text-[10px] py-0 px-1">Coming Soon</span>.
                </div>
              </div>
            </div>
          </div>

          <!-- Membership -->
          <div id="tab-membership" class="tab-content hidden animate-fade-in-up">
            <h2 class="text-3xl font-serif text-brand-light mb-6">Membership</h2>
            <div class="card-fancy p-6">
              <div class="pill">Coming Soon</div>
              <p class="muted mt-4">Membership management will be available here.</p>
            </div>
          </div>

          <!-- History -->
          <div id="tab-history" class="tab-content hidden animate-fade-in-up">
            <h2 class="text-3xl font-serif text-brand-light mb-6">Session History</h2>
            <div class="card-fancy p-6">
              <div class="pill">Coming Soon</div>
              <p class="muted mt-4">Your session history will appear here.</p>
            </div>
          </div>

          <!-- Profile -->
          <div id="tab-profile" class="tab-content hidden animate-fade-in-up">
            <h2 class="text-3xl font-serif text-brand-light mb-6">Profile</h2>
            <div class="card-fancy p-6">
              <div class="pill">Coming Soon</div>
              <p class="muted mt-4">Profile updates will be available here.</p>
            </div>
          </div>
        </section>
      </div>
    </div>
  </main>

  <!-- Toast -->
  <div id="toast" class="toast fixed left-1/2 bottom-6 -translate-x-1/2 flex items-center gap-3 py-3 px-5 rounded opacity-0 pointer-events-none transition-all z-50">
    <div class="bg-brand-gold/20 p-1.5 rounded-full"><i data-lucide="check" class="w-4 h-4 text-brand-gold"></i></div>
    <span id="toast-message" class="text-sm font-bold tracking-wide">Success</span>
  </div>

  <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
    // =========================================================
    // STATE
    // =========================================================
    let lock = null;
    let portalProfile = null;

    let calendarCurrent = new Date();
    let selectedDateStr = null;
    let selectedSlot = null;

    let availabilityByDate = {};
    let availabilityMeta = { maxDriveTimeMinutes: 0, effective_travel_buffer_minutes: 0 };

    const availabilityCache = new Map();

    let treatmentSelect = null;
    let durationSelect = null;

    let selectedServiceKey = null;
    let selectedStandardDuration = null;

    const TREATMENT_RULES = {
      "relaxation":  { label: "Relaxation Massage", durations: [60,75,90,120] },
      "deep-tissue": { label: "Deep Tissue Massage", durations: [60,75,90,120] },
      "sports":      { label: "Sports Massage", durations: [60,75,90,120] },
      "senior":      { label: "Senior Massage", durations: [60,75,90,120] },
      "hot-stone":   { label: "Hot Stone Massage", durations: [60,75,90,120] },
      "cupping":     { label: "Cupping Therapy", durations: [60,75,90,120] },
      "prenatal":    { label: "Prenatal Massage", durations: [30,45,60] },
      "pediatric":   { label: "Pediatric Massage", durations: [30,45] },
      "infant":      { label: "Infant Massage", durations: [30,45] },
    };

    // =========================================================
    // UTIL
    // =========================================================
    function showToast(title, message, isError=false) {
      const toast = document.getElementById("toast");
      const msgEl = document.getElementById("toast-message");
      msgEl.textContent = message || title || "—";
      toast.classList.add("show");
      toast.style.opacity = "1";
      toast.style.transform = "translateX(-50%) translateY(-10px)";
      
      const iconWrap = toast.querySelector("i");
      if (iconWrap) iconWrap.setAttribute("data-lucide", isError ? "alert-circle" : "check");
      if (typeof lucide !== "undefined") lucide.createIcons();
      setTimeout(() => {
          toast.style.opacity = "0";
          toast.style.transform = "translateX(-50%) translateY(0)";
          toast.classList.remove("show");
      }, 3200);
    }

    function showAuthError(msg) {
      const el = document.getElementById('auth0-error');
      if (!el) return;
      el.textContent = msg || "Sign in failed. Please try again.";
      el.classList.remove('hidden');
    }

    function hideAuthError() {
      const el = document.getElementById('auth0-error');
      if (el) el.classList.add('hidden');
    }
    
    let __portalScrollY = 0;

function lockPortalBackground() {
  __portalScrollY = window.scrollY || 0;
  document.body.classList.add("portal-scroll-locked");
  document.body.style.top = `-${__portalScrollY}px`;
}

function unlockPortalBackground() {
  document.body.classList.remove("portal-scroll-locked");
  document.body.style.top = "";
  window.scrollTo(0, __portalScrollY);
}

function showLoginOverlay() {
  const overlay = document.getElementById("login-overlay");
  if (overlay) overlay.classList.remove("hidden");
  lockPortalBackground();
}

function hideLoginOverlay() {
  const overlay = document.getElementById("login-overlay");
  if (overlay) overlay.classList.add("hidden");
  unlockPortalBackground();
}


    // =========================================================
    // TOKEN / PROFILE HELPERS
    // =========================================================
    function getStoredLockTokens() {
      return {
        idToken: localStorage.getItem("rnr_id_token"),
        accessToken: localStorage.getItem("rnr_auth_token"),
      };
    }

    function decodeJwtPayload(idToken) {
      try {
        const parts = String(idToken || "").split(".");
        if (parts.length < 2) return null;
        const base64 = parts[1].replace(/-/g, "+").replace(/_/g, "/");
        const json = decodeURIComponent(atob(base64).split("").map(c => "%" + ("00" + c.charCodeAt(0).toString(16)).slice(-2)).join(""));
        return JSON.parse(json);
      } catch (e) {
        return null;
      }
    }

    function isJwtExpired(payload) {
      try {
        const exp = Number(payload?.exp || 0);
        if (!exp) return true;
        const now = Math.floor(Date.now() / 1000);
        return exp <= now;
      } catch (e) {
        return true;
      }
    }

    function buildProfileFromJwtPayload(payload) {
      if (!payload) return null;

      const pObj = payload[CLAIM_PROFILE_OBJ] || {};
      const address = payload[CLAIM_ADDRESS] || pObj.address || "";
      const city = payload[CLAIM_CITY] || pObj.city || "";
      const postal = payload[CLAIM_POSTAL] || pObj.postal_code || "";
      const phone = payload[CLAIM_PHONE] || pObj.phone || "";

      const fullName = payload.name || "";
      const email = payload.email || "";
      const given = payload.given_name || "";
      const family = payload.family_name || "";

      return {
        email,
        fullName: fullName || [given, family].filter(Boolean).join(" "),
        firstName: given || "",
        lastName: family || "",
        address,
        city,
        postal,
        phone,
      };
    }

    function loadProfileFromLocalStorage() {
      try {
        const raw = localStorage.getItem("rnr_portal_profile");
        if (!raw) return null;
        return JSON.parse(raw);
      } catch (e) {
        return null;
      }
    }

    function saveProfileToLocalStorage(profile) {
      try {
        if (!profile) return;
        localStorage.setItem("rnr_portal_profile", JSON.stringify(profile));
      } catch (e) {}
    }

    async function tryEnrichProfileFromUserInfo(accessToken, currentProfile) {
      try {
        if (!accessToken) return currentProfile;
        const res = await fetch(`https://${AUTH0_DOMAIN}/userinfo`, {
          headers: { Authorization: `Bearer ${accessToken}` }
        });
        if (!res.ok) return currentProfile;
        const p2 = await res.json();
        const merged = {
          ...(currentProfile || {}),
          email: currentProfile?.email || p2.email || "",
          fullName: currentProfile?.fullName || p2.name || "",
          firstName: currentProfile?.firstName || p2.given_name || "",
          lastName: currentProfile?.lastName || p2.family_name || "",
          address: currentProfile?.address || p2[CLAIM_ADDRESS] || p2?.[CLAIM_PROFILE_OBJ]?.address || "",
          city: currentProfile?.city || p2[CLAIM_CITY] || p2?.[CLAIM_PROFILE_OBJ]?.city || "",
          postal: currentProfile?.postal || p2[CLAIM_POSTAL] || p2?.[CLAIM_PROFILE_OBJ]?.postal_code || "",
          phone: currentProfile?.phone || p2[CLAIM_PHONE] || p2?.[CLAIM_PROFILE_OBJ]?.phone || "",
        };
        saveProfileToLocalStorage(merged);
        return merged;
      } catch (e) {
        return currentProfile;
      }
    }

    // =========================================================
    // AUTH CHECK ON LOAD
    // =========================================================
    async function checkExistingAuth() {
      const { idToken, accessToken } = getStoredLockTokens();
      
      if (idToken) {
        const payload = decodeJwtPayload(idToken);
        if (payload && !isJwtExpired(payload)) {
          // Valid token exists - user is authenticated
          try {
            portalProfile = buildProfileFromJwtPayload(payload) || null;

            // Merge with localStorage profile if exists
            const local = loadProfileFromLocalStorage();
            if (local) portalProfile = { ...(portalProfile || {}), ...local };

            // Try to enrich from userinfo (don't let this block login)
            try {
              portalProfile = await tryEnrichProfileFromUserInfo(accessToken, portalProfile);
            } catch (e) {
              console.warn("Could not enrich profile from userinfo:", e);
            }

            // Track login
            try {
              if (typeof gtag === "function") gtag("event", "client_portal_session_restored");
            } catch (e) {}
          } catch (e) {
            console.error("Error building profile:", e);
          }
          
          // ALWAYS hide login overlay if we have a valid token
          hideLoginOverlay();
          hydrateProfileUI();
          renderCalendar();
          
          return true;
        } else {
          // Token expired - clear it
          localStorage.removeItem("rnr_id_token");
          localStorage.removeItem("rnr_auth_token");
        }
      }
      
      // No valid auth - show login overlay and initialize Lock
      showLoginOverlay();
      initAuth0Lock();
      return false;
    }

    // =========================================================
    // AUTH0 LOCK INITIALIZATION
    // =========================================================
    function initAuth0Lock() {
      lock = new Auth0Lock(AUTH0_CLIENT_ID, AUTH0_DOMAIN, {
        container: 'auth0-lock-container',
        allowSignUp: false,
        theme: {
          logo: 'https://static.wixstatic.com/media/bf8fef_511df25fad074d79a408119293545f75~mv2.png',
          primaryColor: '#E0C584'
        },
        languageDictionary: { 
          title: "", 
          emailInputPlaceholder: "Email", 
          passwordInputPlaceholder: "Password" 
        },
        auth: {
          redirect: false,
          responseType: 'token id_token',
          sso: false,
          params: { scope: 'openid profile email' }
        },
        allowedConnections: [AUTH0_DB_CONNECTION],
        usernameStyle: "email",
        rememberLastLogin: true,
        autofocus: true,
        autoclose: false,
        closable: false
      });

      // Show the Lock widget
      lock.show();

      // Handle successful authentication
      lock.on('authenticated', async function(authResult) {
        hideAuthError();
        
        try {
          // Store tokens
          if (authResult && authResult.accessToken) {
            localStorage.setItem('rnr_auth_token', authResult.accessToken);
          }
          if (authResult && authResult.idToken) {
            localStorage.setItem('rnr_id_token', authResult.idToken);
          }

          // Build profile from ID token
          const payload = decodeJwtPayload(authResult.idToken);
          portalProfile = buildProfileFromJwtPayload(payload) || null;

          // Merge with localStorage profile
          const local = loadProfileFromLocalStorage();
          if (local) portalProfile = { ...(portalProfile || {}), ...local };

          // Try to enrich from userinfo
          portalProfile = await tryEnrichProfileFromUserInfo(authResult.accessToken, portalProfile);

          // Track login success
          try {
            if (typeof gtag === "function") gtag("event", "client_portal_login_success");
            if (typeof fbq === "function") fbq("trackCustom", "ClientPortalLoginSuccess");
          } catch (e) {}

          // Hide login overlay with slight delay for smooth transition
          setTimeout(() => {
            hideLoginOverlay();
            hydrateProfileUI();
            renderCalendar();
            showToast("Welcome!", `Signed in as ${portalProfile?.firstName || portalProfile?.email || 'Client'}`);
          }, 300);

        } catch (e) {
          console.error("Auth processing error:", e);
          showAuthError("Sign in succeeded but there was an error loading your profile. Please refresh.");
        }
      });

      // Handle auth errors
      lock.on('authorization_error', function(err) {
        console.error('Auth0 authorization_error:', err);
        showAuthError("Sign in failed. Please check your email/password and try again.");
      });

      lock.on('unrecoverable_error', function(err) {
        console.error('Auth0 unrecoverable_error:', err);
        showAuthError("An error occurred. Please refresh the page and try again.");
      });
    }

    // =========================================================
    // LOGOUT
    // =========================================================
    async function handleLogout() {
      // Clear tokens
      try {
        localStorage.removeItem("rnr_portal_profile");
        localStorage.removeItem("rnr_id_token");
        localStorage.removeItem("rnr_auth_token");
      } catch (e) {}

      portalProfile = null;
      selectedDateStr = null;
      selectedSlot = null;
      availabilityByDate = {};
      availabilityCache.clear();

      // Track logout
      try {
        if (typeof gtag === "function") gtag("event", "client_portal_logout");
      } catch (e) {}

      // Show overlay again
      showLoginOverlay();

      // Reset / re-init lock
      try {
        if (lock) lock.hide();
      } catch (e) {}

      initAuth0Lock();
    }

    // =========================================================
    // UI HYDRATION
    // =========================================================
    function hydrateProfileUI() {
      const nm = portalProfile?.fullName || portalProfile?.email || "Client";
      const email = portalProfile?.email || "—";
      const addr = portalProfile?.address ? `${portalProfile.address}${portalProfile.city ? ", " + portalProfile.city : ""}${portalProfile.postal ? " " + portalProfile.postal : ""}` : "—";
      const phone = portalProfile?.phone || "—";

      const navUser = document.getElementById("nav-user-name");
      const welcome = document.getElementById("welcome-pill");
      const sumClient = document.getElementById("summary-client");
      const sumEmail = document.getElementById("summary-email");
      const pillAddr = document.getElementById("pill-address");
      const pillPhone = document.getElementById("pill-phone");

      if (navUser) navUser.textContent = nm;
      if (welcome) welcome.textContent = nm;
      if (sumClient) sumClient.textContent = nm;
      if (sumEmail) sumEmail.textContent = email;
      if (pillAddr) pillAddr.textContent = `Address: ${addr}`;
      if (pillPhone) pillPhone.textContent = `Phone: ${phone}`;

      // Show missing profile warning if address/city/postal missing
      const missing = document.getElementById("profile-missing");
      const hasAddress = !!(portalProfile?.address && portalProfile?.city && portalProfile?.postal);
      if (missing) {
        if (!hasAddress) missing.classList.remove("hidden");
        else missing.classList.add("hidden");
      }
    }

    // =========================================================
    // TREATMENT / DURATION
    // =========================================================
    function onTreatmentChange() {
      selectedServiceKey = treatmentSelect.value || null;
      selectedStandardDuration = null;
      selectedDateStr = null;
      selectedSlot = null;
      availabilityByDate = {};
      availabilityCache.clear();

      updateSummary();
      hideSlots();

      durationSelect.innerHTML = "";
      durationSelect.disabled = true;

      if (!selectedServiceKey) {
        durationSelect.innerHTML = `<option value="">Select a treatment first…</option>`;
        setAvailabilityStatus("Availability", "Select your treatment and duration to load live availability.", "");
        renderCalendar();
        return;
      }

      const rule = TREATMENT_RULES[selectedServiceKey];
      const opts = rule?.durations || [];
      durationSelect.innerHTML = `<option value="">Select duration…</option>` + opts.map(m => `<option value="${m}">${m} min</option>`).join("");
      durationSelect.disabled = false;

      setAvailabilityStatus("Availability", "Select a duration to load availability.", "");
      renderCalendar();
    }

    async function onDurationChange() {
      const v = durationSelect.value;
      selectedStandardDuration = v ? Number(v) : null;
      selectedDateStr = null;
      selectedSlot = null;
      availabilityByDate = {};
      availabilityCache.clear();

      updateSummary();
      hideSlots();

      if (!selectedServiceKey || !selectedStandardDuration) {
        setAvailabilityStatus("Availability", "Select your treatment and duration to load live availability.", "");
        renderCalendar();
        return;
      }

      await loadAvailabilityForMonth(calendarCurrent);
      renderCalendar();
    }

    // =========================================================
    // AVAILABILITY LOADING
    // =========================================================
    function showAvailabilityLoading(show) {
      const el = document.getElementById("availability-loading");
      if (!el) return;
      if (show) el.classList.remove("hidden");
      else el.classList.add("hidden");
    }

    function setAvailabilityStatus(title, body, meta) {
      const t = document.getElementById("availability-status-title");
      const b = document.getElementById("availability-status-body");
      const m = document.getElementById("availability-meta");
      if (t) t.textContent = title || "Availability";
      if (b) b.textContent = body || "";
      if (m) m.textContent = meta || "";
    }

    function monthKey(dateObj) {
      const y = dateObj.getFullYear();
      const m = String(dateObj.getMonth() + 1).padStart(2, "0");
      return `${y}-${m}`;
    }

    async function loadAvailabilityForMonth(dateObj) {
      const hasAddress = !!(portalProfile?.address && portalProfile?.city && portalProfile?.postal);
      if (!hasAddress) {
        setAvailabilityStatus("Availability", "We need your address (street, city, postal code) to load availability.", "");
        return;
      }

      const key = `${monthKey(dateObj)}::${selectedServiceKey}::${selectedStandardDuration}`;
      if (availabilityCache.has(key)) {
        const cached = availabilityCache.get(key);
        availabilityByDate = cached?.availabilityByDate || {};
        availabilityMeta = cached?.availabilityMeta || availabilityMeta;
        setAvailabilityStatus("Availability", "Availability loaded.", cached?.metaText || "");
        return;
      }

      showAvailabilityLoading(true);
      setAvailabilityStatus("Availability", "Checking availability…", "");

      try {
        const start = new Date(dateObj.getFullYear(), dateObj.getMonth(), 1);
        const end = new Date(dateObj.getFullYear(), dateObj.getMonth() + 1, 0);

        const payload = {
          email: portalProfile?.email || "",
          address: portalProfile?.address || "",
          city: portalProfile?.city || "",
          postal_code: portalProfile?.postal || "",
          phone: portalProfile?.phone || "",
          treatment_key: selectedServiceKey,
          duration_minutes: selectedStandardDuration,
          month_start: start.toISOString().slice(0,10),
          month_end: end.toISOString().slice(0,10),
          practitioner_id: DEFAULT_PRACTITIONER_ID
        };

        const res = await fetch(AVAILABILITY_WEBHOOK_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data?.error || "Availability request failed");

        availabilityByDate = data?.availabilityByDate || {};
        availabilityMeta = data?.meta || availabilityMeta;

        const maxDrive = Number(availabilityMeta?.maxDriveTimeMinutes || 0);
        const effBuff = Number(availabilityMeta?.effective_travel_buffer_minutes || 0);
        const metaText = `Max drive time: ${maxDrive} min • Travel buffer: ${effBuff} min`;

        availabilityCache.set(key, { availabilityByDate, availabilityMeta, metaText });

        setAvailabilityStatus("Availability", "Availability loaded.", metaText);

      } catch (e) {
        console.error(e);
        setAvailabilityStatus("Availability", "Could not load availability. Please try again.", "");
        showToast("Error", "Unable to load availability.", true);
      } finally {
        showAvailabilityLoading(false);
      }
    }

    // =========================================================
    // CALENDAR RENDERING
    // =========================================================
    function setCalendarLabel(dateObj) {
      const el = document.getElementById("calendar-month-label");
      if (!el) return;
      const fmt = dateObj.toLocaleString("en-CA", { month: "long", year: "numeric" });
      el.textContent = fmt;
    }

    function renderCalendar() {
      setCalendarLabel(calendarCurrent);

      const daysContainer = document.getElementById("calendar-days");
      if (!daysContainer) return;
      daysContainer.innerHTML = "";

      const year = calendarCurrent.getFullYear();
      const month = calendarCurrent.getMonth();

      const firstDay = new Date(year, month, 1);
      const startWeekday = firstDay.getDay(); // 0 Sun
      const daysInMonth = new Date(year, month + 1, 0).getDate();

      // Fill leading blanks
      for (let i = 0; i < startWeekday; i++) {
        const d = document.createElement("div");
        d.className = "calendar-day calendar-day-disabled opacity-0";
        d.innerHTML = "&nbsp;";
        daysContainer.appendChild(d);
      }

      const today = new Date();
      const todayStr = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,"0")}-${String(today.getDate()).padStart(2,"0")}`;

      for (let day = 1; day <= daysInMonth; day++) {
        const d = document.createElement("div");
        const dateStr = `${year}-${String(month+1).padStart(2,"0")}-${String(day).padStart(2,"0")}`;

        let cls = "calendar-day";
        const isPast = new Date(year, month, day) < new Date(today.getFullYear(), today.getMonth(), today.getDate());
        const hasAvail = !!(availabilityByDate?.[dateStr]?.slots?.length);

        if (!selectedServiceKey || !selectedStandardDuration) {
          cls += " calendar-day-disabled";
        } else if (isPast) {
          cls += " calendar-day-disabled";
        } else if (hasAvail) {
          cls += " calendar-day-available";
        } else {
          cls += " calendar-day-disabled";
        }

        if (dateStr === todayStr) cls += " calendar-day-today";
        if (selectedDateStr && dateStr === selectedDateStr) cls += " calendar-day-selected";

        d.className = cls;
        d.textContent = String(day);

        if (cls.includes("calendar-day-available")) {
          d.addEventListener("click", () => onSelectDate(dateStr));
        }

        daysContainer.appendChild(d);
      }
    }

    // =========================================================
    // SLOT SELECTION
    // =========================================================
    function showSlots() {
      const selInfo = document.getElementById("selected-date-info");
      const slots = document.getElementById("time-slots-container");
      if (selInfo) selInfo.classList.remove("hidden");
      if (slots) slots.classList.remove("hidden");
    }

    function hideSlots() {
      const selInfo = document.getElementById("selected-date-info");
      const slots = document.getElementById("time-slots-container");
      const noSlots = document.getElementById("no-slots");
      if (selInfo) selInfo.classList.add("hidden");
      if (slots) slots.classList.add("hidden");
      if (noSlots) noSlots.classList.add("hidden");

      const grid = document.getElementById("time-slots-grid");
      if (grid) grid.innerHTML = "";
    }

    function onSelectDate(dateStr) {
      selectedDateStr = dateStr;
      selectedSlot = null;

      const display = document.getElementById("selected-date-display");
      if (display) {
        const dt = new Date(dateStr + "T00:00:00");
        display.textContent = dt.toLocaleDateString("en-CA", { weekday: "long", month: "long", day: "numeric" });
      }

      const dayObj = availabilityByDate?.[dateStr] || {};
      const slots = dayObj?.slots || [];

      const grid = document.getElementById("time-slots-grid");
      const noSlots = document.getElementById("no-slots");
      if (!grid) return;

      grid.innerHTML = "";

      if (!slots.length) {
        if (noSlots) noSlots.classList.remove("hidden");
        showSlots();
        updateSummary();
        renderCalendar();
        return;
      }

      if (noSlots) noSlots.classList.add("hidden");
      showSlots();

      slots.forEach((s) => {
        const btn = document.createElement("button");
        btn.className = "time-slot-btn";
        btn.type = "button";
        btn.innerHTML = `<i data-lucide="clock" class="w-4 h-4 text-brand-gold"></i><span>${formatSlotTime(s?.starts_at)}</span>`;
        btn.addEventListener("click", () => onSelectSlot(s, btn));
        grid.appendChild(btn);
      });

      if (typeof lucide !== "undefined") lucide.createIcons();
      updateSummary();
      renderCalendar();
    }

    function formatSlotTime(iso) {
      try {
        const dt = new Date(iso);
        return dt.toLocaleTimeString("en-CA", { hour: "numeric", minute: "2-digit" }).toLowerCase();
      } catch (e) {
        return "—";
      }
    }

    function onSelectSlot(slotObj, btnEl) {
      selectedSlot = slotObj || null;

      // Unselect others
      const grid = document.getElementById("time-slots-grid");
      if (grid) {
        [...grid.querySelectorAll("button")].forEach(b => b.classList.remove("time-slot-selected"));
      }
      if (btnEl) btnEl.classList.add("time-slot-selected");

      updateSummary();
    }

    // =========================================================
    // TRAVEL FEE
    // =========================================================
    function computeTravelFee(driveMinutes) {
      const mins = Number(driveMinutes || 0);
      if (mins < TRAVEL_FEE_THRESHOLD_MINUTES) return 0;
      for (const tier of TRAVEL_FEE_TIERS) {
        if (mins >= tier.minMinutes) return tier.fee;
      }
      return 0;
    }

    // =========================================================
    // SUMMARY + CONFIRM
    // =========================================================
    function updateSummary() {
      const treatEl = document.getElementById("summary-treatment");
      const dtEl = document.getElementById("summary-datetime");
      const feeEl = document.getElementById("summary-travel-fee");
      const driveEl = document.getElementById("summary-drive-time");

      const confirmBtn = document.getElementById("confirm-booking-btn");
      const confirmText = document.getElementById("confirm-btn-text");

      const treatLabel = selectedServiceKey ? (TREATMENT_RULES[selectedServiceKey]?.label || "Treatment") : "Select a treatment";
      const durLabel = selectedStandardDuration ? `${selectedStandardDuration} min` : "";
      if (treatEl) treatEl.textContent = selectedServiceKey ? `${treatLabel} • ${durLabel}` : treatLabel;

      let dtLabel = "Select a date and time";
      if (selectedDateStr) {
        const dt = new Date(selectedDateStr + "T00:00:00");
        dtLabel = dt.toLocaleDateString("en-CA", { weekday: "long", month: "long", day: "numeric" });
        if (selectedSlot?.starts_at) {
          dtLabel += ` • ${formatSlotTime(selectedSlot.starts_at)}`;
        } else {
          dtLabel += " • Select a time";
        }
      }
      if (dtEl) dtEl.textContent = dtLabel;

      const driveMinutes = selectedSlot?.drive_minutes ?? selectedSlot?.drive_time_minutes ?? 0;
      const travelFee = computeTravelFee(driveMinutes);

      if (feeEl) feeEl.textContent = `$${Number(travelFee).toFixed(2)}`;
      if (driveEl) {
        driveEl.textContent = driveMinutes ? `Drive time: ${Number(driveMinutes)} min` : "—";
      }

      const ready = !!(portalProfile?.email && selectedServiceKey && selectedStandardDuration && selectedDateStr && selectedSlot?.starts_at);
      if (confirmBtn) {
        if (ready) {
          confirmBtn.disabled = false;
          confirmBtn.classList.remove("btn-disabled");
          if (confirmText) confirmText.textContent = "Confirm Booking";
        } else {
          confirmBtn.disabled = true;
          confirmBtn.classList.add("btn-disabled");
          if (confirmText) confirmText.textContent = "Confirm Booking";
        }
      }
    }

    async function confirmBooking() {
      const confirmBtn = document.getElementById("confirm-booking-btn");
      const confirmText = document.getElementById("confirm-btn-text");
      if (confirmBtn) confirmBtn.disabled = true;
      if (confirmText) confirmText.textContent = "Confirming…";

      try {
        const driveMinutes = selectedSlot?.drive_minutes ?? selectedSlot?.drive_time_minutes ?? 0;
        const travelFee = computeTravelFee(driveMinutes);

        const payload = {
          email: portalProfile?.email || "",
          full_name: portalProfile?.fullName || "",
          phone: portalProfile?.phone || "",
          address: portalProfile?.address || "",
          city: portalProfile?.city || "",
          postal_code: portalProfile?.postal || "",
          treatment_key: selectedServiceKey,
          duration_minutes: selectedStandardDuration,
          practitioner_id: DEFAULT_PRACTITIONER_ID,
          slot: selectedSlot,
          date: selectedDateStr,
          travel_fee: travelFee
        };

        const res = await fetch(BOOKING_WEBHOOK_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data?.error || "Booking failed");

        try {
          if (typeof gtag === "function") gtag("event", "client_portal_booking_confirmed");
          if (typeof fbq === "function") fbq("trackCustom", "ClientPortalBookingConfirmed");
        } catch (e) {}

        showToast("Booked!", "Your booking has been confirmed.");
        // Reset selection after booking
        selectedDateStr = null;
        selectedSlot = null;
        hideSlots();
        updateSummary();
        renderCalendar();

      } catch (e) {
        console.error(e);
        showToast("Error", "Could not confirm booking.", true);
      } finally {
        if (confirmBtn) confirmBtn.disabled = false;
        if (confirmText) confirmText.textContent = "Confirm Booking";
        updateSummary();
      }
    }

    // =========================================================
    // NAV / TABS / MOBILE MENU
    // =========================================================
    function setupSidebarTabs() {
      const btns = document.querySelectorAll(".sidebar-btn[data-tab]");
      btns.forEach((btn) => {
        btn.addEventListener("click", () => {
          if (btn.hasAttribute("disabled")) return;
          btns.forEach(b => b.classList.remove("active"));
          btn.classList.add("active");

          const tab = btn.getAttribute("data-tab");
          document.querySelectorAll(".tab-content").forEach(el => el.classList.add("hidden"));
          const panel = document.getElementById(`tab-${tab}`);
          if (panel) panel.classList.remove("hidden");
        });
      });
    }

    function setupMobileMenu() {
      const menu = document.getElementById("mobile-menu");
      const openBtn = document.getElementById("mobile-menu-btn");
      const closeBtn = document.getElementById("mobile-menu-close");
      if (!menu || !openBtn || !closeBtn) return;

      openBtn.addEventListener("click", () => menu.classList.add("open"));
      closeBtn.addEventListener("click", () => menu.classList.remove("open"));

      // Close when clicking outside
      menu.addEventListener("click", (e) => {
        if (e.target === menu) menu.classList.remove("open");
      });
    }

    // =========================================================
    // INIT
    // =========================================================
    async function init() {
      // Icons
      if (typeof lucide !== "undefined") lucide.createIcons();

      // Elements
      treatmentSelect = document.getElementById("treatment-select");
      durationSelect = document.getElementById("duration-select");

      // Sidebar tabs
      setupSidebarTabs();

      // Mobile menu
      setupMobileMenu();

      // Controls
      if (treatmentSelect) treatmentSelect.addEventListener("change", onTreatmentChange);
      if (durationSelect) durationSelect.addEventListener("change", onDurationChange);

      const prevBtn = document.getElementById("prev-month-btn");
      const nextBtn = document.getElementById("next-month-btn");
      if (prevBtn) prevBtn.addEventListener("click", async () => {
        calendarCurrent = new Date(calendarCurrent.getFullYear(), calendarCurrent.getMonth() - 1, 1);
        if (selectedServiceKey && selectedStandardDuration) await loadAvailabilityForMonth(calendarCurrent);
        renderCalendar();
      });
      if (nextBtn) nextBtn.addEventListener("click", async () => {
        calendarCurrent = new Date(calendarCurrent.getFullYear(), calendarCurrent.getMonth() + 1, 1);
        if (selectedServiceKey && selectedStandardDuration) await loadAvailabilityForMonth(calendarCurrent);
        renderCalendar();
      });

      const confirmBtn = document.getElementById("confirm-booking-btn");
      if (confirmBtn) confirmBtn.addEventListener("click", confirmBooking);

      const logoutBtn = document.getElementById("logout-btn");
      const logoutBtnMobile = document.getElementById("logout-btn-mobile");
      if (logoutBtn) logoutBtn.addEventListener("click", handleLogout);
      if (logoutBtnMobile) logoutBtnMobile.addEventListener("click", () => {
        // close mobile menu then logout
        const menu = document.getElementById("mobile-menu");
        if (menu) menu.classList.remove("open");
        handleLogout();
      });

      // Preload initial UI
      setAvailabilityStatus("Availability", "Select your treatment and duration to load live availability.", "");
      renderCalendar();
      updateSummary();

      // Auth check on load - this will either show login or load the portal
      await checkExistingAuth();
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
