<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Health History Intake - Relax &amp; Renew RMT</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Cormorant Garamond -->
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600;700&amp;display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        :root {
            --primary-gold: #E0C584;
            --hover-gold: #F0D594;
            --bg-dark: #000000;
            --text-color: #E0C584;
            --error-text: #f87171;
            --error-bg: rgba(248, 113, 113, 0.1);
            --success-text: #4ade80;
            --success-bg: rgba(74, 222, 128, 0.1);
        }

        body {
            font-family: 'Cormorant Garamond', serif;
            background-color: var(--bg-dark);
            background-image: radial-gradient(circle at center, #1a1a1a 0%, #000000 100%);
            color: var(--text-color);
            min-height: 100vh;
            font-size: 1.125rem;
            line-height: 1.7;
            transition: background 0.3s ease, color 0.3s ease;
            -webkit-font-smoothing: antialiased;
        }

        /* Glassmorphism Container */
        .glass-panel {
            background-color: rgba(10, 10, 10, 0.85);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(224, 197, 132, 0.2);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        /* Input Styling */
        input[type="text"],
        input[type="email"],
        input[type="tel"],
        input[type="date"],
        textarea,
        select {
            background-color: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(224, 197, 132, 0.3);
            color: var(--primary-gold);
            font-family: inherit;
            transition: all 0.3s ease;
            font-size: 1rem;
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: var(--primary-gold);
            box-shadow: 0 0 10px rgba(224, 197, 132, 0.2);
            background-color: rgba(255, 255, 255, 0.05);
        }

        /* Custom Checkbox and Radio Styling */
        input[type="checkbox"],
        input[type="radio"] {
            appearance: none;
            -webkit-appearance: none;
            width: 1.2em;
            height: 1.2em;
            border: 1px solid var(--primary-gold);
            background-color: transparent;
            margin-right: 0.5em;
            cursor: pointer;
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        input[type="radio"] {
            border-radius: 50%;
        }

        input[type="checkbox"] {
            border-radius: 4px;
        }

        input[type="checkbox"]:checked,
        input[type="radio"]:checked {
            background-color: rgba(224, 197, 132, 0.2);
            box-shadow: 0 0 5px var(--primary-gold);
        }

        input[type="checkbox"]:checked::after {
            content: 'âœ“';
            font-size: 0.8em;
            color: var(--primary-gold);
            font-weight: bold;
        }

        input[type="radio"]:checked::after {
            content: '';
            width: 0.6em;
            height: 0.6em;
            background-color: var(--primary-gold);
            border-radius: 50%;
        }

        /* Button Styling */
        .btn-gold {
            background: transparent;
            border: 1px solid var(--primary-gold);
            color: var(--primary-gold);
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 700;
        }

        .btn-gold:hover:not(:disabled) {
            background: rgba(224, 197, 132, 0.1);
            box-shadow: 0 0 15px rgba(224, 197, 132, 0.3);
            transform: translateY(-2px);
            color: var(--hover-gold);
            border-color: var(--hover-gold);
        }

        .btn-gold:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            border-color: #555;
            color: #555;
        }

        /* Section Dividers */
        .section-divider {
            border-bottom: 1px solid rgba(224, 197, 132, 0.2);
        }

        /* Option Hover */
        .choice-option:hover {
            background-color: rgba(224, 197, 132, 0.05);
            border-color: var(--primary-gold);
        }

        /* Loading Spinner */
        .spinner {
            border: 3px solid rgba(224, 197, 132, 0.1);
            border-left-color: var(--primary-gold);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Success/Error Messages */
        .msg-success {
            color: var(--success-text);
            background-color: var(--success-bg);
            border: 1px solid var(--success-text);
        }
        
        .msg-error {
            color: var(--error-text);
            background-color: var(--error-bg);
            border: 1px solid var(--error-text);
        }

        /* Placeholder Opacity */
        ::placeholder {
            color: rgba(224, 197, 132, 0.4);
        }
        
        /* Signature Pad */
        canvas#signaturePad {
            touch-action: none;
            background-color: rgba(255, 255, 255, 0.05);
            cursor: crosshair;
        }

        /* --- EASY VIEWING MODE (Overrides) --- */
        body.easy-view {
            --primary-gold: #000000;
            --hover-gold: #333333;
            --bg-dark: #ffffff;
            --text-color: #000000;
            background-image: none;
            background-color: #ffffff;
            font-weight: 700 !important;
            font-size: 1.25rem !important;
        }

        body.easy-view .glass-panel {
            background-color: #ffffff;
            border: 3px solid #000000;
            box-shadow: none;
        }

        body.easy-view .text-\[\#E0C584\] { color: #000000 !important; font-weight: 800 !important; }
        body.easy-view .text-\[\#E0C584\]\/80 { color: #000000 !important; opacity: 1 !important; font-weight: 700 !important; }
        body.easy-view .text-\[\#E0C584\]\/60 { color: #000000 !important; opacity: 1 !important; }
        
        body.easy-view .border-\[\#E0C584\] { border-color: #000000 !important; border-width: 2px !important; }
        body.easy-view .border-\[\#E0C584\]\/20 { border-color: #000000 !important; border-width: 1px !important; }
        body.easy-view .border-\[\#E0C584\]\/30 { border-color: #000000 !important; border-width: 2px !important; }
        body.easy-view .border-\[\#E0C584\]\/40 { border-color: #000000 !important; border-width: 2px !important; }
        
        body.easy-view .bg-\[\#E0C584\]\/5 { background-color: #f0f0f0 !important; border: 1px solid #000; }
        body.easy-view .bg-\[\#E0C584\]\/10 { background-color: #e5e5e5 !important; }
        
        body.easy-view input, 
        body.easy-view select, 
        body.easy-view textarea {
            background-color: #ffffff;
            border: 2px solid #000000; 
            color: #000000;
            font-weight: 700;
            font-size: 1.15rem;
        }

        body.easy-view input:focus, 
        body.easy-view select:focus, 
        body.easy-view textarea:focus {
            border-color: #000000;
            background-color: #ffffff;
            box-shadow: 0 0 0 2px rgba(0,0,0, 0.2);
        }
        
        body.easy-view ::placeholder {
            color: #000000 !important;
            opacity: 0.6;
            font-weight: 600;
        }
        
        body.easy-view label {
            color: #000000 !important;
            opacity: 1 !important;
            font-weight: 800 !important;
        }

        body.easy-view canvas#signaturePad {
            background-color: #ffffff;
            border: 2px solid #000000;
        }
        
        body.easy-view .btn-gold {
            border: 2px solid #000000;
            color: #000000;
            font-weight: 800;
            background-color: #f0f0f0;
        }
        
        body.easy-view .btn-gold:hover {
            background-color: #000000;
            color: #ffffff;
        }
        
        .hold-active {
            background-color: #f87171 !important;
            color: black !important;
            border-color: #f87171 !important;
        }
    </style>
</head>
<body class="p-2 md:p-8">

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 z-50 bg-black/90 backdrop-blur-sm flex items-center justify-center hidden">
        <div class="text-center">
            <div class="spinner mx-auto mb-4"></div>
            <p class="text-[#E0C584] text-lg tracking-widest uppercase">Submitting...</p>
        </div>
    </div>

    <div class="max-w-5xl mx-auto glass-panel rounded-lg overflow-hidden shadow-2xl relative">
        
        <!-- Header -->
        <div class="p-6 md:p-10 text-center border-b border-[#E0C584]/20 relative overflow-hidden">
            <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full h-full bg-[#E0C584] opacity-5 blur-3xl rounded-full pointer-events-none"></div>
            
            <!-- Easy View Button -->
            <div class="flex justify-end mb-4 md:absolute md:top-8 md:right-10 w-full md:w-auto relative z-20">
                <button id="easyViewBtn" type="button" class="btn-gold px-3 py-1.5 md:px-4 md:py-2 rounded-full flex items-center gap-2 text-xs md:text-sm hover:bg-[#E0C584]/20 transition-all shadow-lg bg-black/40">
                    <i data-lucide="eye" class="w-3 h-3 md:w-4 md:h-4"></i>
                    <span id="easyViewText">Easy Viewing Mode</span>
                </button>
            </div>

            <h1 class="text-2xl md:text-4xl font-bold mb-2 tracking-wide text-[#E0C584] relative z-10">Health History &amp; Billing</h1>
            <p class="text-[#E0C584]/80 text-sm md:text-lg uppercase tracking-widest relative z-10">Relax &amp; Renew RMT</p>
            <div class="mt-4 text-xs md:text-sm opacity-70 relative z-10">
                <p>Port Colborne, Ontario</p>
                <p><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="711012121e041f05023103141d1009101f1503141f14065f1210">[email&#160;protected]</a> | 1-226-337-9064</p>
            </div>
        </div>

        <div class="p-4 md:p-10">
            
            <!-- Messages -->
            <div id="successMessage" class="msg-success p-4 rounded mb-6 hidden">
                <p class="flex items-center gap-2">
                    <i data-lucide="check-circle" class="w-6 h-6"></i>
                    Your form has been submitted successfully! We look forward to seeing you.
                </p>
            </div>

            <div id="errorMessage" class="msg-error p-4 rounded mb-6 hidden">
                <p class="flex items-center gap-2">
                    <i data-lucide="alert-circle" class="w-6 h-6"></i>
                    There was an error submitting your form. Please try again or contact us directly.
                </p>
            </div>

            <form id="healthIntakeForm" class="space-y-10 md:space-y-12">
                
                <!-- Client Profile -->
                <div class="section">
                    <h2 class="text-xl md:text-2xl font-bold mb-6 text-[#E0C584] section-divider pb-2 flex items-center gap-3">
                        <i data-lucide="user" class="w-5 h-5 md:w-6 md:h-6"></i> Client Profile
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6">
                        <div class="space-y-2">
                            <label class="block text-sm uppercase tracking-wide opacity-90">First Name <span class="text-red-400">*</span></label>
                            <input type="text" name="first_name" required class="w-full p-3 rounded">
                        </div>
                        <div class="space-y-2">
                            <label class="block text-sm uppercase tracking-wide opacity-90">Last Name <span class="text-red-400">*</span></label>
                            <input type="text" name="last_name" required class="w-full p-3 rounded">
                        </div>
                        <div class="space-y-2">
                            <label class="block text-sm uppercase tracking-wide opacity-90">Pronouns</label>
                            <input type="text" name="pronouns" placeholder="e.g. He/Him, She/Her" class="w-full p-3 rounded">
                        </div>
                        <div class="space-y-2">
                            <label class="block text-sm uppercase tracking-wide opacity-90">Date of Birth <span class="text-red-400">*</span></label>
                            <input type="date" name="date_of_birth" required class="w-full p-3 rounded">
                        </div>
                        <div class="space-y-2">
                            <label class="block text-sm uppercase tracking-wide opacity-90">Gender <span class="text-red-400">*</span></label>
                            <select name="gender" required class="w-full p-3 rounded">
                                <option value="" class="bg-black">Select...</option>
                                <option value="female" class="bg-black">Female</option>
                                <option value="male" class="bg-black">Male</option>
                                <option value="non-binary" class="bg-black">Non-Binary</option>
                                <option value="prefer_not_to_say" class="bg-black">Prefer not to say</option>
                            </select>
                        </div>
                         <div class="space-y-2">
                            <label class="block text-sm uppercase tracking-wide opacity-90">Occupation</label>
                            <input type="text" name="occupation" class="w-full p-3 rounded">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6 mt-4 md:mt-6">
                        <div class="space-y-2">
                            <label class="block text-sm uppercase tracking-wide opacity-90">Email Address <span class="text-red-400">*</span></label>
                            <input type="email" name="email" required class="w-full p-3 rounded">
                        </div>
                        <div class="space-y-2">
                            <label class="block text-sm uppercase tracking-wide opacity-90">Mobile Phone <span class="text-red-400">*</span></label>
                            <input type="tel" name="phone" required class="w-full p-3 rounded phone-input" placeholder="(xxx) xxx xxxx">
                        </div>
                    </div>

                     <div class="space-y-2 mt-4 md:mt-6">
                        <label class="block text-sm uppercase tracking-wide opacity-90">Source of Referral</label>
                        <select name="referral_source" class="w-full p-3 rounded">
                            <option value="" class="bg-black">How did you hear about us?</option>
                            <option value="friend" class="bg-black">Friend/Family</option>
                            <option value="google" class="bg-black">Google Search</option>
                            <option value="social_media" class="bg-black">Facebook/Instagram</option>
                            <option value="doctor" class="bg-black">Doctor/Medical Professional</option>
                            <option value="other" class="bg-black">Other</option>
                        </select>
                    </div>
                </div>

                <!-- Primary Care & Emergency -->
                <div class="section">
                    <h2 class="text-xl md:text-2xl font-bold mb-6 text-[#E0C584] section-divider pb-2 flex items-center gap-3">
                         <i data-lucide="stethoscope" class="w-5 h-5 md:w-6 md:h-6"></i> Primary Care &amp; Emergency
                    </h2>
                    
                    <h3 class="text-lg font-semibold text-[#E0C584]/80 mb-4">Primary Care Physician</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6 mb-8">
                        <div class="space-y-2">
                            <label class="block text-sm uppercase tracking-wide opacity-90">Doctor's Name <span class="text-red-400">*</span></label>
                            <input type="text" name="doctor_name" required class="w-full p-3 rounded">
                        </div>
                        <div class="space-y-2">
                            <label class="block text-sm uppercase tracking-wide opacity-90">Doctor's Phone <span class="text-red-400">*</span></label>
                            <input type="tel" name="doctor_phone" required class="w-full p-3 rounded phone-input" placeholder="(xxx) xxx xxxx">
                        </div>
                        <div class="md:col-span-2 space-y-2">
                            <label class="block text-sm uppercase tracking-wide opacity-90">Doctor's Address <span class="text-red-400">*</span></label>
                            <input type="text" name="doctor_address" required class="w-full p-3 rounded">
                        </div>
                    </div>

                    <h3 class="text-lg font-semibold text-[#E0C584]/80 mb-4">Emergency Contact</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6">
                        <div class="space-y-2">
                            <label class="block text-sm uppercase tracking-wide opacity-90">Contact Name <span class="text-red-400">*</span></label>
                            <input type="text" name="emergency_name" required class="w-full p-3 rounded">
                        </div>
                        <div class="space-y-2">
                            <label class="block text-sm uppercase tracking-wide opacity-90">Phone <span class="text-red-400">*</span></label>
                            <input type="tel" name="emergency_phone" required class="w-full p-3 rounded phone-input" placeholder="(xxx) xxx xxxx">
                        </div>
                        <div class="space-y-2">
                            <label class="block text-sm uppercase tracking-wide opacity-90">Relationship <span class="text-red-400">*</span></label>
                            <input type="text" name="emergency_relationship" required class="w-full p-3 rounded">
                        </div>
                    </div>
                </div>

                <!-- Health History -->
                <div class="section">
                    <h2 class="text-xl md:text-2xl font-bold mb-6 text-[#E0C584] section-divider pb-2 flex items-center gap-3">
                        <i data-lucide="activity" class="w-5 h-5 md:w-6 md:h-6"></i> Medical History
                    </h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 mb-8">
                        <label class="flex items-start p-3 rounded border border-[#E0C584]/20 choice-option cursor-pointer">
                            <input type="checkbox" name="conditions" value="cardiovascular" class="mt-1">
                            <span class="ml-2 text-sm">Cardiovascular (High/Low BP, Heart Attack, Stroke, Pacemaker)</span>
                        </label>
                        <label class="flex items-start p-3 rounded border border-[#E0C584]/20 choice-option cursor-pointer">
                            <input type="checkbox" name="conditions" value="neurological" class="mt-1">
                            <span class="ml-2 text-sm">Neurological (Numbness, MS, Parkinson's, Sciatica)</span>
                        </label>
                        <label class="flex items-start p-3 rounded border border-[#E0C584]/20 choice-option cursor-pointer">
                            <input type="checkbox" name="conditions" value="respiratory" class="mt-1">
                            <span class="ml-2 text-sm">Respiratory (Asthma, Bronchitis, COPD)</span>
                        </label>
                        <label class="flex items-start p-3 rounded border border-[#E0C584]/20 choice-option cursor-pointer">
                            <input type="checkbox" name="conditions" value="musculoskeletal" class="mt-1">
                            <span class="ml-2 text-sm">Musculoskeletal (Arthritis, Sprains, Fractures)</span>
                        </label>
                        <label class="flex items-start p-3 rounded border border-[#E0C584]/20 choice-option cursor-pointer">
                            <input type="checkbox" name="conditions" value="gastrointestinal" class="mt-1">
                            <span class="ml-2 text-sm">Gastrointestinal (Crohn's, IBS, Colitis)</span>
                        </label>
                        <label class="flex items-start p-3 rounded border border-[#E0C584]/20 choice-option cursor-pointer">
                            <input type="checkbox" name="conditions" value="dermatological" class="mt-1">
                            <span class="ml-2 text-sm">Dermatological (Eczema, Psoriasis, Rashes)</span>
                        </label>
                        <label class="flex items-start p-3 rounded border border-[#E0C584]/20 choice-option cursor-pointer">
                            <input type="checkbox" name="conditions" value="immunological" class="mt-1">
                            <span class="ml-2 text-sm">Immunological/Endocrine (Diabetes, Thyroid)</span>
                        </label>
                        <label class="flex items-start p-3 rounded border border-[#E0C584]/20 choice-option cursor-pointer">
                            <input type="checkbox" name="conditions" value="oncological" class="mt-1">
                            <span class="ml-2 text-sm">Oncological (Current/Past Cancer)</span>
                        </label>
                        <label class="flex items-start p-3 rounded border border-[#E0C584]/20 choice-option cursor-pointer">
                            <input type="checkbox" name="conditions" value="pregnant" class="mt-1">
                            <span class="ml-2 text-sm">Pregnant (or possibly pregnant)</span>
                        </label>
                    </div>

                    <div class="space-y-6">
                        <div class="space-y-2">
                            <label class="block text-sm uppercase tracking-wide opacity-90">Current Medications</label>
                            <textarea name="medications" placeholder="List all medications and supplements..." class="w-full p-3 rounded min-h-[80px]"></textarea>
                        </div>
                        <div class="space-y-2">
                            <label class="block text-sm uppercase tracking-wide opacity-90">Known Allergies</label>
                            <textarea name="allergies" placeholder="Medications, foods, environmental..." class="w-full p-3 rounded min-h-[80px]"></textarea>
                        </div>
                        <div class="space-y-2">
                            <label class="block text-sm uppercase tracking-wide opacity-90">Surgeries &amp; Injuries</label>
                            <textarea name="surgeries_injuries" placeholder="Please list any recent surgeries, fractures, or major injuries with dates..." class="w-full p-3 rounded min-h-[80px]"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Treatment Preferences -->
                <div class="section">
                    <h2 class="text-xl md:text-2xl font-bold mb-6 text-[#E0C584] section-divider pb-2 flex items-center gap-3">
                        <i data-lucide="sparkles" class="w-5 h-5 md:w-6 md:h-6"></i> Preferences &amp; Goals
                    </h2>
                    
                    <div class="space-y-2 mb-6">
                        <label class="block text-lg font-semibold">What are your Primary Goals or Areas of Concern?</label>
                        <textarea name="primary_goals" placeholder="e.g. Back of Neck pain, Lower back tension..." class="w-full p-3 rounded min-h-[100px]"></textarea>
                    </div>

                    <div class="space-y-4 mb-6">
                        <label class="block text-lg font-semibold">Conversation Preference</label>
                        <div class="space-y-3">
                            <label class="flex items-start cursor-pointer choice-option p-3 rounded border border-[#E0C584]/20">
                                <input type="radio" name="conversation_preference" value="quiet" class="mt-1.5">
                                <div class="ml-3">
                                    <span class="block font-bold">Quiet Treatment</span>
                                    <span class="text-sm opacity-80">I enjoy a quiet treatment to help me fully relax. Necessary check-ins regarding pressure/comfort are okay.</span>
                                </div>
                            </label>
                            <label class="flex items-start cursor-pointer choice-option p-3 rounded border border-[#E0C584]/20">
                                <input type="radio" name="conversation_preference" value="chatty" class="mt-1.5">
                                <div class="ml-3">
                                    <span class="block font-bold">Light Conversation</span>
                                    <span class="text-sm opacity-80">I enjoy light conversation during my treatment, this helps me relax.</span>
                                </div>
                            </label>
                            <label class="flex items-center cursor-pointer choice-option p-3 rounded border border-[#E0C584]/20">
                                <input type="radio" name="conversation_preference" value="no_preference" checked class="mt-0">
                                <span class="ml-3 font-bold">No Preference</span>
                            </label>
                        </div>
                    </div>

                     <div class="space-y-2">
                        <label class="block text-sm uppercase tracking-wide opacity-90">Other Preferences</label>
                        <textarea name="other_preferences" placeholder="e.g. Scent sensitivities, pressure preferences, areas to avoid..." class="w-full p-3 rounded min-h-[80px]"></textarea>
                    </div>
                </div>

                <!-- Billing & Payment -->
                <div class="section">
                    <h2 class="text-xl md:text-2xl font-bold mb-6 text-[#E0C584] section-divider pb-2 flex items-center gap-3">
                        <i data-lucide="credit-card" class="w-5 h-5 md:w-6 md:h-6"></i> Billing &amp; Payment Options <span class="text-red-400 ml-1">*</span>
                    </h2>
                    
                    <div class="space-y-4 mb-8">
                        <label class="flex items-start cursor-pointer choice-option p-4 rounded border border-[#E0C584]/30 bg-[#E0C584]/5 hover:bg-[#E0C584]/10 transition-colors">
                            <input type="radio" name="billing_option" value="direct_billing" class="mt-1.5" onclick="toggleInsurance(true)" required>
                            <div class="ml-3">
                                <span class="block text-lg font-bold text-[#E0C584]">Option 1: Direct Billing</span>
                                <span class="text-sm opacity-80 block mt-1">We submit your claim directly to your insurance provider. You will receive a secure payment link for any remaining balance (co-pay), or you may pay via E-Transfer or Cash.</span>
                            </div>
                        </label>
                        
                        <label class="flex items-start cursor-pointer choice-option p-4 rounded border border-[#E0C584]/30 bg-[#E0C584]/5 hover:bg-[#E0C584]/10 transition-colors">
                            <input type="radio" name="billing_option" value="full_payment_electronic" class="mt-1.5" onclick="toggleInsurance(false)" required>
                            <div class="ml-3">
                                <span class="block text-lg font-bold text-[#E0C584]">Option 2: Full Payment - Credit Card Link / E-Transfer</span>
                                <span class="text-sm opacity-80 block mt-1">You will receive a secure payment link after your treatment, or you may pay via E-Transfer. You are responsible for submitting your own insurance claim.</span>
                            </div>
                        </label>

                        <label class="flex items-start cursor-pointer choice-option p-4 rounded border border-[#E0C584]/30 bg-[#E0C584]/5 hover:bg-[#E0C584]/10 transition-colors">
                            <input type="radio" name="billing_option" value="cash" class="mt-1.5" onclick="toggleInsurance(false)" required>
                            <div class="ml-3">
                                <span class="block text-lg font-bold text-[#E0C584]">Option 3: Full Payment - Cash</span>
                                <span class="text-sm opacity-80 block mt-1">You are responsible for submitting your claim to your insurance provider for reimbursement.</span>
                            </div>
                        </label>
                    </div>

                    <!-- Insurance Section -->
                    <div id="insuranceSection" class="hidden pl-4 border-l-2 border-[#E0C584]/30 space-y-6 animate-fade-in">
                        <h3 class="text-xl font-bold text-[#E0C584]">Insurance Information</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
                            <div class="space-y-2">
                                <label class="block text-sm uppercase tracking-wide opacity-90">Insurer Name <span class="text-red-400 hidden insurance-req">*</span></label>
                                <input type="text" name="insurer_name" id="input_insurer_name" placeholder="e.g. SunLife, Manulife" class="w-full p-3 rounded">
                            </div>
                            <div class="space-y-2">
                                <label class="block text-sm uppercase tracking-wide opacity-90">Policy/Plan Number <span class="text-red-400 hidden insurance-req">*</span></label>
                                <input type="text" name="policy_number" id="input_policy_number" class="w-full p-3 rounded">
                            </div>
                            <div class="space-y-2">
                                <label class="block text-sm uppercase tracking-wide opacity-90">Member/Certificate ID <span class="text-red-400 hidden insurance-req">*</span></label>
                                <input type="text" name="member_id" id="input_member_id" class="w-full p-3 rounded">
                            </div>
                            <div class="space-y-2">
                                <label class="block text-sm uppercase tracking-wide opacity-90">Other / Notes</label>
                                <input type="text" name="insurance_other" placeholder="Secondary plan, notes, etc." class="w-full p-3 rounded">
                            </div>
                        </div>

                        <div class="space-y-3 pt-4">
                            <label class="block text-sm uppercase tracking-wide opacity-90">Policy Holder</label>
                            <div class="flex gap-6">
                                <label class="flex items-center cursor-pointer choice-option p-2 rounded">
                                    <input type="radio" name="policy_holder_type" value="self" checked onclick="togglePolicyHolder(false)">
                                    <span class="ml-2">My Policy (Self)</span>
                                </label>
                                <label class="flex items-center cursor-pointer choice-option p-2 rounded">
                                    <input type="radio" name="policy_holder_type" value="other" onclick="togglePolicyHolder(true)">
                                    <span class="ml-2">Other (Spouse/Parent)</span>
                                </label>
                            </div>
                        </div>

                        <!-- Policy Holder Details -->
                        <div id="policyHolderDetails" class="hidden grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6 pt-2 bg-[#E0C584]/5 p-4 rounded">
                            <div class="space-y-2">
                                <label class="block text-sm uppercase tracking-wide opacity-90">Policy Holder First Name</label>
                                <input type="text" name="ph_first_name" class="w-full p-3 rounded">
                            </div>
                            <div class="space-y-2">
                                <label class="block text-sm uppercase tracking-wide opacity-90">Policy Holder Last Name</label>
                                <input type="text" name="ph_last_name" class="w-full p-3 rounded">
                            </div>
                            <div class="space-y-2">
                                <label class="block text-sm uppercase tracking-wide opacity-90">Date of Birth</label>
                                <input type="date" name="ph_dob" class="w-full p-3 rounded">
                            </div>
                             <div class="space-y-2">
                                <label class="block text-sm uppercase tracking-wide opacity-90">Relationship to Client</label>
                                <input type="text" name="ph_relationship" class="w-full p-3 rounded">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Policies & Agreements -->
                <div class="section">
                    <h2 class="text-xl md:text-2xl font-bold mb-6 text-[#E0C584] section-divider pb-2 flex items-center gap-3">
                        <i data-lucide="file-check" class="w-5 h-5 md:w-6 md:h-6"></i> Policies &amp; Agreements
                    </h2>

                    <!-- TELUS Health Consent -->
                    <div class="mb-8">
                        <h3 class="text-lg font-bold text-[#E0C584] mb-2">TELUS Health &amp; Direct Billing Consent</h3>
                        <div class="bg-white/5 p-4 rounded h-40 overflow-y-auto policy-scroll text-sm opacity-90 mb-3 border border-[#E0C584]/20">
                            <p class="mb-2">I authorize my healthcare provider to collect, use and disclose personal information concerning any claims submitted on my behalf with the insurer and/or plan administrator and their service provider(s).</p>
                            <p class="mb-2">I hereby assign benefits payable for the eligible claims to the healthcare provider responsible for submitting my claims electronically to the group benefits plan and I authorize the insurer/plan administrator to issue payment directly to such provider.</p>
                            <p>In the event my claim(s) are declined by the insurer/plan administrator, I understand that I remain responsible for payment to the healthcare provider for any services rendered.</p>
                        </div>
                        <label class="flex items-center cursor-pointer p-2 rounded hover:bg-[#E0C584]/5">
                            <input type="checkbox" name="consent_telus" required>
                            <span class="ml-3 font-semibold text-sm md:text-base">I have read and agree to the TELUS Health Consent terms <span class="text-red-400">*</span></span>
                        </label>
                    </div>

                    <!-- Terms & Conditions -->
                    <div class="mb-8">
                        <div class="flex justify-between items-end mb-2">
                            <h3 class="text-lg font-bold text-[#E0C584]">Terms &amp; Conditions</h3>
                            <a href="https://relaxandrenew.ca/terms" target="_blank" class="text-xs text-[#E0C584] hover:text-white border-b border-[#E0C584] pb-0.5 mb-1 transition-colors">View Full Terms <i data-lucide="external-link" class="inline w-3 h-3 ml-1"></i></a>
                        </div>
                        <div class="bg-white/5 p-4 rounded h-48 overflow-y-auto policy-scroll text-sm opacity-90 mb-3 border border-[#E0C584]/20 space-y-2">
                            <p><strong>Cancellation Policy:</strong> We enforce strict cancellation fees to ensure fair availability.</p>
                            <ul class="list-disc ml-5 mb-2">
                                <li><strong>12+ Hours Notice:</strong> No Charge</li>
                                <li><strong>Under 12 Hours:</strong> Partial Charge</li>
                                <li><strong>Under 6 Hours / No Show:</strong> Full Charge</li>
                            </ul>
                            <p><strong>Services:</strong> All services are provided by Registered Massage Therapists (RMTs) in good standing with the CMTO. We reserve the right to refuse service.</p>
                            <p><strong>Payments:</strong> Payment is due at the time of service via Credit Card, E-Transfer, or Cash. Credit card information is stored securely via Noterro/Square/Stripe to enforce our cancellation policy. Full card numbers are never stored on local systems.</p>
                            <p><strong>Client Conduct:</strong> Any inappropriate remarks, sexual advances, or aggressive actions will result in the immediate termination of the session, full payment will be charged, and the client will be banned.</p>
                            <p><strong>Liability:</strong> The client releases Relax &amp; Renew RMT from liability regarding injury or damage on the client's premises, except in cases of gross negligence.</p>
                        </div>
                        <label class="flex items-start cursor-pointer p-2 rounded hover:bg-[#E0C584]/5">
                            <input type="checkbox" name="consent_terms" required class="mt-1">
                            <span class="ml-3 font-semibold text-sm md:text-base">I agree to the Terms &amp; Conditions (including Cancellation Policy) <span class="text-red-400">*</span></span>
                        </label>
                    </div>

                    <!-- Privacy Policy -->
                    <div class="mb-8">
                        <div class="flex justify-between items-end mb-2">
                            <h3 class="text-lg font-bold text-[#E0C584]">Privacy Policy</h3>
                            <a href="https://relaxandrenew.ca/privacy" target="_blank" class="text-xs text-[#E0C584] hover:text-white border-b border-[#E0C584] pb-0.5 mb-1 transition-colors">View Full Policy <i data-lucide="external-link" class="inline w-3 h-3 ml-1"></i></a>
                        </div>
                        <div class="bg-white/5 p-4 rounded h-40 overflow-y-auto policy-scroll text-sm opacity-90 mb-3 border border-[#E0C584]/20 space-y-2">
                            <p><strong>Collection &amp; Use:</strong> We collect necessary personal (name, address, DOB) and health information to provide safe, effective care under PHIPA. Payment and booking data is processed securely.</p>
                            <p><strong>Disclosure:</strong> We do not sell or rent your information. Disclosure is strictly limited to your circle of care (with consent), third-party processors (e.g., Noterro, Stripe) for booking/billing, or as required by law.</p>
                            <p><strong>Security &amp; Retention:</strong> Records are stored securely in compliance with CMTO regulations. Clinical records are retained for the legally required period (typically 10 years).</p>
                            <p><strong>Your Rights:</strong> You have the right to access, correct, or withdraw consent for your information, subject to legal requirements.</p>
                        </div>
                        <label class="flex items-start cursor-pointer p-2 rounded hover:bg-[#E0C584]/5">
                            <input type="checkbox" name="consent_privacy" required class="mt-1">
                            <span class="ml-3 font-semibold text-sm md:text-base">I agree to the Privacy Policy <span class="text-red-400">*</span></span>
                        </label>
                    </div>

                     <!-- Final Intake Consent -->
                     <div class="mb-8 p-4 border border-[#E0C584] rounded bg-[#E0C584]/10">
                        <p class="mb-4 font-semibold text-[#E0C584]">I confirm that I have answered all questions honestly and to the best of my ability.</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-2">
                                <label class="block text-sm uppercase tracking-wide opacity-90">Type Full Name <span class="text-red-400">*</span></label>
                                <input type="text" name="signature_name" required placeholder="Type your full legal name" class="w-full p-3 rounded bg-black/50 border-[#E0C584]">
                            </div>
                            <div class="space-y-2">
                                <label class="block text-sm uppercase tracking-wide opacity-90">Date <span class="text-red-400">*</span></label>
                                <input type="date" name="signature_date" required class="w-full p-3 rounded bg-black/50 border-[#E0C584]">
                            </div>
                            <div class="md:col-span-2 space-y-2">
                                <label class="block text-sm uppercase tracking-wide opacity-90">Digital Signature (Draw below) <span class="text-red-400">*</span></label>
                                
                                <div class="relative w-full border border-[#E0C584]/40 rounded bg-white/5 overflow-hidden">
                                    <canvas id="signaturePad" class="w-full h-40 md:h-52 block cursor-crosshair touch-none"></canvas>
                                    
                                    <button type="button" id="clearSigBtn" class="absolute top-2 right-2 text-xs font-bold text-black bg-[#E0C584] hover:bg-white px-3 py-1.5 rounded transition-colors z-10 shadow-lg select-none">
                                        Hold 2s to Clear
                                    </button>
                                </div>
                                
                                <input type="hidden" name="signature_image" id="signatureImage">
                                <p class="text-xs text-[#E0C584]/60 mt-1">Please sign using your mouse or finger.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="pt-6">
                    <button type="submit" id="submitBtn" class="w-full btn-gold py-4 px-8 rounded text-lg uppercase tracking-widest font-bold shadow-lg flex items-center justify-center gap-2">
                        <span>Submit Health History</span>
                        <i data-lucide="arrow-right" class="w-5 h-5"></i>
                    </button>
                </div>

            </form>
        </div>
    </div>

    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
        // 1. GLOBAL SCOPE FUNCTIONS (Dropdowns fix)
        function toggleInsurance(show) {
            const section = document.getElementById('insuranceSection');
            if (!section) return;

            const reqInputs = ['input_insurer_name', 'input_policy_number', 'input_member_id'];
            const reqLabels = document.querySelectorAll('.insurance-req');

            if(show) {
                section.classList.remove('hidden');
                reqInputs.forEach(id => {
                    const el = document.getElementById(id);
                    if(el) el.required = true;
                });
                reqLabels.forEach(el => el.classList.remove('hidden'));
            } else {
                section.classList.add('hidden');
                reqInputs.forEach(id => {
                    const el = document.getElementById(id);
                    if(el) el.required = false;
                });
                reqLabels.forEach(el => el.classList.add('hidden'));
            }
        }

        function togglePolicyHolder(isOther) {
            const details = document.getElementById('policyHolderDetails');
            if(isOther) {
                details.classList.remove('hidden');
            } else {
                details.classList.add('hidden');
            }
        }

        // Initialize Lucide Icons
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }

        // Easy View Toggle Logic
        const viewBtn = document.getElementById('easyViewBtn');
        const viewText = document.getElementById('easyViewText');
        
        viewBtn.addEventListener('click', () => {
            document.body.classList.toggle('easy-view');
            const isEasy = document.body.classList.contains('easy-view');
            
            viewText.textContent = isEasy ? 'Exit Easy View' : 'Easy Viewing Mode';
            
            if(isEasy) {
                viewBtn.style.backgroundColor = '#4c1d95';
                viewBtn.style.color = 'white';
                viewBtn.style.borderColor = '#4c1d95';
            } else {
                viewBtn.style.backgroundColor = '';
                viewBtn.style.color = '';
                viewBtn.style.borderColor = '';
            }
        });

        // Phone Formatting Logic
        document.addEventListener('input', function(e) {
            if (e.target.classList.contains('phone-input')) {
                let x = e.target.value.replace(/\D/g, '').match(/(\d{0,3})(\d{0,3})(\d{0,4})/);
                e.target.value = !x[2] ? x[1] : '(' + x[1] + ') ' + x[2] + (x[3] ? ' ' + x[3] : '');
            }
        });

        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');
        let patientId = urlParams.get('patientId');
        let appointmentId = urlParams.get('appointmentId');


        // --- DRAFT PERSISTENCE (Token Pages) ---
        // Saves in-progress form entries locally so refresh/close does not lose work.
        const __RNR_DRAFT_BASE_KEY = 'rnr:healthIntakeDraft:v1';
        const __RNR_DRAFT_KEY = (() => {
            if (token) return `${__RNR_DRAFT_BASE_KEY}:token:${token}`;
            if (patientId || appointmentId) return `${__RNR_DRAFT_BASE_KEY}:pa:${patientId || ''}:${appointmentId || ''}`;
            return `${__RNR_DRAFT_BASE_KEY}:path:${window.location.pathname}`;
        })();

        let __rnrDraftRestoreInProgress = false;
        let __rnrDraftSaveTimer = null;
        let __rnrSignatureStrokes = null;

        function __rnrSafeLocalStorageGet(key) {
            try { return window.localStorage.getItem(key); } catch (_) { return null; }
        }
        function __rnrSafeLocalStorageSet(key, value) {
            try { window.localStorage.setItem(key, value); return true; } catch (_) { return false; }
        }
        function __rnrSafeLocalStorageRemove(key) {
            try { window.localStorage.removeItem(key); } catch (_) {}
        }

        function __rnrReadDraft() {
            const raw = __rnrSafeLocalStorageGet(__RNR_DRAFT_KEY);
            if (!raw) return null;
            try { return JSON.parse(raw); } catch (_) { return null; }
        }

        function __rnrWriteDraft(draft) {
            if (!draft || typeof draft !== 'object') return;
            __rnrSafeLocalStorageSet(__RNR_DRAFT_KEY, JSON.stringify(draft));
        }

        function __rnrCollectDraft() {
            const form = document.getElementById('healthIntakeForm');
            if (!form) return null;

            const elements = Array.from(form.elements).filter(el => el && el.name && !el.disabled);
            const nameCounts = {};
            elements.forEach(el => { nameCounts[el.name] = (nameCounts[el.name] || 0) + 1; });

            const data = {};

            elements.forEach(el => {
                const name = el.name;
                const tag = (el.tagName || '').toLowerCase();

                // Avoid storing large base64 values; signature is persisted as strokes instead.
                if (name === 'signature_image') return;

                if (el.type === 'checkbox') {
                    const isGroup = (nameCounts[name] || 0) > 1;
                    if (isGroup) {
                        if (!Array.isArray(data[name])) data[name] = [];
                        if (el.checked) data[name].push(el.value);
                    } else {
                        data[name] = !!el.checked;
                    }
                    return;
                }

                if (el.type === 'radio') {
                    if (el.checked) data[name] = el.value;
                    return;
                }

                if (tag === 'select' || tag === 'textarea' || el.type === 'text' || el.type === 'email' || el.type === 'tel' || el.type === 'date' || el.type === 'hidden') {
                    data[name] = el.value;
                    return;
                }

                // Default fallback
                data[name] = el.value;
            });

            return {
                v: 1,
                updatedAt: new Date().toISOString(),
                token: token || null,
                patientId: patientId || null,
                appointmentId: appointmentId || null,
                data,
                signatureStrokes: Array.isArray(__rnrSignatureStrokes) ? __rnrSignatureStrokes : null
            };
        }

        function __rnrApplyDraft(draft) {
            if (!draft || typeof draft !== 'object' || !draft.data) return;
            const form = document.getElementById('healthIntakeForm');
            if (!form) return;

            __rnrDraftRestoreInProgress = true;

            const elements = Array.from(form.elements).filter(el => el && el.name && !el.disabled);
            const nameCounts = {};
            elements.forEach(el => { nameCounts[el.name] = (nameCounts[el.name] || 0) + 1; });

            elements.forEach(el => {
                const name = el.name;
                const saved = draft.data[name];
                if (saved === undefined) return;

                if (name === 'signature_image') return;

                if (el.type === 'checkbox') {
                    const isGroup = (nameCounts[name] || 0) > 1;
                    if (isGroup) {
                        el.checked = Array.isArray(saved) && saved.includes(el.value);
                    } else {
                        el.checked = !!saved;
                    }
                    return;
                }

                if (el.type === 'radio') {
                    el.checked = (el.value === saved);
                    return;
                }

                el.value = saved;
            });

            if (Array.isArray(draft.signatureStrokes)) {
                __rnrSignatureStrokes = draft.signatureStrokes;
            }

            // Ensure dependent sections reflect restored radios
            if (draft.data.billing_option) {
                toggleInsurance(draft.data.billing_option === 'direct_billing');
            }
            if (draft.data.policy_holder_type) {
                togglePolicyHolder(draft.data.policy_holder_type === 'other');
            }

            __rnrDraftRestoreInProgress = false;
        }

        function __rnrSaveDraftDebounced() {
            if (__rnrDraftRestoreInProgress) return;
            if (!token) return; // only persist on token pages (as requested)

            clearTimeout(__rnrDraftSaveTimer);
            __rnrDraftSaveTimer = setTimeout(() => {
                const draft = __rnrCollectDraft();
                if (draft) __rnrWriteDraft(draft);
            }, 250);
        }

        function __rnrClearDraft() {
            __rnrSafeLocalStorageRemove(__RNR_DRAFT_KEY);
        }

        (function __rnrInitDraftPersistence() {
            if (!token) return; // only on token pages
            const draft = __rnrReadDraft();
            if (draft) __rnrApplyDraft(draft);

            const form = document.getElementById('healthIntakeForm');
            if (!form) return;

            form.addEventListener('input', __rnrSaveDraftDebounced);
            form.addEventListener('change', __rnrSaveDraftDebounced);
        })();

        // PDF snapshot tuning (brightness) - affects the captured HTML only, not on-page visuals.
        function __rnrTunePdfSnapshot(html) {
            if (typeof html !== 'string') return html;

            // Slightly reduce the header glow overlay in the captured snapshot only.
            return html.replace(
                'bg-[#E0C584] opacity-5 blur-3xl rounded-full pointer-events-none"></div>',
                'bg-[#E0C584] opacity-5 blur-3xl rounded-full pointer-events-none" style="opacity:0.03;"></div>'
            );
        }

        // Set today's date for signature date
        const dateInput = document.querySelector('input[name="signature_date"]');
        if(dateInput) {
            if (!dateInput.value) dateInput.valueAsDate = new Date();
        }

        // 2. TOKEN LOGIC
        (async function validateToken() {
            if (!token) return;

            try {
                const response = await fetch('https://primary-production-efcf.up.railway.app/webhook/validate-token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token })
                });
                
                if (!response.ok) throw new Error('Token validation failed');

                const data = await response.json();
                
                if (data.valid) {
                    patientId = data.patientId;
                    appointmentId = data.appointmentId;
                    
                    if (data.firstName) {
                        const el = document.querySelector('input[name="first_name"]');
                        if(el && !el.value) el.value = data.firstName;
                    }
                    if (data.lastName) {
                        const el = document.querySelector('input[name="last_name"]');
                        if(el && !el.value) el.value = data.lastName;
                    }
                    if (data.email) {
                        const el = document.querySelector('input[name="email"]');
                        if(el && !el.value) el.value = data.email;
                    }
                    if (data.phone) {
                        const el = document.querySelector('input[name="phone"]');
                        if(el && !el.value) el.value = data.phone;
                    }
                }
            } catch (err) {
                console.error('Token validation error:', err);
            }
        })();

        // 3. SIGNATURE PAD LOGIC
        (function initSignaturePad() {
            const canvas = document.getElementById('signaturePad');
            const ctx = canvas.getContext('2d');
            const clearBtn = document.getElementById('clearSigBtn');
            const signatureInput = document.getElementById('signatureImage');
            
            let isDrawing = false;
            let currentStroke = [];
            let allStrokes = [];
            
            // Restore saved signature (draft persistence) so refresh/close does not lose it.
            let __rnrRestoredStrokes = null;
            try {
                const __draft = __rnrReadDraft();
                if (__draft && Array.isArray(__draft.signatureStrokes)) {
                    __rnrRestoredStrokes = __draft.signatureStrokes;
                } else if (Array.isArray(__rnrSignatureStrokes)) {
                    __rnrRestoredStrokes = __rnrSignatureStrokes;
                }
            } catch (_) {}
            
            function redraw() {
                const isEasyView = document.body.classList.contains('easy-view');
                ctx.strokeStyle = isEasyView ? '#000000' : '#E0C584'; 
                ctx.lineWidth = 2.5;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';

                allStrokes.forEach(stroke => {
                    if(stroke.length < 1) return;
                    ctx.beginPath();
                    ctx.moveTo(stroke[0].x, stroke[0].y);
                    for (let i = 1; i < stroke.length; i++) {
                        ctx.lineTo(stroke[i].x, stroke[i].y);
                    }
                    ctx.stroke();
                });
            }

            function resizeCanvas() {
                const rect = canvas.getBoundingClientRect();
                if (canvas.width !== rect.width || canvas.height !== rect.height) {
                    canvas.width = rect.width;
                    canvas.height = rect.height;
                    redraw();
                }
            }

            window.addEventListener('load', resizeCanvas);
            window.addEventListener('resize', resizeCanvas);
            resizeCanvas();
            
            if (Array.isArray(__rnrRestoredStrokes)) {
                allStrokes = __rnrRestoredStrokes;
                __rnrSignatureStrokes = allStrokes;
                if (allStrokes.length > 0) {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    redraw();
                    signatureInput.value = canvas.toDataURL('image/png');
                } else {
                    signatureInput.value = '';
                }
            }


            function getPointerPos(e) {
                const rect = canvas.getBoundingClientRect();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                return {
                    x: clientX - rect.left,
                    y: clientY - rect.top
                };
            }

            function startDrawing(e) {
                e.preventDefault(); 
                isDrawing = true;
                currentStroke = [];
                const pos = getPointerPos(e);
                currentStroke.push(pos);
                
                const isEasyView = document.body.classList.contains('easy-view');
                ctx.strokeStyle = isEasyView ? '#000000' : '#E0C584'; 
                ctx.lineWidth = 2.5;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                
                ctx.beginPath();
                ctx.moveTo(pos.x, pos.y);
                ctx.lineTo(pos.x, pos.y);
                ctx.stroke();
            }

            function draw(e) {
                if (!isDrawing) return;
                e.preventDefault();
                const pos = getPointerPos(e);
                currentStroke.push(pos);
                ctx.lineTo(pos.x, pos.y);
                ctx.stroke();
            }

            function stopDrawing(e) {
                if (!isDrawing) return;
                isDrawing = false;
                
                if (currentStroke.length > 0) {
                    allStrokes.push(currentStroke);
                }
                
                if(allStrokes.length > 0) {
                    signatureInput.value = canvas.toDataURL('image/png');
                    
                    __rnrSignatureStrokes = allStrokes;
                    __rnrSaveDraftDebounced();
                }
            }

            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            canvas.addEventListener('touchstart', startDrawing, { passive: false });
            canvas.addEventListener('touchmove', draw, { passive: false });
            canvas.addEventListener('touchend', stopDrawing);

            let clearTimer = null;
            let countdownInterval = null;
            const HOLD_DURATION = 2000;

            function startClearTimer(e) {
                e.preventDefault();
                let timeLeft = 2;
                
                clearBtn.classList.add('hold-active');
                clearBtn.innerText = `Holding... ${timeLeft}s`;

                countdownInterval = setInterval(() => {
                    timeLeft--;
                    if(timeLeft > 0) {
                        clearBtn.innerText = `Holding... ${timeLeft}s`;
                    }
                }, 1000);

                clearTimer = setTimeout(() => {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    allStrokes = [];
                    signatureInput.value = '';
                    
                    __rnrSignatureStrokes = allStrokes;
                    __rnrSaveDraftDebounced();
                    
                    resetClearButton("Cleared!");
                }, HOLD_DURATION);
            }

            function cancelClearTimer(e) {
                if(e) e.preventDefault();
                resetClearButton("Hold 2s to Clear");
            }

            function resetClearButton(text) {
                clearTimeout(clearTimer);
                clearInterval(countdownInterval);
                clearTimer = null;
                countdownInterval = null;
                
                clearBtn.classList.remove('hold-active');
                clearBtn.innerText = text;
                
                if(text === "Cleared!") {
                    setTimeout(() => {
                        clearBtn.innerText = "Hold 2s to Clear";
                    }, 2000);
                }
            }

            clearBtn.addEventListener('mousedown', startClearTimer);
            clearBtn.addEventListener('touchstart', startClearTimer, { passive: false });
            clearBtn.addEventListener('mouseup', cancelClearTimer);
            clearBtn.addEventListener('mouseleave', cancelClearTimer);
            clearBtn.addEventListener('touchend', cancelClearTimer);

        })();

        // 4. FORM SUBMISSION LOGIC
document.getElementById('healthIntakeForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const signatureInput = document.getElementById('signatureImage');
    
    if(!signatureInput.value) {
        alert("Please sign the form before submitting.");
        return;
    }

    const submitBtn = document.getElementById('submitBtn');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const successMessage = document.getElementById('successMessage');
    const errorMessage = document.getElementById('errorMessage');
    
    successMessage.classList.add('hidden');
    errorMessage.classList.add('hidden');
    
    // SYNC ALL FORM VALUES TO HTML ATTRIBUTES BEFORE CAPTURING
    
    // Handle text inputs, emails, tel, date, etc.
    document.querySelectorAll('input[type="text"], input[type="email"], input[type="tel"], input[type="date"], input[type="hidden"]').forEach(input => {
        input.setAttribute('value', input.value);
    });
    
    // Handle textareas
    document.querySelectorAll('textarea').forEach(textarea => {
        textarea.textContent = textarea.value;
    });
    
    // Handle select elements
    document.querySelectorAll('select').forEach(select => {
        select.querySelectorAll('option').forEach(option => {
            if(option.value === select.value) {
                option.setAttribute('selected', 'selected');
            } else {
                option.removeAttribute('selected');
            }
        });
    });
    
    // Handle checkboxes
    document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
        if(checkbox.checked) {
            checkbox.setAttribute('checked', 'checked');
        } else {
            checkbox.removeAttribute('checked');
        }
    });
    
    // Handle radio buttons
    document.querySelectorAll('input[type="radio"]').forEach(radio => {
        if(radio.checked) {
            radio.setAttribute('checked', 'checked');
        } else {
            radio.removeAttribute('checked');
        }
    });
    
    // CONVERT SIGNATURE CANVAS TO AN IMAGE FOR THE SNAPSHOT
    const canvas = document.getElementById('signaturePad');
    const signatureDataUrl = canvas.toDataURL('image/png');
    
    // Create an image element to replace the canvas temporarily
    const signatureImg = document.createElement('img');
    signatureImg.src = signatureDataUrl;
    signatureImg.id = 'signaturePadImage';
    signatureImg.className = canvas.className;
    signatureImg.style.cssText = `
        width: 100%;
        height: ${canvas.offsetHeight}px;
        display: block;
        background-color: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(224, 197, 132, 0.4);
        border-radius: 0.25rem;
    `;
    
    // Store reference to canvas parent and sibling
    const canvasParent = canvas.parentElement;
    const clearBtn = document.getElementById('clearSigBtn');
    
    // Temporarily hide the clear button and replace canvas with image
    clearBtn.style.display = 'none';
    canvas.style.display = 'none';
    canvasParent.insertBefore(signatureImg, canvas);
    
    // Ensure insurance section visibility is captured
    const insuranceSection = document.getElementById('insuranceSection');
    if(insuranceSection && !insuranceSection.classList.contains('hidden')) {
        insuranceSection.setAttribute('style', 'display: block !important;');
    }
    
    // Ensure policy holder details visibility is captured
    const policyHolderDetails = document.getElementById('policyHolderDetails');
    if(policyHolderDetails && !policyHolderDetails.classList.contains('hidden')) {
        policyHolderDetails.setAttribute('style', 'display: grid !important;');
    }
    
    // CAPTURE HTML SNAPSHOT
    let formHtmlSnapshot = document.documentElement.outerHTML;
    formHtmlSnapshot = __rnrTunePdfSnapshot(formHtmlSnapshot);
    
    // RESTORE the canvas and button immediately after capturing
    signatureImg.remove();
    canvas.style.display = 'block';
    clearBtn.style.display = '';
    
    // Remove inline styles we added
    if(insuranceSection) insuranceSection.removeAttribute('style');
    if(policyHolderDetails) policyHolderDetails.removeAttribute('style');
    
    // NOW disable button and show loading overlay
    submitBtn.disabled = true;
    loadingOverlay.classList.remove('hidden');
    
    const formData = new FormData(this);
    const formDataObj = {
        patientId: patientId,
        appointmentId: appointmentId,
        submittedAt: new Date().toISOString()
    };
    
    for (let [key, value] of formData.entries()) {
        if (key === 'conditions') {
            if (!formDataObj[key]) formDataObj[key] = [];
            formDataObj[key].push(value);
        } else {
            formDataObj[key] = value;
        }
    }
    
    // Use the pre-captured HTML snapshot
    const data = {
        formHtml: formHtmlSnapshot,
        formData: formDataObj
    };
    
    try {
        const response = await fetch('https://primary-production-efcf.up.railway.app/webhook/health-intake-submit', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        if (!response.ok) {
            throw new Error('Submission failed');
        }
        
        loadingOverlay.classList.add('hidden');
        successMessage.classList.remove('hidden');
        this.reset();
        
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height); 
        signatureInput.value = '';
        
        __rnrSignatureStrokes = null;
        __rnrClearDraft();
        
        window.scrollTo({ top: 0, behavior: 'smooth' });
        
    } catch (error) {
        console.error('Error:', error);
        loadingOverlay.classList.add('hidden');
        errorMessage.classList.remove('hidden');
        submitBtn.disabled = false;
        
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
});
    </script>

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=AW-17575022013"><