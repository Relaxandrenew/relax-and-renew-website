<script>
                // Phone number force-formatting (BACKSPACE/DELETE SAFE)
                (function setupPhoneFormatting() {
                    const input = document.getElementById('client-phone');
                    if (!input) return;

                    const MAX_DIGITS = 10;
                    let isApplying = false;

                    function digitsOnly(v) {
                        return (v || '').replace(/\D/g, '').slice(0, MAX_DIGITS);
                    }

                    function formatPhone(d) {
                        if (!d) return '';
                        if (d.length <= 3) return `(${d}`;
                        if (d.length <= 6) return `(${d.slice(0,3)}) ${d.slice(3)}`;
                        return `(${d.slice(0,3)}) ${d.slice(3,6)}-${d.slice(6,10)}`;
                    }

                    function countDigitsBeforeCaret(value, caretPos) {
                        return value.slice(0, caretPos).replace(/\D/g, '').length;
                    }

                    function caretPosForDigitIndex(formattedValue, digitIndex) {
                        if (digitIndex <= 0) return 0;
                        let seen = 0;
                        for (let i = 0; i < formattedValue.length; i++) {
                            if (/\d/.test(formattedValue[i])) {
                                seen++;
                                if (seen === digitIndex) return i + 1;
                            }
                        }
                        return formattedValue.length;
                    }

                    function applyDigitsAndCaret(digits, caretDigitIndex) {
                        const newValue = formatPhone(digitsOnly(digits));
                        isApplying = true;
                        input.value = newValue;
                        const newCaret = caretPosForDigitIndex(newValue, caretDigitIndex);
                        input.setSelectionRange(newCaret, newCaret);
                        isApplying = false;
                    }

                    // Handle Backspace/Delete on formatting characters in ONE keypress
                    input.addEventListener('keydown', (e) => {
                        if (e.key !== 'Backspace' && e.key !== 'Delete') return;

                        const value = input.value;
                        const start = input.selectionStart ?? 0;
                        const end = input.selectionEnd ?? 0;

                        // If user has a selection, let the browser delete it; input handler will re-format.
                        if (start !== end) return;

                        if (e.key === 'Backspace') {
                            // If the char just before caret is a formatting char, delete the previous digit instead.
                            if (start > 0 && !/\d/.test(value[start - 1])) {
                                e.preventDefault();
                                const digits = digitsOnly(value);
                                const digitsBefore = countDigitsBeforeCaret(value, start);
                                if (digitsBefore <= 0) return;
                                const newDigits = digits.slice(0, digitsBefore - 1) + digits.slice(digitsBefore);
                                applyDigitsAndCaret(newDigits, digitsBefore - 1);
                            }
                        }

                        if (e.key === 'Delete') {
                            // If the char at caret is a formatting char, delete the next digit instead.
                            if (start < value.length && !/\d/.test(value[start])) {
                                e.preventDefault();
                                const digits = digitsOnly(value);
                                const digitsBefore = countDigitsBeforeCaret(value, start);
                                if (digitsBefore >= digits.length) return;
                                const newDigits = digits.slice(0, digitsBefore) + digits.slice(digitsBefore + 1);
                                applyDigitsAndCaret(newDigits, digitsBefore);
                            }
                        }
                    });

                    // Mobile-friendly deletion support (covers cases where keydown may not fire)
                    input.addEventListener('beforeinput', (e) => {
                        if (isApplying) return;

                        const t = e.inputType;
                        const isDelete =
                            t === 'deleteContentBackward' ||
                            t === 'deleteContentForward' ||
                            t === 'deleteByCut';

                        if (!isDelete) return;

                        const value = input.value;
                        const start = input.selectionStart ?? 0;
                        const end = input.selectionEnd ?? 0;

                        const digits = digitsOnly(value);
                        const dStart = countDigitsBeforeCaret(value, start);
                        const dEnd = countDigitsBeforeCaret(value, end);

                        // Remove selection (or cut) in digit-space
                        if (dStart !== dEnd) {
                            e.preventDefault();
                            const newDigits = digits.slice(0, dStart) + digits.slice(dEnd);
                            applyDigitsAndCaret(newDigits, dStart);
                            return;
                        }

                        if (t === 'deleteContentBackward') {
                            if (dStart <= 0) return;
                            e.preventDefault();
                            const newDigits = digits.slice(0, dStart - 1) + digits.slice(dStart);
                            applyDigitsAndCaret(newDigits, dStart - 1);
                            return;
                        }

                        if (t === 'deleteContentForward') {
                            if (dStart >= digits.length) return;
                            e.preventDefault();
                            const newDigits = digits.slice(0, dStart) + digits.slice(dStart + 1);
                            applyDigitsAndCaret(newDigits, dStart);
                        }
                    });

                    // Format on any input (typing/paste), while preserving caret position in digit-space
                    input.addEventListener('input', () => {
                        if (isApplying) return;

                        const oldValue = input.value;
                        const caret = input.selectionStart ?? oldValue.length;

                        const digitsBefore = countDigitsBeforeCaret(oldValue, caret);
                        const digits = digitsOnly(oldValue);

                        const newValue = formatPhone(digits);
                        isApplying = true;
                        input.value = newValue;

                        const newCaret = caretPosForDigitIndex(newValue, digitsBefore);
                        input.setSelectionRange(newCaret, newCaret);
                        isApplying = false;
                    });

                    input.setAttribute('inputmode', 'tel');
                    input.setAttribute('autocomplete', 'tel');
                })();
</script>
