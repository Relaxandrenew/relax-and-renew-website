<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Book Now | Relax & Renew RMT</title>
    <meta name="description" content="Book your mobile RMT massage therapy session in Niagara Region. View services and pricing.">

    <!-- Meta Pixel -->
    <script>
    !function(f,b,e,v,n,t,s)
    {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
    n.callMethod.apply(n,arguments):n.queue.push(arguments)};
    if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
    n.queue=[];t=b.createElement(e);t.async=!0;
    t.src=v;s=b.getElementsByTagName(e)[0];
    s.parentNode.insertBefore(t,s)}(window, document,'script',
    'https://connect.facebook.net/en_US/fbevents.js');
    fbq('init', '701194265870298');
    fbq('track', 'PageView');
    </script>
    <noscript><img height="1" width="1" style="display:none"
    src="https://www.facebook.com/tr?id=701194265870298&ev=PageView&noscript=1"
    /></noscript>

    <!-- Google Tag / Ads -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=AW-17575022013"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-J4NC9FL44H');
        gtag('config', 'AW-17575022013');
    </script>

    <!-- Error suppression for third-party scripts -->
    <script>
        window.onerror = function(msg, url) {
            if (!url || (msg && String(msg).toLowerCase().indexOf("script error") > -1)) return true;
            return false;
        };
        window.addEventListener('unhandledrejection', function(event) { event.preventDefault(); });

        window.gm_authFailure = function() {
            console.warn("Google Maps API: Authentication restricted.");
            const inputs = document.querySelectorAll('#address-input-initial');
            inputs.forEach(el => {
                el.placeholder = "Address lookup unavailable";
                el.disabled = false;
                el.style.opacity = "0.8";
            });
        };
    </script>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            gold: '#E0C584',
                            goldHover: '#F0D594',
                            light: '#F0E2C0',
                            dim: 'rgba(240, 226, 192, 0.6)',
                            black: '#050505',
                            dark: '#0a0a0a',
                            panel: 'rgba(20, 20, 20, 0.7)',
                        }
                    },
                    fontFamily: { serif: ['"Cormorant Garamond"', 'serif'] },
                    backgroundImage: {
                        'hero-pattern': "linear-gradient(to bottom, rgba(0,0,0,0.3), rgba(0,0,0,0.9)), url('https://static.wixstatic.com/media/bf8fef_94f8be278f0f4b8abaee73b95d03b5e2~mv2.png')",
                        'alternate-pattern': "linear-gradient(to bottom, rgba(0,0,0,0.8), rgba(0,0,0,0.95)), url('https://static.wixstatic.com/media/bf8fef_7776f5b067be4025a75ed7e149bb1d7e~mv2.jpg')"
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out',
                        'slide-up': 'slideUp 0.4s ease-out',
                        'pulse-subtle': 'pulseSubtle 2s ease-in-out infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        pulseSubtle: {
                            '0%, 100%': { opacity: '1' },
                            '50%': { opacity: '0.7' },
                        }
                    }
                }
            }
        };
    </script>

    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

    <style>
        body { background-color: #050505; color: #F0E2C0; font-family: 'Cormorant Garamond', serif; font-size: 1.15rem; line-height: 1.7; overflow-x: hidden; }
        html { scroll-behavior: smooth; }

        /* Navigation - Matching Main Site */
        .fixed-nav { position: fixed; top: 0; left: 0; width: 100%; z-index: 50; transition: all 0.4s ease; background: rgba(5, 5, 5, 0.95); backdrop-filter: blur(15px); border-bottom: 1px solid rgba(224, 197, 132, 0.2); }
        
        .nav-link { color: #F0E2C0; text-transform: uppercase; font-size: 0.8rem; font-weight: 600; letter-spacing: 0.15em; text-decoration: none; position: relative; padding-bottom: 5px; }
        .nav-link::after { content: ''; position: absolute; bottom: 0; left: 0; width: 0; height: 1px; background: #E0C584; transition: width 0.3s ease; }
        .nav-link:hover::after { width: 100%; }

        .card-fancy { background: linear-gradient(145deg, rgba(20,20,20,0.9), rgba(10,10,10,0.95)); border: 1px solid rgba(224, 197, 132, 0.15); backdrop-filter: blur(10px); transition: all 0.4s ease; padding: 2.5rem 2rem; position: relative; overflow: hidden; border-radius: 8px; }
        .card-fancy::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 2px; background: linear-gradient(90deg, transparent, #E0C584, transparent); transform: scaleX(0); transition: transform 0.5s ease; }
        .card-fancy:hover::before { transform: scaleX(1); }

        .btn-gold { border: 1px solid #E0C584; color: #E0C584; padding: 0.6rem 2rem; text-transform: uppercase; font-weight: 700; letter-spacing: 0.1em; transition: 0.3s; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; cursor: pointer; border-radius: 4px; }
        .btn-gold:hover { background: rgba(224, 197, 132, 0.15); color: #F0E2C0; border-color: #F0D594; box-shadow: 0 0 20px rgba(224, 197, 132, 0.3); }

        .btn-filled { background: #E0C584; color: #000; border: 1px solid #E0C584; padding: 0.6rem 2rem; text-transform: uppercase; font-weight: 700; letter-spacing: 0.1em; transition: 0.3s; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; cursor: pointer; border-radius: 4px; }
        .btn-filled:hover { background: #F0D594; border-color: #F0D594; transform: translateY(-2px); box-shadow: 0 8px 25px rgba(224, 197, 132, 0.4); }

        .pac-container { background-color: #1a1a1a; border: 1px solid #E0C584; font-family: 'Cormorant Garamond', serif; z-index: 200 !important; border-radius: 4px; }
        .pac-item { border-top: 1px solid rgba(224, 197, 132, 0.1); color: #F0E2C0; padding: 10px; cursor: pointer; }
        .pac-item:hover { background-color: rgba(224, 197, 132, 0.1); }
        .pac-item-query { color: #E0C584; }

        .modal-backdrop { background-color: rgba(0, 0, 0, 0.92); backdrop-filter: blur(8px); z-index: 100; }

        .calendar-grid { display: grid; grid-template-columns: repeat(7, minmax(0, 1fr)); gap: 0.5rem; }
        .calendar-day-disabled { opacity: 0.25; cursor: not-allowed; }
        .calendar-day-available { border: 2px solid rgba(224,197,132,0.4); cursor: pointer; transition: all 0.3s ease; background: rgba(224,197,132,0.05); }
        .calendar-day-available:hover { background: rgba(224,197,132,0.15); border-color: rgba(224,197,132,0.7); transform: translateY(-2px); box-shadow: 0 4px 15px rgba(224, 197, 132, 0.2); }
        .calendar-day-selected { background: rgba(224,197,132,0.25); border-color: #E0C584; box-shadow: 0 0 20px rgba(224, 197, 132, 0.3); }
        
        .time-slot-btn { transition: all 0.3s ease; position: relative; overflow: hidden; }
        .time-slot-btn::before { content: ''; position: absolute; top: 50%; left: 50%; width: 0; height: 0; border-radius: 50%; background: rgba(224, 197, 132, 0.3); transform: translate(-50%, -50%); transition: width 0.5s ease, height 0.5s ease; }
        .time-slot-btn:hover::before { width: 200%; height: 200%; }
        .time-slot-btn > * { position: relative; z-index: 1; }

        .therapist-badge { background: linear-gradient(135deg, rgba(224,197,132,0.1), rgba(224,197,132,0.05)); border: 1px solid rgba(224,197,132,0.3); border-radius: 6px; padding: 0.5rem 0.75rem; }
        
        input:focus, select:focus, textarea:focus { box-shadow: 0 0 0 3px rgba(224, 197, 132, 0.1); }
        
        .loading-shimmer { background: linear-gradient(90deg, rgba(224,197,132,0.1) 25%, rgba(224,197,132,0.2) 50%, rgba(224,197,132,0.1) 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

        /* Header hero section */
        .header-hero { 
            background: linear-gradient(to bottom, rgba(0,0,0,0.4), rgba(5,5,5,1)), url('https://static.wixstatic.com/media/bf8fef_94f8be278f0f4b8abaee73b95d03b5e2~mv2.png');
            background-size: cover;
            background-position: center;
        }
    </style>

    <!-- Address autocomplete bootstrap -->
    <script>
        function initAllAutocompletes() {
            try {
                if (typeof google === 'undefined' || !google.maps || !google.maps.places) {
                    console.error("Google Maps API not loaded.");
                    return;
                }
                const addrInput = document.getElementById('address-input-initial');
                if (addrInput) {
                    const ac = new google.maps.places.Autocomplete(addrInput, {
                        componentRestrictions: { country: "ca" },
                        fields: ["address_components", "formatted_address"],
                        types: ["geocode"],
                    });
                    ac.addListener("place_changed", () => {
                        const place = ac.getPlace();
                        if (!place) return;
                        fillAddressFromPlace(place);
                    });
                }
            } catch (e) {
                console.warn("Maps init error", e);
            }
        }

        function fillAddressFromPlace(place) {
            try {
                let street = place.formatted_address || "";
                let city = "";
                let postal = "";
                if (place.address_components) {
                    for (const c of place.address_components) {
                        const t = c.types[0];
                        if (t === "locality" || t === "administrative_area_level_3") city = c.long_name;
                        if (t === "postal_code") postal = c.long_name;
                    }
                }
                window.__selectedAddress = { address: street, city, postal_code: postal };
            } catch (e) {
                console.warn("fillAddressFromPlace error", e);
            }
        }
    </script>
</head>

<body class="bg-brand-black selection:bg-brand-gold selection:text-black relative">

    <!-- NAVIGATION -->
    <nav id="navbar" class="fixed-nav">
        <div class="container mx-auto px-6 flex justify-between items-center h-20">
            <a href="index.html" class="flex items-center gap-3 no-underline group">
                <img src="https://static.wixstatic.com/media/bf8fef_511df25fad074d79a408119293545f75~mv2.png" alt="Relax & Renew Logo" class="h-10 w-auto transition-transform group-hover:scale-105">
                <div class="hidden md:flex flex-col">
                    <span class="text-brand-gold font-bold tracking-[0.2em] text-sm leading-none">RELAX & RENEW</span>
                    <span class="text-brand-light text-[0.65rem] tracking-[0.4em] uppercase opacity-70 leading-tight mt-1">Mobile RMT</span>
                </div>
            </a>
            <div class="hidden lg:flex items-center space-x-8 whitespace-nowrap">
                <a href="index.html#services" class="nav-link">Services</a>
                <a href="index.html#pricing" class="nav-link">Pricing</a>
                <a href="index.html#giftcards" class="nav-link">Gift Cards</a>
                <a href="index.html#area" class="nav-link">Service Area</a>
                <a href="index.html#faq" class="nav-link">FAQ</a>
                <a href="therapists.html" class="nav-link">Our Therapists</a>
                <a href="membership.html" class="nav-link text-brand-gold font-bold">Membership</a>
            </div>
        </div>
    </nav>

    <!-- HEADER HERO WITH STEP 1 INFO -->
    <header class="header-hero pt-28 pb-16 border-b border-brand-gold/20">
        <div class="container mx-auto px-6 max-w-6xl">
            <div class="animate-slide-up">
                <span class="inline-block text-brand-gold/80 tracking-[0.2em] uppercase text-sm font-bold mb-3 bg-brand-gold/10 px-4 py-2 rounded-full">
                    <i data-lucide="calendar-check" class="w-4 h-4 inline mr-2"></i>
                    Step 1: Address + Treatment
                </span>
                <h1 class="text-4xl md:text-5xl lg:text-6xl text-brand-light mt-3 mb-5 font-serif leading-tight">
                    Mobile Appointment Booking
                </h1>
                <p class="text-brand-dim text-base md:text-lg max-w-2xl leading-relaxed">
                    Enter your service address and choose your treatment. We'll calculate drive-time between appointments and only show times that realistically work for mobile visits.
                </p>
            </div>
        </div>
    </header>

    <!-- BOOKING CALENDAR SECTION -->
    <section id="booking" class="py-12 bg-brand-black border-b border-brand-light/5">
        <div class="container mx-auto px-6 max-w-6xl">
            <div class="card-fancy animate-fade-in">
                <!-- Top helper row -->
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-8 pb-6 border-b border-brand-gold/10">
                    <div class="flex items-center gap-3">
                        <div class="bg-brand-gold/10 p-2 rounded-full">
                            <i data-lucide="map-pin" class="w-5 h-5 text-brand-gold"></i>
                        </div>
                        <div>
                            <div class="text-xs uppercase tracking-[0.18em] text-brand-gold/70 font-bold mb-1">Service Location</div>
                            <div class="text-sm text-brand-light" id="selected-address-label">Service address + treatment required to view availability</div>
                        </div>
                    </div>
                    <button id="change-address-btn" class="btn-gold text-sm px-6 py-3">
                        <i data-lucide="edit-3" class="w-4 h-4"></i>
                        <span>Change Selection</span>
                    </button>
                </div>

                <!-- Calendar controls -->
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
                    <div class="flex items-center gap-4">
                        <button id="prev-month-btn" class="p-2 rounded border border-brand-gold/30 hover:bg-brand-gold/10 hover:border-brand-gold disabled:opacity-30 disabled:cursor-not-allowed transition-all">
                            <i data-lucide="chevron-left" class="w-5 h-5 text-brand-gold"></i>
                        </button>
                        <div class="text-brand-light text-lg md:text-xl font-serif">
                            <span id="calendar-month-label"></span>
                        </div>
                        <button id="next-month-btn" class="p-2 rounded border border-brand-gold/30 hover:bg-brand-gold/10 hover:border-brand-gold transition-all">
                            <i data-lucide="chevron-right" class="w-5 h-5 text-brand-gold"></i>
                        </button>
                    </div>
                    <div class="flex items-center gap-6 text-[0.7rem] uppercase tracking-[0.16em] text-brand-dim">
                        <div class="flex items-center gap-2">
                            <span class="inline-block w-4 h-4 rounded border border-brand-gold/20"></span> No Availability
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="inline-block w-4 h-4 rounded border border-brand-gold/70 bg-brand-gold/15"></span> Available
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="inline-block w-4 h-4 rounded border border-brand-gold bg-brand-gold/30"></span> Selected
                        </div>
                    </div>
                </div>

                <!-- Weekday header -->
                <div class="calendar-grid text-[0.75rem] uppercase tracking-[0.16em] text-brand-gold/70 mb-3 font-bold">
                    <div class="text-center py-2">Sun</div>
                    <div class="text-center py-2">Mon</div>
                    <div class="text-center py-2">Tue</div>
                    <div class="text-center py-2">Wed</div>
                    <div class="text-center py-2">Thu</div>
                    <div class="text-center py-2">Fri</div>
                    <div class="text-center py-2">Sat</div>
                </div>

                <!-- Calendar days -->
                <div id="calendar-days" class="calendar-grid text-sm mb-8"></div>

                <!-- Availability status -->
                <div id="availability-status" class="text-xs text-brand-dim/80 mb-6 p-4 rounded bg-brand-gold/5 border border-brand-gold/10">
                    <div class="flex items-center gap-2">
                        <i data-lucide="info" class="w-4 h-4 text-brand-gold"></i>
                        <span>Enter your address and select a treatment to load live availability.</span>
                    </div>
                </div>

                <!-- Time slots for selected date -->
                <div id="time-slots-wrapper" class="border-t border-brand-gold/20 pt-6 mt-4 hidden animate-slide-up">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
                        <div>
                            <div class="text-xs uppercase tracking-[0.18em] text-brand-gold flex items-center gap-2 mb-2">
                                <i data-lucide="clock" class="w-4 h-4"></i>
                                <span id="selected-date-label">Available Times</span>
                            </div>
                            <div class="text-[11px] text-brand-dim/80">
                                <span id="selected-treatment-label"></span>
                            </div>
                        </div>
                        <div id="therapist-info" class="hidden therapist-badge">
                            <div class="flex items-center gap-2 text-sm">
                                <i data-lucide="user-check" class="w-4 h-4 text-brand-gold"></i>
                                <span class="text-brand-light" id="therapist-name"></span>
                            </div>
                        </div>
                    </div>
                    <div id="time-slots" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-3"></div>
                </div>
            </div>
        </div>
    </section>

    <footer class="bg-neutral-950 py-12 border-t border-brand-gold/20 text-center">
        <div class="container mx-auto px-6">
            <p class="text-brand-dim/60 text-sm mb-4">Professional, registered mobile massage therapy.</p>
            <div class="flex justify-center gap-6 text-brand-gold mb-8">
                <a href="https://www.facebook.com/share/1F1fYU6yrF/" target="_blank" class="hover:text-brand-light transition-colors bg-brand-light/5 p-2 rounded-full"><i data-lucide="facebook" class="w-4 h-4"></i></a>
                <a href="mailto:info@relaxandrenew.ca" class="hover:text-brand-light transition-colors bg-brand-light/5 p-2 rounded-full"><i data-lucide="mail" class="w-4 h-4"></i></a>
            </div>
            <a href="https://relaxandrenew.ca" class="text-brand-gold hover:text-brand-light text-sm underline transition-colors">Return to Main Website</a>
        </div>
    </footer>

    <!-- ADDRESS MODAL -->
    <div id="address-modal" class="fixed inset-0 modal-backdrop flex items-center justify-center p-4 hidden">
        <div class="bg-brand-black border border-brand-gold/30 rounded-lg p-8 md:p-10 max-w-xl w-full relative shadow-2xl animate-slide-up">
            <button id="address-modal-close" class="absolute top-4 right-4 text-brand-gold/70 hover:text-brand-light transition-colors">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
            <div class="text-center mb-8">
                <div class="inline-block bg-brand-gold/10 p-3 rounded-full mb-4">
                    <i data-lucide="map-pin" class="w-8 h-8 text-brand-gold"></i>
                </div>
                <h3 class="text-3xl text-brand-gold font-serif mb-2">Where will we be visiting?</h3>
                <p class="text-sm text-brand-dim max-w-md mx-auto leading-relaxed">
                    We'll use this address to calculate drive-time between appointments and only show times that are realistic for mobile service.
                </p>
            </div>

            <label class="block text-[11px] text-brand-gold/80 uppercase font-bold mb-2 tracking-wider">Service Address *</label>
            <input id="address-input-initial" type="text" autocomplete="off" placeholder="Start typing your address..." class="w-full bg-white/5 border border-brand-gold/40 rounded-lg p-3 text-brand-light text-sm focus:outline-none focus:border-brand-gold focus:bg-white/10 transition-all mb-2">
            <button id="toggle-manual-address" class="text-[11px] underline text-brand-gold/80 hover:text-brand-light transition-colors mb-6">
                Can't find your address? Enter it manually.
            </button>

            <div id="manual-address-wrapper" class="space-y-4 hidden">
                <div>
                    <label class="block text-[11px] text-brand-gold/80 uppercase font-bold mb-2 tracking-wider">Street Address *</label>
                    <input id="manual-street" type="text" class="w-full bg-white/5 border border-brand-gold/30 rounded-lg p-3 text-brand-light text-sm focus:outline-none focus:border-brand-gold focus:bg-white/10 transition-all">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-[11px] text-brand-gold/80 uppercase font-bold mb-2 tracking-wider">City *</label>
                        <input id="manual-city" type="text" class="w-full bg-white/5 border border-brand-gold/30 rounded-lg p-3 text-brand-light text-sm focus:outline-none focus:border-brand-gold focus:bg-white/10 transition-all">
                    </div>
                    <div>
                        <label class="block text-[11px] text-brand-gold/80 uppercase font-bold mb-2 tracking-wider">Postal Code *</label>
                        <input id="manual-postal" type="text" class="w-full bg-white/5 border border-brand-gold/30 rounded-lg p-3 text-brand-light text-sm focus:outline-none focus:border-brand-gold focus:bg-white/10 transition-all">
                    </div>
                </div>
            </div>

            <!-- Treatment + Duration -->
            <div class="mt-8 space-y-4">
                <div>
                    <label class="block text-[11px] text-brand-gold/80 uppercase font-bold mb-2 tracking-wider">Treatment *</label>
                    <select id="service-select" class="w-full bg-white/5 border border-brand-gold/40 rounded-lg p-3 text-brand-light text-sm focus:outline-none focus:border-brand-gold focus:bg-brand-black transition-all">
                        <option value="" disabled selected>Select a treatment...</option>

                        <optgroup label="Core Therapeutic">
                            <option value="relaxation">Relaxation Massage</option>
                            <option value="deep_tissue">Deep Tissue Massage</option>
                            <option value="sports">Sports Massage</option>
                            <option value="senior">Senior Massage</option>
                        </optgroup>

                        <optgroup label="Premium Therapeutic">
                            <option value="hot_stone">Hot Stone Massage</option>
                            <option value="cupping">Cupping Therapy</option>
                        </optgroup>

                        <optgroup label="Specialty">
                            <option value="prenatal">Prenatal Massage</option>
                            <option value="pediatric">Pediatric Massage</option>
                            <option value="infant">Infant Massage</option>
                        </optgroup>
                    </select>
                </div>

                <div>
                    <label class="block text-[11px] text-brand-gold/80 uppercase font-bold mb-2 tracking-wider">Duration *</label>
                    <select id="duration-select" disabled class="w-full bg-white/5 border border-brand-gold/40 rounded-lg p-3 text-brand-light text-sm focus:outline-none focus:border-brand-gold focus:bg-brand-black disabled:opacity-60 transition-all">
                        <option value="" disabled selected>Select a duration...</option>
                    </select>
                    <p class="mt-3 text-[11px] text-brand-dim/70 bg-brand-gold/5 p-3 rounded-lg border border-brand-gold/10">
                        <i data-lucide="info" class="w-3 h-3 inline mr-1"></i>
                        You will only see the service duration. We add a standard 25-minute setup/pack-up internally.
                    </p>
                </div>
            </div>

            <button id="address-continue-btn" class="w-full btn-filled py-4 mt-6 font-bold tracking-wider text-base">
                <i data-lucide="arrow-right-circle" class="w-5 h-5"></i>
                <span>Show Available Times</span>
            </button>

            <p id="address-error" class="text-xs text-red-400 mt-4 hidden bg-red-500/10 border border-red-500/30 p-3 rounded-lg">
                <i data-lucide="alert-circle" class="w-4 h-4 inline mr-1"></i>
                Please provide an address, treatment, and duration before continuing.
            </p>
        </div>
    </div>

    <!-- SCRIPT: AVAILABILITY -->
    <script>
        // ---------------- CONFIG ----------------
        const AVAILABILITY_URL = "/.netlify/functions/cliniko-mobile-availability";
        const STATIC_SETUP_MINUTES = 25;

        // Therapist data (you can expand this)
        const THERAPISTS = {
            'cassandra': { name: 'Cassandra', specialty: 'Deep Tissue & Sports' },
            'default': { name: 'Available Therapist', specialty: 'All Services' }
        };

        // ---------------- RULES ----------------
        const TREATMENT_RULES = {
            relaxation:  { label: "Relaxation Massage", durations: [60, 75, 90, 120] },
            deep_tissue: { label: "Deep Tissue Massage", durations: [60, 75, 90, 120] },
            sports:      { label: "Sports Massage", durations: [60, 75, 90, 120] },
            senior:      { label: "Senior Massage", durations: [60, 75, 90, 120] },

            hot_stone:   { label: "Hot Stone Massage", durations: [60, 75, 90, 120] },
            cupping:     { label: "Cupping Therapy", durations: [60, 75, 90, 120] },

            prenatal:    { label: "Prenatal Massage", durations: [30, 45, 60] },
            pediatric:   { label: "Pediatric Massage", durations: [30, 45] },
            infant:      { label: "Infant Massage", durations: [30, 45] },
        };

        // ---------------- STATE ----------------
        let availabilityByDate = {};
        let calendarCurrent = new Date();
        let selectedDateStr = null;
        let selectedSlot = null;
        window.__selectedAddress = null;

        let selectedServiceKey = null;
        let selectedStandardDuration = null;

        // ---------------- HELPERS ----------------
        function toDateStr(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }

        function formatDateLabel(date) {
            return date.toLocaleDateString('en-CA', {
                weekday: 'long', month: 'long', day: 'numeric', year: 'numeric'
            });
        }

        function parseISODate(iso) {
            const d = new Date(iso);
            if (isNaN(d.getTime())) return null;
            return d;
        }

        function formatTimeLabel(slot) {
            if (slot.label) return slot.label;
            const dateObj = parseISODate(slot.start);
            if (!dateObj) return 'Time';
            return dateObj.toLocaleTimeString('en-CA', { hour: 'numeric', minute: '2-digit' });
        }

        function setAvailabilityFromResponse(data) {
            availabilityByDate = {};

            console.log('ðŸ” Raw API Response:', data);
            console.log('ðŸ” Type:', typeof data);

            if (!data) return;

            // Handle object with dates property (expected from n8n)
            if (data.dates && Array.isArray(data.dates)) {
                console.log('âœ… Processing dates array from response');
                data.dates.forEach(day => {
                    if (!day || !day.date || !Array.isArray(day.slots)) return;
                    availabilityByDate[day.date] = day.slots;
                });
                console.log('ðŸ“… Availability by date:', availabilityByDate);
                return;
            }

            // Fallback: Handle direct array
            if (Array.isArray(data)) {
                console.log('âœ… Processing as direct array');
                data.forEach(day => {
                    if (!day || !day.date || !Array.isArray(day.slots)) return;
                    availabilityByDate[day.date] = day.slots;
                });
                console.log('ðŸ“… Availability by date:', availabilityByDate);
                return;
            }

            console.error('âŒ Could not parse availability data structure');
        }

        function hasSlots(dateStr) {
            return Array.isArray(availabilityByDate[dateStr]) && availabilityByDate[dateStr].length > 0;
        }

        function updateAvailabilityStatus(message, isError = false) {
            const el = document.getElementById('availability-status');
            const iconClass = isError ? 'alert-circle' : 'info';
            el.innerHTML = `<div class="flex items-center gap-2"><i data-lucide="${iconClass}" class="w-4 h-4 ${isError ? 'text-red-400' : 'text-brand-gold'}"></i><span>${message}</span></div>`;
            el.className = "text-xs mb-6 p-4 rounded border " + (isError ? "text-red-400 bg-red-500/10 border-red-500/30" : "text-brand-dim/80 bg-brand-gold/5 border-brand-gold/10");
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function computeMonthRange(monthDate) {
            const now = new Date(); now.setHours(0,0,0,0);
            const y = monthDate.getFullYear();
            const m = monthDate.getMonth();
            const first = new Date(y, m, 1); first.setHours(0,0,0,0);
            const last = new Date(y, m + 1, 0); last.setHours(0,0,0,0);

            const from = (y === now.getFullYear() && m === now.getMonth()) ? now : first;
            return { from: toDateStr(from), to: toDateStr(last) };
        }

        // ---------------- CALENDAR RENDER ----------------
        function renderCalendar() {
            const monthLabelEl = document.getElementById('calendar-month-label');
            const daysContainer = document.getElementById('calendar-days');
            const today = new Date(); today.setHours(0,0,0,0);

            const year = calendarCurrent.getFullYear();
            const month = calendarCurrent.getMonth();
            const firstOfMonth = new Date(year, month, 1);
            const lastOfMonth = new Date(year, month + 1, 0);

            monthLabelEl.textContent = calendarCurrent.toLocaleDateString('en-CA', { month: 'long', year: 'numeric' });

            const startDow = firstOfMonth.getDay();
            const daysInMonth = lastOfMonth.getDate();
            daysContainer.innerHTML = '';

            const totalCells = Math.ceil((startDow + daysInMonth) / 7) * 7;

            for (let cellIndex = 0; cellIndex < totalCells; cellIndex++) {
                const dayEl = document.createElement('button');
                dayEl.type = 'button';
                dayEl.className = "relative text-center py-3 text-base rounded-lg border transition-all";

                const dayNumber = cellIndex - startDow + 1;
                if (dayNumber < 1 || dayNumber > daysInMonth) {
                    dayEl.classList.add('opacity-0', 'pointer-events-none', 'border-transparent');
                    daysContainer.appendChild(dayEl);
                    continue;
                }

                const cellDate = new Date(year, month, dayNumber);
                cellDate.setHours(0,0,0,0);
                const dateStr = toDateStr(cellDate);

                dayEl.textContent = dayNumber;

                if (cellDate < today) {
                    dayEl.classList.add('calendar-day-disabled', 'border-brand-gold/10', 'bg-black/30');
                    daysContainer.appendChild(dayEl);
                    continue;
                }

                dayEl.classList.add('border-brand-gold/20', 'bg-black/30');
                
                if (hasSlots(dateStr)) {
                    dayEl.classList.add('calendar-day-available');
                    dayEl.classList.remove('border-brand-gold/20');
                }
                
                if (selectedDateStr === dateStr) {
                    dayEl.classList.add('calendar-day-selected');
                }

                dayEl.addEventListener('click', () => {
                    if (!hasSlots(dateStr)) return;
                    selectedDateStr = dateStr;
                    selectedSlot = null;
                    renderCalendar();
                    renderTimeSlotsForDate(dateStr);
                });

                daysContainer.appendChild(dayEl);
            }
        }

        function renderTimeSlotsForDate(dateStr) {
            const wrapper = document.getElementById('time-slots-wrapper');
            const container = document.getElementById('time-slots');
            const dateLabelEl = document.getElementById('selected-date-label');
            const treatLabelEl = document.getElementById('selected-treatment-label');
            const therapistInfo = document.getElementById('therapist-info');
            const therapistName = document.getElementById('therapist-name');

            if (!hasSlots(dateStr)) {
                wrapper.classList.add('hidden');
                container.innerHTML = '';
                return;
            }

            const [yy, mm, dd] = dateStr.split('-').map(Number);
            const dateObj = new Date(yy, mm - 1, dd);
            dateLabelEl.textContent = formatDateLabel(dateObj);

            const treat = selectedServiceKey ? TREATMENT_RULES[selectedServiceKey] : null;
            treatLabelEl.textContent = (treat && selectedStandardDuration)
                ? `${treat.label} â€¢ ${selectedStandardDuration} min`
                : '';

            const slots = availabilityByDate[dateStr];
            container.innerHTML = '';

            // Show therapist info (simplified - you can enhance this based on your data)
            if (slots.length > 0) {
                const therapist = THERAPISTS['cassandra'] || THERAPISTS['default'];
                therapistName.textContent = therapist.name;
                therapistInfo.classList.remove('hidden');
            }

            slots.forEach((slot) => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = "time-slot-btn px-4 py-3 rounded-lg border border-brand-gold/30 text-sm text-brand-light bg-black/40 hover:bg-brand-gold/15 hover:border-brand-gold flex flex-col items-center justify-center gap-1";
                
                const timeLabel = formatTimeLabel(slot);
                btn.innerHTML = `
                    <i data-lucide="clock" class="w-4 h-4 text-brand-gold"></i>
                    <span class="font-semibold">${timeLabel}</span>
                `;

                btn.addEventListener('click', () => {
                    selectedSlot = slot;
                    renderTimeSlotsForDate(dateStr);
                });

                if (selectedSlot && selectedSlot.start === slot.start) {
                    btn.classList.add('bg-brand-gold/25', 'border-brand-gold', 'ring-2', 'ring-brand-gold/50');
                }

                container.appendChild(btn);
            });

            wrapper.classList.remove('hidden');
            
            // Render icons once after all buttons are created
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        // ---------------- ADDRESS MODAL LOGIC ----------------
        function openAddressModal() {
            const modal = document.getElementById('address-modal');
            if (modal) modal.classList.remove('hidden');
        }
        
        function closeAddressModal() {
            const modal = document.getElementById('address-modal');
            if (modal) modal.classList.add('hidden');
        }

        function getAddressFromModal() {
            const manualWrapper = document.getElementById('manual-address-wrapper');
            const isManual = !manualWrapper.classList.contains('hidden');

            if (isManual) {
                const street = document.getElementById('manual-street').value.trim();
                const city = document.getElementById('manual-city').value.trim();
                const postal = document.getElementById('manual-postal').value.trim();
                if (!street || !city || !postal) return null;
                const full = `${street}, ${city} ${postal}`;
                const addrObj = { address: full, city, postal_code: postal };
                window.__selectedAddress = addrObj;
                return addrObj;
            }

            if (window.__selectedAddress && window.__selectedAddress.address) return window.__selectedAddress;

            const raw = document.getElementById('address-input-initial').value.trim();
            if (!raw) return null;
            const addrObj = { address: raw, city: "", postal_code: "" };
            window.__selectedAddress = addrObj;
            return addrObj;
        }

        function rebuildDurationOptions() {
            const durationSelect = document.getElementById('duration-select');
            durationSelect.innerHTML = '<option value="" disabled selected>Select a duration...</option>';

            if (!selectedServiceKey || !TREATMENT_RULES[selectedServiceKey]) {
                durationSelect.disabled = true;
                selectedStandardDuration = null;
                return;
            }

            const durations = TREATMENT_RULES[selectedServiceKey].durations;
            durations.forEach(min => {
                const opt = document.createElement('option');
                opt.value = String(min);
                opt.textContent = `${min} min`;
                durationSelect.appendChild(opt);
            });

            durationSelect.disabled = false;
            selectedStandardDuration = null;
        }

        async function loadAvailabilityForCurrentMonth() {
            const addrObj = window.__selectedAddress;
            if (!addrObj || !addrObj.address) {
                updateAvailabilityStatus("Enter your address to load live availability.", false);
                return;
            }
            if (!selectedServiceKey || !selectedStandardDuration) {
                updateAvailabilityStatus("Select your treatment and duration to load live availability.", false);
                return;
            }

            try {
                updateAvailabilityStatus("Checking live availability for this address...", false);
                selectedDateStr = null;
                selectedSlot = null;
                document.getElementById('time-slots-wrapper').classList.add('hidden');

                const { from, to } = computeMonthRange(calendarCurrent);
                
                // Calculate block minutes (what Cliniko needs to reserve)
                const blockMinutes = Number(selectedStandardDuration) + STATIC_SETUP_MINUTES;

                const treat = selectedServiceKey ? TREATMENT_RULES[selectedServiceKey] : null;

                // Send both standard and block durations
                const payload = {
                    address: addrObj.address,
                    city: addrObj.city,
                    postal_code: addrObj.postal_code,
                    from,
                    to,
                    durationMinutes: blockMinutes,
                    standardDurationMinutes: Number(selectedStandardDuration),
                    treatment_key: selectedServiceKey,
                    treatment_label: treat ? treat.label : ""
                };

                console.log('ðŸ“¤ Sending payload:', payload);

                const res = await fetch(AVAILABILITY_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!res.ok) {
                    console.error('âŒ Availability error', res.status, await res.text());
                    setAvailabilityFromResponse(null);
                    renderCalendar();
                    updateAvailabilityStatus("We couldn't load availability right now. Please try again or contact us.", true);
                    return;
                }

                const data = await res.json();
                setAvailabilityFromResponse(data);

                const any = Object.keys(availabilityByDate).some(d => hasSlots(d));
                if (!any) {
                    updateAvailabilityStatus("No mobile availability found for this month with the selected treatment and duration. Please try another month or contact us.", false);
                } else {
                    updateAvailabilityStatus("Select a date to see available times.", false);
                }

                renderCalendar();
            } catch (e) {
                console.error('âŒ Availability exception', e);
                updateAvailabilityStatus("Something went wrong while loading times. Please try again or call us.", true);
            }
        }

        // ---------------- INIT ----------------
        function initializeApp() {
            if (typeof lucide !== 'undefined') lucide.createIcons();

            const serviceSelect = document.getElementById('service-select');
            const durationSelect = document.getElementById('duration-select');

            serviceSelect.addEventListener('change', () => {
                selectedServiceKey = serviceSelect.value || null;
                rebuildDurationOptions();
            });

            durationSelect.addEventListener('change', () => {
                selectedStandardDuration = durationSelect.value ? Number(durationSelect.value) : null;
            });

            document.getElementById('prev-month-btn').addEventListener('click', async () => {
                const today = new Date(); today.setHours(0,0,0,0);
                const isCurrentMonth = today.getFullYear() === calendarCurrent.getFullYear() && today.getMonth() === calendarCurrent.getMonth();

                if (isCurrentMonth) return;
                
                calendarCurrent.setMonth(calendarCurrent.getMonth() - 1);
                await loadAvailabilityForCurrentMonth();
                updatePrevMonthButton();
            });
            
            function updatePrevMonthButton() {
                const today = new Date(); today.setHours(0,0,0,0);
                const isCurrentMonth = today.getFullYear() === calendarCurrent.getFullYear() && today.getMonth() === calendarCurrent.getMonth();
                document.getElementById('prev-month-btn').disabled = isCurrentMonth;
            }
            updatePrevMonthButton();

            document.getElementById('next-month-btn').addEventListener('click', async () => {
                calendarCurrent.setMonth(calendarCurrent.getMonth() + 1);
                await loadAvailabilityForCurrentMonth();
                updatePrevMonthButton();
            });

            document.getElementById('toggle-manual-address').addEventListener('click', (e) => {
                e.preventDefault();
                const manualWrapper = document.getElementById('manual-address-wrapper');
                const autoInput = document.getElementById('address-input-initial');
                const isHidden = manualWrapper.classList.contains('hidden');

                if (isHidden) {
                    manualWrapper.classList.remove('hidden');
                    autoInput.classList.add('hidden');
                    e.target.textContent = "Use address lookup instead.";
                } else {
                    manualWrapper.classList.add('hidden');
                    autoInput.classList.remove('hidden');
                    e.target.textContent = "Can't find your address? Enter it manually.";
                }
            });

            document.getElementById('address-continue-btn').addEventListener('click', async () => {
                const addr = getAddressFromModal();
                const errorEl = document.getElementById('address-error');
                const labelEl = document.getElementById('selected-address-label');
                const treat = selectedServiceKey ? TREATMENT_RULES[selectedServiceKey] : null;

                if (!addr || !selectedStandardDuration || !treat) {
                    errorEl.classList.remove('hidden');
                    return;
                }

                errorEl.classList.add('hidden');
                labelEl.textContent = `${treat.label} (${selectedStandardDuration} min) at ${addr.city || addr.address}`;
                closeAddressModal();
                await loadAvailabilityForCurrentMonth();
            });

            document.getElementById('change-address-btn').addEventListener('click', openAddressModal);
            document.getElementById('address-modal-close').addEventListener('click', closeAddressModal);
            
            document.getElementById('address-modal').classList.remove('hidden');
            renderCalendar();
        }

        window.onload = initializeApp;

    </script>

    <!-- Google Maps Places API -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAZz1rumAp-1QeQsZ70GXh3vQH3sJQjx6A&libraries=places&callback=initAllAutocompletes" async defer></script>
</body>
</html>
